cscope 15 $HOME/code/git/my/lwan -q 0000002057 0000278326
	@common/base64.c

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

12 
	~"ba£64.h
"

14 cÚ¡ 
	gba£64_bË
[65] =

24 cÚ¡ 
	gba£64_decode_bË
[256] = {

61 * 
	$ba£64_’code
(cÚ¡ *
¤c
, 
size_t
 
Ën
,

62 
size_t
 *
out_Ën
)

64 *
out
, *
pos
;

65 cÚ¡ *
’d
, *
š
;

66 
size_t
 
Ş’
;

67 
lše_Ën
;

69 
Ş’
 = 
Ën
 * 4 / 3 + 4;

70 
Ş’
 += olen / 72;

71 
Ş’
++;

72 ià(
Ş’
 < 
Ën
)

73  
NULL
;

74 
out
 = 
	`m®loc
(
Ş’
);

75 ià(
out
 =ğ
NULL
)

76  
NULL
;

78 
’d
 = 
¤c
 + 
Ën
;

79 
š
 = 
¤c
;

80 
pos
 = 
out
;

81 
lše_Ën
 = 0;

82 
’d
 - 
š
 >= 3) {

83 *
pos
++ = 
ba£64_bË
[
š
[0] >> 2];

84 *
pos
++ = 
ba£64_bË
[((
š
[0] & 0x03) << 4) | (in[1] >> 4)];

85 *
pos
++ = 
ba£64_bË
[((
š
[1] & 0x0f) << 2) | (in[2] >> 6)];

86 *
pos
++ = 
ba£64_bË
[
š
[2] & 0x3f];

87 
š
 += 3;

88 
lše_Ën
 += 4;

89 ià(
lše_Ën
 >= 72) {

90 *
pos
++ = '\n';

91 
lše_Ën
 = 0;

95 ià(
’d
 - 
š
) {

96 *
pos
++ = 
ba£64_bË
[
š
[0] >> 2];

97 ià(
’d
 - 
š
 == 1) {

98 *
pos
++ = 
ba£64_bË
[(
š
[0] & 0x03) << 4];

99 *
pos
++ = '=';

101 *
pos
++ = 
ba£64_bË
[((
š
[0] & 0x03) << 4) |

102 (
š
[1] >> 4)];

103 *
pos
++ = 
ba£64_bË
[(
š
[1] & 0x0f) << 2];

105 *
pos
++ = '=';

106 
lše_Ën
 += 4;

109 ià(
lše_Ën
)

110 *
pos
++ = '\n';

112 *
pos
 = '\0';

113 ià(
out_Ën
)

114 *
out_Ën
 = (
size_t
)(
pos
 - 
out
);

115  
out
;

116 
	}
}

128 * 
	$ba£64_decode
(cÚ¡ *
¤c
, 
size_t
 
Ën
,

129 
size_t
 *
out_Ën
)

131 *
out
, *
pos
, 
block
[4];

132 
size_t
 
i
, 
couÁ
, 
Ş’
;

133 
·d
 = 0;

135 
couÁ
 = 0;

136 
i
 = 0; i < 
Ën
; i++) {

137 ià(
ba£64_decode_bË
[
¤c
[
i
]] != 0x80)

138 
couÁ
++;

141 ià(
couÁ
 == 0 || count % 4)

142  
NULL
;

144 
Ş’
 = (
couÁ
 / 4 * 3) + 1;

145 
pos
 = 
out
 = 
	`m®loc
(
Ş’
);

146 ià(
out
 =ğ
NULL
)

147  
NULL
;

149 
couÁ
 = 0;

150 
i
 = 0; i < 
Ën
; i++) {

151 
tmp
 = 
ba£64_decode_bË
[
¤c
[
i
]];

152 ià(
tmp
 == 0x80)

155 ià(
¤c
[
i
] == '=')

156 
·d
++;

157 
block
[
couÁ
] = 
tmp
;

158 
couÁ
++;

159 ià(
couÁ
 == 4) {

160 *
pos
++ = ()((
block
[0] << 2) | (block[1] >> 4));

161 *
pos
++ = ()((
block
[1] << 4) | (block[2] >> 2));

162 *
pos
++ = ()((
block
[2] << 6) | block[3]);

163 
couÁ
 = 0;

164 ià(
·d
) {

165 ià(
·d
 == 1)

166 
pos
--;

167 ià(
·d
 == 2)

168 
pos
 -= 2;

171 
	`ä“
(
out
);

172  
NULL
;

178 *
pos
 = '\0';

180 *
out_Ën
 = (
size_t
)(
pos
 - 
out
);

181  
out
;

182 
	}
}

	@common/base64.h

1 #iâdeà
AUTH_BASE64_H


2 
	#AUTH_BASE64_H


	)

4 
	~<¡ddef.h
>

6 *
ba£64_’code
(cÚ¡ *
¤c
, 
size_t
 
Ën
,

7 
size_t
 *
out_Ën
);

8 *
ba£64_decode
(cÚ¡ *
¤c
, 
size_t
 
Ën
,

9 
size_t
 *
out_Ën
);

	@common/hash.c

21 
	~"hash.h
"

22 
	~"murmur3.h
"

24 
	~<¡dšt.h
>

25 
	~<¡dboŞ.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

28 
	~<”ºo.h
>

30 cÚ¡ 
	gn_buck‘s
 = 512;

31 cÚ¡ 
	g¡•s
 = 64;

33 
	shash_’Œy
 {

34 cÚ¡ *
	mkey
;

35 cÚ¡ *
	mv®ue
;

36 
	mhashv®
;

39 
	shash_buck‘
 {

40 
hash_’Œy
 *
	m’Œ›s
;

41 
	mu£d
;

42 
	mtÙ®
;

45 
	shash
 {

46 
	mcouÁ
;

47 (*
	mhash_v®ue
)(cÚ¡ *
	mkey
);

48 (*
	mkey_com·»
)(cÚ¡ *
	mk1
, cÚ¡ *
	mk2
);

49 (*
	mä“_v®ue
)(*
	mv®ue
);

50 (*
	mä“_key
)(*
	mv®ue
);

51 
hash_buck‘
 
	mbuck‘s
[];

54 
šlše
 
	$hash_št
(cÚ¡ *
key±r
)

57 
key
 = ()()
key±r
;

58 
c2
 = 0x27d4eb2d;

60 
key
 = (key ^ 61) ^ (key >> 16);

61 
key
 += key << 3;

62 
key
 ^= key >> 4;

63 
key
 *ğ
c2
;

64 
key
 ^= key >> 15;

65  
key
;

66 
	}
}

68 #ià
defšed
(
HAVE_BUILTIN_CPU_INIT
è&& defšed(
USE_HARDWARE_CRC32
)

69 
šlše
 
	$hash_üc32
(cÚ¡ *
key±r
)

71 
hash
 = 0xABAD1DEA;

72 cÚ¡ *
key
 = 
key±r
;

73 
size_t
 
Ën
 = 
	`¡¾’
(
key
);

75 #ià
__x86_64__


76 
Ën
 >ğ(
ušt64_t
)) {

77 
hash
 = ()
	`__butš_Ÿ32_üc32di
(hash, *((
ušt64_t
 *)
key
));

78 
key
 +ğ(
ušt64_t
);

79 
Ën
 -ğ(
ušt64_t
);

82 
Ën
 >ğ(
ušt32_t
)) {

83 
hash
 = 
	`__butš_Ÿ32_üc32si
(hash, *((
ušt32_t
 *)
key
));

84 
key
 +ğ(
ušt32_t
);

85 
Ën
 -ğ(
ušt32_t
);

87 ià(
Ën
 >ğ(
ušt16_t
)) {

88 
hash
 = 
	`__butš_Ÿ32_üc32hi
(hash, *((
ušt16_t
 *)
key
));

89 
key
 +ğ(
ušt16_t
);

90 
Ën
 -ğ(
ušt16_t
);

92 ià(
Ën
)

93 
hash
 = 
	`__butš_Ÿ32_üc32qi
(hash, ()*
key
);

95  
hash
;

96 
	}
}

99 
šlše
 
	$hash_št_key_cmp
(cÚ¡ *
k1
, cÚ¡ *
k2
)

101 
a
 = ()()
k1
;

102 
b
 = ()()
k2
;

103  
a
 - 
b
;

104 
	}
}

106 
hash
 *
hash_š‹º®_Ãw
(

107 (*
hash_v®ue
)(cÚ¡ *
key
),

108 (*
key_com·»
)(cÚ¡ *
k1
, cÚ¡ *
k2
),

109 (*
ä“_key
)(*
v®ue
),

110 (*
ä“_v®ue
)(*
v®ue
))

112 
hash
 *hash = 
	`ÿÎoc
(1, (hash) +

113 
n_buck‘s
 * (
hash_buck‘
));

114 ià(
hash
 =ğ
NULL
)

115  
NULL
;

116 
hash
->
hash_v®ue
 = hash_value;

117 
hash
->
key_com·»
 = key_compare;

118 
hash
->
ä“_v®ue
 = free_value;

119 
hash
->
ä“_key
 = free_key;

120  
hash
;

121 
	}
}

123 
hash
 *
hash_št_Ãw
((*
ä“_key
)(*
v®ue
),

124 (*
ä“_v®ue
)(*
v®ue
))

126  
	`hash_š‹º®_Ãw
(
hash_št
,

127 
hash_št_key_cmp
,

128 
ä“_key
,

129 
ä“_v®ue
);

130 
	}
}

132 
hash
 *
hash_¡r_Ãw
((*
ä“_key
)(*
v®ue
),

133 (*
ä“_v®ue
)(*
v®ue
))

135 (*
hash_func
)(cÚ¡ *
key
);

137 #ià
	`defšed
(
HAVE_BUILTIN_CPU_INIT
è&& defšed(
USE_HARDWARE_CRC32
)

138 
	`__butš_ıu_š™
();

139 ià(
	`__butš_ıu_suµÜts
("sse4.2")) {

140 
hash_func
 = 
hash_üc32
;

142 
hash_func
 = 
murmur3_sim¶e
;

145 
hash_func
 = 
murmur3_sim¶e
;

148  
	`hash_š‹º®_Ãw
(

149 
hash_func
,

150 ((*)(cÚ¡ *, cÚ¡ *))
¡rcmp
,

151 
ä“_key
,

152 
ä“_v®ue
);

153 
	}
}

155 
	$hash_ä“
(
hash
 *hash)

157 
hash_buck‘
 *
buck‘
, *
buck‘_’d
;

159 ià(
hash
 =ğ
NULL
)

162 
buck‘
 = 
hash
->
buck‘s
;

163 
buck‘_’d
 = 
buck‘
 + 
n_buck‘s
;

164 ; 
buck‘
 < 
buck‘_’d
; bucket++) {

165 ià(
hash
->
ä“_v®ue
) {

166 
hash_’Œy
 *
’Œy
, *
’Œy_’d
;

167 
’Œy
 = 
buck‘
->
’Œ›s
;

168 
’Œy_’d
 = 
’Œy
 + 
buck‘
->
u£d
;

169 ; 
’Œy
 < 
’Œy_’d
;ƒntry++) {

170 
hash
->
	`ä“_v®ue
((*)
’Œy
->
v®ue
);

171 ià(
hash
->
ä“_key
)

172 
hash
->
	`ä“_key
((*)
’Œy
->
key
);

175 
	`ä“
(
buck‘
->
’Œ›s
);

177 
	`ä“
(
hash
);

178 
	}
}

186 
	$hash_add
(
hash
 *hash, cÚ¡ *
key
, cÚ¡ *
v®ue
)

188 
hashv®
 = 
hash
->
	`hash_v®ue
(
key
);

189 
pos
 = 
hashv®
 & (
n_buck‘s
 - 1);

190 
hash_buck‘
 *
buck‘
 = 
hash
->
buck‘s
 + 
pos
;

191 
hash_’Œy
 *
’Œy
, *
’Œy_’d
;

193 ià(
buck‘
->
u£d
 + 1 >ğbuck‘->
tÙ®
) {

194 
Ãw_tÙ®
 = 
buck‘
->
tÙ®
 + 
¡•s
;

195 
size_t
 
size
 = 
Ãw_tÙ®
 * (
hash_’Œy
);

196 
hash_’Œy
 *
tmp
 = 
	`»®loc
(
buck‘
->
’Œ›s
, 
size
);

197 ià(
tmp
 =ğ
NULL
)

198  -
”ºo
;

199 
buck‘
->
’Œ›s
 = 
tmp
;

200 
buck‘
->
tÙ®
 = 
Ãw_tÙ®
;

203 
’Œy
 = 
buck‘
->
’Œ›s
;

204 
’Œy_’d
 = 
’Œy
 + 
buck‘
->
u£d
;

205 ; 
’Œy
 < 
’Œy_’d
;ƒntry++) {

206 ià(
hashv®
 !ğ
’Œy
->hashval)

208 ià(
hash
->
	`key_com·»
(
key
, 
’Œy
->key) != 0)

210 ià(
hash
->
ä“_v®ue
)

211 
hash
->
	`ä“_v®ue
((*)
’Œy
->
v®ue
);

212 ià(
hash
->
ä“_key
)

213 
hash
->
	`ä“_key
((*)
’Œy
->
key
);

215 
’Œy
->
key
 = key;

216 
’Œy
->
v®ue
 = value;

220 
’Œy
->
key
 = key;

221 
’Œy
->
v®ue
 = value;

222 
’Œy
->
hashv®
 = hashval;

223 
buck‘
->
u£d
++;

224 
hash
->
couÁ
++;

226 
	}
}

229 
	$hash_add_unique
(
hash
 *hash, cÚ¡ *
key
, cÚ¡ *
v®ue
)

231 
hashv®
 = 
hash
->
	`hash_v®ue
(
key
);

232 
pos
 = 
hashv®
 & (
n_buck‘s
 - 1);

233 
hash_buck‘
 *
buck‘
 = 
hash
->
buck‘s
 + 
pos
;

234 
hash_’Œy
 *
’Œy
, *
’Œy_’d
;

236 ià(
buck‘
->
u£d
 + 1 >ğbuck‘->
tÙ®
) {

237 
Ãw_tÙ®
 = 
buck‘
->
tÙ®
 + 
¡•s
;

238 
size_t
 
size
 = 
Ãw_tÙ®
 * (
hash_’Œy
);

239 
hash_’Œy
 *
tmp
 = 
	`»®loc
(
buck‘
->
’Œ›s
, 
size
);

240 ià(
tmp
 =ğ
NULL
)

241  -
”ºo
;

242 
buck‘
->
’Œ›s
 = 
tmp
;

243 
buck‘
->
tÙ®
 = 
Ãw_tÙ®
;

246 
’Œy
 = 
buck‘
->
’Œ›s
;

247 
’Œy_’d
 = 
’Œy
 + 
buck‘
->
u£d
;

248 ; 
’Œy
 < 
’Œy_’d
;ƒntry++) {

249 ià(
hashv®
 !ğ
’Œy
->hashval)

251 ià(
hash
->
	`key_com·»
(
key
, 
’Œy
->key) == 0)

252  -
EEXIST
;

255 
’Œy
->
key
 = key;

256 
’Œy
->
v®ue
 = value;

257 
’Œy
->
hashv®
 = hashval;

258 
buck‘
->
u£d
++;

259 
hash
->
couÁ
++;

261 
	}
}

263 
šlše
 
hash_’Œy
 *
	$hash_fšd_’Œy
(cÚ¡ 
hash
 *hash,

264 cÚ¡ *
key
,

265 
hashv®
)

267 
pos
 = 
hashv®
 & (
n_buck‘s
 - 1);

268 cÚ¡ 
hash_buck‘
 *
buck‘
 = 
hash
->
buck‘s
 + 
pos
;

269 
hash_’Œy
 *
’Œy
, *
’Œy_’d
;

271 
’Œy
 = 
buck‘
->
’Œ›s
;

272 
’Œy_’d
 = 
’Œy
 + 
buck‘
->
u£d
;

273 ; 
’Œy
 < 
’Œy_’d
;ƒntry++) {

274 ià(
hashv®
 !ğ
’Œy
->hashval)

276 ià(
hash
->
	`key_com·»
(
key
, 
’Œy
->key) == 0)

277  
’Œy
;

280  
NULL
;

281 
	}
}

283 *
	$hash_fšd
(cÚ¡ 
hash
 *hash, cÚ¡ *
key
)

285 cÚ¡ 
hash_’Œy
 *
’Œy
;

287 
’Œy
 = 
	`hash_fšd_’Œy
(
hash
, 
key
, hash->
	`hash_v®ue
(key));

288 ià(
’Œy
)

289  (*)
’Œy
->
v®ue
;

290  
NULL
;

291 
	}
}

293 
	$hash_d–
(
hash
 *hash, cÚ¡ *
key
)

295 
hashv®
 = 
hash
->
	`hash_v®ue
(
key
);

296 
pos
 = 
hashv®
 & (
n_buck‘s
 - 1);

297 
¡•s_u£d
, 
¡•s_tÙ®
;

298 
hash_buck‘
 *
buck‘
 = 
hash
->
buck‘s
 + 
pos
;

299 
hash_’Œy
 *
’Œy
, *
’Œy_’d
;

301 
’Œy
 = 
	`hash_fšd_’Œy
(
hash
, 
key
, 
hashv®
);

302 ià(
’Œy
 =ğ
NULL
)

303  -
ENOENT
;

305 ià(
hash
->
ä“_v®ue
)

306 
hash
->
	`ä“_v®ue
((*)
’Œy
->
v®ue
);

307 ià(
hash
->
ä“_key
)

308 
hash
->
	`ä“_key
((*)
’Œy
->
key
);

310 
’Œy_’d
 = 
buck‘
->
’Œ›s
 + buck‘->
u£d
;

311 
	`memmove
(
’Œy
,ƒntry + 1,

312 (
size_t
)(
’Œy_’d
 - 
’Œy
è* (
hash_’Œy
));

314 
buck‘
->
u£d
--;

315 
hash
->
couÁ
--;

317 
¡•s_u£d
 = 
buck‘
->
u£d
 / 
¡•s
;

318 
¡•s_tÙ®
 = 
buck‘
->
tÙ®
 / 
¡•s
;

319 ià(
¡•s_u£d
 + 1 < 
¡•s_tÙ®
) {

320 
size_t
 
size
 = (
¡•s_u£d
 + 1) *

321 
¡•s
 * (
hash_’Œy
);

322 
hash_’Œy
 *
tmp
 = 
	`»®loc
(
buck‘
->
’Œ›s
, 
size
);

323 ià(
tmp
) {

324 
buck‘
->
’Œ›s
 = 
tmp
;

325 
buck‘
->
tÙ®
 = (
¡•s_u£d
 + 1è* 
¡•s
;

330 
	}
}

332 
	$hash_g‘_couÁ
(cÚ¡ 
hash
 *hash)

334  
hash
->
couÁ
;

335 
	}
}

337 
	$hash_™”_š™
(cÚ¡ 
hash
 *hash, 
hash_™”
 *
™”
)

339 
™”
->
hash
 = hash;

340 
™”
->
buck‘
 = 0;

341 
™”
->
’Œy
 = -1;

342 
	}
}

344 
boŞ
 
	$hash_™”_Ãxt
(
hash_™”
 *
™”
, cÚ¡ **
key
,

345 cÚ¡ **
v®ue
)

347 cÚ¡ 
hash_buck‘
 *
b
 = 
™”
->
hash
->
buck‘s
 + i‹r->
buck‘
;

348 cÚ¡ 
hash_’Œy
 *
e
;

350 
™”
->
’Œy
++;

352 ià(()
™”
->
’Œy
 >ğ
b
->
u£d
) {

353 
™”
->
’Œy
 = 0;

355 
™”
->
buck‘
++; i‹r->buck‘ < 
n_buck‘s
;

356 
™”
->
buck‘
++) {

357 
b
 = 
™”
->
hash
->
buck‘s
 + i‹r->
buck‘
;

359 ià(
b
->
u£d
 > 0)

363 ià(
™”
->
buck‘
 >ğ
n_buck‘s
)

364  
çl£
;

367 
e
 = 
b
->
’Œ›s
 + 
™”
->
’Œy
;

369 ià(
v®ue
 !ğ
NULL
)

370 *
v®ue
 = 
e
->value;

371 ià(
key
 !ğ
NULL
)

372 *
key
 = 
e
->key;

374  
Œue
;

375 
	}
}

	@common/hash.h

1 #´agm¨
Úû


3 
	~<¡dboŞ.h
>

4 
	~<sys/ty³s.h
>

6 
	ghash
;

8 
	shash_™”
 {

9 cÚ¡ 
hash
 *
	mhash
;

10 
	mbuck‘
;

11 
	m’Œy
;

14 
hash
 *
hash_št_Ãw
((*
ä“_key
)(*
v®ue
),

15 (*
ä“_v®ue
)(*
v®ue
));

16 
hash
 *
	`hash_¡r_Ãw
((*
ä“_key
)(*
v®ue
),

17 (*
ä“_v®ue
)(*
v®ue
));

18 
	`hash_ä“
(
hash
 *hash);

19 
	`hash_add
(
hash
 *hash, cÚ¡ *
key
, cÚ¡ *
v®ue
);

20 
	`hash_add_unique
(
hash
 *hash, cÚ¡ *
key
, cÚ¡ *
v®ue
);

21 
	`hash_d–
(
hash
 *hash, cÚ¡ *
key
);

22 *
	`hash_fšd
(cÚ¡ 
hash
 *hash, cÚ¡ *
key
);

23 
	`hash_g‘_couÁ
(cÚ¡ 
hash
 *hash);

24 
	`hash_™”_š™
(cÚ¡ 
hash
 *hash, 
hash_™”
 *
™”
);

25 
boŞ
 
	`hash_™”_Ãxt
(
hash_™”
 *
™”
, cÚ¡ **
key
,

26 cÚ¡ **
v®ue
);

	@common/int-to-str.c

20 
	~<as£¹.h
>

21 
	~"št-to-¡r.h
"

23 
ALWAYS_INLINE
 *

24 
	$ušt_to_¡ršg
(
size_t
 
v®ue
,

25 
d¡
[
INT_TO_STR_BUFFER_SIZE
],

26 
size_t
 *
Ëngth_out
)

32 cÚ¡ 
size_t
 
Ëngth
 = 
INT_TO_STR_BUFFER_SIZE
;

33 
size_t
 
Ãxt
 = 
Ëngth
 - 1;

34 cÚ¡ 
dig™s
[201] =

40 
d¡
[
Ãxt
--] = '\0';

41 
v®ue
 >= 100) {

42 cÚ¡ 
ušt32_t
 
i
 = (ušt32_t)((
v®ue
 % 100) * 2);

43 
v®ue
 /= 100;

44 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

45 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

46 
Ãxt
 -= 2;

49 ià(
v®ue
 < 10) {

50 
d¡
[
Ãxt
] = ()('0' + (
ušt32_t
)
v®ue
);

51 *
Ëngth_out
 = 
Ëngth
 - 
Ãxt
 - 1;

52  
d¡
 + 
Ãxt
;

54 
ušt32_t
 
i
 = (ušt32_t)
v®ue
 * 2;

55 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

56 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

57 *
Ëngth_out
 = 
Ëngth
 - 
Ãxt
;

58  
d¡
 + 
Ãxt
 - 1;

59 
	}
}

61 
ALWAYS_INLINE
 *

62 
	$št_to_¡ršg
(
ssize_t
 
v®ue
,

63 
d¡
[
INT_TO_STR_BUFFER_SIZE
],

64 
size_t
 *
Ëngth_out
)

66 ià(
v®ue
 < 0) {

67 *
p
 = 
	`ušt_to_¡ršg
((
size_t
è-
v®ue
, 
d¡
, 
Ëngth_out
);

68 *--
p
 = '-';

69 ++*
Ëngth_out
;

71  
p
;

74  
	`ušt_to_¡ršg
((
size_t
è
v®ue
, 
d¡
, 
Ëngth_out
);

75 
	}
}

	@common/int-to-str.h

19 #iâdeà
__INT_TO_STR_H__


20 
	#__INT_TO_STR_H__


	)

22 
	~"lwª.h
"

24 
	#INT_TO_STR_BUFFER_SIZE
 (3 * (
size_t
è+ 1)

	)

26 *
št_to_¡ršg
(
ssize_t
 
v®ue
,

27 
bufãr
[
INT_TO_STR_BUFFER_SIZE
],

28 
size_t
 *
Ën
);

29 *
ušt_to_¡ršg
(
size_t
 
v®ue
,

30 
bufãr
[
INT_TO_STR_BUFFER_SIZE
],

31 
size_t
 *
Ën
);

	@common/list.c

30 
	~<¡dio.h
>

31 
	~<¡dlib.h
>

32 
	~"li¡.h
"

34 *
	$cÜru±
(cÚ¡ *
abÜt¡r
,

35 cÚ¡ 
li¡_node
 *
h—d
,

36 cÚ¡ 
li¡_node
 *
node
,

37 
couÁ
)

39 ià(
abÜt¡r
) {

40 
	`årštf
(
¡d”r
,

42 
abÜt¡r
, 
node
, 
couÁ
, 
h—d
);

43 
	`abÜt
();

45  
NULL
;

46 
	}
}

48 
li¡_node
 *
	$li¡_check_node
(cÚ¡ 
li¡_node
 *
node
,

49 cÚ¡ *
abÜt¡r
)

51 cÚ¡ 
li¡_node
 *
p
, *
n
;

52 
couÁ
 = 0;

54 
p
 = 
node
, 
n
 =‚ode->
Ãxt
;‚ !=‚ode;… =‚,‚ =‚->next) {

55 
couÁ
++;

56 ià(
n
->
´ev
 !ğ
p
)

57  
	`cÜru±
(
abÜt¡r
, 
node
, 
n
, 
couÁ
);

60 ià(
node
->
´ev
 !ğ
p
)

61  
	`cÜru±
(
abÜt¡r
, 
node
,‚ode, 0);

63  (
li¡_node
 *)
node
;

64 
	}
}

66 
li¡_h—d
 *
	$li¡_check
(cÚ¡ 
li¡_h—d
 *
h
, cÚ¡ *
abÜt¡r
)

68 ià(!
	`li¡_check_node
(&
h
->
n
, 
abÜt¡r
))

69  
NULL
;

70  (
li¡_h—d
 *)
h
;

71 
	}
}

	@common/list.h

30 #iâdeà
_LIST_H


31 
	#_LIST_H


	)

32 
	~<¡dboŞ.h
>

33 
	~<¡ddef.h
>

34 
	~<as£¹.h
>

55 
	#check_ty³
(
ex´
, 
ty³
) \

56 ((
	`ty³of
(
ex´
è*)0 !ğ(
ty³
 *)0)

	)

81 
	#check_ty³s_m©ch
(
ex´1
, 
ex´2
) \

82 ((
	`ty³of
(
ex´1
è*)0 !ğÑy³of(
ex´2
è*)0)

	)

108 
	#cÚš”_of
(
memb”_±r
, 
cÚššg_ty³
, 
memb”
) \

109 ((
cÚššg_ty³
 *) \

110 ((*)(
memb”_±r
) \

111 - 
	`cÚš”_off
(
cÚššg_ty³
, 
memb”
)) \

112 + 
	`check_ty³s_m©ch
(*(
memb”_±r
), ((
cÚššg_ty³
 *)0)->
memb”
))

	)

130 #ià
HAVE_TYPEOF


131 
	#cÚš”_of_v¬
(
memb”_±r
, 
cÚš”_v¬
, 
memb”
) \

132 
	`cÚš”_of
(
memb”_±r
, 
	`ty³of
(*
cÚš”_v¬
), 
memb”
)

	)

134 
	#cÚš”_of_v¬
(
memb”_±r
, 
cÚš”_v¬
, 
memb”
) \

135 ((*)((*)(
memb”_±r
) - \

136 
	`cÚš”_off_v¬
(
cÚš”_v¬
, 
memb”
)))

	)

163 
	#cÚš”_off
(
cÚššg_ty³
, 
memb”
) \

164 
	`off£tof
(
cÚššg_ty³
, 
memb”
)

	)

176 
	#cÚš”_off_v¬
(
v¬
, 
memb”
) \

177 
	`cÚš”_off
(
	`ty³of
(*
v¬
), 
memb”
)

	)

192 
	sli¡_node


194 
li¡_node
 *
	mÃxt
, *
	m´ev
;

209 
	sli¡_h—d


211 
li¡_node
 
	mn
;

240 
li¡_h—d
 *
li¡_check
(cÚ¡ li¡_h—d *
h
, cÚ¡ *
abÜt¡r
);

258 
li¡_node
 *
li¡_check_node
(cÚ¡ li¡_nod*
n
,

259 cÚ¡ *
abÜt¡r
);

261 #ifdeà
_LIST_DEBUG


262 
	#li¡_debug
(
h
è
	`li¡_check
((h), 
__func__
)

	)

263 
	#li¡_debug_node
(
n
è
	`li¡_check_node
(Ò), 
__func__
)

	)

265 
	#li¡_debug
(
h
è(h)

	)

266 
	#li¡_debug_node
(
n
èÒ)

	)

281 
	#LIST_HEAD_INIT
(
Çme
è{ { &Çme.
n
, &Çme.À} }

	)

296 
	#LIST_HEAD
(
Çme
) \

297 
li¡_h—d
 
Çme
 = 
	`LIST_HEAD_INIT
Òame)

	)

310 
šlše
 
	$li¡_h—d_š™
(
li¡_h—d
 *
h
)

312 
h
->
n
.
Ãxt
 = h->n.
´ev
 = &h->n;

313 
	}
}

328 
šlše
 
	$li¡_add
(
li¡_h—d
 *
h
, 
li¡_node
 *
n
)

330 
n
->
Ãxt
 = 
h
->n.next;

331 
n
->
´ev
 = &
h
->n;

332 
h
->
n
.
Ãxt
->
´ev
 =‚;

333 
h
->
n
.
Ãxt
 =‚;

334 ()
	`li¡_debug
(
h
);

335 
	}
}

347 
šlše
 
	$li¡_add_
(
li¡_h—d
 *
h
, 
li¡_node
 *
n
)

349 
n
->
Ãxt
 = &
h
->n;

350 
n
->
´ev
 = 
h
->n.prev;

351 
h
->
n
.
´ev
->
Ãxt
 =‚;

352 
h
->
n
.
´ev
 =‚;

353 ()
	`li¡_debug
(
h
);

354 
	}
}

365 
šlše
 
boŞ
 
	$li¡_em±y
(cÚ¡ 
li¡_h—d
 *
h
)

367 ()
	`li¡_debug
(
h
);

368  
h
->
n
.
Ãxt
 == &h->n;

369 
	}
}

385 
šlše
 
	$li¡_d–
(
li¡_node
 *
n
)

387 ()
	`li¡_debug_node
(
n
);

388 
n
->
Ãxt
->
´ev
 =‚->prev;

389 
n
->
´ev
->
Ãxt
 =‚->next;

390 #ifdeà
_LIST_DEBUG


392 
n
->
Ãxt
 =‚->
´ev
 = 
NULL
;

394 
	}
}

410 
šlše
 
	$li¡_d–_äom
(
li¡_h—d
 *
h
, 
li¡_node
 *
n
)

412 #ifdeà
_LIST_DEBUG


415 
li¡_node
 *
i
;

416 
i
 = 
h
->
n
.
Ãxt
; i !=‚; i = i->next)

417 
	`as£¹
(
i
 !ğ&
h
->
n
);

420 ()
h
;

424 
	`as£¹
(!
	`li¡_em±y
(
h
));

425 
	`li¡_d–
(
n
);

426 
	}
}

441 
	#li¡_’Œy
(
n
, 
ty³
, 
memb”
è
	`cÚš”_of
Ò,y³, memb”)

	)

457 
	#li¡_tİ
(
h
, 
ty³
, 
memb”
) \

458 ((
ty³
 *)
	`li¡_tİ_
((
h
), 
	`li¡_off_
Ñy³, 
memb”
)))

	)

460 
šlše
 cÚ¡ *
	$li¡_tİ_
(cÚ¡ 
li¡_h—d
 *
h
, 
size_t
 
off
)

462 ià(
	`li¡_em±y
(
h
))

463  
NULL
;

464  (cÚ¡ *)
h
->
n
.
Ãxt
 - 
off
;

465 
	}
}

481 
	#li¡_pİ
(
h
, 
ty³
, 
memb”
) \

482 ((
ty³
 *)
	`li¡_pİ_
((
h
), 
	`li¡_off_
Ñy³, 
memb”
)))

	)

484 
šlše
 cÚ¡ *
	$li¡_pİ_
(cÚ¡ 
li¡_h—d
 *
h
, 
size_t
 
off
)

486 
li¡_node
 *
n
;

488 ià(
	`li¡_em±y
(
h
))

489  
NULL
;

490 
n
 = 
h
->n.
Ãxt
;

491 
	`li¡_d–
(
n
);

492  (cÚ¡ *)
n
 - 
off
;

493 
	}
}

509 
	#li¡_
(
h
, 
ty³
, 
memb”
) \

510 ((
ty³
 *)
	`li¡__
((
h
), 
	`li¡_off_
Ñy³, 
memb”
)))

	)

512 
šlše
 cÚ¡ *
	$li¡__
(cÚ¡ 
li¡_h—d
 *
h
, 
size_t
 
off
)

514 ià(
	`li¡_em±y
(
h
))

515  
NULL
;

516  (cÚ¡ *)
h
->
n
.
´ev
 - 
off
;

517 
	}
}

532 
	#li¡_fÜ_—ch
(
h
, 
i
, 
memb”
) \

533 
	`li¡_fÜ_—ch_off
(
h
, 
i
, 
	`li¡_off_v¬_
(i, 
memb”
))

	)

548 
	#li¡_fÜ_—ch_»v
(
h
, 
i
, 
memb”
) \

549 
i
 = 
	`cÚš”_of_v¬
(
	`li¡_debug
(
h
)->
n
.
´ev
, i, 
memb”
); \

550 &
i
->
memb”
 !ğ&(
h
)->
n
; \

551 
i
 = 
	`cÚš”_of_v¬
(i->
memb”
.
´ev
, i, memb”))

	)

571 
	#li¡_fÜ_—ch_§ã
(
h
, 
i
, 
nxt
, 
memb”
) \

572 
	`li¡_fÜ_—ch_§ã_off
(
h
, 
i
, 
nxt
, 
	`li¡_off_v¬_
(i, 
memb”
))

	)

589 
šlše
 
	$li¡_­³nd_li¡
(
li¡_h—d
 *
to
,

590 
li¡_h—d
 *
äom
)

592 
li¡_node
 *
äom_
 = 
	`li¡_debug
(
äom
)->
n
.
´ev
;

593 
li¡_node
 *
to_
 = 
	`li¡_debug
(
to
)->
n
.
´ev
;

596 
to
->
n
.
´ev
 = 
äom_
;

597 
äom_
->
Ãxt
 = &
to
->
n
;

598 
to_
->
Ãxt
 = &
äom
->
n
;

599 
äom
->
n
.
´ev
 = 
to_
;

602 
	`li¡_d–
(&
äom
->
n
);

603 
	`li¡_h—d_š™
(
äom
);

604 
	}
}

619 
šlše
 
	$li¡_´•’d_li¡
(
li¡_h—d
 *
to
,

620 
li¡_h—d
 *
äom
)

622 
li¡_node
 *
äom_
 = 
	`li¡_debug
(
äom
)->
n
.
´ev
;

623 
li¡_node
 *
to_h—d
 = 
	`li¡_debug
(
to
)->
n
.
Ãxt
;

626 
to
->
n
.
Ãxt
 = &
äom
->n;

627 
äom
->
n
.
´ev
 = &
to
->n;

628 
to_h—d
->
´ev
 = 
äom_
;

629 
äom_
->
Ãxt
 = 
to_h—d
;

632 
	`li¡_d–
(&
äom
->
n
);

633 
	`li¡_h—d_š™
(
äom
);

634 
	}
}

665 
	#li¡_fÜ_—ch_off
(
h
, 
i
, 
off
) \

666 
i
 = 
	`li¡_node_to_off_
(
	`li¡_debug
(
h
)->
n
.
Ãxt
, (
off
)); \

667 
	`li¡_node_äom_off_
((*)
i
, (
off
)è!ğ&(
h
)->
n
; \

668 
i
 = 
	`li¡_node_to_off_
(
	`li¡_node_äom_off_
((*)i, (
off
))->
Ãxt
, \

669 (
off
)))

	)

687 
	#li¡_fÜ_—ch_§ã_off
(
h
, 
i
, 
nxt
, 
off
) \

688 
i
 = 
	`li¡_node_to_off_
(
	`li¡_debug
(
h
)->
n
.
Ãxt
, (
off
)), \

689 
nxt
 = 
	`li¡_node_to_off_
(
	`li¡_node_äom_off_
(
i
, (
off
))->
Ãxt
, \

690 (
off
)); \

691 
	`li¡_node_äom_off_
(
i
, (
off
)è!ğ&(
h
)->
n
; \

692 
i
 = 
nxt
, \

693 
nxt
 = 
	`li¡_node_to_off_
(
	`li¡_node_äom_off_
(
i
, (
off
))->
Ãxt
, \

694 (
off
)))

	)

698 
	#li¡_’Œy_off
(
n
, 
ty³
, 
off
) \

699 ((
ty³
 *)
	`li¡_node_äom_off_
((
n
), (
off
)))

	)

701 
	#li¡_h—d_off
(
h
, 
ty³
, 
off
) \

702 ((
ty³
 *)
	`li¡_h—d_off
((
h
), (
off
)))

	)

704 
	#li¡__off
(
h
, 
ty³
, 
off
) \

705 ((
ty³
 *)
	`li¡__
((
h
), (
off
)))

	)

707 
	#li¡_add_off
(
h
, 
n
, 
off
) \

708 
	`li¡_add
((
h
), 
	`li¡_node_äom_off_
((
n
), (
off
)))

	)

710 
	#li¡_d–_off
(
n
, 
off
) \

711 
	`li¡_d–
(
	`li¡_node_äom_off_
((
n
), (
off
)))

	)

713 
	#li¡_d–_äom_off
(
h
, 
n
, 
off
) \

714 
	`li¡_d–_äom
(
h
, 
	`li¡_node_äom_off_
((
n
), (
off
)))

	)

717 
šlše
 *
	$li¡_node_to_off_
(
li¡_node
 *
node
, 
size_t
 
off
)

719  (*)((*)
node
 - 
off
);

720 
	}
}

721 
šlše
 
li¡_node
 *
	$li¡_node_äom_off_
(*
±r
, 
size_t
 
off
)

723  (
li¡_node
 *)((*)
±r
 + 
off
);

724 
	}
}

727 
	#li¡_off_
(
ty³
, 
memb”
) \

728 (
	`cÚš”_off
(
ty³
, 
memb”
) + \

729 
	`check_ty³
(((
ty³
 *)0)->
memb”
, 
li¡_node
))

	)

731 
	#li¡_off_v¬_
(
v¬
, 
memb”
) \

732 (
	`cÚš”_off_v¬
(
v¬
, 
memb”
) + \

733 
	`check_ty³
(
v¬
->
memb”
, 
li¡_node
))

	)

	@common/lwan-cache.c

20 
	~<as£¹.h
>

21 
	~<”ºo.h
>

22 
	~<±h»ad.h
>

23 
	~<¡dboŞ.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

26 
	~<time.h
>

28 
	~"lwª.h
"

29 
	~"lwª-´iv©e.h
"

30 
	~"lwª-ÿche.h
"

31 
	~"hash.h
"

33 
	#GET_AND_REF_TRIES
 5

	)

37 
	mFLOATING
 = 1 << 0,

38 
	mTEMPORARY
 = 1 << 1,

41 
	mSHUTTING_DOWN
 = 1 << 0

44 
	sÿche_t
 {

46 
hash
 *
	mbË
;

47 
±h»ad_rwlock_t
 
	mlock
;

48 } 
	mhash
;

51 
li¡_h—d
 
	mli¡
;

52 
±h»ad_rwlock_t
 
	mlock
;

53 } 
	mqueue
;

56 
C»©eEÁryC®lback
 
	mü—‹_’Œy
;

57 
De¡royEÁryC®lback
 
	mde¡roy_’Œy
;

58 *
	mcÚ‹xt
;

59 } 
	mcb
;

62 
time_t
 
	mtime_to_live
;

63 
şockid_t
 
	mşock_id
;

64 } 
	m£‰šgs
;

66 
	mæags
;

68 #iâdeà
NDEBUG


70 
	mh™s
;

71 
	mmis£s
;

72 
	meviùed
;

73 } 
	m¡©s
;

77 
boŞ
 
ÿche_´uÃr_job
(*
d©a
);

79 
şockid_t
 
	$d‘eù_ç¡e¡_mÚÙÚic_şock
()

81 #ifdeà
CLOCK_MONOTONIC_COARSE


82 
time¥ec
 
ts
;

84 ià(!
	`şock_g‘time
(
CLOCK_MONOTONIC_COARSE
, &
ts
))

85  
CLOCK_MONOTONIC_COARSE
;

87  
CLOCK_MONOTONIC
;

88 
	}
}

90 
ALWAYS_INLINE
 
	$şock_mÚÙÚic_g‘time
(
ÿche_t
 *
ÿche
,

91 
time¥ec
 *
ts
)

93 ià(
	`UNLIKELY
(
	`şock_g‘time
(
ÿche
->
£‰šgs
.
şock_id
, 
ts
) < 0))

94 
	`lwª_¡©us_³¼Ü
("clock_gettime");

95 
	}
}

97 
ÿche_t
 *
	$ÿche_ü—‹
(
C»©eEÁryC®lback
 
ü—‹_’Œy_cb
,

98 
De¡royEÁryC®lback
 
de¡roy_’Œy_cb
,

99 *
cb_cÚ‹xt
,

100 
time_t
 
time_to_live
)

102 
ÿche_t
 *
ÿche
;

104 
	`as£¹
(
ü—‹_’Œy_cb
);

105 
	`as£¹
(
de¡roy_’Œy_cb
);

106 
	`as£¹
(
time_to_live
 > 0);

108 
ÿche
 = 
	`ÿÎoc
(1, (*cache));

109 ià(!
ÿche
)

110  
NULL
;

112 
ÿche
->
hash
.
bË
 = 
	`hash_¡r_Ãw
(
ä“
, 
NULL
);

113 ià(!
ÿche
->
hash
.
bË
)

114 
”rÜ_no_hash
;

116 ià(
	`±h»ad_rwlock_š™
(&
ÿche
->
hash
.
lock
, 
NULL
))

117 
”rÜ_no_hash_lock
;

118 ià(
	`±h»ad_rwlock_š™
(&
ÿche
->
queue
.
lock
, 
NULL
))

119 
”rÜ_no_queue_lock
;

121 
ÿche
->
cb
.
ü—‹_’Œy
 = 
ü—‹_’Œy_cb
;

122 
ÿche
->
cb
.
de¡roy_’Œy
 = 
de¡roy_’Œy_cb
;

123 
ÿche
->
cb
.
cÚ‹xt
 = 
cb_cÚ‹xt
;

125 
ÿche
->
£‰šgs
.
şock_id
 = 
	`d‘eù_ç¡e¡_mÚÙÚic_şock
();

126 
ÿche
->
£‰šgs
.
time_to_live
 =ime_to_live;

128 
	`li¡_h—d_š™
(&
ÿche
->
queue
.
li¡
);

130 
	`lwª_job_add
(
ÿche_´uÃr_job
, 
ÿche
);

132  
ÿche
;

134 
”rÜ_no_queue_lock
:

135 
	`±h»ad_rwlock_de¡roy
(&
ÿche
->
hash
.
lock
);

136 
”rÜ_no_hash_lock
:

137 
	`hash_ä“
(
ÿche
->
hash
.
bË
);

138 
”rÜ_no_hash
:

139 
	`ä“
(
ÿche
);

141  
NULL
;

142 
	}
}

144 
	$ÿche_de¡roy
(
ÿche_t
 *
ÿche
)

146 
	`as£¹
(
ÿche
);

148 #iâdeà
NDEBUG


149 
	`lwª_¡©us_debug
("Cache stats: %d hits, %d misses, %dƒvictions",

150 
ÿche
->
¡©s
.
h™s
, cache->¡©s.
mis£s
,

151 
ÿche
->
¡©s
.
eviùed
);

154 
	`lwª_job_d–
(
ÿche_´uÃr_job
, 
ÿche
);

155 
ÿche
->
æags
 |ğ
SHUTTING_DOWN
;

156 
	`ÿche_´uÃr_job
(
ÿche
);

157 
	`±h»ad_rwlock_de¡roy
(&
ÿche
->
hash
.
lock
);

158 
	`±h»ad_rwlock_de¡roy
(&
ÿche
->
queue
.
lock
);

159 
	`hash_ä“
(
ÿche
->
hash
.
bË
);

160 
	`ä“
(
ÿche
);

161 
	}
}

163 
ALWAYS_INLINE
 
ÿche_’Œy_t
 *
	$cÚv”t_to_‹mpÜ¬y
(

164 
ÿche_’Œy_t
 *
’Œy
)

166 
’Œy
->
æags
 = 
TEMPORARY
;

167  
’Œy
;

168 
	}
}

170 
ÿche_’Œy_t
 *
	$ÿche_g‘_ªd_»f_’Œy
(
ÿche_t
 *
ÿche
,

171 cÚ¡ *
key
, *
”rÜ
)

173 
ÿche_’Œy_t
 *
’Œy
;

175 
	`as£¹
(
ÿche
);

176 
	`as£¹
(
”rÜ
);

177 
	`as£¹
(
key
);

179 *
”rÜ
 = 0;

184 ià(
	`UNLIKELY
(
	`±h»ad_rwlock_Œyrdlock
(&
ÿche
->
hash
.
lock
è=ğ
EBUSY
)) {

185 *
”rÜ
 = 
EWOULDBLOCK
;

186  
NULL
;

190 
’Œy
 = 
	`hash_fšd
(
ÿche
->
hash
.
bË
, 
key
);

191 ià(
	`LIKELY
(
’Œy
)) {

192 
	`ATOMIC_INC
(
’Œy
->
»fs
);

193 
	`±h»ad_rwlock_uÆock
(&
ÿche
->
hash
.
lock
);

194 #iâdeà
NDEBUG


195 
	`ATOMIC_INC
(
ÿche
->
¡©s
.
h™s
);

197  
’Œy
;

201 
	`±h»ad_rwlock_uÆock
(&
ÿche
->
hash
.
lock
);

203 #iâdeà
NDEBUG


204 
	`ATOMIC_INC
(
ÿche
->
¡©s
.
mis£s
);

207 
’Œy
 = 
ÿche
->
cb
.
	`ü—‹_’Œy
(
key
, cache->cb.
cÚ‹xt
);

208 ià(!
’Œy
)

209  
NULL
;

211 
	`mem£t
(
’Œy
, 0, (*entry));

212 
’Œy
->
key
 = 
	`¡rdup
(key);

213 
’Œy
->
»fs
 = 1;

215 ià(
	`±h»ad_rwlock_Œyw¾ock
(&
ÿche
->
hash
.
lock
è=ğ
EBUSY
) {

221  
	`cÚv”t_to_‹mpÜ¬y
(
’Œy
);

224 ià(!
	`hash_add_unique
(
ÿche
->
hash
.
bË
, 
’Œy
->
key
,ƒntry)) {

225 
	`şock_mÚÙÚic_g‘time
(
ÿche
, &
’Œy
->
time_to_d›
);

227 
’Œy
->
time_to_d›
.
tv_£c
 +ğ
ÿche
->
£‰šgs
.
time_to_live
;

229 
	`±h»ad_rwlock_w¾ock
(&
ÿche
->
queue
.
lock
);

230 
	`li¡_add_
(&
ÿche
->
queue
.
li¡
, &
’Œy
->
’Œ›s
);

231 
	`±h»ad_rwlock_uÆock
(&
ÿche
->
queue
.
lock
);

239 
	`cÚv”t_to_‹mpÜ¬y
(
’Œy
);

242 
	`±h»ad_rwlock_uÆock
(&
ÿche
->
hash
.
lock
);

243  
’Œy
;

244 
	}
}

246 
	$ÿche_’Œy_uÄef
(
ÿche_t
 *
ÿche
, 
ÿche_’Œy_t
 *
’Œy
)

248 
	`as£¹
(
’Œy
);

250 ià(
’Œy
->
æags
 & 
TEMPORARY
) {

251 
	`ä“
(
’Œy
->
key
);

252 
de¡roy_’Œy
;

255 ià(
	`ATOMIC_DEC
(
’Œy
->
»fs
))

260 ià(
’Œy
->
æags
 & 
FLOATING
) {

261 
de¡roy_’Œy
:

265 
ÿche
->
cb
.
	`de¡roy_’Œy
(
’Œy
, cache->cb.
cÚ‹xt
);

267 
	}
}

269 
boŞ
 
	$ÿche_´uÃr_job
(*
d©a
)

271 
ÿche_t
 *
ÿche
 = 
d©a
;

272 
ÿche_’Œy_t
 *
node
, *
Ãxt
;

273 
time¥ec
 
now
;

274 
boŞ
 
shu‰šg_down
 = 
ÿche
->
æags
 & 
SHUTTING_DOWN
;

275 
eviùed
 = 0;

276 
li¡_h—d
 
queue
;

278 ià(
	`UNLIKELY
(
	`±h»ad_rwlock_Œyw¾ock
(&
ÿche
->
queue
.
lock
è=ğ
EBUSY
))

279  
çl£
;

282 ià(
	`li¡_em±y
(&
ÿche
->
queue
.
li¡
)) {

283 ià(
	`UNLIKELY
(
	`±h»ad_rwlock_uÆock
(&
ÿche
->
queue
.
lock
) < 0))

284 
	`lwª_¡©us_³¼Ü
("pthread_rwlock_unlock");

285  
çl£
;

290 
	`li¡_h—d_š™
(&
queue
);

291 
	`li¡_­³nd_li¡
(&
queue
, &
ÿche
->queue.
li¡
);

292 
	`li¡_h—d_š™
(&
ÿche
->
queue
.
li¡
);

294 ià(
	`UNLIKELY
(
	`±h»ad_rwlock_uÆock
(&
ÿche
->
queue
.
lock
) < 0)) {

295 
	`lwª_¡©us_³¼Ü
("pthread_rwlock_unlock");

296 
’d
;

299 
	`şock_mÚÙÚic_g‘time
(
ÿche
, &
now
);

300 
	`li¡_fÜ_—ch_§ã
(&
queue
, 
node
, 
Ãxt
, 
’Œ›s
)

302 *
key
 = 
node
->key;

304 ià(
now
.
tv_£c
 < 
node
->
time_to_d›
.tv_£ø&& 
	`LIKELY
(!
shu‰šg_down
))

307 
	`li¡_d–
(&
node
->
’Œ›s
);

309 ià(
	`UNLIKELY
(
	`±h»ad_rwlock_w¾ock
(&
ÿche
->
hash
.
lock
) < 0)) {

310 
	`lwª_¡©us_³¼Ü
("pthread_rwlock_wrlock");

314 
	`hash_d–
(
ÿche
->
hash
.
bË
, 
key
);

316 ià(
	`UNLIKELY
(
	`±h»ad_rwlock_uÆock
(&
ÿche
->
hash
.
lock
) < 0))

317 
	`lwª_¡©us_³¼Ü
("pthread_rwlock_unlock");

319 ià(
	`ATOMIC_INC
(
node
->
»fs
) == 1) {

320 
ÿche
->
cb
.
	`de¡roy_’Œy
(
node
, cache->cb.
cÚ‹xt
);

322 
	`ATOMIC_BITWISE
(&
node
->
æags
, 
Ü
, 
FLOATING
);

325 ià(!
	`ATOMIC_DEC
(
node
->
»fs
))

326 
ÿche
->
cb
.
	`de¡roy_’Œy
(
node
, cache->cb.
cÚ‹xt
);

329 
eviùed
++;

335 ià(
	`li¡_em±y
(&
queue
))

336 
’d
;

340 ià(
	`±h»ad_rwlock_Œyw¾ock
(&
ÿche
->
queue
.
lock
) >= 0) {

341 
	`li¡_´•’d_li¡
(&
ÿche
->
queue
.
li¡
, &queue);

343 ià(
	`±h»ad_rwlock_uÆock
(&
ÿche
->
queue
.
lock
) < 0)

344 
	`lwª_¡©us_³¼Ü
("pthread_rwlock_unlock");

346 
	`lwª_¡©us_³¼Ü
("pthread_rwlock_trywrlock");

349 
’d
:

350 #iâdeà
NDEBUG


351 
	`ATOMIC_AAF
(&
ÿche
->
¡©s
.
eviùed
,ƒvicted);

353  
eviùed
;

354 
	}
}

356 
ÿche_’Œy_t
*

357 
	$ÿche_cÜo_g‘_ªd_»f_’Œy
(
ÿche_t
 *
ÿche
, 
cÜo_t
 *
cÜo
,

358 cÚ¡ *
key
)

360 
Œ›s
 = 
GET_AND_REF_TRIES
;ries;ries--) {

361 
”rÜ
;

362 
ÿche_’Œy_t
 *
û
 = 
	`ÿche_g‘_ªd_»f_’Œy
(
ÿche
, 
key
, &
”rÜ
);

364 ià(
	`LIKELY
(
û
)) {

370 
	`cÜo_deãr2
(
cÜo
, 
	`CORO_DEFER2
(
ÿche_’Œy_uÄef
), 
ÿche
, 
û
);

371  
û
;

378 ià(
”rÜ
 =ğ
EWOULDBLOCK
) {

379 
	`cÜo_y›ld
(
cÜo
, 
CONN_CORO_MAY_RESUME
);

385  
NULL
;

386 
	}
}

	@common/lwan-cache.h

20 #iâdeà
LWAN_CACHE_H


21 
	#LWAN_CACHE_H


	)

23 
	~<time.h
>

25 
	~"li¡.h
"

26 
	~"lwª-cÜo.h
"

28 
	sÿche_’Œy_t
 {

29 
li¡_node
 
	m’Œ›s
;

30 *
	mkey
;

31 
	m»fs
;

32 
	mæags
;

33 
time¥ec
 
	mtime_to_d›
;

36 
	gÿche_’Œy_t
 *(*
	tC»©eEÁryC®lback
)(

37 cÚ¡ *
	tkey
, *
	tcÚ‹xt
);

38 (*
	tDe¡royEÁryC®lback
)(

39 
	tÿche_’Œy_t
 *
	t’Œy
, *
	tcÚ‹xt
);

41 
ÿche_t
;

43 
ÿche_t
 *
	`ÿche_ü—‹
(
C»©eEÁryC®lback
 
ü—‹_’Œy_cb
,

44 
De¡royEÁryC®lback
 
de¡roy_’Œy_cb
,

45 *
cb_cÚ‹xt
,

46 
time_t
 
time_to_live
);

47 
	`ÿche_de¡roy
(
ÿche_t
 *
ÿche
);

49 
ÿche_’Œy_t
 *
	`ÿche_g‘_ªd_»f_’Œy
(
ÿche_t
 *
ÿche
,

50 cÚ¡ *
key
, *
”rÜ
);

51 
	`ÿche_’Œy_uÄef
(
ÿche_t
 *
ÿche
, 
ÿche_’Œy_t
 *
’Œy
);

52 
ÿche_’Œy_t
 *
	`ÿche_cÜo_g‘_ªd_»f_’Œy
(
ÿche_t
 *
ÿche
,

53 
cÜo_t
 *
cÜo
, cÚ¡ *
key
);

	@common/lwan-config.c

20 
	#_GNU_SOURCE


	)

21 
	~<ùy³.h
>

22 
	~<”ºo.h
>

23 
	~<lim™s.h
>

24 
	~<¡d¬g.h
>

25 
	~<¡dboŞ.h
>

26 
	~<¡dio.h
>

27 
	~<¡dlib.h
>

28 
	~<¡ršg.h
>

30 
	~"lwª-cÚfig.h
"

31 
	~"lwª-¡©us.h
"

32 
	~"hash.h
"

34 
	$·r£_time_³riod
(cÚ¡ *
¡r
, 
deçuÉ_v®ue
)

36 
tÙ®
 = 0;

37 
³riod
;

38 
muÉl›r
;

40 ià(!
¡r
)

41  
deçuÉ_v®ue
;

43 *
¡r
 && 
	`ssÿnf
(¡r, "%u%c", &
³riod
, &
muÉl›r
) == 2) {

44 
muÉl›r
) {

45 's': 
tÙ®
 +ğ
³riod
; ;

46 'm': 
tÙ®
 +ğ
³riod
 * 
ONE_MINUTE
; ;

47 'h': 
tÙ®
 +ğ
³riod
 * 
ONE_HOUR
; ;

48 'd': 
tÙ®
 +ğ
³riod
 * 
ONE_DAY
; ;

49 'w': 
tÙ®
 +ğ
³riod
 * 
ONE_WEEK
; ;

50 'M': 
tÙ®
 +ğ
³riod
 * 
ONE_MONTH
; ;

51 'y': 
tÙ®
 +ğ
³riod
 * 
ONE_YEAR
; ;

53 
	`lwª_¡©us_w¬nšg
("Ignoring unknown multiplier: %c",

54 
muÉl›r
);

57 
¡r
 = (cÚ¡ *)
	`¿wmemchr
(¡r, 
muÉl›r
) + 1;

60  
tÙ®
 ?Ù® : 
deçuÉ_v®ue
;

61 
	}
}

63 
boŞ
 
	$·r£_boŞ
(cÚ¡ *
v®ue
, 
boŞ
 
deçuÉ_v®ue
)

65 ià(!
	`¡rcmp
(
v®ue
, "true") || !strcmp(value, "1")

66 || !
	`¡rcmp
(
v®ue
, "on") || !strcmp(value, "yes"))

67  
Œue
;

69 ià(!
	`¡rcmp
(
v®ue
, "false") || !strcmp(value, "0")

70 || !
	`¡rcmp
(
v®ue
, "off") || !strcmp(value, "no"))

71  
çl£
;

73  
deçuÉ_v®ue
;

74 
	}
}

76 
	$·r£_lÚg
(cÚ¡ *
v®ue
, 
deçuÉ_v®ue
)

78 *
’d±r
;

79 
·r£d
;

81 
”ºo
 = 0;

82 
·r£d
 = 
	`¡¹Ş
(
v®ue
, &
’d±r
, 0);

84 ià(
”ºo
 != 0)

85  
deçuÉ_v®ue
;

87 ià(*
’d±r
 !ğ'\0' || 
v®ue
 ==ƒndptr)

88  
deçuÉ_v®ue
;

90  
·r£d
;

91 
	}
}

93 
boŞ
 
	$cÚfig_”rÜ
(
cÚfig_t
 *
cÚf
, cÚ¡ *
fmt
, ...)

95 
va_li¡
 
v®ues
;

96 
Ën
;

97 *
ouut
;

99 ià(
cÚf
->
”rÜ_mes§ge
)

100  
çl£
;

102 
	`va_¡¬t
(
v®ues
, 
fmt
);

103 
Ën
 = 
	`va¥rštf
(&
ouut
, 
fmt
, 
v®ues
);

104 
	`va_’d
(
v®ues
);

106 ià(
Ën
 >= 0) {

107 
cÚf
->
”rÜ_mes§ge
 = 
ouut
;

108  
Œue
;

111 
cÚf
->
”rÜ_mes§ge
 = 
NULL
;

112  
çl£
;

113 
	}
}

115 *
	$»move_comm’ts
(*
lše
)

117 *
tmp
 = 
	`¡¼chr
(
lše
, '#');

118 ià(
tmp
)

119 *
tmp
 = '\0';

120  
lše
;

121 
	}
}

123 *
	$»move_Œašg_¥aûs
(*
lše
)

125 *
’d
 = 
	`¿wmemchr
(
lše
, '\0');

127 
’d
--; 
	`is¥aû
(*end);ƒnd--);

128 *(
’d
 + 1) = '\0';

130  
lše
;

131 
	}
}

133 *
	$»move_Ëadšg_¥aûs
(*
lše
)

135 
	`is¥aû
(*
lše
))

136 
lše
++;

137  
lše
;

138 
	}
}

140 *
	$fšd_lše_’d
(*
lše
)

142 ià(*
lše
 == '\0')

143  
lše
;

144  (*)
	`¿wmemchr
(
lše
, '\0') - 1;

145 
	}
}

147 
boŞ
 
	$·r£_£ùiÚ
(*
lše
, 
cÚfig_lše_t
 *
l
)

149 *
Çme
, *
·¿m
;

150 *
b¿ck‘
 = 
	`¡¼chr
(
lše
, '{');

151 ià(!
b¿ck‘
)

152  
çl£
;

154 *
¥aû
 = 
	`¡rchr
(
lše
, ' ');

155 ià(!
¥aû
)

156  
çl£
;

158 *
b¿ck‘
 = '\0';

159 *
¥aû
 = '\0';

160 
Çme
 = 
	`»move_Œašg_¥aûs
(
	`»move_Ëadšg_¥aûs
(
lše
));

161 
·¿m
 = 
	`»move_Œašg_¥aûs
(
	`»move_Ëadšg_¥aûs
(
¥aû
 + 1));

163 
l
->
£ùiÚ
.
Çme
 =‚ame;

164 
l
->
£ùiÚ
.
·¿m
 =…aram;

165 
l
->
ty³
 = 
CONFIG_LINE_TYPE_SECTION
;

167  
Œue
;

168 
	}
}

170 
boŞ
 
	$·r£_lše
(*
lše
, 
cÚfig_lše_t
 *
l
, *
equ®
)

172 *
equ®
 = '\0';

173 
l
->
lše
.
key
 = 
	`»move_Œašg_¥aûs
(
	`»move_Ëadšg_¥aûs
(line));

174 
l
->
lše
.
v®ue
 = 
	`»move_Ëadšg_¥aûs
(
equ®
 + 1);

175 
l
->
ty³
 = 
CONFIG_LINE_TYPE_LINE
;

177  
Œue
;

178 
	}
}

180 
boŞ
 
	$cÚfig_»ad_lše
(
cÚfig_t
 *
cÚf
, 
cÚfig_lše_t
 *
l
)

182 *
lše
, *
lše_’d
;

184 ià(
cÚf
->
”rÜ_mes§ge
)

185  
çl£
;

187 
»Œy
:

188 ià(!
	`fg‘s
(
l
->
bufãr
, Ö->bufãr), 
cÚf
->
fe
))

189  
çl£
;

191 
cÚf
->
lše
++;

193 
lše
 = 
	`»move_comm’ts
(
l
->
bufãr
);

194 
lše
 = 
	`»move_Ëadšg_¥aûs
(line);

195 
lše
 = 
	`»move_Œašg_¥aûs
(line);

196 
lše_’d
 = 
	`fšd_lše_’d
(
lše
);

198 ià(*
lše_’d
 == '{') {

199 ià(!
	`·r£_£ùiÚ
(
lše
, 
l
)) {

200 
	`cÚfig_”rÜ
(
cÚf
, "Malformed section opening");

201  
çl£
;

203 } ià(*
lše
 == '\0') {

204 
»Œy
;

205 } ià(*
lše
 =ğ'}' &&†š=ğ
lše_’d
) {

206 
l
->
ty³
 = 
CONFIG_LINE_TYPE_SECTION_END
;

208 *
equ®
 = 
	`¡rchr
(
lše
, '=');

209 ià(
equ®
) {

210 ià(!
	`·r£_lše
(
lše
, 
l
, 
equ®
)) {

211 
	`cÚfig_”rÜ
(
cÚf
, "Malformed key=value†ine");

212  
çl£
;

215 
	`cÚfig_”rÜ
(
cÚf
, "Expecting section or key=value");

216  
çl£
;

220  
Œue
;

221 
	}
}

223 
boŞ
 
	$cÚfig_İ’
(
cÚfig_t
 *
cÚf
, cÚ¡ *
·th
)

225 ià(!
cÚf
)

226  
çl£
;

227 ià(!
·th
)

228  
çl£
;

229 
cÚf
->
fe
 = 
	`fİ’
(
·th
, "r");

230 ià(!
cÚf
->
fe
)

231  
çl£
;

232 
cÚf
->
lše
 = 0;

233 
cÚf
->
”rÜ_mes§ge
 = 
NULL
;

234  
Œue
;

235 
	}
}

237 
	$cÚfig_şo£
(
cÚfig_t
 *
cÚf
)

239 ià(!
cÚf
)

241 ià(!
cÚf
->
fe
)

243 
	`fşo£
(
cÚf
->
fe
è=ğ
EOF
) {

244 ià(
”ºo
 !ğ
EINTR
) {

245 
	`lwª_¡©us_³¼Ü
("Could‚ot close config file");

249 
	`ä“
(
cÚf
->
”rÜ_mes§ge
);

250 
	}
}

	@common/lwan-config.h

20 #iâdeà
__LWAN_CONFIG_H__


21 
	#__LWAN_CONFIG_H__


	)

23 
	#ONE_MINUTE
 60

	)

24 
	#ONE_HOUR
 (
ONE_MINUTE
 * 60)

	)

25 
	#ONE_DAY
 (
ONE_HOUR
 * 24)

	)

26 
	#ONE_WEEK
 (
ONE_DAY
 * 7)

	)

27 
	#ONE_MONTH
 (
ONE_DAY
 * 31)

	)

28 
	#ONE_YEAR
 (
ONE_MONTH
 * 12)

	)

30 
	~<¡dio.h
>

31 
	~<¡dboŞ.h
>

33 
cÚfig_t_
 
	tcÚfig_t
;

34 
cÚfig_lše_t_
 
	tcÚfig_lše_t
;

37 
	mCONFIG_LINE_TYPE_LINE
,

38 
	mCONFIG_LINE_TYPE_SECTION
,

39 
	mCONFIG_LINE_TYPE_SECTION_END


40 } 
	tcÚfig_lše_ty³_t
;

42 
	scÚfig_t_
 {

43 
FILE
 *
	mfe
;

44 
	mlše
;

45 *
	m”rÜ_mes§ge
;

48 
	scÚfig_lše_t_
 {

51 *
	mÇme
, *
	m·¿m
;

52 } 
	m£ùiÚ
;

54 *
	mkey
, *
	mv®ue
;

55 } 
	mlše
;

57 
cÚfig_lše_ty³_t
 
	mty³
;

58 
	mbufãr
[1024];

61 
boŞ
 
cÚfig_İ’
(
cÚfig_t
 *
cÚf
, cÚ¡ *
·th
);

62 
cÚfig_şo£
(
cÚfig_t
 *
cÚf
);

63 
boŞ
 
cÚfig_”rÜ
(
cÚfig_t
 *
cÚf
, cÚ¡ *
fmt
, ...);

64 
boŞ
 
cÚfig_»ad_lše
(
cÚfig_t
 *
cÚf
, 
cÚfig_lše_t
 *
l
);

66 
boŞ
 
·r£_boŞ
(cÚ¡ *
v®ue
, boŞ 
deçuÉ_v®ue
);

67 
·r£_lÚg
(cÚ¡ *
v®ue
, 
deçuÉ_v®ue
);

68 
·r£_time_³riod
(cÚ¡ *
¡r
, 
deçuÉ_v®ue
);

	@common/lwan-coro.c

20 
	#_GNU_SOURCE


	)

21 
	~<as£¹.h
>

22 
	~<lim™s.h
>

23 
	~<¡d¬g.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

28 
	~"lwª.h
"

29 
	~"lwª-cÜo.h
"

31 #ifdeà
USE_VALGRIND


32 
	~<v®gršd/v®gršd.h
>

35 
	#CORO_STACK_MIN
 ((3 * (
PTHREAD_STACK_MIN
)è/ 2)

	)

37 
¡©ic_as£¹
(
DEFAULT_BUFFER_SIZE
 < (
CORO_STACK_MIN
 + 
PTHREAD_STACK_MIN
),

40 
cÜo_deãr_t_
 
	tcÜo_deãr_t
;

42 
	scÜo_deãr_t_
 {

43 
cÜo_deãr_t
 *
	mÃxt
;

44 (*
	mfunc
)();

45 *
	md©a1
;

46 *
	md©a2
;

49 
	scÜo_t_
 {

50 
cÜo_sw™ch”_t
 *
	msw™ch”
;

51 
cÜo_cÚ‹xt_t
 
	mcÚ‹xt
;

52 
	my›ld_v®ue
;

54 #ià!
defšed
(
NDEBUG
è&& defšed(
USE_VALGRIND
)

55 
	mvg_¡ack_id
;

58 
cÜo_deãr_t
 *
	mdeãr
;

59 *
	md©a
;

61 
boŞ
 
	m’ded
;

64 
cÜo_’Œy_pošt
(
cÜo_t
 *
d©a
, 
cÜo_funùiÚ_t
 
func
);

76 #ià
defšed
(
__x86_64__
)

77 
	$cÜo_sw­cÚ‹xt
(
cÜo_cÚ‹xt_t
 *
cu¼’t
, cÜo_cÚ‹xt_ˆ*
Ùh”
)

78 
	`__©Œibu‹__
((
nošlše
));

79 
	`asm
(

107 #–ià
	`defšed
(
__i386__
)

108 
	$cÜo_sw­cÚ‹xt
(
cÜo_cÚ‹xt_t
 *
cu¼’t
, cÜo_cÚ‹xt_ˆ*
Ùh”
)

109 
	`__©Œibu‹__
((
nošlše
));

110 
	`asm
(

136 
	#cÜo_sw­cÚ‹xt
(
cur
,
Ùh
è
	`sw­cÚ‹xt
(cur, oth)

	)

140 
	$cÜo_’Œy_pošt
(
cÜo_t
 *
cÜo
, 
cÜo_funùiÚ_t
 
func
)

142 
»tuº_v®ue
 = 
	`func
(
cÜo
);

143 
cÜo
->
’ded
 = 
Œue
;

144 
	`cÜo_y›ld
(
cÜo
, 
»tuº_v®ue
);

145 
	}
}

148 
	$cÜo_run_deã¼ed
(
cÜo_t
 *
cÜo
)

150 
cÜo_deãr_t
 *
deãr
 = 
cÜo
->defer; defer;) {

151 
cÜo_deãr_t
 *
tmp
 = 
deãr
;

152 
deãr
->
	`func
(deãr->
d©a1
, deãr->
d©a2
);

153 
deãr
 = 
tmp
->
Ãxt
;

154 
	`ä“
(
tmp
);

156 
cÜo
->
deãr
 = 
NULL
;

157 
	}
}

160 
	$cÜo_»£t
(
cÜo_t
 *
cÜo
, 
cÜo_funùiÚ_t
 
func
, *
d©a
)

162 *
¡ack
 = (*)(
cÜo
 + 1);

164 
cÜo
->
’ded
 = 
çl£
;

165 
cÜo
->
d©a
 = data;

167 
	`cÜo_run_deã¼ed
(
cÜo
);

169 #ià
	`defšed
(
__x86_64__
)

170 
cÜo
->
cÚ‹xt
[6 ] = (
ušŒ_t
) coro;

171 
cÜo
->
cÚ‹xt
[7 ] = (
ušŒ_t
è
func
;

172 
cÜo
->
cÚ‹xt
[8 ] = (
ušŒ_t
è
cÜo_’Œy_pošt
;

173 
cÜo
->
cÚ‹xt
[9 ] = (
ušŒ_t
è
¡ack
 + 
CORO_STACK_MIN
;

174 #–ià
	`defšed
(
__i386__
)

176 
¡ack
 = (*)((
ušŒ_t
)(¡ack + 
CORO_STACK_MIN
 -

177 (
ušŒ_t
) * 2) & 0xfffffff0);

179 
ušŒ_t
 *
¬gp
 = (ušŒ_ˆ*)
¡ack
;

180 *
¬gp
++ = 0;

181 *
¬gp
++ = (
ušŒ_t
)
cÜo
;

182 *
¬gp
++ = (
ušŒ_t
)
func
;

184 
cÜo
->
cÚ‹xt
[5 ] = (
ušŒ_t
è
cÜo_’Œy_pošt
;

185 
cÜo
->
cÚ‹xt
[6 ] = (
ušŒ_t
è
¡ack
;

187 
	`g‘cÚ‹xt
(&
cÜo
->
cÚ‹xt
);

189 
cÜo
->
cÚ‹xt
.
uc_¡ack
.
ss_¥
 = 
¡ack
;

190 
cÜo
->
cÚ‹xt
.
uc_¡ack
.
ss_size
 = 
CORO_STACK_MIN
;

191 
cÜo
->
cÚ‹xt
.
uc_¡ack
.
ss_æags
 = 0;

192 
cÜo
->
cÚ‹xt
.
uc_lšk
 = 
NULL
;

194 
	`makecÚ‹xt
(&
cÜo
->
cÚ‹xt
, ((*)())
cÜo_’Œy_pošt
, 2, cÜo, 
func
);

196 
	}
}

198 
ALWAYS_INLINE
 
cÜo_t
 *

199 
	$cÜo_Ãw
(
cÜo_sw™ch”_t
 *
sw™ch”
, 
cÜo_funùiÚ_t
 
funùiÚ
, *
d©a
)

201 
cÜo_t
 *
cÜo
 = 
	`m®loc
((*cÜoè+ 
CORO_STACK_MIN
);

202 ià(!
cÜo
)

203  
NULL
;

205 
cÜo
->
sw™ch”
 = switcher;

206 
cÜo
->
deãr
 = 
NULL
;

207 
	`cÜo_»£t
(
cÜo
, 
funùiÚ
, 
d©a
);

209 #ià!
	`defšed
(
NDEBUG
è&& defšed(
USE_VALGRIND
)

210 *
¡ack
 = (*)(
cÜo
 + 1);

211 
cÜo
->
vg_¡ack_id
 = 
	`VALGRIND_STACK_REGISTER
(
¡ack
, sck + 
CORO_STACK_MIN
);

214  
cÜo
;

215 
	}
}

217 
ALWAYS_INLINE
 *

218 
	$cÜo_g‘_d©a
(
cÜo_t
 *
cÜo
)

220  
	`LIKELY
(
cÜo
è? cÜo->
d©a
 : 
NULL
;

221 
	}
}

223 
ALWAYS_INLINE
 

224 
	$cÜo_»sume
(
cÜo_t
 *
cÜo
)

226 
	`as£¹
(
cÜo
);

227 
	`as£¹
(
cÜo
->
’ded
 =ğ
çl£
);

229 #ià
	`defšed
(
__x86_64__
è|| defšed(
__i386__
)

230 
	`cÜo_sw­cÚ‹xt
(&
cÜo
->
sw™ch”
->
ÿÎ”
, &cÜo->
cÚ‹xt
);

231 ià(!
cÜo
->
’ded
)

232 
	`memıy
(&
cÜo
->
cÚ‹xt
, &cÜo->
sw™ch”
->
ÿÎ“
,

233 (
cÜo
->
cÚ‹xt
));

235 
cÜo_cÚ‹xt_t
 
´ev_ÿÎ”
;

237 
	`memıy
(&
´ev_ÿÎ”
, &
cÜo
->
sw™ch”
->
ÿÎ”
, (prev_caller));

238 
	`cÜo_sw­cÚ‹xt
(&
cÜo
->
sw™ch”
->
ÿÎ”
, &cÜo->
cÚ‹xt
);

239 ià(!
cÜo
->
’ded
) {

240 
	`memıy
(&
cÜo
->
cÚ‹xt
, &cÜo->
sw™ch”
->
ÿÎ“
,

241 (
cÜo
->
cÚ‹xt
));

242 
	`memıy
(&
cÜo
->
sw™ch”
->
ÿÎ”
, &
´ev_ÿÎ”
,

243 (
cÜo
->
sw™ch”
->
ÿÎ”
));

247  
cÜo
->
y›ld_v®ue
;

248 
	}
}

250 
ALWAYS_INLINE
 

251 
	$cÜo_»sume_v®ue
(
cÜo_t
 *
cÜo
, 
v®ue
)

253 
	`as£¹
(
cÜo
);

254 
	`as£¹
(
cÜo
->
’ded
 =ğ
çl£
);

256 
cÜo
->
y›ld_v®ue
 = 
v®ue
;

257  
	`cÜo_»sume
(
cÜo
);

258 
	}
}

260 
ALWAYS_INLINE
 

261 
	$cÜo_y›ld
(
cÜo_t
 *
cÜo
, 
v®ue
)

263 
	`as£¹
(
cÜo
);

264 
cÜo
->
y›ld_v®ue
 = 
v®ue
;

265 
	`cÜo_sw­cÚ‹xt
(&
cÜo
->
sw™ch”
->
ÿÎ“
, &cÜo->sw™ch”->
ÿÎ”
);

266  
cÜo
->
y›ld_v®ue
;

267 
	}
}

270 
	$cÜo_ä“
(
cÜo_t
 *
cÜo
)

272 
	`as£¹
(
cÜo
);

273 #ià!
	`defšed
(
NDEBUG
è&& defšed(
USE_VALGRIND
)

274 
	`VALGRIND_STACK_DEREGISTER
(
cÜo
->
vg_¡ack_id
);

276 
	`cÜo_run_deã¼ed
(
cÜo
);

277 
	`ä“
(
cÜo
);

278 
	}
}

281 
cÜo_deãr_ªy
(
cÜo_t
 *
cÜo
, (*
func
)(), *
d©a1
, *
d©a2
)

283 
cÜo_deãr_t
 *
	gdeãr
 = 
m®loc
((*
deãr
));

284 ià(
UNLIKELY
(!
deãr
))

287 
as£¹
(
func
);

290 
	gdeãr
->
	gÃxt
 = 
cÜo
->
deãr
;

291 
	gdeãr
->
	gfunc
 = 
func
;

292 
	gdeãr
->
	gd©a1
 = 
d©a1
;

293 
	gdeãr
->
	gd©a2
 = 
d©a2
;

294 
	gcÜo
->
	gdeãr
 = 
deãr
;

297 
ALWAYS_INLINE
 

298 
cÜo_deãr
(
cÜo_t
 *
cÜo
, (*
func
)(*
d©a
), *data)

300 
	`cÜo_deãr_ªy
(
cÜo
, 
func
, 
d©a
, 
NULL
);

301 
	}
}

303 
ALWAYS_INLINE
 

304 
cÜo_deãr2
(
cÜo_t
 *
cÜo
, (*
func
)(*
d©a1
, *
d©a2
),

305 *
d©a1
, *
d©a2
)

307 
	`cÜo_deãr_ªy
(
cÜo
, 
func
, 
d©a1
, 
d©a2
);

308 
	}
}

311 
cÜo_m®loc_fuÎ
(
cÜo_t
 *
cÜo
, 
size_t
 
size
, (*
de¡roy_func
)())

313 
cÜo_deãr_t
 *
deãr
 = 
	`m®loc
((*deãrè+ 
size
);

314 ià(
	`UNLIKELY
(!
deãr
))

315  
NULL
;

317 
deãr
->
Ãxt
 = 
cÜo
->defer;

318 
deãr
->
func
 = 
de¡roy_func
;

319 
deãr
->
d©a1
 = defer + 1;

320 
deãr
->
d©a2
 = 
NULL
;

322 
cÜo
->
deãr
 = defer;

324  
deãr
 + 1;

325 
	}
}

327 
	$nÙhšg
()

329 
	}
}

331 
šlše
 *

332 
	$cÜo_m®loc
(
cÜo_t
 *
cÜo
, 
size_t
 
size
)

334  
	`cÜo_m®loc_fuÎ
(
cÜo
, 
size
, 
nÙhšg
);

335 
	}
}

338 
	$cÜo_¡rdup
(
cÜo_t
 *
cÜo
, cÚ¡ *
¡r
)

340 
size_t
 
Ën
 = 
	`¡¾’
(
¡r
) + 1;

341 *
dup
 = 
	`cÜo_m®loc
(
cÜo
, 
Ën
);

342 ià(
	`LIKELY
(
dup
))

343 
	`memıy
(
dup
, 
¡r
, 
Ën
);

344  
dup
;

345 
	}
}

348 
	$cÜo_´štf
(
cÜo_t
 *
cÜo
, cÚ¡ *
fmt
, ...)

350 
va_li¡
 
v®ues
;

351 
Ën
;

352 *
tmp_¡r
;

354 
	`va_¡¬t
(
v®ues
, 
fmt
);

355 
Ën
 = 
	`va¥rštf
(&
tmp_¡r
, 
fmt
, 
v®ues
);

356 
	`va_’d
(
v®ues
);

358 ià(
	`UNLIKELY
(
Ën
 < 0))

359  
NULL
;

361 
	`cÜo_deãr
(
cÜo
, 
	`CORO_DEFER
(
ä“
), 
tmp_¡r
);

362  
tmp_¡r
;

363 
	}
}

	@common/lwan-coro.h

20 #iâdeà
__LWAN_CORO_H__


21 
	#__LWAN_CORO_H__


	)

23 
	~<¡ddef.h
>

24 #ià
defšed
(
__x86_64__
)

25 
	~<¡dšt.h
>

26 
ušŒ_t
 
	tcÜo_cÚ‹xt_t
[10];

27 #–ià
defšed
(
__i386__
)

28 
	~<¡dšt.h
>

29 
ušŒ_t
 
	tcÜo_cÚ‹xt_t
[7];

31 
	~<ucÚ‹xt.h
>

32 
ucÚ‹xt_t
 
	tcÜo_cÚ‹xt_t
;

35 
cÜo_t_
 
	tcÜo_t
;

36 
cÜo_sw™ch”_t_
 
	tcÜo_sw™ch”_t
;

38 (*
	tcÜo_funùiÚ_t
è(
	tcÜo_t
 *
	tcÜo
);

40 
	scÜo_sw™ch”_t_
 {

41 
cÜo_cÚ‹xt_t
 
ÿÎ”
;

42 
cÜo_cÚ‹xt_t
 
ÿÎ“
;

45 
cÜo_t
 *
	`cÜo_Ãw
(
cÜo_sw™ch”_t
 *
sw™ch”
, 
cÜo_funùiÚ_t
 
funùiÚ
, *
d©a
);

46 
	`cÜo_ä“
(
cÜo_t
 *
cÜo
);

48 
	`cÜo_»£t
(
cÜo_t
 *
cÜo
, 
cÜo_funùiÚ_t
 
func
, *
d©a
);

50 
	`cÜo_»sume
(
cÜo_t
 *
cÜo
);

51 
	`cÜo_»sume_v®ue
(
cÜo_t
 *
cÜo
, 
v®ue
);

52 
	`cÜo_y›ld
(
cÜo_t
 *
cÜo
, 
v®ue
);

54 *
	`cÜo_g‘_d©a
(
cÜo_t
 *
cÜo
);

56 
	`cÜo_deãr
(
cÜo_t
 *
cÜo
, (*
func
)(*
d©a
), *data);

57 
	`cÜo_deãr2
(
cÜo_t
 *
cÜo
, (*
func
)(*
d©a1
, *
d©a2
),

58 *
d©a1
, *
d©a2
);

59 *
	`cÜo_m®loc
(
cÜo_t
 *
cÜo
, 
size_t
 
sz
);

60 *
	`cÜo_m®loc_fuÎ
(
cÜo_t
 *
cÜo
, 
size_t
 
size
, (*
de¡roy_func
)());

61 *
	`cÜo_¡rdup
(
cÜo_t
 *
cÜo
, cÚ¡ *
¡r
);

62 *
	`cÜo_´štf
(
cÜo_t
 *
cÜo
, cÚ¡ *
fmt
, ...);

64 
	#CORO_DEFER
(
â
è(((*)(*))(â))

	)

65 
	#CORO_DEFER2
(
â
è(((*)(*, *))(â))

	)

	@common/lwan-http-authorize.c

20 
	~<”ºo.h
>

21 
	~<¡dboŞ.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

25 
	~"ba£64.h
"

26 
	~"lwª-ÿche.h
"

27 
	~"lwª-cÚfig.h
"

28 
	~"lwª-h‰p-authÜize.h
"

30 
	s»®m_·sswÜd_fe_t
 {

31 
ÿche_’Œy_t
 
	mba£
;

32 
hash
 *
	m’Œ›s
;

35 
ÿche_t
 *
	g»®m_·sswÜd_ÿche
 = 
NULL
;

37 
	$fou¹y_two_ªd_ä“
(*
¡r
)

39 ià(
	`LIKELY
(
¡r
)) {

40 *
s
 = 
¡r
;

41 *
s
)

42 *
s
++ = 42;

43 
	`ä“
(
¡r
);

45 
	}
}

47 
ÿche_’Œy_t
 *
ü—‹_»®m_fe
(

48 cÚ¡ *
key
,

49 *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

51 
»®m_·sswÜd_fe_t
 *
	g½f
 = 
m®loc
((*
½f
));

52 
cÚfig_t
 
	gf
;

53 
cÚfig_lše_t
 
	gl
;

55 ià(
UNLIKELY
(!
½f
))

56  
	gNULL
;

58 
	g½f
->
	g’Œ›s
 = 
hash_¡r_Ãw
(
fou¹y_two_ªd_ä“
, fourty_two_and_free);

59 ià(
UNLIKELY
(!
½f
->
’Œ›s
))

60 
	g”rÜ_no_şo£
;

62 ià(!
cÚfig_İ’
(&
f
, 
key
))

63 
	g”rÜ_no_şo£
;

65 
cÚfig_»ad_lše
(&
f
, &
l
)) {

67 
	gl
.
	gty³
) {

68 
	gCONFIG_LINE_TYPE_LINE
: {

69 *
u£ºame
 = 
¡rdup
(
l
.
lše
.
key
);

70 ià(!
	gu£ºame
)

71 
	g”rÜ
;

73 *
	g·sswÜd
 = 
¡rdup
(
l
.
lše
.
v®ue
);

74 ià(!
	g·sswÜd
) {

75 
ä“
(
u£ºame
);

76 
	g”rÜ
;

79 
	g”r
 = 
hash_add_unique
(
½f
->
’Œ›s
, 
u£ºame
, 
·sswÜd
);

80 ià(
LIKELY
(!
”r
))

83 
ä“
(
u£ºame
);

84 
ä“
(
·sswÜd
);

86 ià(
	g”r
 =ğ-
EEXIST
) {

87 
lwª_¡©us_w¬nšg
(

89 
l
.
lše
.
key
);

93 
	g”rÜ
;

96 
cÚfig_”rÜ
(&
f
, "Expected username =…assword");

101 ià(
	gf
.
	g”rÜ_mes§ge
) {

102 
lwª_¡©us_”rÜ
("Error on…assword file \"%s\",†ine %d: %s",

103 
key
, 
f
.
lše
, f.
”rÜ_mes§ge
);

104 
	g”rÜ
;

107 
cÚfig_şo£
(&
f
);

108  (
	gÿche_’Œy_t
 *)
	g½f
;

110 
	g”rÜ
:

111 
cÚfig_şo£
(&
f
);

112 
	g”rÜ_no_şo£
:

113 
hash_ä“
(
½f
->
’Œ›s
);

114 
ä“
(
½f
);

115  
	gNULL
;

118 
de¡roy_»®m_fe
(
ÿche_’Œy_t
 *
’Œy
,

119 *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

121 
»®m_·sswÜd_fe_t
 *
	g½f
 = (»®m_·sswÜd_fe_ˆ*)
’Œy
;

122 
hash_ä“
(
½f
->
’Œ›s
);

123 
ä“
(
½f
);

126 
boŞ


127 
	$lwª_h‰p_authÜize_š™
()

129 
»®m_·sswÜd_ÿche
 = 
	`ÿche_ü—‹
(
ü—‹_»®m_fe
,

130 
de¡roy_»®m_fe
, 
NULL
, 60);

132  !!
»®m_·sswÜd_ÿche
;

133 
	}
}

136 
	$lwª_h‰p_authÜize_shutdown
()

138 
	`ÿche_de¡roy
(
»®m_·sswÜd_ÿche
);

139 
	}
}

141 
boŞ


142 
	$authÜize
(
cÜo_t
 *
cÜo
,

143 
lwª_v®ue_t
 *
authÜiz©iÚ
,

144 cÚ¡ *
·sswÜd_fe
)

146 
»®m_·sswÜd_fe_t
 *
½f
;

147 *
decoded
;

148 *
cŞÚ
;

149 *
·sswÜd
;

150 *
looked_·sswÜd
;

151 
size_t
 
decoded_Ën
;

152 
boŞ
 
·sswÜd_ok
 = 
çl£
;

154 
½f
 = (
»®m_·sswÜd_fe_t
 *)
	`ÿche_cÜo_g‘_ªd_»f_’Œy
(

155 
»®m_·sswÜd_ÿche
, 
cÜo
, 
·sswÜd_fe
);

156 ià(
	`UNLIKELY
(!
½f
))

157  
çl£
;

159 
decoded
 = 
	`ba£64_decode
((*)
authÜiz©iÚ
->
v®ue
,

160 
authÜiz©iÚ
->
Ën
, &
decoded_Ën
);

161 ià(
	`UNLIKELY
(!
decoded
))

162  
çl£
;

164 ià(
	`UNLIKELY
(
decoded_Ën
 >ğ(((
cÚfig_lše_t
 *)0)->
bufãr
)))

165 
out
;

167 
cŞÚ
 = 
	`memchr
(
decoded
, ':', 
decoded_Ën
);

168 ià(
	`UNLIKELY
(!
cŞÚ
))

169 
out
;

171 *
cŞÚ
 = '\0';

172 
·sswÜd
 = 
cŞÚ
 + 1;

174 
looked_·sswÜd
 = 
	`hash_fšd
(
½f
->
’Œ›s
, 
decoded
);

175 ià(
looked_·sswÜd
)

176 
·sswÜd_ok
 = !
	`¡rcmp
(
·sswÜd
, 
looked_·sswÜd
);

178 
out
:

179 
	`ä“
(
decoded
);

180  
·sswÜd_ok
;

181 
	}
}

183 
boŞ


184 
	$lwª_h‰p_authÜize
(
lwª_»que¡_t
 *
»que¡
,

185 
lwª_v®ue_t
 *
authÜiz©iÚ
,

186 cÚ¡ *
»®m
,

187 cÚ¡ *
·sswÜd_fe
)

189 cÚ¡ 
auth’tiÿ‹_tm¶
[] = "Basic„ealm=\"%s\"";

190 cÚ¡ 
size_t
 
basic_Ën
 = ("Basic ") - 1;

191 
lwª_key_v®ue_t
 *
h—d”s
;

193 ià(!
authÜiz©iÚ
->
v®ue
)

194 
uÇuthÜized
;

196 ià(
	`UNLIKELY
(
	`¡ºcmp
(
authÜiz©iÚ
->
v®ue
, "Basiø", 
basic_Ën
)))

197 
uÇuthÜized
;

199 
authÜiz©iÚ
->
v®ue
 +ğ
basic_Ën
;

200 
authÜiz©iÚ
->
Ën
 -ğ
basic_Ën
;

202 ià(
	`authÜize
(
»que¡
->
cÚn
->
cÜo
, 
authÜiz©iÚ
, 
·sswÜd_fe
))

203  
Œue
;

205 
uÇuthÜized
:

206 
h—d”s
 = 
	`cÜo_m®loc
(
»que¡
->
cÚn
->
cÜo
, 2 * (*headers));

207 
h—d”s
[0].
key
 = "WWW-Authenticate";

208 
h—d”s
[0].
v®ue
 = 
	`cÜo_´štf
(
»que¡
->
cÚn
->
cÜo
,

209 
auth’tiÿ‹_tm¶
, 
»®m
);

210 
h—d”s
[1].
key
 = h—d”s[1].
v®ue
 = 
NULL
;

212 
»que¡
->
»¥Ú£
.
h—d”s
 = headers;

213  
çl£
;

214 
	}
}

	@common/lwan-http-authorize.h

20 #iâdeà
LWAN_HTTP_AUTHORIZE_H


21 
	#LWAN_HTTP_AUTHORIZE_H


	)

23 
	~"lwª.h
"

25 
boŞ
 
lwª_h‰p_authÜize_š™
();

26 
lwª_h‰p_authÜize_shutdown
();

28 
boŞ


29 
lwª_h‰p_authÜize
(
lwª_»que¡_t
 *
»que¡
,

30 
lwª_v®ue_t
 *
authÜiz©iÚ
,

31 cÚ¡ *
»®m
,

32 cÚ¡ *
·sswÜd_fe
);

	@common/lwan-io-wrappers.c

20 
	~<as£¹.h
>

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<uni¡d.h
>

24 
	~<sys/£ndfe.h
>

26 
	~"lwª.h
"

27 
	~"lwª-io-w¿µ”s.h
"

29 cÚ¡ 
	gMAX_FAILED_TRIES
 = 5;

30 cÚ¡ 
size_t
 
	gBUFFER_SIZE
 = 1400;

33 
	$lwª_İ’©
(
lwª_»que¡_t
 *
»que¡
,

34 
dœfd
, cÚ¡ *
·thÇme
, 
æags
)

36 
Œ›s
 = 
MAX_FAILED_TRIES
;ries;ries--) {

37 
fd
 = 
	`İ’©
(
dœfd
, 
·thÇme
, 
æags
);

38 ià(
	`LIKELY
(
fd
 >= 0)) {

39 
	`cÜo_deãr
(
»que¡
->
cÚn
->
cÜo
, 
	`CORO_DEFER
(
şo£
), (*)(
šŒ_t
)
fd
);

40  
fd
;

43 
”ºo
) {

44 
EINTR
:

45 
EMFILE
:

46 
ENFILE
:

47 
ENOMEM
:

48 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

51  -
”ºo
;

55  -
ENFILE
;

56 
	}
}

58 
ssize_t


59 
	$lwª_wr™ev
(
lwª_»que¡_t
 *
»que¡
, 
iovec
 *
iov
, 
iov_couÁ
)

61 
ssize_t
 
tÙ®_wr™‹n
 = 0;

62 
cu¼_iov
 = 0;

64 
Œ›s
 = 
MAX_FAILED_TRIES
;ries;) {

65 
ssize_t
 
wr™‹n
 = 
	`wr™ev
(
»que¡
->
fd
, 
iov
 + 
cu¼_iov
, 
iov_couÁ
 - curr_iov);

66 ià(
	`UNLIKELY
(
wr™‹n
 < 0)) {

68 
Œ›s
--;

70 
”ºo
) {

71 
EAGAIN
:

72 
EINTR
:

73 
Œy_agaš
;

75 
out
;

79 
tÙ®_wr™‹n
 +ğ
wr™‹n
;

81 
wr™‹n
 >ğ(
ssize_t
)
iov
[
cu¼_iov
].
iov_Ën
)

82 
wr™‹n
 -ğ(
ssize_t
)
iov
[
cu¼_iov
++].
iov_Ën
;

84 ià(
cu¼_iov
 =ğ
iov_couÁ
)

85  
tÙ®_wr™‹n
;

87 
iov
[
cu¼_iov
].
iov_ba£
 = (*)iov[cu¼_iov].iov_ba£ + 
wr™‹n
;

88 
iov
[
cu¼_iov
].
iov_Ën
 -ğ(
size_t
)
wr™‹n
;

90 
Œy_agaš
:

91 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

94 
out
:

95 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

96 
	`__butš_uÄ—chabË
();

97 
	}
}

99 
ssize_t


100 
	$lwª_wr™e
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

102 
ssize_t
 
tÙ®_wr™‹n
 = 0;

104 
Œ›s
 = 
MAX_FAILED_TRIES
;ries;) {

105 
ssize_t
 
wr™‹n
 = 
	`wr™e
(
»que¡
->
fd
, 
buf
, 
couÁ
);

106 ià(
	`UNLIKELY
(
wr™‹n
 < 0)) {

107 
Œ›s
--;

109 
”ºo
) {

110 
EAGAIN
:

111 
EINTR
:

112 
Œy_agaš
;

114 
out
;

118 
tÙ®_wr™‹n
 +ğ
wr™‹n
;

119 ià((
size_t
)
tÙ®_wr™‹n
 =ğ
couÁ
)

120  
tÙ®_wr™‹n
;

121 ià((
size_t
)
tÙ®_wr™‹n
 < 
couÁ
)

122 
buf
 = (*)buà+ 
wr™‹n
;

124 
Œy_agaš
:

125 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

128 
out
:

129 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

130 
	`__butš_uÄ—chabË
();

131 
	}
}

133 
ssize_t


134 
	$lwª_£nd
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
buf
, 
size_t
 
couÁ
, 
æags
)

136 
ssize_t
 
tÙ®_£Á
 = 0;

138 
Œ›s
 = 
MAX_FAILED_TRIES
;ries;) {

139 
ssize_t
 
wr™‹n
 = 
	`£nd
(
»que¡
->
fd
, 
buf
, 
couÁ
, 
æags
);

140 ià(
	`UNLIKELY
(
wr™‹n
 < 0)) {

141 
Œ›s
--;

143 
”ºo
) {

144 
EAGAIN
:

145 
EINTR
:

146 
Œy_agaš
;

148 
out
;

152 
tÙ®_£Á
 +ğ
wr™‹n
;

153 ià((
size_t
)
tÙ®_£Á
 =ğ
couÁ
)

154  
tÙ®_£Á
;

155 ià((
size_t
)
tÙ®_£Á
 < 
couÁ
)

156 
buf
 = (*)buà+ 
wr™‹n
;

158 
Œy_agaš
:

159 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

162 
out
:

163 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

164 
	`__butš_uÄ—chabË
();

165 
	}
}

167 
ALWAYS_INLINE
 
ssize_t


168 
	$£ndfe_»ad_wr™e
(
cÜo_t
 *
cÜo
, 
š_fd
, 
out_fd
, 
off_t
 
off£t
, 
size_t
 
couÁ
)

171 
ssize_t
 
tÙ®_by‹s_wr™‹n
 = 0;

174 *
bufãr
 = 
	`cÜo_m®loc
(
cÜo
, 
BUFFER_SIZE
);

176 ià(
off£t
 && 
	`l£ek
(
š_fd
, off£t, 
SEEK_SET
) < 0) {

177 
	`lwª_¡©us_³¼Ü
("lseek");

181 
couÁ
 > 0) {

182 
ssize_t
 
»ad_by‹s
 = 
	`»ad
(
š_fd
, 
bufãr
, 
BUFFER_SIZE
);

183 ià(
»ad_by‹s
 < 0) {

184 
	`cÜo_y›ld
(
cÜo
, 
CONN_CORO_ABORT
);

185 
	`__butš_uÄ—chabË
();

188 
ssize_t
 
by‹s_wr™‹n
 = 
	`wr™e
(
out_fd
, 
bufãr
, (
size_t
)
»ad_by‹s
);

189 ià(
by‹s_wr™‹n
 < 0) {

190 
	`cÜo_y›ld
(
cÜo
, 
CONN_CORO_ABORT
);

191 
	`__butš_uÄ—chabË
();

194 
tÙ®_by‹s_wr™‹n
 +ğ
by‹s_wr™‹n
;

195 
couÁ
 -ğ(
size_t
)
by‹s_wr™‹n
;

196 
	`cÜo_y›ld
(
cÜo
, 
CONN_CORO_MAY_RESUME
);

199  
tÙ®_by‹s_wr™‹n
;

200 
	}
}

202 
ALWAYS_INLINE
 
ssize_t


203 
	$£ndfe_lšux_£ndfe
(
cÜo_t
 *
cÜo
, 
š_fd
, 
out_fd
, 
off_t
 
off£t
, 
size_t
 
couÁ
)

205 
size_t
 
tÙ®_wr™‹n
 = 0;

206 
size_t
 
to_be_wr™‹n
 = 
couÁ
;

209 
ssize_t
 
wr™‹n
 = 
	`£ndfe
(
out_fd
, 
š_fd
, &
off£t
, 
to_be_wr™‹n
);

210 ià(
wr™‹n
 < 0) {

211 
”ºo
) {

212 
EAGAIN
:

213 
EINTR
:

214 
	`cÜo_y›ld
(
cÜo
, 
CONN_CORO_MAY_RESUME
);

218 
	`cÜo_y›ld
(
cÜo
, 
CONN_CORO_ABORT
);

219 
	`__butš_uÄ—chabË
();

223 
tÙ®_wr™‹n
 +ğ(
size_t
)
wr™‹n
;

224 
to_be_wr™‹n
 -ğ(
size_t
)
wr™‹n
;

226 
	`cÜo_y›ld
(
cÜo
, 
CONN_CORO_MAY_RESUME
);

227 } 
to_be_wr™‹n
 > 0);

229  (
ssize_t
)
tÙ®_wr™‹n
;

230 
	}
}

232 
ssize_t


233 
	$lwª_£ndfe
(
lwª_»que¡_t
 *
»que¡
, 
š_fd
, 
off_t
 
off£t
, 
size_t
 
couÁ
)

235 ià(
couÁ
 > 
BUFFER_SIZE
 * 5) {

236 ià(
	`UNLIKELY
(
	`posix_çdvi£
(
š_fd
, 
off£t
, (
off_t
)
couÁ
,

237 
POSIX_FADV_SEQUENTIAL
) < 0))

238 
	`lwª_¡©us_³¼Ü
("posix_fadvise");

241 
ssize_t
 
wr™‹n_by‹s
 = 
	`£ndfe_lšux_£ndfe
(

242 
»que¡
->
cÚn
->
cÜo
, 
š_fd
,„eque¡->
fd
, 
off£t
, 
couÁ
);

244 ià(
	`UNLIKELY
(
wr™‹n_by‹s
 < 0)) {

245 
”ºo
) {

246 
ENOSYS
:

247 
EINVAL
:

248  
	`£ndfe_»ad_wr™e
(
»que¡
->
cÚn
->
cÜo
, 
š_fd
,„eque¡->
fd
, 
off£t
, 
couÁ
);

251  
wr™‹n_by‹s
;

252 
	}
}

	@common/lwan-io-wrappers.h

20 #iâdeà
__LWAN_IO_WRAPPERS_H__


21 
	#__LWAN_IO_WRAPPERS_H__


	)

23 
	~<uni¡d.h
>

24 
	~<sys/uio.h
>

26 
	~"lwª.h
"

28 
lwª_İ’©
(
lwª_»que¡_t
 *
»que¡
, 
dœfd
, cÚ¡ *
·thÇme
,

29 
æags
);

30 
ssize_t
 
lwª_wr™ev
(
lwª_»que¡_t
 *
»que¡
, 
iovec
 *
iov
,

31 
iovút
);

32 
ssize_t
 
lwª_wr™e
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
bufãr
,

33 
size_t
 
couÁ
);

34 
ssize_t
 
lwª_£nd
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
buf
, 
size_t
 
couÁ
,

35 
æags
);

36 
ssize_t
 
lwª_£ndfe
(
lwª_»que¡_t
 *
»que¡
, 
š_fd
,

37 
off_t
 
off£t
, 
size_t
 
couÁ
);

	@common/lwan-job.c

20 
	#_GNU_SOURCE


	)

21 
	~<as£¹.h
>

22 
	~<”ºo.h
>

23 
	~<±h»ad.h
>

24 
	~<sched.h
>

25 
	~<¡dboŞ.h
>

26 
	~<¡dlib.h
>

27 
	~<uni¡d.h
>

29 
	~"lwª.h
"

30 
	~"lwª-¡©us.h
"

31 
	~"li¡.h
"

33 
	sjob_t
 {

34 
li¡_node
 
	mjobs
;

35 
boŞ
 (*
cb
)(*
	md©a
);

36 *
	md©a
;

39 
±h»ad_t
 
	g£lf
;

40 
±h»ad_mu‹x_t
 
	gqueue_mu‹x
;

41 
boŞ
 
	gruÂšg
 = 
çl£
;

42 
li¡_h—d
 
	gjobs
;

45 
job_th»ad
(*
d©a
 
__©Œibu‹__
((
unu£d
)))

47 
time¥ec
 
	grg
 = { 1, 0 };

49 
	gruÂšg
) {

50 
job_t
 *
	gjob
;

51 
boŞ
 
	ghad_job
 = 
çl£
;

53 
±h»ad_mu‹x_lock
(&
queue_mu‹x
);

54 
li¡_fÜ_—ch
(&
jobs
, 
job
, jobs)

55 
	ghad_job
 |ğ
job
->
cb
(job->
d©a
);

56 
±h»ad_mu‹x_uÆock
(&
queue_mu‹x
);

58 ià(
	ghad_job
)

59 
	grg
.
	gtv_£c
 = 1;

60 ià(
	grg
.
	gtv_£c
 <= 15)

61 
rg
.
tv_£c
++;

63 ià(
UNLIKELY
(
Çno¦“p
(&
rg
, 
NULL
) < 0)) {

64 ià(
	g”ºo
 =ğ
EINTR
)

65 
¦“p
(1);

69  
	gNULL
;

72 
	$lwª_job_th»ad_š™
()

74 
	`as£¹
(!
ruÂšg
);

76 
	`lwª_¡©us_debug
("Initializing†ow…riority jobhread");

78 
	`li¡_h—d_š™
(&
jobs
);

80 
ruÂšg
 = 
Œue
;

81 ià(
	`±h»ad_ü—‹
(&
£lf
, 
NULL
, 
job_th»ad
, NULL) < 0)

82 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pthread_create");

84 #ifdeà
SCHED_IDLE


85 
sched_·¿m
 sched_param = {

86 .
sched_´iÜ™y
 = 0

88 ià(
	`±h»ad_£tsched·¿m
(
£lf
, 
SCHED_IDLE
, &
sched_·¿m
) < 0)

89 
	`lwª_¡©us_³¼Ü
("pthread_setschedparam");

91 
	}
}

93 
	$lwª_job_th»ad_shutdown
()

95 
	`lwª_¡©us_debug
("Shutting down jobhread");

97 
	`±h»ad_mu‹x_lock
(&
queue_mu‹x
);

98 
job_t
 *
node
, *
Ãxt
;

99 
	`li¡_fÜ_—ch_§ã
(&
jobs
, 
node
, 
Ãxt
, jobs) {

100 
	`li¡_d–
(&
node
->
jobs
);

101 
	`ä“
(
node
);

103 
ruÂšg
 = 
çl£
;

104 ià(
	`±h»ad_Œyjoš_Å
(
£lf
, 
NULL
) < 0)

105 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pthread_join");

106 
	`±h»ad_mu‹x_uÆock
(&
queue_mu‹x
);

107 
	}
}

109 
lwª_job_add
(
	$boŞ
 (*
cb
)(*
d©a
), *data)

111 
	`as£¹
(
cb
);

113 
job_t
 *
job
 = 
	`ÿÎoc
(1, (*job));

114 ià(!
job
)

115 
	`lwª_¡©us_ü™iÿl_³¼Ü
("calloc");

117 
job
->
cb
 = cb;

118 
job
->
d©a
 = data;

120 
	`±h»ad_mu‹x_lock
(&
queue_mu‹x
);

121 
	`li¡_add
(&
jobs
, &
job
->jobs);

122 
	`±h»ad_mu‹x_uÆock
(&
queue_mu‹x
);

123 
	}
}

125 
lwª_job_d–
(
	$boŞ
 (*
cb
)(*
d©a
), *data)

127 
job_t
 *
node
, *
Ãxt
;

129 
	`as£¹
(
cb
);

131 
	`±h»ad_mu‹x_lock
(&
queue_mu‹x
);

132 
	`li¡_fÜ_—ch_§ã
(&
jobs
, 
node
, 
Ãxt
, jobs) {

133 ià(
cb
 =ğ
node
->cb && 
d©a
 ==‚ode->data) {

134 
	`li¡_d–
(&
node
->
jobs
);

135 
	`ä“
(
node
);

138 
	`±h»ad_mu‹x_uÆock
(&
queue_mu‹x
);

139 
	}
}

	@common/lwan-lua.c

20 
	#_GNU_SOURCE


	)

21 
	~<ùy³.h
>

22 
	~<Ïuxlib.h
>

23 
	~<lua.h
>

24 
	~<lu®ib.h
>

25 
	~<±h»ad.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

29 
	~"lwª.h
"

30 
	~"lwª-ÿche.h
"

31 
	~"lwª-cÚfig.h
"

32 
	~"lwª-lua.h
"

34 cÚ¡ *
	g»que¡_m‘©abË_Çme
 = "Lwan.Request";

36 
	slwª_lua_´iv_t
 {

37 *
	mdeçuÉ_ty³
;

38 *
	msüt_fe
;

39 
±h»ad_key_t
 
	mÿche_key
;

40 
	mÿche_³riod
;

43 
	slwª_lua_¡©e_t
 {

44 
ÿche_’Œy_t
 
	mba£
;

45 
lua_S‹
 *
	mL
;

48 
ALWAYS_INLINE
 
lwª_»que¡_t
 *
	$u£rd©a_as_»que¡
(
lua_S‹
 *
L
, 
n
)

50  *((
lwª_»que¡_t
 **)
	`luaL_checkud©a
(
L
, 
n
, 
»que¡_m‘©abË_Çme
));

51 
	}
}

53 
	$»q_§y_cb
(
lua_S‹
 *
L
)

55 
lwª_»que¡_t
 *
»que¡
 = 
	`u£rd©a_as_»que¡
(
L
, 1);

56 
size_t
 
»¥Ú£_¡r_Ën
;

57 cÚ¡ *
»¥Ú£_¡r
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
»¥Ú£_¡r_Ën
);

59 
	`¡rbuf_£t_¡©ic
(
»que¡
->
»¥Ú£
.
bufãr
, 
»¥Ú£_¡r
, 
»¥Ú£_¡r_Ën
);

60 
	`lwª_»¥Ú£_£nd_chunk
(
»que¡
);

63 
	}
}

65 
	$»q_£nd_ev’t_cb
(
lua_S‹
 *
L
)

67 
lwª_»que¡_t
 *
»que¡
 = 
	`u£rd©a_as_»que¡
(
L
, 1);

68 
size_t
 
ev’t_¡r_Ën
;

69 cÚ¡ *
ev’t_¡r
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
ev’t_¡r_Ën
);

70 cÚ¡ *
ev’t_Çme
 = 
	`lua_to¡ršg
(
L
, -2);

72 
	`¡rbuf_£t_¡©ic
(
»que¡
->
»¥Ú£
.
bufãr
, 
ev’t_¡r
, 
ev’t_¡r_Ën
);

73 
	`lwª_»¥Ú£_£nd_ev’t
(
»que¡
, 
ev’t_Çme
);

76 
	}
}

78 
	$»q_y›ld_cb
(
lua_S‹
 *
L
)

80  
	`lua_y›ld
(
L
, 0);

81 
	}
}

83 
	$»q_£t_»¥Ú£_cb
(
lua_S‹
 *
L
)

85 
lwª_»que¡_t
 *
»que¡
 = 
	`u£rd©a_as_»que¡
(
L
, 1);

86 
size_t
 
»¥Ú£_¡r_Ën
;

87 cÚ¡ *
»¥Ú£_¡r
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
»¥Ú£_¡r_Ën
);

89 
	`¡rbuf_£t
(
»que¡
->
»¥Ú£
.
bufãr
, 
»¥Ú£_¡r
, 
»¥Ú£_¡r_Ën
);

92 
	}
}

94 
»que¡_·¿m_g‘‹r
(
lua_S‹
 *
L
,

95 cÚ¡ *(*
g‘‹r
)(
lwª_»que¡_t
 *
»q
, cÚ¡ *
key
))

97 
lwª_»que¡_t
 *
	g»que¡
 = 
u£rd©a_as_»que¡
(
L
, 1);

98 cÚ¡ *
	gkey_¡r
 = 
lua_to¡ršg
(
L
, -1);

100 cÚ¡ *
	gv®ue
 = 
g‘‹r
(
»que¡
, 
key_¡r
);

101 ià(!
	gv®ue
)

102 
lua_pushn
(
L
);

104 
lua_push¡ršg
(
L
, 
v®ue
);

109 
	$»q_qu”y_·¿m_cb
(
lua_S‹
 *
L
)

111  
	`»que¡_·¿m_g‘‹r
(
L
, 
lwª_»que¡_g‘_qu”y_·¿m
);

112 
	}
}

114 
	$»q_po¡_·¿m_cb
(
lua_S‹
 *
L
)

116  
	`»que¡_·¿m_g‘‹r
(
L
, 
lwª_»que¡_g‘_po¡_·¿m
);

117 
	}
}

119 cÚ¡ 
luaL_»g
 
	glwª_»que¡_m‘a_»gs
[] = {

120 { "qu”y_·¿m", 
»q_qu”y_·¿m_cb
 },

121 { "po¡_·¿m", 
»q_po¡_·¿m_cb
 },

122 { "y›ld", 
»q_y›ld_cb
 },

123 { "£t_»¥Ú£", 
»q_£t_»¥Ú£_cb
 },

124 { "§y", 
»q_§y_cb
 },

125 { "£nd_ev’t", 
»q_£nd_ev’t_cb
 },

126 { 
NULL
, NULL }

129 
ÿche_’Œy_t
 *
¡©e_ü—‹
(cÚ¡ *
key
 
__©Œibu‹__
((
unu£d
)),

130 *
cÚ‹xt
)

132 
lwª_lua_´iv_t
 *
	g´iv
 = 
cÚ‹xt
;

133 
lwª_lua_¡©e_t
 *
	g¡©e
 = 
m®loc
((*
¡©e
));

135 ià(
UNLIKELY
(!
¡©e
))

136  
	gNULL
;

138 
	g¡©e
->
	gL
 = 
luaL_Ãw¡©e
();

139 ià(
UNLIKELY
(!
¡©e
->
L
)) {

140 
ä“
(
¡©e
);

141  
	gNULL
;

144 
luaL_İ’libs
(
¡©e
->
L
);

146 
luaL_Ãwm‘©abË
(
¡©e
->
L
, 
»que¡_m‘©abË_Çme
);

147 
luaL_»gi¡”
(
¡©e
->
L
, 
NULL
, 
lwª_»que¡_m‘a_»gs
);

148 
lua_£tf›ld
(
¡©e
->
L
, -1, "__index");

150 ià(
UNLIKELY
(
luaL_dofe
(
¡©e
->
L
, 
´iv
->
süt_fe
) != 0)) {

151 
lwª_¡©us_”rÜ
("E¼Ü o³nšg Lu¨süˆ%s", 
lua_to¡ršg
(
¡©e
->
L
, -1));

152 
lua_şo£
(
¡©e
->
L
);

153 
ä“
(
¡©e
);

154  
	gNULL
;

157  (
	gÿche_’Œy_t
 *)
	g¡©e
;

160 
¡©e_de¡roy
(
ÿche_’Œy_t
 *
’Œy
,

161 *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

163 
lwª_lua_¡©e_t
 *
	g¡©e
 = (lwª_lua_¡©e_ˆ*)
’Œy
;

165 
lua_şo£
(
¡©e
->
L
);

166 
ä“
(
¡©e
);

169 
ÿche_t
 *
	$g‘_Ü_ü—‹_ÿche
(
lwª_lua_´iv_t
 *
´iv
)

171 
ÿche_t
 *
ÿche
 = 
	`±h»ad_g‘¥ecific
(
´iv
->
ÿche_key
);

172 ià(
	`UNLIKELY
(!
ÿche
)) {

173 
	`lwª_¡©us_debug
("Creating cache forhishread");

174 
ÿche
 = 
	`ÿche_ü—‹
(
¡©e_ü—‹
, 
¡©e_de¡roy
, 
´iv
,…riv->
ÿche_³riod
);

175 ià(
	`UNLIKELY
(!
ÿche
))

176 
	`lwª_¡©us_”rÜ
("Could‚ot create cache");

179 
	`±h»ad_£t¥ecific
(
´iv
->
ÿche_key
, 
ÿche
);

181  
ÿche
;

182 
	}
}

184 
	$uÄef_th»ad
(*
d©a1
, *
d©a2
)

186 
lua_S‹
 *
L
 = 
d©a1
;

187 
th»ad_»f
 = ()(
šŒ_t
)
d©a2
;

188 
	`luaL_uÄef
(
L
, 
LUA_REGISTRYINDEX
, 
th»ad_»f
);

189 
	}
}

191 
ALWAYS_INLINE
 cÚ¡ *
	$g‘_hªdË_´efix
(
lwª_»que¡_t
 *
»que¡
, 
size_t
 *
Ën
)

193 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_GET
) {

194 *
Ën
 = ("handle_get_");

197 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_POST
) {

198 *
Ën
 = ("handle_post_");

201 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_HEAD
) {

202 *
Ën
 = ("handle_head_");

206  
NULL
;

207 
	}
}

209 
boŞ
 
	$g‘_hªdËr_funùiÚ
(
lua_S‹
 *
L
, 
lwª_»que¡_t
 *
»que¡
)

211 
size_t
 
hªdË_´efix_Ën
;

212 cÚ¡ *
hªdË_´efix
 = 
	`g‘_hªdË_´efix
(
»que¡
, &
hªdË_´efix_Ën
);

213 ià(
	`UNLIKELY
(!
hªdË_´efix
))

214  
çl£
;

216 
hªdËr_Çme
[128];

217 *
m‘hod_Çme
 = 
	`mempıy
(
hªdËr_Çme
, 
hªdË_´efix
, 
hªdË_´efix_Ën
);

219 *
u¾
;

220 
size_t
 
u¾_Ën
;

221 ià(
»que¡
->
u¾
.
Ën
) {

222 
u¾
 = 
	`¡rdu·
(
»que¡
->u¾.
v®ue
);

223 *
c
 = 
u¾
; *c; c++) {

224 ià(*
c
 == '/') {

225 *
c
 = '\0';

228 ià(
	`UNLIKELY
(!
	`i§Êum
(*
c
) && *c != '_'))

229  
çl£
;

231 
u¾_Ën
 = 
	`¡¾’
(
u¾
);

233 
u¾
 = "root";

234 
u¾_Ën
 = 4;

237 ià(
	`UNLIKELY
((
hªdË_´efix_Ën
 + 
u¾_Ën
 + 1è> (
hªdËr_Çme
)))

238  
çl£
;

239 
	`memıy
(
m‘hod_Çme
 - 1, 
u¾
, (
hªdËr_Çme
è- 
u¾_Ën
 - 1);

241 
	`lua_g‘glob®
(
L
, 
hªdËr_Çme
);

242  
	`lua_isfunùiÚ
(
L
, -1);

243 
	}
}

245 
	$push_»que¡
(
lua_S‹
 *
L
, 
lwª_»que¡_t
 *
»que¡
)

247 
lwª_»que¡_t
 **
u£rd©a
 = 
	`lua_Ãwu£rd©a
(
L
, (lwan_request_t *));

248 *
u£rd©a
 = 
»que¡
;

249 
	`luaL_g‘m‘©abË
(
L
, 
»que¡_m‘©abË_Çme
);

250 
	`lua_£tm‘©abË
(
L
, -2);

251 
	}
}

253 
lua_S‹
 *
	$push_Ãwth»ad
(
lua_S‹
 *
L
, 
cÜo_t
 *
cÜo
)

255 
lua_S‹
 *
L1
 = 
	`lua_Ãwth»ad
(
L
);

256 ià(
	`UNLIKELY
(!
L1
))

257  
NULL
;

259 
th»ad_»f
 = 
	`luaL_»f
(
L
, 
LUA_REGISTRYINDEX
);

260 
	`cÜo_deãr2
(
cÜo
, 
	`CORO_DEFER2
(
uÄef_th»ad
), 
L
, (*)(
šŒ_t
)
th»ad_»f
);

262  
L1
;

263 
	}
}

265 
lwª_h‰p_¡©us_t


266 
	$lua_hªdË_cb
(
lwª_»que¡_t
 *
»que¡
,

267 
lwª_»¥Ú£_t
 *
»¥Ú£
,

268 *
d©a
)

270 
lwª_lua_´iv_t
 *
´iv
 = 
d©a
;

272 ià(
	`UNLIKELY
(!
´iv
))

273  
HTTP_INTERNAL_ERROR
;

275 
ÿche_t
 *
ÿche
 = 
	`g‘_Ü_ü—‹_ÿche
(
´iv
);

276 ià(
	`UNLIKELY
(!
ÿche
))

277  
HTTP_INTERNAL_ERROR
;

279 
lwª_lua_¡©e_t
 *
¡©e
 = (lwª_lua_¡©e_ˆ*)
	`ÿche_cÜo_g‘_ªd_»f_’Œy
(

280 
ÿche
, 
»que¡
->
cÚn
->
cÜo
, "");

281 ià(
	`UNLIKELY
(!
¡©e
))

282  
HTTP_NOT_FOUND
;

284 
lua_S‹
 *
L
 = 
	`push_Ãwth»ad
(
¡©e
->L, 
»que¡
->
cÚn
->
cÜo
);

285 ià(
	`UNLIKELY
(!
L
))

286  
HTTP_INTERNAL_ERROR
;

288 ià(
	`UNLIKELY
(!
	`g‘_hªdËr_funùiÚ
(
L
, 
»que¡
)))

289  
HTTP_NOT_FOUND
;

291 
n_¬gum’ts
 = 1;

292 
	`push_»que¡
(
L
, 
»que¡
);

293 
»¥Ú£
->
mime_ty³
 = 
´iv
->
deçuÉ_ty³
;

294 
Œue
) {

295 
	`lua_»sume
(
L
, 
n_¬gum’ts
)) {

296 
LUA_YIELD
:

297 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

298 
n_¬gum’ts
 = 0;

301  
HTTP_OK
;

303 
	`lwª_¡©us_”rÜ
("E¼Ü from Lu¨süt: %s", 
	`lua_to¡ršg
(
L
, -1));

304  
HTTP_INTERNAL_ERROR
;

307 
	}
}

309 *
	$lua_š™
(*
d©a
)

311 
lwª_lua_£‰šgs_t
 *
£‰šgs
 = 
d©a
;

312 
lwª_lua_´iv_t
 *
´iv
;

314 
´iv
 = 
	`m®loc
((*priv));

315 ià(!
´iv
) {

316 
	`lwª_¡©us_”rÜ
("Could‚ot‡llocate memory for…rivate Lua struct");

317  
NULL
;

320 
´iv
->
deçuÉ_ty³
 = 
	`¡rdup
(

321 
£‰šgs
->
deçuÉ_ty³
 ? settings->default_type : "text/plain");

322 ià(!
´iv
->
deçuÉ_ty³
) {

323 
	`lwª_¡©us_³¼Ü
("strdup");

324 
out_no_deçuÉ_ty³
;

327 ià(!
£‰šgs
->
süt_fe
) {

328 
	`lwª_¡©us_”rÜ
("No Lua script file…rovided");

329 
out_no_süt_fe
;

331 
´iv
->
süt_fe
 = 
	`¡rdup
(
£‰šgs
->script_file);

332 ià(!
´iv
->
süt_fe
) {

333 
	`lwª_¡©us_³¼Ü
("strdup");

334 
out_no_süt_fe
;

337 ià(
	`±h»ad_key_ü—‹
(&
´iv
->
ÿche_key
, 
NULL
)) {

338 
	`lwª_¡©us_³¼Ü
("pthread_key_create");

339 
out_key_ü—‹
;

342 
´iv
->
ÿche_³riod
 = 
£‰šgs
->cache_period;

344  
´iv
;

346 
out_key_ü—‹
:

347 
	`ä“
(
´iv
->
süt_fe
);

348 
out_no_süt_fe
:

349 
	`ä“
(
´iv
->
deçuÉ_ty³
);

350 
out_no_deçuÉ_ty³
:

351 
	`ä“
(
´iv
);

352  
NULL
;

353 
	}
}

355 
	$lua_shutdown
(*
d©a
)

357 
lwª_lua_´iv_t
 *
´iv
 = 
d©a
;

358 ià(
´iv
) {

359 
	`±h»ad_key_d–‘e
(
´iv
->
ÿche_key
);

360 
	`ä“
(
´iv
->
deçuÉ_ty³
);

361 
	`ä“
(
´iv
->
süt_fe
);

362 
	`ä“
(
´iv
);

364 
	}
}

366 *
	$lua_š™_äom_hash
(cÚ¡ 
hash
 *hash)

368 
lwª_lua_£‰šgs_t
 
£‰šgs
 = {

369 .
deçuÉ_ty³
 = 
	`hash_fšd
(
hash
, "defaultype"),

370 .
süt_fe
 = 
	`hash_fšd
(
hash
, "script file"),

371 .
ÿche_³riod
 = 
	`·r£_time_³riod
(
	`hash_fšd
(
hash
, "cache…eriod"), 15)

373  
	`lua_š™
(&
£‰šgs
);

374 
	}
}

376 cÚ¡ 
lwª_moduË_t
 *
	$lwª_moduË_lua
()

378 cÚ¡ 
lwª_moduË_t
 
lua_moduË
 = {

379 .
Çme
 = "lua",

380 .
š™
 = 
lua_š™
,

381 .
š™_äom_hash
 = 
lua_š™_äom_hash
,

382 .
shutdown
 = 
lua_shutdown
,

383 .
hªdË
 = 
lua_hªdË_cb
,

384 .
æags
 = 
HANDLER_PARSE_QUERY_STRING


385 | 
HANDLER_REMOVE_LEADING_SLASH


388  &
lua_moduË
;

389 
	}
}

	@common/lwan-lua.h

20 #iâdeà
__LWAN_LUA_H__


21 
	#__LWAN_LUA_H__


	)

23 
	~"lwª.h
"

25 
	slwª_lua_£‰šgs_t
 {

26 cÚ¡ *
	mdeçuÉ_ty³
;

27 cÚ¡ *
	msüt_fe
;

28 
	mÿche_³riod
;

31 
	#LUA
(
deçuÉ_ty³_
) \

32 .
moduË
 = 
	`lwª_moduË_lua
(), \

33 .
¬gs
 = ((
lwª_lua_t
[]) {{ \

34 .
deçuÉ_ty³
 = 
deçuÉ_ty³_
 \

36 .
æags
 = 0

	)

38 cÚ¡ 
lwª_moduË_t
 *
lwª_moduË_lua
();

	@common/lwan-private.h

20 #iâdeà
__LWAN_PRIVATE_H__


21 
	#__LWAN_PRIVATE_H__


	)

23 
	~"lwª.h
"

25 
lwª_»¥Ú£_š™
();

26 
lwª_»¥Ú£_shutdown
();

28 
lwª_sock‘_š™
(
lwª_t
 *
l
);

29 
lwª_sock‘_shutdown
(
lwª_t
 *
l
);

31 
lwª_th»ad_š™
(
lwª_t
 *
l
);

32 
lwª_th»ad_shutdown
(
lwª_t
 *
l
);

33 
lwª_th»ad_add_ş›Á
(
lwª_th»ad_t
 *
t
, 
fd
);

35 
lwª_¡©us_š™
(
lwª_t
 *
l
);

36 
lwª_¡©us_shutdown
(
lwª_t
 *
l
);

38 
lwª_job_th»ad_š™
();

39 
lwª_job_th»ad_shutdown
();

40 
lwª_job_add
(
	$boŞ
 (*
cb
)(*
d©a
), *data);

41 
	`lwª_job_d–
(
	$boŞ
 (*
cb
)(*
d©a
), *data);

43 
	`lwª_bËs_š™
();

44 
	`lwª_bËs_shutdown
();

	@common/lwan-redirect.c

20 
	~<¡ršg.h
>

21 
	~<¡dlib.h
>

23 
	~"lwª.h
"

24 
	~"lwª-»dœeù.h
"

26 
lwª_h‰p_¡©us_t


27 
	$»dœeù_hªdË_cb
(
lwª_»que¡_t
 *
»que¡
,

28 
lwª_»¥Ú£_t
 *
»¥Ú£
,

29 *
d©a
)

31 ià(
	`UNLIKELY
(!
d©a
))

32  
HTTP_INTERNAL_ERROR
;

34 
lwª_key_v®ue_t
 *
h—d”s
 = 
	`cÜo_m®loc
(
»que¡
->
cÚn
->
cÜo
, (*headers) * 2);

35 ià(
	`UNLIKELY
(!
h—d”s
))

36  
HTTP_INTERNAL_ERROR
;

38 
h—d”s
[0].
key
 = "Location";

39 
h—d”s
[0].
v®ue
 = 
d©a
;

40 
h—d”s
[1].
key
 = 
NULL
;

41 
h—d”s
[1].
v®ue
 = 
NULL
;

43 
»¥Ú£
->
h—d”s
 = headers;

45  
HTTP_MOVED_PERMANENTLY
;

46 
	}
}

48 *
	$»dœeù_š™
(*
d©a
)

50 
lwª_»dœeù_£‰šgs_t
 *
£‰šgs
 = 
d©a
;

51  (
£‰šgs
->
to
è? 
	`¡rdup
(£‰šgs->toè: 
NULL
;

52 
	}
}

54 *
	$»dœeù_š™_äom_hash
(cÚ¡ 
hash
 *hash)

56 
lwª_»dœeù_£‰šgs_t
 
£‰šgs
 = {

57 .
to
 = 
	`hash_fšd
(
hash
, "to")

59  
	`»dœeù_š™
(&
£‰šgs
);

60 
	}
}

62 cÚ¡ 
lwª_moduË_t
 *
	$lwª_moduË_»dœeù
()

64 cÚ¡ 
lwª_moduË_t
 
»dœeù_moduË
 = {

65 .
Çme
 = "redirect",

66 .
š™
 = 
»dœeù_š™
,

67 .
š™_äom_hash
 = 
»dœeù_š™_äom_hash
,

68 .
shutdown
 = 
ä“
,

69 .
hªdË
 = 
»dœeù_hªdË_cb
,

70 .
æags
 = 0

73  &
»dœeù_moduË
;

74 
	}
}

	@common/lwan-redirect.h

20 #iâdeà
__LWAN_REDIRECT_H__


21 
	#__LWAN_REDIRECT_H__


	)

23 
	~"lwª.h
"

25 
	slwª_»dœeù_£‰šgs_t
 {

26 *
	mto
;

29 
	#REDIRECT
(
to_
) \

30 .
moduË
 = 
	`lwª_moduË_»dœeù
(), \

31 .
¬gs
 = ((
lwª_»dœeù_t
[]) {{ \

32 .
to
 = 
to_
 \

34 .
æags
 = 0

	)

36 cÚ¡ 
lwª_moduË_t
 *
lwª_moduË_»dœeù
();

	@common/lwan-request.c

20 
	#_GNU_SOURCE


	)

21 
	~<as£¹.h
>

22 
	~<”ºo.h
>

23 
	~<š‰y³s.h
>

24 
	~<¡ddef.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<uni¡d.h
>

28 
	~<¬·/š‘.h
>

30 
	~"lwª.h
"

31 
	~"lwª-cÚfig.h
"

32 
	~"lwª-h‰p-authÜize.h
"

35 
	mFINALIZER_DONE
,

36 
	mFINALIZER_TRY_AGAIN
,

37 
	mFINALIZER_YIELD_TRY_AGAIN
,

38 
	mFINALIZER_ERROR_TOO_LARGE


39 } 
	tlwª_»ad_fš®iz”_t
;

41 
lwª_»que¡_·r£_t_
 
	tlwª_»que¡_·r£_t
;

43 
	slwª_»que¡_·r£_t_
 {

44 
lwª_v®ue_t
 
	mbufãr
;

45 
lwª_v®ue_t
 
	mqu”y_¡ršg
;

46 
lwª_v®ue_t
 
	mif_modif›d_sšû
;

47 
lwª_v®ue_t
 
	m¿nge
;

48 
lwª_v®ue_t
 
	macû±_’codšg
;

49 
lwª_v®ue_t
 
	mäagm’t
;

50 
lwª_v®ue_t
 
	mcÚ‹Á_Ëngth
;

51 
lwª_v®ue_t
 
	mpo¡_d©a
;

52 
lwª_v®ue_t
 
	mcÚ‹Á_ty³
;

53 
lwª_v®ue_t
 
	mauthÜiz©iÚ
;

54 
	mcÚÃùiÚ
;

57 
	$decode_hex_dig™
(
ch
è
	`__©Œibu‹__
((
pu»
));

58 
boŞ
 
	$is_hex_dig™
(
ch
è
	`__©Œibu‹__
((
pu»
));

59 
	$has_z”o_by‹
(
n
è
	`__©Œibu‹__
((
pu»
));

60 
	$is_¥aû
(
ch
è
	`__©Œibu‹__
((
pu»
));

61 *
	$ignÜe_Ëadšg_wh™e¥aû
(*
bufãr
è
	`__©Œibu‹__
((
pu»
));

63 
ALWAYS_INLINE
 *

64 
	$id’tify_h‰p_m‘hod
(
lwª_»que¡_t
 *
»que¡
, *
bufãr
)

67 
HTTP_STR_GET
 = 
	`MULTICHAR_CONSTANT
('G','E','T',' '),

68 
HTTP_STR_HEAD
 = 
	`MULTICHAR_CONSTANT
('H','E','A','D'),

69 
HTTP_STR_POST
 = 
	`MULTICHAR_CONSTANT
('P','O','S','T')

72 
	`STRING_SWITCH
(
bufãr
) {

73 
HTTP_STR_GET
:

74 
»que¡
->
æags
 |ğ
REQUEST_METHOD_GET
;

75  
bufãr
 + 4;

76 
HTTP_STR_HEAD
:

77 
»que¡
->
æags
 |ğ
REQUEST_METHOD_HEAD
;

78  
bufãr
 + 5;

79 
HTTP_STR_POST
:

80 
»que¡
->
æags
 |ğ
REQUEST_METHOD_POST
;

81  
bufãr
 + 5;

83  
NULL
;

84 
	}
}

86 
ALWAYS_INLINE
 

87 
	$decode_hex_dig™
(
ch
)

89  ()((
ch
 <= '9') ? ch - '0' : (ch & 7) + 9);

90 
	}
}

92 
ALWAYS_INLINE
 
boŞ


93 
	$is_hex_dig™
(
ch
)

95  (
ch
 >= '0' && ch <= '9') || (ch >= 'a' && ch <= 'f') || (ch >= 'A' && ch <= 'F');

96 
	}
}

98 
size_t


99 
	$u¾_decode
(*
¡r
)

101 ià(
	`UNLIKELY
(!
¡r
))

104 *
ch
, *
decoded
;

105 
decoded
 = 
ch
 = 
¡r
; *ch; ch++) {

106 ià(*
ch
 =ğ'%' && 
	`LIKELY
(
	`is_hex_dig™
(ch[1]) && is_hex_digit(ch[2]))) {

107 
tmp
 = ()(
	`decode_hex_dig™
(
ch
[1]) << 4 | decode_hex_digit(ch[2]));

108 ià(
	`UNLIKELY
(!
tmp
))

110 *
decoded
++ = 
tmp
;

111 
ch
 += 2;

112 } ià(*
ch
 == '+') {

113 *
decoded
++ = ' ';

115 *
decoded
++ = *
ch
;

119 *
decoded
 = '\0';

120  (
size_t
)(
decoded
 - 
¡r
);

121 
	}
}

124 
	$key_v®ue_com·»_qsÜt_key
(cÚ¡ *
a
, cÚ¡ *
b
)

126  
	`¡rcmp
(((
lwª_key_v®ue_t
 *)
a
)->
key
, (Öwª_key_v®ue_ˆ*)
b
)->key);

127 
	}
}

129 
	#DECODE_AND_ADD
() \

131 ià(
	`LIKELY
(
	`u¾_decode
(
key
))) { \

132 
kvs
[
v®ues
].
key
 = key; \

133 ià(
	`LIKELY
(
	`u¾_decode
(
v®ue
))) \

134 
kvs
[
v®ues
].
v®ue
 = value; \

136 
kvs
[
v®ues
].
v®ue
 = ""; \

137 ++
v®ues
; \

138 ià(
	`UNLIKELY
(
v®ues
 >ğ
	`N_ELEMENTS
(
kvs
))) \

139 
oom
; \

141 } 0)

	)

144 
	$·r£_u¾’coded_keyv®ues
(
lwª_»que¡_t
 *
»que¡
,

145 
lwª_v®ue_t
 *
h–³r_v®ue
, 
lwª_key_v®ue_t
 **
ba£
, 
size_t
 *
Ën
)

147 ià(!
h–³r_v®ue
->
v®ue
)

150 *
key
 = 
h–³r_v®ue
->
v®ue
;

151 *
v®ue
 = 
NULL
;

152 
size_t
 
v®ues
 = 0;

153 
lwª_key_v®ue_t
 
kvs
[256];

155 *
ch
 = 
key
; *ch; ch++) {

156 *
ch
) {

158 *
ch
 = '\0';

159 
v®ue
 = 
ch
 + 1;

163 *
ch
 = '\0';

164 
	`DECODE_AND_ADD
();

165 
key
 = 
ch
 + 1;

166 
v®ue
 = 
NULL
;

170 
	`DECODE_AND_ADD
();

171 
oom
:

172 
kvs
[
v®ues
].
key
 = kvs[v®ues].
v®ue
 = 
NULL
;

174 
lwª_key_v®ue_t
 *
kv
 = 
	`cÜo_m®loc
(
»que¡
->
cÚn
->
cÜo
,

175 (1 + 
v®ues
è* (
lwª_key_v®ue_t
));

176 ià(
	`LIKELY
(
kv
)) {

177 
	`qsÜt
(
kvs
, 
v®ues
, (
lwª_key_v®ue_t
), 
key_v®ue_com·»_qsÜt_key
);

178 *
ba£
 = 
	`memıy
(
kv
, 
kvs
, (1 + 
v®ues
è* (
lwª_key_v®ue_t
));

179 *
Ën
 = 
v®ues
;

181 
	}
}

183 #undeà
DECODE_AND_ADD


186 
	$·r£_qu”y_¡ršg
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

188 
	`·r£_u¾’coded_keyv®ues
(
»que¡
, &
h–³r
->
qu”y_¡ršg
,

189 &
»que¡
->
qu”y_·¿ms
.
ba£
, &»que¡->qu”y_·¿ms.
Ën
);

190 
	}
}

193 
	$·r£_po¡_d©a
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

195 cÚ¡ 
cÚ‹Á_ty³
[] = "application/x-www-form-urlencoded";

197 ià(
h–³r
->
cÚ‹Á_ty³
.
Ën
 != (content_type) - 1)

199 ià(
	`UNLIKELY
(
	`¡rcmp
(
h–³r
->
cÚ‹Á_ty³
.
v®ue
, content_type)))

202 
	`·r£_u¾’coded_keyv®ues
(
»que¡
, &
h–³r
->
po¡_d©a
,

203 &
»que¡
->
po¡_d©a
.
ba£
, &»que¡->po¡_d©a.
Ën
);

204 
	}
}

207 
	$id’tify_h‰p_·th
(
lwª_»que¡_t
 *
»que¡
, *
bufãr
,

208 
lwª_»que¡_·r£_t
 *
h–³r
)

210 cÚ¡ 
size_t
 
mšim®_»que¡_lše_Ën
 = ("/ HTTP/1.0") - 1;

212 *
’d_of_lše
 = 
	`memchr
(
bufãr
, '\r',

213 (
h–³r
->
bufãr
.
Ën
 - (
size_t
)(bufã¸- h–³r->bufãr.
v®ue
)));

214 ià(
	`UNLIKELY
(!
’d_of_lše
))

215  
NULL
;

216 ià(
	`UNLIKELY
((
size_t
)(
’d_of_lše
 - 
bufãr
è< 
mšim®_»que¡_lše_Ën
))

217  
NULL
;

218 *
’d_of_lše
 = '\0';

220 *
¥aû
 = 
’d_of_lše
 - ("HTTP/X.X");

221 ià(
	`UNLIKELY
(*(
¥aû
 + 1) != 'H'))

222  
NULL
;

223 *
¥aû
 = '\0';

225 ià(
	`UNLIKELY
(*(
¥aû
 + 6) != '1'))

226  
NULL
;

228 ià(*(
¥aû
 + 8) == '0')

229 
»que¡
->
æags
 |ğ
REQUEST_IS_HTTP_1_0
;

231 ià(
	`UNLIKELY
(*
bufãr
 != '/'))

232  
NULL
;

234 
»que¡
->
u¾
.
v®ue
 = 
bufãr
;

235 
»que¡
->
u¾
.
Ën
 = (
size_t
)(
¥aû
 - 
bufãr
);

238 *
äagm’t
 = 
	`memrchr
(
bufãr
, '#', 
»que¡
->
u¾
.
Ën
);

239 ià(
äagm’t
) {

240 *
äagm’t
 = '\0';

241 
h–³r
->
äagm’t
.
v®ue
 = fragment + 1;

242 
h–³r
->
äagm’t
.
Ën
 = (
size_t
)(
¥aû
 - fragment - 1);

243 
»que¡
->
u¾
.
Ën
 -ğ
h–³r
->
äagm’t
.len + 1;

248 *
qu”y_¡ršg
 = 
	`memchr
(
bufãr
, '?', 
»que¡
->
u¾
.
Ën
);

249 ià(
qu”y_¡ršg
) {

250 *
qu”y_¡ršg
 = '\0';

251 
h–³r
->
qu”y_¡ršg
.
v®ue
 = query_string + 1;

252 
h–³r
->
qu”y_¡ršg
.
Ën
 = (
size_t
)((
äagm’t
 ? f¿gm’ˆ: 
¥aû
) - query_string - 1);

253 
»que¡
->
u¾
.
Ën
 -ğ
h–³r
->
qu”y_¡ršg
.len + 1;

256 
»que¡
->
Üigš®_u¾
.
v®ue
 = 
bufãr
;

257 
»que¡
->
Üigš®_u¾
.
Ën
 =„eque¡->
u¾
.len;

259  
’d_of_lše
 + 1;

260 
	}
}

262 
	#MATCH_HEADER
(
hdr
) \

264 *
’d
; \

265 
p
 +ğ(
hdr
) - 1; \

266 ià(
p
 >ğ
bufãr_’d
) \

267 
’d
; \

268 ià(
	`UNLIKELY
(*
p
++ != ':')) \

269 
did_nÙ_m©ch
; \

270 ià(
	`UNLIKELY
(*
p
++ != ' ')) \

271 
did_nÙ_m©ch
; \

272 ià(
	`LIKELY
(
’d
 = 
	`¡rchr
(
p
, '\r'))) { \

273 *
’d
 = '\0'; \

274 
v®ue
 = 
p
; \

275 
p
 = 
’d
 + 1; \

276 
Ëngth
 = (
size_t
)(
’d
 - 
v®ue
); \

277 ià(
	`UNLIKELY
(*
p
 != '\n')) \

278 
did_nÙ_m©ch
; \

279 } 
did_nÙ_m©ch
; \

280 } 0)

	)

282 
	#CASE_HEADER
(
hdr_cÚ¡
,
hdr_Çme
) \

283 
hdr_cÚ¡
: 
	`MATCH_HEADER
(
hdr_Çme
);

	)

286 
	$·r£_h—d”s
(
lwª_»que¡_·r£_t
 *
h–³r
, *
bufãr
, *
bufãr_’d
)

289 
HTTP_HDR_CONNECTION
 = 
	`MULTICHAR_CONSTANT_L
('C','o','n','n'),

290 
HTTP_HDR_RANGE
 = 
	`MULTICHAR_CONSTANT_L
('R','a','n','g'),

291 
HTTP_HDR_IF_MODIFIED_SINCE
 = 
	`MULTICHAR_CONSTANT_L
('I','f','-','M'),

292 
HTTP_HDR_ACCEPT
 = 
	`MULTICHAR_CONSTANT_L
('A','c','c','e'),

293 
HTTP_HDR_CONTENT
 = 
	`MULTICHAR_CONSTANT_L
('C','o','n','t'),

294 
HTTP_HDR_ENCODING
 = 
	`MULTICHAR_CONSTANT_L
('-','E','n','c'),

295 
HTTP_HDR_LENGTH
 = 
	`MULTICHAR_CONSTANT_L
('-','L','e','n'),

296 
HTTP_HDR_TYPE
 = 
	`MULTICHAR_CONSTANT_L
('-','T','y','p'),

297 
HTTP_HDR_AUTHORIZATION
 = 
	`MULTICHAR_CONSTANT_L
('A','u','t','h'),

300 ià(
	`UNLIKELY
(!
bufãr
))

301  
NULL
;

303 *
p
 = 
bufãr
; *p; buffer = ++p) {

304 *
v®ue
;

305 
size_t
 
Ëngth
;

307 
»Œy
:

308 ià((
p
 + (
št32_t
)è>ğ
bufãr_’d
)

311 
	`STRING_SWITCH_L
(
p
) {

312 
	`CASE_HEADER
(
HTTP_HDR_CONNECTION
, "Connection")

313 
h–³r
->
cÚÃùiÚ
 = (*
v®ue
 | 0x20);

315 
	`CASE_HEADER
(
HTTP_HDR_IF_MODIFIED_SINCE
, "If-Modified-Since")

316 
h–³r
->
if_modif›d_sšû
.
v®ue
 = value;

317 
h–³r
->
if_modif›d_sšû
.
Ën
 = 
Ëngth
;

319 
	`CASE_HEADER
(
HTTP_HDR_RANGE
, "Range")

320 
h–³r
->
¿nge
.
v®ue
 = value;

321 
h–³r
->
¿nge
.
Ën
 = 
Ëngth
;

323 
	`CASE_HEADER
(
HTTP_HDR_AUTHORIZATION
, "Authorization")

324 
h–³r
->
authÜiz©iÚ
.
v®ue
 = value;

325 
h–³r
->
authÜiz©iÚ
.
Ën
 = 
Ëngth
;

327 
	`CASE_HEADER
(
HTTP_HDR_ENCODING
, "-Encoding")

328 
h–³r
->
acû±_’codšg
.
v®ue
 = value;

329 
h–³r
->
acû±_’codšg
.
Ën
 = 
Ëngth
;

331 
	`CASE_HEADER
(
HTTP_HDR_TYPE
, "-Type")

332 
h–³r
->
cÚ‹Á_ty³
.
v®ue
 = value;

333 
h–³r
->
cÚ‹Á_ty³
.
Ën
 = 
Ëngth
;

335 
	`CASE_HEADER
(
HTTP_HDR_LENGTH
, "-Length")

336 
h–³r
->
cÚ‹Á_Ëngth
.
v®ue
 = value;

337 
h–³r
->
cÚ‹Á_Ëngth
.
Ën
 = 
Ëngth
;

339 
HTTP_HDR_CONTENT
:

340 
p
 += ("Content") - 1;

341 
»Œy
;

342 
HTTP_HDR_ACCEPT
:

343 
p
 += ("Accept") - 1;

344 
»Œy
;

346 
did_nÙ_m©ch
:

347 
p
 = 
	`memchr
Õ, '\n', (
size_t
)(
bufãr_’d
 -…));

348 ià(!
p
)

352 
’d
:

353  
bufãr
;

354 
	}
}

356 #undeà
CASE_HEADER


357 #undeà
MATCH_HEADER


360 
	$·r£_if_modif›d_sšû
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

362 ià(
	`UNLIKELY
(!
h–³r
->
if_modif›d_sšû
.
Ën
))

365 
tm
 
t
;

366 *
´oûs£d
 = 
	`¡½time
(
h–³r
->
if_modif›d_sšû
.
v®ue
,

367 "%a, %d %b %Y %H:%M:%S GMT", &
t
);

369 ià(
	`UNLIKELY
(!
´oûs£d
))

371 ià(
	`UNLIKELY
(*
´oûs£d
))

374 
»que¡
->
h—d”
.
if_modif›d_sšû
 = 
	`timegm
(&
t
);

375 
	}
}

378 
	$·r£_¿nge
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

380 ià(
	`UNLIKELY
(
h–³r
->
¿nge
.
Ën
 <= (("bytes=") - 1)))

383 *
¿nge
 = 
h–³r
->¿nge.
v®ue
;

384 ià(
	`UNLIKELY
(
	`¡ºcmp
(
¿nge
, "bytes=", ("bytes=") - 1)))

387 
¿nge
 += ("bytes=") - 1;

388 
off_t
 
äom
, 
to
;

390 ià(
	`ssÿnf
(
¿nge
, "%"
PRIu64
"-%"PRIu64, &
äom
, &
to
) == 2) {

391 
»que¡
->
h—d”
.
¿nge
.
äom
 = from;

392 
»que¡
->
h—d”
.
¿nge
.
to
 =o;

393 } ià(
	`ssÿnf
(
¿nge
, "-%"
PRIu64
, &
to
) == 1) {

394 
»que¡
->
h—d”
.
¿nge
.
äom
 = 0;

395 
»que¡
->
h—d”
.
¿nge
.
to
 =o;

396 } ià(
	`ssÿnf
(
¿nge
, "%"
PRIu64
"-", &
äom
) == 1) {

397 
»que¡
->
h—d”
.
¿nge
.
äom
 = from;

398 
»que¡
->
h—d”
.
¿nge
.
to
 = -1;

400 
»que¡
->
h—d”
.
¿nge
.
äom
 = -1;

401 
»que¡
->
h—d”
.
¿nge
.
to
 = -1;

403 
	}
}

406 
	$·r£_acû±_’codšg
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

408 ià(!
h–³r
->
acû±_’codšg
.
Ën
)

412 
ENCODING_DEFL1
 = 
	`MULTICHAR_CONSTANT
('d','e','f','l'),

413 
ENCODING_DEFL2
 = 
	`MULTICHAR_CONSTANT
(' ','d','e','f')

416 *
p
 = 
h–³r
->
acû±_’codšg
.
v®ue
;… && *p;…++) {

417 
	`STRING_SWITCH
(
p
) {

418 
ENCODING_DEFL1
:

419 
ENCODING_DEFL2
:

420 
»que¡
->
æags
 |ğ
REQUEST_ACCEPT_DEFLATE
;

424 ià(!(
p
 = 
	`¡rchr
(p, ',')))

427 
	}
}

429 
ALWAYS_INLINE
 

430 
	$has_z”o_by‹
(
n
)

432  ((
n
 - 0x01010101UL) & ~n) & 0x80808080UL;

433 
	}
}

435 
ALWAYS_INLINE
 

436 
	$is_¥aû
(
ch
)

438  
	`has_z”o_by‹
((0x1010101UL * ()
ch
) ^ 0x090a0d20UL);

439 
	}
}

441 
ALWAYS_INLINE
 *

442 
	$ignÜe_Ëadšg_wh™e¥aû
(*
bufãr
)

444 *
bufãr
 && 
	`is_¥aû
(*buffer))

445 
bufãr
++;

446  
bufãr
;

447 
	}
}

449 
ALWAYS_INLINE
 

450 
	$compu‹_k“p_®ive_æag
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

452 
boŞ
 
is_k“p_®ive
;

453 ià(
»que¡
->
æags
 & 
REQUEST_IS_HTTP_1_0
)

454 
is_k“p_®ive
 = (
h–³r
->
cÚÃùiÚ
 == 'k');

456 
is_k“p_®ive
 = (
h–³r
->
cÚÃùiÚ
 != 'c');

457 ià(
is_k“p_®ive
)

458 
»que¡
->
cÚn
->
æags
 |ğ
CONN_KEEP_ALIVE
;

460 
»que¡
->
cÚn
->
æags
 &ğ~
CONN_KEEP_ALIVE
;

461 
	}
}

463 
lwª_h‰p_¡©us_t
 
»ad_äom_»que¡_sock‘
(
lwª_»que¡_t
 *
»que¡
,

464 
lwª_v®ue_t
 *
bufãr
, cÚ¡ 
size_t
 
bufãr_size
,

465 
	$lwª_»ad_fš®iz”_t
 (*
fš®iz”
)(
size_t
 
tÙ®_»ad
, size_ˆ
bufãr_size
, 
lwª_v®ue_t
 *
bufãr
))

467 
ssize_t
 
n
;

468 
size_t
 
tÙ®_»ad
 = 0;

469 
·ck‘s_»maššg
 = 16;

471 ; 
·ck‘s_»maššg
 > 0;…ackets_remaining--) {

472 
n
 = 
	`»ad
(
»que¡
->
fd
, 
bufãr
->
v®ue
 + 
tÙ®_»ad
,

473 (
size_t
)(
bufãr_size
 - 
tÙ®_»ad
));

475 ià(
	`UNLIKELY
(
n
 == 0)) {

476 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

477 
	`__butš_uÄ—chabË
();

480 ià(
	`UNLIKELY
(
n
 < 0)) {

481 
”ºo
) {

482 
EAGAIN
:

483 
EINTR
:

484 
y›ld_ªd_»ad_agaš
:

487 
»que¡
->
cÚn
->
æags
 ^ğ
CONN_WRITE_EVENTS
;

489 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

491 
»que¡
->
cÚn
->
æags
 ^ğ
CONN_WRITE_EVENTS
;

497 ià(
	`UNLIKELY
(!
tÙ®_»ad
))

498  
HTTP_BAD_REQUEST
;

501 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

502 
	`__butš_uÄ—chabË
();

505 
tÙ®_»ad
 +ğ(
size_t
)
n
;

506 
bufãr
->
v®ue
[
tÙ®_»ad
] = '\0';

508 
	`fš®iz”
(
tÙ®_»ad
, 
bufãr_size
, 
bufãr
)) {

509 
FINALIZER_DONE
:

510 
bufãr
->
Ën
 = (
size_t
)
tÙ®_»ad
;

511  
HTTP_OK
;

512 
FINALIZER_TRY_AGAIN
:

514 
FINALIZER_YIELD_TRY_AGAIN
:

515 
y›ld_ªd_»ad_agaš
;

516 
FINALIZER_ERROR_TOO_LARGE
:

517  
HTTP_TOO_LARGE
;

528  
HTTP_TIMEOUT
;

529 
	}
}

531 
lwª_»ad_fš®iz”_t
 
	$»ad_»que¡_fš®iz”
(
size_t
 
tÙ®_»ad
,

532 
size_t
 
bufãr_size
, 
lwª_v®ue_t
 *
bufãr
)

534 ià(
	`UNLIKELY
(
tÙ®_»ad
 < 4))

535  
FINALIZER_YIELD_TRY_AGAIN
;

537 ià(
	`UNLIKELY
(
tÙ®_»ad
 =ğ
bufãr_size
))

538  
FINALIZER_ERROR_TOO_LARGE
;

540 ià(
	`LIKELY
(!
	`memcmp
(
bufãr
->
v®ue
 + 
tÙ®_»ad
 - 4, "\r\n\r\n", 4)))

541  
FINALIZER_DONE
;

543 *
po¡_d©a_£·¿tÜ
 = 
	`¡¼chr
(
bufãr
->
v®ue
, '\n');

544 ià(
po¡_d©a_£·¿tÜ
) {

545 ià(
	`LIKELY
(!
	`memcmp
(
po¡_d©a_£·¿tÜ
 - 3, "\r\n\r", 3)))

546  
FINALIZER_DONE
;

549  
FINALIZER_TRY_AGAIN
;

550 
	}
}

552 
ALWAYS_INLINE
 
lwª_h‰p_¡©us_t


553 
	$»ad_»que¡
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

555  
	`»ad_äom_»que¡_sock‘
(
»que¡
, &
h–³r
->
bufãr
,

556 
DEFAULT_BUFFER_SIZE
, 
»ad_»que¡_fš®iz”
);

557 
	}
}

559 
lwª_»ad_fš®iz”_t


560 
»ad_po¡_d©a_fš®iz”
(
size_t
 
tÙ®_»ad
, size_ˆ
bufãr_size
,

561 
lwª_v®ue_t
 *
bufãr
 
__©Œibu‹__
((
unu£d
)))

563 ià(
LIKELY
(
tÙ®_»ad
 =ğ
bufãr_size
))

564  
FINALIZER_DONE
;

565  
	gFINALIZER_YIELD_TRY_AGAIN
;

568 
lwª_h‰p_¡©us_t


569 
	$»ad_po¡_d©a
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
, 

570 *
bufãr
)

572 
·r£d_Ëngth
;

574 ià(!
h–³r
->
cÚ‹Á_Ëngth
.
v®ue
)

575  
HTTP_BAD_REQUEST
;

576 
·r£d_Ëngth
 = 
	`·r£_lÚg
(
h–³r
->
cÚ‹Á_Ëngth
.
v®ue
, 
DEFAULT_BUFFER_SIZE
);

577 ià(
	`UNLIKELY
(
·r£d_Ëngth
 > 
DEFAULT_BUFFER_SIZE
))

578  
HTTP_TOO_LARGE
;

579 ià(
	`UNLIKELY
(
·r£d_Ëngth
 < 0))

580  
HTTP_BAD_REQUEST
;

582 
size_t
 
po¡_d©a_size
 = (size_t)
·r£d_Ëngth
;

583 
size_t
 
cu¼_po¡_d©a_Ën
 =

584 (
h–³r
->
bufãr
.
Ën
 - (
size_t
)(bufã¸- h–³r->bufãr.
v®ue
));

585 ià(
cu¼_po¡_d©a_Ën
 =ğ
po¡_d©a_size
) {

586 
h–³r
->
po¡_d©a
.
v®ue
 = 
bufãr
;

587 
h–³r
->
po¡_d©a
.
Ën
 = (
size_t
)
po¡_d©a_size
;

589  
HTTP_OK
;

592 
h–³r
->
po¡_d©a
.
v®ue
 = 
	`cÜo_m®loc
(
»que¡
->
cÚn
->
cÜo
, (
size_t
)
po¡_d©a_size
);

593 ià(!
h–³r
->
po¡_d©a
.
v®ue
)

594  
HTTP_INTERNAL_ERROR
;

596 
	`memıy
(
h–³r
->
po¡_d©a
.
v®ue
, 
bufãr
, (
size_t
)
cu¼_po¡_d©a_Ën
);

597 
h–³r
->
po¡_d©a
.
Ën
 = (
size_t
)
cu¼_po¡_d©a_Ën
;

598 
h–³r
->
po¡_d©a
.
v®ue
 +ğ
cu¼_po¡_d©a_Ën
;

600 
lwª_h‰p_¡©us_t
 
¡©us
 = 
	`»ad_äom_»que¡_sock‘
(
»que¡
,

601 &
h–³r
->
po¡_d©a
,

602 
po¡_d©a_size
 - 
cu¼_po¡_d©a_Ën
,

603 
»ad_po¡_d©a_fš®iz”
);

604 ià(
¡©us
 !ğ
HTTP_OK
)

605  
¡©us
;

607 
h–³r
->
po¡_d©a
.
v®ue
 -ğ
cu¼_po¡_d©a_Ën
;

608  
HTTP_OK
;

609 
	}
}

611 
lwª_h‰p_¡©us_t


612 
	$·r£_h‰p_»que¡
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»que¡_·r£_t
 *
h–³r
)

614 *
bufãr
;

616 
bufãr
 = 
	`ignÜe_Ëadšg_wh™e¥aû
(
h–³r
->bufãr.
v®ue
);

617 ià(
	`UNLIKELY
(!*
bufãr
))

618  
HTTP_BAD_REQUEST
;

620 
bufãr
 = 
	`id’tify_h‰p_m‘hod
(
»que¡
, buffer);

621 ià(
	`UNLIKELY
(!
bufãr
))

622  
HTTP_NOT_ALLOWED
;

624 
bufãr
 = 
	`id’tify_h‰p_·th
(
»que¡
, bufãr, 
h–³r
);

625 ià(
	`UNLIKELY
(!
bufãr
))

626  
HTTP_BAD_REQUEST
;

628 
bufãr
 = 
	`·r£_h—d”s
(
h–³r
, bufãr, h–³r->bufãr.
v®ue
 + h–³r->bufãr.
Ën
);

629 ià(
	`UNLIKELY
(!
bufãr
))

630  
HTTP_BAD_REQUEST
;

632 
size_t
 
decoded_Ën
 = 
	`u¾_decode
(
»que¡
->
u¾
.
v®ue
);

633 ià(
	`UNLIKELY
(!
decoded_Ën
))

634  
HTTP_BAD_REQUEST
;

635 
»que¡
->
Üigš®_u¾
.
Ën
 =„eque¡->
u¾
.ËÀğ
decoded_Ën
;

637 
	`compu‹_k“p_®ive_æag
(
»que¡
, 
h–³r
);

639 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_POST
) {

640 
lwª_h‰p_¡©us_t
 
¡©us
 = 
	`»ad_po¡_d©a
(
»que¡
, 
h–³r
, 
bufãr
);

641 ià(
	`UNLIKELY
(
¡©us
 !ğ
HTTP_OK
))

642  
¡©us
;

645  
HTTP_OK
;

646 
	}
}

648 
lwª_h‰p_¡©us_t


649 
	$´•¬e_fÜ_»¥Ú£
(
lwª_u¾_m­_t
 *
u¾_m­
,

650 
lwª_»que¡_t
 *
»que¡
,

651 
lwª_»que¡_·r£_t
 *
h–³r
)

653 ià(
u¾_m­
->
æags
 & 
HANDLER_PARSE_QUERY_STRING
)

654 
	`·r£_qu”y_¡ršg
(
»que¡
, 
h–³r
);

656 ià(
u¾_m­
->
æags
 & 
HANDLER_PARSE_IF_MODIFIED_SINCE
)

657 
	`·r£_if_modif›d_sšû
(
»que¡
, 
h–³r
);

659 ià(
u¾_m­
->
æags
 & 
HANDLER_PARSE_RANGE
)

660 
	`·r£_¿nge
(
»que¡
, 
h–³r
);

662 ià(
u¾_m­
->
æags
 & 
HANDLER_PARSE_ACCEPT_ENCODING
)

663 
	`·r£_acû±_’codšg
(
»que¡
, 
h–³r
);

665 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_POST
) {

666 ià(
u¾_m­
->
æags
 & 
HANDLER_PARSE_POST_DATA
)

667 
	`·r£_po¡_d©a
(
»que¡
, 
h–³r
);

669  
HTTP_NOT_ALLOWED
;

672 ià(
u¾_m­
->
æags
 & 
HANDLER_MUST_AUTHORIZE
) {

673 ià(!
	`lwª_h‰p_authÜize
(
»que¡
,

674 &
h–³r
->
authÜiz©iÚ
,

675 
u¾_m­
->
authÜiz©iÚ
.
»®m
,

676 
u¾_m­
->
authÜiz©iÚ
.
·sswÜd_fe
))

677  
HTTP_NOT_AUTHORIZED
;

680 ià(
u¾_m­
->
æags
 & 
HANDLER_REMOVE_LEADING_SLASH
) {

681 *
»que¡
->
u¾
.
v®ue
 =ğ'/' &&„eque¡->u¾.
Ën
 > 0) {

682 ++
»que¡
->
u¾
.
v®ue
;

683 --
»que¡
->
u¾
.
Ën
;

687  
HTTP_OK
;

688 
	}
}

691 
	$lwª_´oûss_»que¡
(
lwª_t
 *
l
, 
lwª_»que¡_t
 *
»que¡
)

693 
lwª_h‰p_¡©us_t
 
¡©us
;

694 
lwª_u¾_m­_t
 *
u¾_m­
;

695 
bufãr
[
DEFAULT_BUFFER_SIZE
];

696 
lwª_»que¡_·r£_t
 
h–³r
 = {

697 .
bufãr
 = {

698 .
v®ue
 = 
bufãr
,

699 .
Ën
 = 0

703 
¡©us
 = 
	`»ad_»que¡
(
»que¡
, &
h–³r
);

704 ià(
	`UNLIKELY
(
¡©us
 !ğ
HTTP_OK
)) {

706 ià(
¡©us
 !ğ
HTTP_BAD_REQUEST
)

707 
	`lwª_deçuÉ_»¥Ú£
(
»que¡
, 
¡©us
);

712 
¡©us
 = 
	`·r£_h‰p_»que¡
(
»que¡
, &
h–³r
);

713 ià(
	`UNLIKELY
(
¡©us
 !ğ
HTTP_OK
)) {

714 
	`lwª_deçuÉ_»¥Ú£
(
»que¡
, 
¡©us
);

718 
u¾_m­
 = 
	`lwª_Œ›_lookup_´efix
(
l
->
u¾_m­_Œ›
, 
»que¡
->
u¾
.
v®ue
);

719 ià(
	`UNLIKELY
(!
u¾_m­
)) {

720 
	`lwª_deçuÉ_»¥Ú£
(
»que¡
, 
HTTP_NOT_FOUND
);

724 
»que¡
->
u¾
.
v®ue
 +ğ
u¾_m­
->
´efix_Ën
;

725 
»que¡
->
u¾
.
Ën
 -ğ
u¾_m­
->
´efix_Ën
;

727 
¡©us
 = 
	`´•¬e_fÜ_»¥Ú£
(
u¾_m­
, 
»que¡
, &
h–³r
);

728 ià(
	`UNLIKELY
(
¡©us
 !ğ
HTTP_OK
)) {

729 
	`lwª_deçuÉ_»¥Ú£
(
»que¡
, 
¡©us
);

733 
¡©us
 = 
u¾_m­
->
	`hªdËr
(
»que¡
, &»que¡->
»¥Ú£
, u¾_m­->
d©a
);

734 
	`lwª_»¥Ú£
(
»que¡
, 
¡©us
);

735 
	}
}

738 
	$v®ue_¬¿y_b£¬ch
(
lwª_key_v®ue_t
 *
ba£
, cÚ¡ 
size_t
 
Ën
, cÚ¡ *
key
)

740 ià(
	`UNLIKELY
(!
Ën
))

741  
NULL
;

743 
size_t
 
low”_bound
 = 0;

744 
size_t
 
uµ”_bound
 = 
Ën
;

745 
size_t
 
key_Ën
 = 
	`¡¾’
(
key
);

747 
low”_bound
 < 
uµ”_bound
) {

749 
size_t
 
idx
 = (
low”_bound
 + 
uµ”_bound
) / 2;

750 
lwª_key_v®ue_t
 *
±r
 = 
ba£
 + 
idx
;

751 
cmp
 = 
	`¡ºcmp
(
key
, 
±r
->key, 
key_Ën
);

752 ià(
	`LIKELY
(!
cmp
))

753  
±r
->
v®ue
;

754 ià(
cmp
 > 0)

755 
low”_bound
 = 
idx
 + 1;

757 
uµ”_bound
 = 
idx
;

760  
NULL
;

761 
	}
}

763 
ALWAYS_INLINE
 const *

764 
	$lwª_»que¡_g‘_qu”y_·¿m
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
key
)

766  
	`v®ue_¬¿y_b£¬ch
(
»que¡
->
qu”y_·¿ms
.
ba£
,

767 
»que¡
->
qu”y_·¿ms
.
Ën
, 
key
);

768 
	}
}

770 
ALWAYS_INLINE
 const *

771 
	$lwª_»que¡_g‘_po¡_·¿m
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
key
)

773  
	`v®ue_¬¿y_b£¬ch
(
»que¡
->
po¡_d©a
.
ba£
,

774 
»que¡
->
po¡_d©a
.
Ën
, 
key
);

775 
	}
}

777 
ALWAYS_INLINE
 

778 
	$lwª_cÚÃùiÚ_g‘_fd
(
lwª_cÚÃùiÚ_t
 *
cÚn
)

780  ()(
±rdiff_t
)(
cÚn
 - cÚn->
th»ad
->
lwª
->
cÚns
);

781 
	}
}

784 
	$lwª_»que¡_g‘_»mÙe_add»ss
(
lwª_»que¡_t
 *
»que¡
,

785 
bufãr
[
INET6_ADDRSTRLEN
])

787 
sockaddr_¡Üage
 
sock_addr
 = { 0 };

788 
sockËn_t
 
sock_Ën
 = (
sockaddr_¡Üage
);

789 ià(
	`UNLIKELY
(
	`g‘³”Çme
(
»que¡
->
fd
, (
sockaddr
 *)&
sock_addr
, &
sock_Ën
) < 0))

790  
NULL
;

792 ià(
sock_addr
.
ss_çmy
 =ğ
AF_INET
)

793  
	`š‘_Áİ
(
AF_INET
, &((
sockaddr_š
 *)&
sock_addr
)->
sš_addr
,

794 
bufãr
, 
INET6_ADDRSTRLEN
);

795  
	`š‘_Áİ
(
AF_INET6
, &((
sockaddr_š6
 *)&
sock_addr
)->
sš6_addr
,

796 
bufãr
, 
INET6_ADDRSTRLEN
);

797 
	}
}

	@common/lwan-response.c

20 
	#_GNU_SOURCE


	)

21 
	~<as£¹.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/uio.h
>

24 
	~<uni¡d.h
>

25 
	~<Ãtš‘/š.h
>

27 
	~"št-to-¡r.h
"

28 
	~"lwª.h
"

29 
	~"lwª-io-w¿µ”s.h
"

30 
	~"lwª-‹m¶©e.h
"

32 
lwª_l_t
 *
	g”rÜ_‹m¶©e
 = 
NULL
;

34 cÚ¡ *
	g”rÜ_‹m¶©e_¡r
 = "<html><head><style>" \

59 
	s”rÜ_‹m¶©e_t
 {

60 cÚ¡ *
	mshÜt_mes§ge
;

61 cÚ¡ *
	mlÚg_mes§ge
;

65 
	$lwª_»¥Ú£_š™
()

67 
lwª_v¬_desütÜ_t
 
”rÜ_desütÜ
[] = {

68 
	`TPL_VAR_STR
(
”rÜ_‹m¶©e_t
, 
shÜt_mes§ge
),

69 
	`TPL_VAR_STR
(
”rÜ_‹m¶©e_t
, 
lÚg_mes§ge
),

70 
TPL_VAR_SENTINEL


73 
	`as£¹
(!
”rÜ_‹m¶©e
);

75 
	`lwª_¡©us_debug
("Initializing default„esponse");

77 
”rÜ_‹m¶©e
 = 
	`lwª_l_compe_¡ršg
(
”rÜ_‹m¶©e_¡r
, 
”rÜ_desütÜ
);

78 ià(
	`UNLIKELY
(!
”rÜ_‹m¶©e
))

79 
	`lwª_¡©us_ü™iÿl_³¼Ü
("lwan_tpl_compile_string");

80 
	}
}

83 
	$lwª_»¥Ú£_shutdown
()

85 
	`lwª_¡©us_debug
("Shutting down„esponse");

86 
	`as£¹
(
”rÜ_‹m¶©e
);

87 
	`lwª_l_ä“
(
”rÜ_‹m¶©e
);

88 
	}
}

90 #iâdeà
NDEBUG


92 
	$g‘_»que¡_m‘hod
(
lwª_»que¡_t
 *
»que¡
)

94 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_GET
)

96 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_HEAD
)

98 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_POST
)

101 
	}
}

104 
	$log_»que¡
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
)

106 
_bufãr
[
INET6_ADDRSTRLEN
];

108 
	`lwª_¡©us_debug
("%s \"%s %s HTTP/%s\" %d %s",

109 
	`lwª_»que¡_g‘_»mÙe_add»ss
(
»que¡
, 
_bufãr
),

110 
	`g‘_»que¡_m‘hod
(
»que¡
),

111 
»que¡
->
Üigš®_u¾
.
v®ue
,

112 
»que¡
->
æags
 & 
REQUEST_IS_HTTP_1_0
 ? "1.0" : "1.1",

113 
¡©us
,

114 
»que¡
->
»¥Ú£
.
mime_ty³
);

115 
	}
}

117 
	#log_»que¡
(...)

	)

121 
	$lwª_»¥Ú£
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
)

123 
h—d”s
[
DEFAULT_HEADERS_SIZE
];

125 ià(
»que¡
->
æags
 & 
RESPONSE_CHUNKED_ENCODING
) {

127 ià(
	`UNLIKELY
(!
	`¡rbuf_»£t_Ëngth
(
»que¡
->
»¥Ú£
.
bufãr
)))

128 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

129 
	`lwª_»¥Ú£_£nd_chunk
(
»que¡
);

130 
	`log_»que¡
(
»que¡
, 
¡©us
);

134 ià(
	`UNLIKELY
(
»que¡
->
æags
 & 
RESPONSE_SENT_HEADERS
)) {

135 
	`lwª_¡©us_debug
("Headers‡lready sent, ignoring call");

141 ià(
	`UNLIKELY
(!
»que¡
->
»¥Ú£
.
mime_ty³
)) {

142 
	`lwª_deçuÉ_»¥Ú£
(
»que¡
, 
¡©us
);

146 
	`log_»que¡
(
»que¡
, 
¡©us
);

148 ià(
»que¡
->
»¥Ú£
.
¡»am
.
ÿÎback
) {

149 
lwª_h‰p_¡©us_t
 
ÿÎback_¡©us
;

151 
ÿÎback_¡©us
 = 
»que¡
->
»¥Ú£
.
¡»am
.
	`ÿÎback
(request,

152 
»que¡
->
»¥Ú£
.
¡»am
.
d©a
);

154 
»que¡
->
»¥Ú£
.
¡»am
.
ÿÎback
 = 
NULL
;

156 ià(
ÿÎback_¡©us
 >ğ
HTTP_BAD_REQUEST
)

157 
	`lwª_deçuÉ_»¥Ú£
(
»que¡
, 
ÿÎback_¡©us
);

161 
size_t
 
h—d”_Ën
 = 
	`lwª_´•¬e_»¥Ú£_h—d”
(
»que¡
, 
¡©us
, 
h—d”s
, (headers));

162 ià(
	`UNLIKELY
(!
h—d”_Ën
)) {

163 
	`lwª_deçuÉ_»¥Ú£
(
»que¡
, 
HTTP_INTERNAL_ERROR
);

167 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_HEAD
) {

168 
	`lwª_wr™e
(
»que¡
, 
h—d”s
, 
h—d”_Ën
);

172 
iovec
 
»¥Ú£_vec
[] = {

173 { .
iov_ba£
 = 
h—d”s
, .
iov_Ën
 = 
h—d”_Ën
 },

174 { .
iov_ba£
 = 
	`¡rbuf_g‘_bufãr
(
»que¡
->
»¥Ú£
.
bufãr
), .
iov_Ën
 = 
	`¡rbuf_g‘_Ëngth
(request->response.buffer) }

177 
	`lwª_wr™ev
(
»que¡
, 
»¥Ú£_vec
, 
	`N_ELEMENTS
(response_vec));

178 
	}
}

181 
	$lwª_deçuÉ_»¥Ú£
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
)

183 
»que¡
->
»¥Ú£
.
mime_ty³
 = "text/html";

185 
	`lwª_l_­¶y_w™h_bufãr
(
”rÜ_‹m¶©e
, 
»que¡
->
»¥Ú£
.
bufãr
,

186 (
”rÜ_‹m¶©e_t
[]) {{

187 .
shÜt_mes§ge
 = 
	`lwª_h‰p_¡©us_as_¡ršg
(
¡©us
),

188 .
lÚg_mes§ge
 = 
	`lwª_h‰p_¡©us_as_desütive_¡ršg
(
¡©us
)

191 
	`lwª_»¥Ú£
(
»que¡
, 
¡©us
);

192 
	}
}

194 
	#RETURN_0_ON_OVERFLOW
(
Ën_
) \

195 ià(
	`UNLIKELY
(
p_h—d”s
 + (
Ën_
è>ğ
p_h—d”s_’d
)è 0

	)

197 
	#APPEND_STRING_LEN
(
cÚ¡_¡r_
,
Ën_
) \

199 
	`RETURN_0_ON_OVERFLOW
(
Ën_
); \

200 
p_h—d”s
 = 
	`mempıy
Õ_h—d”s, (
cÚ¡_¡r_
), (
Ën_
)); \

201 } 0)

	)

203 
	#APPEND_STRING
(
¡r_
) \

205 
size_t
 
Ën
 = 
	`¡¾’
(
¡r_
); \

206 
	`APPEND_STRING_LEN
((
¡r_
), 
Ën
); \

207 } 0)

	)

209 
	#APPEND_CHAR
(
v®ue_
) \

211 
	`RETURN_0_ON_OVERFLOW
(1); \

212 *
p_h—d”s
++ = (
v®ue_
); \

213 } 0)

	)

215 
	#APPEND_CHAR_NOCHECK
(
v®ue_
) \

216 *
p_h—d”s
++ = (
v®ue_
)

	)

218 
	#APPEND_UINT
(
v®ue_
) \

220 
size_t
 
Ën
; \

221 *
tmp
 = 
	`ušt_to_¡ršg
((
v®ue_
), 
bufãr
, &
Ën
); \

222 
	`RETURN_0_ON_OVERFLOW
(
Ën
); \

223 
	`APPEND_STRING_LEN
(
tmp
, 
Ën
); \

224 } 0)

	)

226 
	#APPEND_CONSTANT
(
cÚ¡_¡r_
) \

227 
	`APPEND_STRING_LEN
((
cÚ¡_¡r_
), (cÚ¡_¡r_è- 1)

	)

229 
ALWAYS_INLINE
 
size_t


230 
	$lwª_´•¬e_»¥Ú£_h—d”
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
, 
h—d”s
[], 
size_t
 
h—d”s_buf_size
)

232 *
p_h—d”s
;

233 *
p_h—d”s_’d
 = 
h—d”s
 + 
h—d”s_buf_size
;

234 
bufãr
[
INT_TO_STR_BUFFER_SIZE
];

235 
boŞ
 
d©e_ov”ridd’
 = 
çl£
;

236 
boŞ
 
expœes_ov”ridd’
 = 
çl£
;

238 
p_h—d”s
 = 
h—d”s
;

240 ià(
»que¡
->
æags
 & 
REQUEST_IS_HTTP_1_0
)

241 
	`APPEND_CONSTANT
("HTTP/1.0 ");

243 
	`APPEND_CONSTANT
("HTTP/1.1 ");

244 
	`APPEND_STRING
(
	`lwª_h‰p_¡©us_as_¡ršg_w™h_code
(
¡©us
));

246 ià(
»que¡
->
æags
 & 
RESPONSE_CHUNKED_ENCODING
) {

247 
	`APPEND_CONSTANT
("\r\nTransfer-Encoding: chunked");

248 } ià(
»que¡
->
æags
 & 
RESPONSE_NO_CONTENT_LENGTH
) {

251 
	`APPEND_CONSTANT
("\r\nContent-Length: ");

252 ià(
»que¡
->
»¥Ú£
.
¡»am
.
ÿÎback
)

253 
	`APPEND_UINT
(
»que¡
->
»¥Ú£
.
cÚ‹Á_Ëngth
);

255 
	`APPEND_UINT
(
	`¡rbuf_g‘_Ëngth
(
»que¡
->
»¥Ú£
.
bufãr
));

258 
	`APPEND_CONSTANT
("\r\nContent-Type: ");

259 
	`APPEND_STRING
(
»que¡
->
»¥Ú£
.
mime_ty³
);

261 ià(
»que¡
->
cÚn
->
æags
 & 
CONN_KEEP_ALIVE
)

262 
	`APPEND_CONSTANT
("\r\nConnection: keep-alive");

264 
	`APPEND_CONSTANT
("\r\nConnection: close");

266 ià((
¡©us
 < 
HTTP_BAD_REQUEST
 && 
»que¡
->
»¥Ú£
.
h—d”s
)) {

267 
lwª_key_v®ue_t
 *
h—d”
;

269 
h—d”
 = 
»que¡
->
»¥Ú£
.
h—d”s
; h—d”->
key
; header++) {

270 ià(
	`UNLIKELY
(!
	`¡rcmp
(
h—d”
->
key
, "Server")))

272 ià(
	`UNLIKELY
(!
	`¡rcmp
(
h—d”
->
key
, "Date")))

273 
d©e_ov”ridd’
 = 
Œue
;

274 ià(
	`UNLIKELY
(!
	`¡rcmp
(
h—d”
->
key
, "Expires")))

275 
expœes_ov”ridd’
 = 
Œue
;

277 
	`RETURN_0_ON_OVERFLOW
(4);

278 
	`APPEND_CHAR_NOCHECK
('\r');

279 
	`APPEND_CHAR_NOCHECK
('\n');

280 
	`APPEND_STRING
(
h—d”
->
key
);

281 
	`APPEND_CHAR_NOCHECK
(':');

282 
	`APPEND_CHAR_NOCHECK
(' ');

283 
	`APPEND_STRING
(
h—d”
->
v®ue
);

285 } ià(
¡©us
 =ğ
HTTP_NOT_AUTHORIZED
) {

286 
lwª_key_v®ue_t
 *
h—d”
;

288 
h—d”
 = 
»que¡
->
»¥Ú£
.
h—d”s
; h—d”->
key
; header++) {

289 ià(!
	`¡rcmp
(
h—d”
->
key
, "WWW-Authenticate")) {

290 
	`APPEND_CONSTANT
("\r\nWWW-Authenticate: ");

291 
	`APPEND_STRING
(
h—d”
->
v®ue
);

297 ià(
	`LIKELY
(!
d©e_ov”ridd’
)) {

298 
	`APPEND_CONSTANT
("\r\nDate: ");

299 
	`APPEND_STRING_LEN
(
»que¡
->
cÚn
->
th»ad
->
d©e
.date, 29);

302 ià(
	`LIKELY
(!
expœes_ov”ridd’
)) {

303 
	`APPEND_CONSTANT
("\r\nExpires: ");

304 
	`APPEND_STRING_LEN
(
»que¡
->
cÚn
->
th»ad
->
d©e
.
expœes
, 29);

307 
	`APPEND_CONSTANT
("\r\nServer:†wan\r\n\r\n\0");

309  (
size_t
)(
p_h—d”s
 - 
h—d”s
 - 1);

310 
	}
}

312 #undeà
APPEND_CHAR


313 #undeà
APPEND_CHAR_NOCHECK


314 #undeà
APPEND_CONSTANT


315 #undeà
APPEND_STRING


316 #undeà
APPEND_STRING_LEN


317 #undeà
APPEND_UINT


318 #undeà
RETURN_0_ON_OVERFLOW


320 
boŞ


321 
	$lwª_»¥Ú£_£t_chunked
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
)

323 
bufãr
[
DEFAULT_BUFFER_SIZE
];

324 
size_t
 
bufãr_Ën
;

326 ià(
»que¡
->
æags
 & 
RESPONSE_SENT_HEADERS
)

327  
çl£
;

329 
»que¡
->
æags
 |ğ
RESPONSE_CHUNKED_ENCODING
;

330 
bufãr_Ën
 = 
	`lwª_´•¬e_»¥Ú£_h—d”
(
»que¡
, 
¡©us
,

331 
bufãr
, 
DEFAULT_BUFFER_SIZE
);

332 ià(
	`UNLIKELY
(!
bufãr_Ën
))

333  
çl£
;

335 
»que¡
->
æags
 |ğ
RESPONSE_SENT_HEADERS
;

336 
	`lwª_£nd
(
»que¡
, 
bufãr
, 
bufãr_Ën
, 
MSG_MORE
);

338  
Œue
;

339 
	}
}

342 
	$lwª_»¥Ú£_£nd_chunk
(
lwª_»que¡_t
 *
»que¡
)

344 ià(!(
»que¡
->
æags
 & 
RESPONSE_SENT_HEADERS
)) {

345 ià(
	`UNLIKELY
(!
	`lwª_»¥Ú£_£t_chunked
(
»que¡
, 
HTTP_OK
)))

349 
size_t
 
bufãr_Ën
 = 
	`¡rbuf_g‘_Ëngth
(
»que¡
->
»¥Ú£
.
bufãr
);

350 ià(
	`UNLIKELY
(!
bufãr_Ën
)) {

351 cÚ¡ 
Ï¡_chunk
[] = "0\r\n\r\n";

352 
	`lwª_£nd
(
»que¡
, 
Ï¡_chunk
, (last_chunk) - 1, 0);

356 
chunk_size
[3 * (
size_t
) + 2];

357 
cÚv”‹d_Ën
 = 
	`¢´štf
(
chunk_size
, (chunk_size), "%zx\r\n", 
bufãr_Ën
);

358 ià(
	`UNLIKELY
(
cÚv”‹d_Ën
 < 0))

359 
abÜt_cÜo
;

360 
size_t
 
chunk_size_Ën
 = (size_t)
cÚv”‹d_Ën
;

362 
iovec
 
chunk_vec
[] = {

363 { .
iov_ba£
 = 
chunk_size
, .
iov_Ën
 = 
chunk_size_Ën
 },

364 { .
iov_ba£
 = 
	`¡rbuf_g‘_bufãr
(
»que¡
->
»¥Ú£
.
bufãr
), .
iov_Ën
 = 
bufãr_Ën
 },

365 { .
iov_ba£
 = "\r\n", .
iov_Ën
 = 2 }

368 
	`lwª_wr™ev
(
»que¡
, 
chunk_vec
, 
	`N_ELEMENTS
(chunk_vec));

370 ià(
	`LIKELY
(
	`¡rbuf_»£t_Ëngth
(
»que¡
->
»¥Ú£
.
bufãr
))) {

371 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

375 
abÜt_cÜo
:

376 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

377 
	`__butš_uÄ—chabË
();

378 
	}
}

380 
boŞ


381 
	$lwª_»¥Ú£_£t_ev’t_¡»am
(
lwª_»que¡_t
 *
»que¡
,

382 
lwª_h‰p_¡©us_t
 
¡©us
)

384 
bufãr
[
DEFAULT_BUFFER_SIZE
];

385 
size_t
 
bufãr_Ën
;

387 ià(
»que¡
->
æags
 & 
RESPONSE_SENT_HEADERS
)

388  
çl£
;

390 
»que¡
->
»¥Ú£
.
mime_ty³
 = "text/event-stream";

391 
»que¡
->
æags
 |ğ
RESPONSE_NO_CONTENT_LENGTH
;

392 
bufãr_Ën
 = 
	`lwª_´•¬e_»¥Ú£_h—d”
(
»que¡
, 
¡©us
,

393 
bufãr
, 
DEFAULT_BUFFER_SIZE
);

394 ià(
	`UNLIKELY
(!
bufãr_Ën
))

395  
çl£
;

397 
»que¡
->
æags
 |ğ
RESPONSE_SENT_HEADERS
;

398 
	`lwª_£nd
(
»que¡
, 
bufãr
, 
bufãr_Ën
, 
MSG_MORE
);

400  
Œue
;

401 
	}
}

404 
	$lwª_»¥Ú£_£nd_ev’t
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
ev’t
)

406 ià(!(
»que¡
->
æags
 & 
RESPONSE_SENT_HEADERS
)) {

407 ià(
	`UNLIKELY
(!
	`lwª_»¥Ú£_£t_ev’t_¡»am
(
»que¡
, 
HTTP_OK
)))

411 
iovec
 
vec
[6];

412 
Ï¡
 = 0;

414 ià(
ev’t
) {

415 
vec
[
Ï¡
].
iov_ba£
 = "event: ";

416 
vec
[
Ï¡
].
iov_Ën
 = ("event: ") - 1;

417 
Ï¡
++;

419 
vec
[
Ï¡
].
iov_ba£
 = (*)
ev’t
;

420 
vec
[
Ï¡
].
iov_Ën
 = 
	`¡¾’
(
ev’t
);

421 
Ï¡
++;

423 
vec
[
Ï¡
].
iov_ba£
 = "\r\n";

424 
vec
[
Ï¡
].
iov_Ën
 = 2;

425 
Ï¡
++;

428 
size_t
 
bufãr_Ën
 = 
	`¡rbuf_g‘_Ëngth
(
»que¡
->
»¥Ú£
.
bufãr
);

429 ià(
bufãr_Ën
) {

430 
vec
[
Ï¡
].
iov_ba£
 = "data: ";

431 
vec
[
Ï¡
].
iov_Ën
 = ("data: ") - 1;

432 
Ï¡
++;

434 
vec
[
Ï¡
].
iov_ba£
 = 
	`¡rbuf_g‘_bufãr
(
»que¡
->
»¥Ú£
.
bufãr
);

435 
vec
[
Ï¡
].
iov_Ën
 = 
bufãr_Ën
;

436 
Ï¡
++;

440 
vec
[
Ï¡
].
iov_ba£
 = "\r\n\r\n";

441 
vec
[
Ï¡
].
iov_Ën
 = 4;

442 
Ï¡
++;

444 
	`lwª_wr™ev
(
»que¡
, 
vec
, 
Ï¡
);

446 ià(
	`UNLIKELY
(!
	`¡rbuf_»£t_Ëngth
(
»que¡
->
»¥Ú£
.
bufãr
))) {

447 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_ABORT
);

448 
	`__butš_uÄ—chabË
();

451 
	`cÜo_y›ld
(
»que¡
->
cÚn
->
cÜo
, 
CONN_CORO_MAY_RESUME
);

452 
	}
}

	@common/lwan-serve-files.c

20 
	#_GNU_SOURCE


	)

21 
	~<dœ’t.h
>

22 
	~<”ºo.h
>

23 
	~<fú.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

26 
	~<sys/mmª.h
>

27 
	~<sys/¡©.h
>

28 
	~<zlib.h
>

30 
	~"lwª.h
"

31 
	~"lwª-ÿche.h
"

32 
	~"lwª-io-w¿µ”s.h
"

33 
	~"lwª-£rve-fes.h
"

34 
	~"lwª-‹m¶©e.h
"

35 
	~"»®·th©.h
"

36 
	~"hash.h
"

38 
	#SET_NTH_HEADER
(
numb”_
, 
key_
, 
v®ue_
) \

40 
h—d”s
[
numb”_
].
key
 = (
key_
); \

41 
h—d”s
[
numb”_
].
v®ue
 = (
v®ue_
); \

42 } 0)

	)

44 
£rve_fes_´iv_t_
 
	t£rve_fes_´iv_t
;

45 
fe_ÿche_’Œy_t_
 
	tfe_ÿche_’Œy_t
;

46 
ÿche_funcs_t_
 
	tÿche_funcs_t
;

47 
mm­_ÿche_d©a_t_
 
	tmm­_ÿche_d©a_t
;

48 
£ndfe_ÿche_d©a_t_
 
	t£ndfe_ÿche_d©a_t
;

49 
dœ_li¡_ÿche_d©a_t_
 
	tdœ_li¡_ÿche_d©a_t
;

50 
»dœ_ÿche_d©a_t_
 
	t»dœ_ÿche_d©a_t
;

52 
	s£rve_fes_´iv_t_
 {

54 *
	m·th
;

55 
size_t
 
	m·th_Ën
;

56 
	mfd
;

57 } 
	mroÙ
;

59 
	mİ’_mode
;

60 cÚ¡ *
	mšdex_html
;

62 
ÿche_t
 *
	mÿche
;

63 
lwª_l_t
 *
	mdœeùÜy_li¡_l
;

66 
	sÿche_funcs_t_
 {

67 
lwª_h‰p_¡©us_t
 (*
£rve
)(
lwª_»que¡_t
 *
	m»que¡
,

68 *
	md©a
);

69 
boŞ
 (*
š™
)(
fe_ÿche_’Œy_t
 *
	mû
,

70 
£rve_fes_´iv_t
 *
	m´iv
,

71 cÚ¡ *
	mfuÎ_·th
,

72 
¡©
 *
	m¡
);

73 (*
	mä“
)(*
	md©a
);

74 
size_t
 
	m¡ruù_size
;

77 
	smm­_ÿche_d©a_t_
 {

79 *
	mcÚ‹Ás
;

81 
	msize
;

82 } 
	mcom´es£d
, 
	muncom´es£d
;

85 
	s£ndfe_ÿche_d©a_t_
 {

92 *
	mf’ame
;

93 
size_t
 
	msize
;

96 
	sdœ_li¡_ÿche_d©a_t_
 {

97 
¡rbuf_t
 *
	m»nd”ed
;

100 
	s»dœ_ÿche_d©a_t_
 {

101 *
	m»dœ_to
;

104 
	sfe_ÿche_’Œy_t_
 {

105 
ÿche_’Œy_t
 
	mba£
;

108 
	m¡ršg
[31];

109 
time_t
 
	mš‹g”
;

110 } 
	mÏ¡_modif›d
;

112 cÚ¡ *
	mmime_ty³
;

113 cÚ¡ 
ÿche_funcs_t
 *
	mfuncs
;

116 
	sfe_li¡_t
 {

117 cÚ¡ *
	mfuÎ_·th
;

118 cÚ¡ *
	m»l_·th
;

120 
lwª_l_li¡_g’”©Ü_t
 
	mg’”©Ü
;

122 cÚ¡ *
	micÚ
;

123 cÚ¡ *
	micÚ_®t
;

124 cÚ¡ *
	mÇme
;

125 cÚ¡ *
	mty³
;

127 
	msize
;

128 cÚ¡ *
	mun™
;

129 } 
	mfe_li¡
;

132 
dœeùÜy_li¡_g’”©Ü
(
cÜo_t
 *
cÜo
);

134 
boŞ
 
mm­_š™
(
fe_ÿche_’Œy_t
 *
û
, 
£rve_fes_´iv_t
 *
´iv
,

135 cÚ¡ *
fuÎ_·th
, 
¡©
 *
¡
);

136 
mm­_ä“
(*
d©a
);

137 
lwª_h‰p_¡©us_t
 
mm­_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
);

138 
boŞ
 
£ndfe_š™
(
fe_ÿche_’Œy_t
 *
û
, 
£rve_fes_´iv_t
 *
´iv
,

139 cÚ¡ *
fuÎ_·th
, 
¡©
 *
¡
);

140 
£ndfe_ä“
(*
d©a
);

141 
lwª_h‰p_¡©us_t
 
£ndfe_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
);

142 
boŞ
 
dœli¡_š™
(
fe_ÿche_’Œy_t
 *
û
, 
£rve_fes_´iv_t
 *
´iv
,

143 cÚ¡ *
fuÎ_·th
, 
¡©
 *
¡
);

144 
dœli¡_ä“
(*
d©a
);

145 
lwª_h‰p_¡©us_t
 
dœli¡_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
);

146 
boŞ
 
»dœ_š™
(
fe_ÿche_’Œy_t
 *
û
, 
£rve_fes_´iv_t
 *
´iv
,

147 cÚ¡ *
fuÎ_·th
, 
¡©
 *
¡
);

148 
»dœ_ä“
(*
d©a
);

149 
lwª_h‰p_¡©us_t
 
»dœ_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
);

152 cÚ¡ 
ÿche_funcs_t
 
	gmm­_funcs
 = {

153 .
š™
 = 
mm­_š™
,

154 .
	gä“
 = 
mm­_ä“
,

155 .
	g£rve
 = 
mm­_£rve
,

156 .
	g¡ruù_size
 = (
mm­_ÿche_d©a_t
)

159 cÚ¡ 
ÿche_funcs_t
 
	g£ndfe_funcs
 = {

160 .
š™
 = 
£ndfe_š™
,

161 .
	gä“
 = 
£ndfe_ä“
,

162 .
	g£rve
 = 
£ndfe_£rve
,

163 .
	g¡ruù_size
 = (
£ndfe_ÿche_d©a_t
)

166 cÚ¡ 
ÿche_funcs_t
 
	gdœli¡_funcs
 = {

167 .
š™
 = 
dœli¡_š™
,

168 .
	gä“
 = 
dœli¡_ä“
,

169 .
	g£rve
 = 
dœli¡_£rve
,

170 .
	g¡ruù_size
 = (
dœ_li¡_ÿche_d©a_t
)

173 cÚ¡ 
ÿche_funcs_t
 
	g»dœ_funcs
 = {

174 .
š™
 = 
»dœ_š™
,

175 .
	gä“
 = 
»dœ_ä“
,

176 .
	g£rve
 = 
»dœ_£rve
,

177 .
	g¡ruù_size
 = (
»dœ_ÿche_d©a_t
)

180 cÚ¡ 
lwª_v¬_desütÜ_t
 
	gfe_li¡_™em_desc
[] = {

181 
TPL_VAR_STR
(
fe_li¡_t
, 
fe_li¡
.
icÚ
),

182 
TPL_VAR_STR
(
fe_li¡_t
, 
fe_li¡
.
icÚ_®t
),

183 
TPL_VAR_STR_ESCAPE
(
fe_li¡_t
, 
fe_li¡
.
Çme
),

184 
TPL_VAR_STR
(
fe_li¡_t
, 
fe_li¡
.
ty³
),

185 
TPL_VAR_INT
(
fe_li¡_t
, 
fe_li¡
.
size
),

186 
TPL_VAR_STR
(
fe_li¡_t
, 
fe_li¡
.
un™
),

187 
TPL_VAR_SENTINEL


190 cÚ¡ 
lwª_v¬_desütÜ_t
 
	gfe_li¡_desc
[] = {

191 
TPL_VAR_STR_ESCAPE
(
fe_li¡_t
, 
fuÎ_·th
),

192 
TPL_VAR_STR_ESCAPE
(
fe_li¡_t
, 
»l_·th
),

193 
TPL_VAR_SEQUENCE
(
fe_li¡_t
, 
fe_li¡
,

194 
dœeùÜy_li¡_g’”©Ü
, 
fe_li¡_™em_desc
),

195 
TPL_VAR_SENTINEL


198 cÚ¡ *
	gdœeùÜy_li¡_l_¡r
 = "<html>\n"

233 
	$dœeùÜy_li¡_g’”©Ü
(
cÜo_t
 *
cÜo
)

235 
DIR
 *
dœ
;

236 
dœ’t
 
’Œy
, *
bufãr
;

237 
fe_li¡_t
 *
æ
 = 
	`cÜo_g‘_d©a
(
cÜo
);

238 
fd
;

240 
dœ
 = 
	`İ’dœ
(
æ
->
fuÎ_·th
);

241 ià(!
dœ
)

244 
fd
 = 
	`dœfd
(
dœ
);

245 ià(
fd
 < 0)

246 
out
;

248 !
	`»addœ_r
(
dœ
, &
’Œy
, &
bufãr
)) {

249 
¡©
 
¡
;

251 ià(!
bufãr
)

254 ià(
’Œy
.
d_Çme
[0] == '.')

257 ià(
	`f¡©©
(
fd
, 
’Œy
.
d_Çme
, &
¡
, 0) < 0)

260 ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

261 
æ
->
fe_li¡
.
icÚ
 = "folder";

262 
æ
->
fe_li¡
.
icÚ_®t
 = "DIR";

263 
æ
->
fe_li¡
.
ty³
 = "directory";

264 } ià(
	`S_ISREG
(
¡
.
¡_mode
)) {

265 
æ
->
fe_li¡
.
icÚ
 = "file";

266 
æ
->
fe_li¡
.
icÚ_®t
 = "FILE";

267 
æ
->
fe_li¡
.
ty³
 = 
	`lwª_d‘”mše_mime_ty³_fÜ_fe_Çme
(
’Œy
.
d_Çme
);

272 ià(
¡
.
¡_size
 < 1024) {

273 
æ
->
fe_li¡
.
size
 = ()
¡
.
¡_size
;

274 
æ
->
fe_li¡
.
un™
 = "B";

275 } ià(
¡
.
¡_size
 < 1024 * 1024) {

276 
æ
->
fe_li¡
.
size
 = ()(
¡
.
¡_size
 / 1024);

277 
æ
->
fe_li¡
.
un™
 = "KiB";

278 } ià(
¡
.
¡_size
 < 1024 * 1024 * 1024) {

279 
æ
->
fe_li¡
.
size
 = ()(
¡
.
¡_size
 / (1024 * 1024));

280 
æ
->
fe_li¡
.
un™
 = "MiB";

282 
æ
->
fe_li¡
.
size
 = ()(
¡
.
¡_size
 / (1024 * 1024 * 1024));

283 
æ
->
fe_li¡
.
un™
 = "GiB";

286 
æ
->
fe_li¡
.
Çme
 = 
’Œy
.
d_Çme
;

288 ià(
	`cÜo_y›ld
(
cÜo
, 1))

292 
out
:

293 
	`şo£dœ
(
dœ
);

295 
	}
}

298 
	$com´ess_ÿched_’Œy
(
mm­_ÿche_d©a_t
 *
md
)

300 cÚ¡ 
size_t
 
deæ©ed_h—d”_size
 = ("Content-Encoding: deflate");

302 
md
->
com´es£d
.
size
 = 
	`com´essBound
(md->
uncom´es£d
.size);

304 ià(
	`UNLIKELY
(!(
md
->
com´es£d
.
cÚ‹Ás
 = 
	`m®loc
(md->com´es£d.
size
))))

305 
”rÜ_z”o_out
;

307 ià(
	`UNLIKELY
(
	`com´ess
(
md
->
com´es£d
.
cÚ‹Ás
, &md->com´es£d.
size
,

308 
md
->
uncom´es£d
.
cÚ‹Ás
, md->uncom´es£d.
size
è!ğ
Z_OK
))

309 
”rÜ_ä“_com´es£d
;

311 ià((
md
->
com´es£d
.
size
 + 
deæ©ed_h—d”_size
è< md->
uncom´es£d
.size)

314 
”rÜ_ä“_com´es£d
:

315 
	`ä“
(
md
->
com´es£d
.
cÚ‹Ás
);

316 
md
->
com´es£d
.
cÚ‹Ás
 = 
NULL
;

317 
”rÜ_z”o_out
:

318 
md
->
com´es£d
.
size
 = 0;

319 
	}
}

321 
boŞ


322 
	$mm­_š™
(
fe_ÿche_’Œy_t
 *
û
,

323 
£rve_fes_´iv_t
 *
´iv
,

324 cÚ¡ *
fuÎ_·th
,

325 
¡©
 *
¡
)

327 
mm­_ÿche_d©a_t
 *
md
 = (mm­_ÿche_d©a_ˆ*)(
û
 + 1);

328 
fe_fd
;

329 
boŞ
 
sucûss
;

331 
fe_fd
 = 
	`İ’©
(
´iv
->
roÙ
.
fd
, 
fuÎ_·th
 +…riv->roÙ.
·th_Ën
 + 1,

332 
´iv
->
İ’_mode
);

333 ià(
	`UNLIKELY
(
fe_fd
 < 0))

334  
çl£
;

336 
md
->
uncom´es£d
.
cÚ‹Ás
 = 
	`mm­
(
NULL
, (
size_t
)
¡
->
¡_size
, 
PROT_READ
,

337 
MAP_SHARED
, 
fe_fd
, 0);

338 ià(
	`UNLIKELY
(
md
->
uncom´es£d
.
cÚ‹Ás
 =ğ
MAP_FAILED
)) {

339 
sucûss
 = 
çl£
;

340 
şo£_fe
;

343 ià(
	`UNLIKELY
(
	`madvi£
(
md
->
uncom´es£d
.
cÚ‹Ás
, (
size_t
)
¡
->
¡_size
,

344 
MADV_WILLNEED
) < 0))

345 
	`lwª_¡©us_³¼Ü
("madvise");

347 
md
->
uncom´es£d
.
size
 = (
size_t
)
¡
->
¡_size
;

348 
	`com´ess_ÿched_’Œy
(
md
);

350 
û
->
mime_ty³
 = 
	`lwª_d‘”mše_mime_ty³_fÜ_fe_Çme
(

351 
fuÎ_·th
 + 
´iv
->
roÙ
.
·th_Ën
);

353 
sucûss
 = 
Œue
;

355 
şo£_fe
:

356 
	`şo£
(
fe_fd
);

358  
sucûss
;

359 
	}
}

361 
boŞ


362 
	$£ndfe_š™
(
fe_ÿche_’Œy_t
 *
û
,

363 
£rve_fes_´iv_t
 *
´iv
,

364 cÚ¡ *
fuÎ_·th
,

365 
¡©
 *
¡
)

367 
£ndfe_ÿche_d©a_t
 *
sd
 = (£ndfe_ÿche_d©a_ˆ*)(
û
 + 1);

369 
sd
->
size
 = (
size_t
)
¡
->
¡_size
;

370 
sd
->
f’ame
 = 
	`¡rdup
(
fuÎ_·th
 + 
´iv
->
roÙ
.
·th_Ën
 + 1);

372 
û
->
mime_ty³
 = 
	`lwª_d‘”mše_mime_ty³_fÜ_fe_Çme
(

373 
fuÎ_·th
 + 
´iv
->
roÙ
.
·th_Ën
);

375  !!
sd
->
f’ame
;

376 
	}
}

378 
boŞ


379 
dœli¡_š™
(
fe_ÿche_’Œy_t
 *
û
,

380 
£rve_fes_´iv_t
 *
´iv
,

381 cÚ¡ *
fuÎ_·th
,

382 
¡©
 *
¡
 
__©Œibu‹__
((
unu£d
)))

384 
dœ_li¡_ÿche_d©a_t
 *
	gdd
 = (dœ_li¡_ÿche_d©a_ˆ*)(
û
 + 1);

385 
fe_li¡_t
 
	gv¬s
 = {

386 .
fuÎ_·th
 = full_path,

387 .
	g»l_·th
 = 
fuÎ_·th
 + 
´iv
->
roÙ
.
·th_Ën


390 
	gdd
->
	g»nd”ed
 = 
lwª_l_­¶y
(
´iv
->
dœeùÜy_li¡_l
, &
v¬s
);

391 
	gû
->
	gmime_ty³
 = "text/html";

393  !!
	gdd
->
	g»nd”ed
;

396 
boŞ


397 
»dœ_š™
(
fe_ÿche_’Œy_t
 *
û
,

398 
£rve_fes_´iv_t
 *
´iv
,

399 cÚ¡ *
fuÎ_·th
,

400 
¡©
 *
¡
 
__©Œibu‹__
((
unu£d
)))

402 
»dœ_ÿche_d©a_t
 *
	grd
 = (»dœ_ÿche_d©a_ˆ*)(
û
 + 1);

404 ià(
a¥rštf
(&
rd
->
»dœ_to
, "%s/", 
fuÎ_·th
 + 
´iv
->
roÙ
.
·th_Ën
) < 0)

405  
	gçl£
;

407 
	gû
->
	gmime_ty³
 = "text/plain";

408  
	gŒue
;

411 cÚ¡ 
ÿche_funcs_t
 *

412 
	$g‘_funcs
(
£rve_fes_´iv_t
 *
´iv
, cÚ¡ *
key
, *
fuÎ_·th
,

413 
¡©
 *
¡
)

415 
šdex_html_·th_buf
[
PATH_MAX
];

416 *
šdex_html_·th
 = 
šdex_html_·th_buf
;

418 ià(
	`S_ISDIR
(
¡
->
¡_mode
)) {

422 ià(*
key
 == '\0') {

423 
šdex_html_·th
 = (*)
´iv
->
šdex_html
;

428 cÚ¡ *
key_’d
 = 
	`¿wmemchr
(
key
, '\0');

429 ià(*(
key_’d
 - 1) != '/')

430  &
»dœ_funcs
;

432 ià(
	`UNLIKELY
(
	`¢´štf
(
šdex_html_·th
, 
PATH_MAX
, "%s%s",

433 
key
, 
´iv
->
šdex_html
) < 0))

434  
NULL
;

438 ià(
	`f¡©©
(
´iv
->
roÙ
.
fd
, 
šdex_html_·th
, 
¡
, 0) < 0) {

439 ià(
	`UNLIKELY
(
”ºo
 !ğ
ENOENT
))

440  
NULL
;

443  &
dœli¡_funcs
;

449 ià(
	`UNLIKELY
(
´iv
->
roÙ
.
·th_Ën
 + 1 +

450 
	`¡¾’
(
šdex_html_·th
è+ 1 >ğ
PATH_MAX
))

451  
NULL
;

453 
fuÎ_·th
[
´iv
->
roÙ
.
·th_Ën
] = '/';

454 
	`¡ºıy
(
fuÎ_·th
 + 
´iv
->
roÙ
.
·th_Ën
 + 1, 
šdex_html_·th
,

455 
PATH_MAX
 - 
´iv
->
roÙ
.
·th_Ën
 - 1);

460 ià(
¡
->
¡_size
 < 16384)

461  &
mm­_funcs
;

463  &
£ndfe_funcs
;

464 
	}
}

466 
fe_ÿche_’Œy_t
 *

467 
	$ü—‹_ÿche_’Œy_äom_funcs
(
£rve_fes_´iv_t
 *
´iv
, cÚ¡ *
fuÎ_·th
,

468 
¡©
 *
¡
, cÚ¡ 
ÿche_funcs_t
 *
funcs
)

470 
fe_ÿche_’Œy_t
 *
fû
;

472 
fû
 = 
	`m®loc
((*fûè+ 
funcs
->
¡ruù_size
);

473 ià(
	`UNLIKELY
(!
fû
))

474  
NULL
;

476 ià(
	`LIKELY
(
funcs
->
	`š™
(
fû
, 
´iv
, 
fuÎ_·th
, 
¡
))) {

477 
fû
->
funcs
 = funcs;

478  
fû
;

481 
	`ä“
(
fû
);

483 ià(
funcs
 !ğ&
mm­_funcs
)

484  
NULL
;

486  
	`ü—‹_ÿche_’Œy_äom_funcs
(
´iv
, 
fuÎ_·th
, 
¡
, &
£ndfe_funcs
);

487 
	}
}

489 
ÿche_’Œy_t
 *

490 
	$ü—‹_ÿche_’Œy
(cÚ¡ *
key
, *
cÚ‹xt
)

492 
£rve_fes_´iv_t
 *
´iv
 = 
cÚ‹xt
;

493 
fe_ÿche_’Œy_t
 *
fû
;

494 
¡©
 
¡
;

495 cÚ¡ 
ÿche_funcs_t
 *
funcs
;

496 
fuÎ_·th
[
PATH_MAX
];

498 ià(
	`UNLIKELY
(!
	`»®·th©2
(
´iv
->
roÙ
.
fd
,…riv->roÙ.
·th
,

499 
key
, 
fuÎ_·th
, &
¡
)))

500  
NULL
;

502 ià(
	`UNLIKELY
(
	`¡ºcmp
(
fuÎ_·th
, 
´iv
->
roÙ
.
·th
,…riv->roÙ.
·th_Ën
)))

503  
NULL
;

505 
funcs
 = 
	`g‘_funcs
(
´iv
, 
key
, 
fuÎ_·th
, &
¡
);

506 ià(
	`UNLIKELY
(!
funcs
))

507  
NULL
;

509 
fû
 = 
	`ü—‹_ÿche_’Œy_äom_funcs
(
´iv
, 
fuÎ_·th
, &
¡
, 
funcs
);

510 ià(
	`UNLIKELY
(!
fû
))

511  
NULL
;

513 
	`lwª_fÜm©_rfc_time
(
¡
.
¡_mtime
, 
fû
->
Ï¡_modif›d
.
¡ršg
);

514 
fû
->
Ï¡_modif›d
.
š‹g”
 = 
¡
.
¡_mtime
;

516  (
ÿche_’Œy_t
 *)
fû
;

517 
	}
}

520 
	$mm­_ä“
(*
d©a
)

522 
mm­_ÿche_d©a_t
 *
md
 = 
d©a
;

524 
	`munm­
(
md
->
uncom´es£d
.
cÚ‹Ás
, md->uncom´es£d.
size
);

525 
	`ä“
(
md
->
com´es£d
.
cÚ‹Ás
);

526 
	}
}

529 
	$£ndfe_ä“
(*
d©a
)

531 
£ndfe_ÿche_d©a_t
 *
sd
 = 
d©a
;

533 
	`ä“
(
sd
->
f’ame
);

534 
	}
}

537 
	$dœli¡_ä“
(*
d©a
)

539 
dœ_li¡_ÿche_d©a_t
 *
dd
 = 
d©a
;

541 
	`¡rbuf_ä“
(
dd
->
»nd”ed
);

542 
	}
}

545 
	$»dœ_ä“
(*
d©a
)

547 
»dœ_ÿche_d©a_t
 *
rd
 = 
d©a
;

549 
	`ä“
(
rd
->
»dœ_to
);

550 
	}
}

553 
de¡roy_ÿche_’Œy
(
ÿche_’Œy_t
 *
’Œy
, *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

555 
fe_ÿche_’Œy_t
 *
	gfû
 = (fe_ÿche_’Œy_ˆ*)
’Œy
;

557 
	gfû
->
	gfuncs
->
ä“
(
fû
 + 1);

558 
ä“
(
fû
);

562 
	$Œy_İ’_dœeùÜy
(cÚ¡ *
·th
, *
İ’_mode
)

564 
fd
;

566 *
İ’_mode
 = 
O_RDONLY
 | 
O_NOATIME
 | 
O_NONBLOCK
;

568 
fd
 = 
	`İ’
(
·th
, *
İ’_mode
 | 
O_DIRECTORY
);

569 ià(
fd
 < 0) {

571 *
İ’_mode
 &ğ~
O_NOATIME
;

573 
fd
 = 
	`İ’
(
·th
, *
İ’_mode
 | 
O_DIRECTORY
);

574 ià(
fd
 < 0) {

576 *
İ’_mode
 &ğ~
O_NONBLOCK
;

578 
fd
 = 
	`İ’
(
·th
, *
İ’_mode
 | 
O_DIRECTORY
);

582  
fd
;

583 
	}
}

586 
	$£rve_fes_š™
(*
¬gs
)

588 
lwª_£rve_fes_£‰šgs_t
 *
£‰šgs
 = 
¬gs
;

589 *
ÿnÚiÿl_roÙ
;

590 
roÙ_fd
;

591 
£rve_fes_´iv_t
 *
´iv
;

592 
İ’_mode
;

594 ià(!
£‰šgs
->
roÙ_·th
) {

595 
	`lwª_¡©us_”rÜ
("root_path‚ot specified");

596  
NULL
;

599 
ÿnÚiÿl_roÙ
 = 
	`»®·th
(
£‰šgs
->
roÙ_·th
, 
NULL
);

600 ià(!
ÿnÚiÿl_roÙ
) {

601 
	`lwª_¡©us_³¼Ü
("Could‚ot obtain„eal…ath of \"%s\"",

602 
£‰šgs
->
roÙ_·th
);

603 
out_»®·th
;

606 
roÙ_fd
 = 
	`Œy_İ’_dœeùÜy
(
ÿnÚiÿl_roÙ
, &
İ’_mode
);

607 ià(
roÙ_fd
 < 0) {

608 
	`lwª_¡©us_³¼Ü
("Could‚ot open directory \"%s\"",

609 
ÿnÚiÿl_roÙ
);

610 
out_İ’
;

613 
´iv
 = 
	`m®loc
((*priv));

614 ià(!
´iv
) {

615 
	`lwª_¡©us_³¼Ü
("malloc");

616 
out_m®loc
;

619 
´iv
->
ÿche
 = 
	`ÿche_ü—‹
(
ü—‹_ÿche_’Œy
, 
de¡roy_ÿche_’Œy
,

620 
´iv
, 5);

621 ià(!
´iv
->
ÿche
) {

622 
	`lwª_¡©us_”rÜ
("Couldn't create cache");

623 
out_ÿche_ü—‹
;

626 
´iv
->
dœeùÜy_li¡_l
 = 
	`lwª_l_compe_¡ršg
(

627 
dœeùÜy_li¡_l_¡r
, 
fe_li¡_desc
);

628 ià(!
´iv
->
dœeùÜy_li¡_l
) {

629 
	`lwª_¡©us_”rÜ
("Could‚ot compile directory†istemplate");

630 
out_l_compe
;

633 
´iv
->
roÙ
.
·th
 = 
ÿnÚiÿl_roÙ
;

634 
´iv
->
roÙ
.
·th_Ën
 = 
	`¡¾’
(
ÿnÚiÿl_roÙ
);

635 
´iv
->
roÙ
.
fd
 = 
roÙ_fd
;

636 
´iv
->
İ’_mode
 = open_mode;

637 
´iv
->
šdex_html
 = 
£‰šgs
->index_html ? settings->index_html : "index.html";

639  
´iv
;

641 
out_l_compe
:

642 
	`ÿche_de¡roy
(
´iv
->
ÿche
);

643 
out_ÿche_ü—‹
:

644 
	`ä“
(
´iv
);

645 
out_m®loc
:

646 
	`şo£
(
roÙ_fd
);

647 
out_İ’
:

648 
	`ä“
(
ÿnÚiÿl_roÙ
);

649 
out_»®·th
:

650  
NULL
;

651 
	}
}

654 
	$£rve_fes_š™_äom_hash
(cÚ¡ 
hash
 *hash)

656 
lwª_£rve_fes_£‰šgs_t
 
£‰šgs
 = {

657 .
roÙ_·th
 = 
	`hash_fšd
(
hash
, "path"),

658 .
šdex_html
 = 
	`hash_fšd
(
hash
, "index_path")

660  
	`£rve_fes_š™
(&
£‰šgs
);

661 
	}
}

664 
	$£rve_fes_shutdown
(*
d©a
)

666 
£rve_fes_´iv_t
 *
´iv
 = 
d©a
;

668 ià(!
´iv
) {

669 
	`lwª_¡©us_w¬nšg
("Nothingo shutdown");

673 
	`lwª_l_ä“
(
´iv
->
dœeùÜy_li¡_l
);

674 
	`ÿche_de¡roy
(
´iv
->
ÿche
);

675 
	`şo£
(
´iv
->
roÙ
.
fd
);

676 
	`ä“
(
´iv
->
roÙ
.
·th
);

677 
	`ä“
(
´iv
);

678 
	}
}

680 
ALWAYS_INLINE
 
boŞ


681 
	$ş›Á_has_äesh_cÚ‹Á
(
lwª_»que¡_t
 *
»que¡
, 
time_t
 
mtime
)

683  
»que¡
->
h—d”
.
if_modif›d_sšû
 && 
mtime
 <=„equest->header.if_modified_since;

684 
	}
}

686 
size_t


687 
	$´•¬e_h—d”s
(
lwª_»que¡_t
 *
»que¡
,

688 
lwª_h‰p_¡©us_t
 
»tuº_¡©us
,

689 
fe_ÿche_’Œy_t
 *
fû
,

690 
size_t
 
size
,

691 
boŞ
 
deæ©ed
,

692 *
h—d”_buf
,

693 
size_t
 
h—d”_buf_size
)

695 
lwª_key_v®ue_t
 
h—d”s
[3];

697 
»que¡
->
»¥Ú£
.
h—d”s
 = headers;

698 
»que¡
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 
size
;

700 
	`SET_NTH_HEADER
(0, "La¡-Modif›d", 
fû
->
Ï¡_modif›d
.
¡ršg
);

702 ià(
deæ©ed
) {

703 
	`SET_NTH_HEADER
(1, "Content-Encoding", "deflate");

704 
	`SET_NTH_HEADER
(2, 
NULL
, NULL);

706 
	`SET_NTH_HEADER
(1, 
NULL
, NULL);

709  
	`lwª_´•¬e_»¥Ú£_h—d”
(
»que¡
, 
»tuº_¡©us
,

710 
h—d”_buf
, 
h—d”_buf_size
);

711 
	}
}

713 
ALWAYS_INLINE
 
lwª_h‰p_¡©us_t


714 
	$compu‹_¿nge
(
lwª_»que¡_t
 *
»que¡
, 
off_t
 *
äom
, off_ˆ*
to
, off_ˆ
size
)

716 
off_t
 
f
, 
t
;

718 
f
 = 
»que¡
->
h—d”
.
¿nge
.
äom
;

719 
t
 = 
»que¡
->
h—d”
.
¿nge
.
to
;

724 ià(
	`LIKELY
(
t
 <ğ0 && 
f
 <= 0)) {

725 *
äom
 = 0;

726 *
to
 = 
size
;

727  
HTTP_OK
;

733 ià(
	`UNLIKELY
(
t
 >ğ
f
))

734  
HTTP_RANGE_UNSATISFIABLE
;

739 ià(
	`UNLIKELY
(
f
 >ğ
size
 || 
t
 >= size))

740  
HTTP_RANGE_UNSATISFIABLE
;

745 ià(
t
 < 0)

746 
t
 = 
size
 - 
f
;

748 
t
 -ğ
f
;

754 ià(
	`UNLIKELY
(
t
 <= 0))

755  
HTTP_RANGE_UNSATISFIABLE
;

757 *
äom
 = 
f
;

758 *
to
 = 
t
;

760  
HTTP_PARTIAL_CONTENT
;

761 
	}
}

763 
lwª_h‰p_¡©us_t


764 
	$£ndfe_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
)

766 
fe_ÿche_’Œy_t
 *
fû
 = 
d©a
;

767 
£ndfe_ÿche_d©a_t
 *
sd
 = (£ndfe_ÿche_d©a_ˆ*)(
fû
 + 1);

768 
h—d”s
[
DEFAULT_BUFFER_SIZE
];

769 
size_t
 
h—d”_Ën
;

770 
lwª_h‰p_¡©us_t
 
»tuº_¡©us
;

771 
off_t
 
äom
, 
to
;

773 
»tuº_¡©us
 = 
	`compu‹_¿nge
(
»que¡
, &
äom
, &
to
, (
off_t
)
sd
->
size
);

774 ià(
	`UNLIKELY
(
»tuº_¡©us
 =ğ
HTTP_RANGE_UNSATISFIABLE
))

775  
HTTP_RANGE_UNSATISFIABLE
;

777 ià(
	`ş›Á_has_äesh_cÚ‹Á
(
»que¡
, 
fû
->
Ï¡_modif›d
.
š‹g”
))

778 
»tuº_¡©us
 = 
HTTP_NOT_MODIFIED
;

780 
h—d”_Ën
 = 
	`´•¬e_h—d”s
(
»que¡
, 
»tuº_¡©us
,

781 
fû
, 
sd
->
size
, 
çl£
,

782 
h—d”s
, 
DEFAULT_HEADERS_SIZE
);

783 ià(
	`UNLIKELY
(!
h—d”_Ën
))

784  
HTTP_INTERNAL_ERROR
;

786 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_HEAD
 || 
»tuº_¡©us
 =ğ
HTTP_NOT_MODIFIED
) {

787 
	`lwª_wr™e
(
»que¡
, 
h—d”s
, 
h—d”_Ën
);

789 
£rve_fes_´iv_t
 *
´iv
 = 
»que¡
->
»¥Ú£
.
¡»am
.priv;

797 
fe_fd
 = 
	`lwª_İ’©
(
»que¡
, 
´iv
->
roÙ
.
fd
, 
sd
->
f’ame
,

798 
´iv
->
İ’_mode
);

799 ià(
	`UNLIKELY
(
fe_fd
 < 0)) {

800 
fe_fd
) {

801 -
EACCES
:

802  
HTTP_FORBIDDEN
;

803 -
ENFILE
:

804  
HTTP_UNAVAILABLE
;

806  
HTTP_NOT_FOUND
;

810 
	`lwª_£nd
(
»que¡
, 
h—d”s
, 
h—d”_Ën
, 
MSG_MORE
);

811 
	`lwª_£ndfe
(
»que¡
, 
fe_fd
, 
äom
, (
size_t
)
to
);

814  
»tuº_¡©us
;

815 
	}
}

817 
lwª_h‰p_¡©us_t


818 
	$£rve_cÚ‹Ás_ªd_size
(
lwª_»que¡_t
 *
»que¡
, 
fe_ÿche_’Œy_t
 *
fû
,

819 
boŞ
 
deæ©ed
, *
cÚ‹Ás
, 
size_t
 
size
)

821 
h—d”s
[
DEFAULT_BUFFER_SIZE
];

822 
size_t
 
h—d”_Ën
;

823 
lwª_h‰p_¡©us_t
 
»tuº_¡©us
 = 
HTTP_OK
;

825 ià(
	`ş›Á_has_äesh_cÚ‹Á
(
»que¡
, 
fû
->
Ï¡_modif›d
.
š‹g”
))

826 
»tuº_¡©us
 = 
HTTP_NOT_MODIFIED
;

828 
h—d”_Ën
 = 
	`´•¬e_h—d”s
(
»que¡
, 
»tuº_¡©us
,

829 
fû
, 
size
, 
deæ©ed
,

830 
h—d”s
, 
DEFAULT_HEADERS_SIZE
);

831 ià(
	`UNLIKELY
(!
h—d”_Ën
))

832  
HTTP_INTERNAL_ERROR
;

834 ià(
»que¡
->
æags
 & 
REQUEST_METHOD_HEAD
 || 
»tuº_¡©us
 =ğ
HTTP_NOT_MODIFIED
) {

835 
	`lwª_wr™e
(
»que¡
, 
h—d”s
, 
h—d”_Ën
);

837 
iovec
 
»¥Ú£_vec
[] = {

838 { .
iov_ba£
 = 
h—d”s
, .
iov_Ën
 = 
h—d”_Ën
 },

839 { .
iov_ba£
 = 
cÚ‹Ás
, .
iov_Ën
 = 
size
 }

842 
	`lwª_wr™ev
(
»que¡
, 
»¥Ú£_vec
, 
	`N_ELEMENTS
(response_vec));

845  
»tuº_¡©us
;

846 
	}
}

848 
lwª_h‰p_¡©us_t


849 
	$mm­_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
)

851 
fe_ÿche_’Œy_t
 *
fû
 = 
d©a
;

852 
mm­_ÿche_d©a_t
 *
md
 = (mm­_ÿche_d©a_ˆ*)(
fû
 + 1);

853 *
cÚ‹Ás
;

854 
size_t
 
size
;

855 
boŞ
 
com´es£d
;

857 ià(
md
->
com´es£d
.
size
 && (
»que¡
->
æags
 & 
REQUEST_ACCEPT_DEFLATE
)) {

858 
cÚ‹Ás
 = 
md
->
com´es£d
.contents;

859 
size
 = 
md
->
com´es£d
.size;

860 
com´es£d
 = 
Œue
;

862 
cÚ‹Ás
 = 
md
->
uncom´es£d
.contents;

863 
size
 = 
md
->
uncom´es£d
.size;

864 
com´es£d
 = 
çl£
;

867  
	`£rve_cÚ‹Ás_ªd_size
(
»que¡
, 
fû
, 
com´es£d
, 
cÚ‹Ás
, 
size
);

868 
	}
}

870 
lwª_h‰p_¡©us_t


871 
	$dœli¡_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
)

873 
fe_ÿche_’Œy_t
 *
fû
 = 
d©a
;

874 
dœ_li¡_ÿche_d©a_t
 *
dd
 = (dœ_li¡_ÿche_d©a_ˆ*)(
fû
 + 1);

876  
	`£rve_cÚ‹Ás_ªd_size
(
»que¡
, 
fû
, 
çl£
,

877 
	`¡rbuf_g‘_bufãr
(
dd
->
»nd”ed
), 
	`¡rbuf_g‘_Ëngth
(dd->rendered));

878 
	}
}

880 
lwª_h‰p_¡©us_t


881 
	$»dœ_£rve
(
lwª_»que¡_t
 *
»que¡
, *
d©a
)

883 
fe_ÿche_’Œy_t
 *
fû
 = 
d©a
;

884 
»dœ_ÿche_d©a_t
 *
rd
 = (»dœ_ÿche_d©a_ˆ*)(
fû
 + 1);

885 
h—d”_buf
[
DEFAULT_BUFFER_SIZE
];

886 
size_t
 
h—d”_buf_size
;

887 
lwª_key_v®ue_t
 
h—d”s
[2];

889 
»que¡
->
»¥Ú£
.
h—d”s
 = headers;

890 
»que¡
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 
	`¡¾’
(
rd
->
»dœ_to
);

892 
	`SET_NTH_HEADER
(0, "LoÿtiÚ", 
rd
->
»dœ_to
);

893 
	`SET_NTH_HEADER
(1, 
NULL
, NULL);

895 
h—d”_buf_size
 = 
	`lwª_´•¬e_»¥Ú£_h—d”
(
»que¡
,

896 
HTTP_MOVED_PERMANENTLY
, 
h—d”_buf
, 
DEFAULT_BUFFER_SIZE
);

897 ià(
	`UNLIKELY
(!
h—d”_buf_size
))

898  
HTTP_INTERNAL_ERROR
;

900 
iovec
 
»¥Ú£_vec
[] = {

901 { .
iov_ba£
 = 
h—d”_buf
, .
iov_Ën
 = 
h—d”_buf_size
 },

902 { .
iov_ba£
 = 
rd
->
»dœ_to
, .
iov_Ën
 = 
»que¡
->
»¥Ú£
.
cÚ‹Á_Ëngth
 },

905 
	`lwª_wr™ev
(
»que¡
, 
»¥Ú£_vec
, 
	`N_ELEMENTS
(response_vec));

907  
HTTP_MOVED_PERMANENTLY
;

908 
	}
}

910 
lwª_h‰p_¡©us_t


911 
	$£rve_fes_hªdË_cb
(
lwª_»que¡_t
 *
»que¡
, 
lwª_»¥Ú£_t
 *
»¥Ú£
, *
d©a
)

913 
lwª_h‰p_¡©us_t
 
»tuº_¡©us
 = 
HTTP_NOT_FOUND
;

914 
£rve_fes_´iv_t
 *
´iv
 = 
d©a
;

915 
ÿche_’Œy_t
 *
û
;

917 ià(
	`UNLIKELY
(!
´iv
)) {

918 
»tuº_¡©us
 = 
HTTP_INTERNAL_ERROR
;

919 
ç
;

922 
û
 = 
	`ÿche_cÜo_g‘_ªd_»f_’Œy
(
´iv
->
ÿche
, 
»que¡
->
cÚn
->
cÜo
,

923 
»que¡
->
u¾
.
v®ue
);

924 ià(
	`LIKELY
(
û
)) {

925 
fe_ÿche_’Œy_t
 *
fû
 = (fe_ÿche_’Œy_ˆ*)
û
;

926 
»¥Ú£
->
mime_ty³
 = 
fû
->mime_type;

927 
»¥Ú£
->
¡»am
.
ÿÎback
 = 
fû
->
funcs
->
£rve
;

928 
»¥Ú£
->
¡»am
.
d©a
 = 
û
;

929 
»¥Ú£
->
¡»am
.
´iv
 =…riv;

931  
HTTP_OK
;

934 
ç
:

935 
»¥Ú£
->
¡»am
.
ÿÎback
 = 
NULL
;

936  
»tuº_¡©us
;

937 
	}
}

939 cÚ¡ 
lwª_moduË_t
 *
	$lwª_moduË_£rve_fes
()

941 cÚ¡ 
lwª_moduË_t
 
£rve_fes
 = {

942 .
Çme
 = "serve_files",

943 .
š™
 = 
£rve_fes_š™
,

944 .
š™_äom_hash
 = 
£rve_fes_š™_äom_hash
,

945 .
shutdown
 = 
£rve_fes_shutdown
,

946 .
hªdË
 = 
£rve_fes_hªdË_cb
,

947 .
æags
 = 
HANDLER_REMOVE_LEADING_SLASH


948 | 
HANDLER_PARSE_IF_MODIFIED_SINCE


949 | 
HANDLER_PARSE_RANGE


950 | 
HANDLER_PARSE_ACCEPT_ENCODING


953  &
£rve_fes
;

954 
	}
}

	@common/lwan-serve-files.h

20 #iâdeà
__LWAN_SERVE_FILES_H__


21 
	#__LWAN_SERVE_FILES_H__


	)

23 
	~"lwª.h
"

25 
	slwª_£rve_fes_£‰šgs_t
 {

26 *
	mroÙ_·th
;

27 *
	mšdex_html
;

30 
	#SERVE_FILES_SETTINGS
(
roÙ_·th_
, 
šdex_html_
) \

31 .
moduË
 = 
	`lwª_moduË_£rve_fes
(), \

32 .
¬gs
 = ((
lwª_£rve_fes_£‰šgs_t
[]) {{ \

33 .
roÙ_·th
 = 
roÙ_·th_
, \

34 .
šdex_html
 = 
šdex_html_
 \

36 .
æags
 = 0

	)

38 
	#SERVE_FILES
(
roÙ_·th
) \

39 
	`SERVE_FILES_SETTINGS
(
roÙ_·th
, 
NULL
)

	)

41 cÚ¡ 
lwª_moduË_t
 *
lwª_moduË_£rve_fes
();

	@common/lwan-socket.c

20 
	#_GNU_SOURCE


	)

21 
	~<¬·/š‘.h
>

22 
	~<fú.h
>

23 
	~<Ãtdb.h
>

24 
	~<Ãtš‘/tı.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<sys/»sourû.h
>

28 
	~<sys/sock‘.h
>

29 
	~<sys/ty³s.h
>

30 
	~<uni¡d.h
>

32 
	~"lwª.h
"

33 
	~"sd-d«mÚ.h
"

34 
	~"št-to-¡r.h
"

38 
	$g‘_backlog_size
()

40 #ifdeà
SOMAXCONN


41 
backlog
 = 
SOMAXCONN
;

43 
backlog
 = 128;

45 
FILE
 *
somaxcÚn
;

47 
somaxcÚn
 = 
	`fİ’
("/proc/sys/net/core/somaxconn", "r");

48 ià(
somaxcÚn
) {

49 
tmp
;

50 ià(
	`fsÿnf
(
somaxcÚn
, "%d", &
tmp
) == 1)

51 
backlog
 = 
tmp
;

52 
	`fşo£
(
somaxcÚn
);

55  
backlog
;

56 
	}
}

59 
	$£tup_sock‘_äom_sy¡emd
()

61 
fd
 = 
SD_LISTEN_FDS_START
;

63 ià(!
	`sd_is_sock‘_š‘
(
fd
, 
AF_UNSPEC
, 
SOCK_STREAM
, 1, 0))

64 
	`lwª_¡©us_ü™iÿl
("Passed file descriptor is‚ot‡ "

67  
fd
;

68 
	}
}

70 
§_çmy_t


71 
	$·r£_li¡’”_v4
(*
li¡’”
, **
node
, **
pÜt
)

73 *
cŞÚ
 = 
	`¡¼chr
(
li¡’”
, ':');

74 ià(!
cŞÚ
) {

75 *
pÜt
 = "8080";

76 ià(!
	`¡rchr
(
li¡’”
, '.')) {

78 *
node
 = "0.0.0.0";

81 *
node
 = 
li¡’”
;

88 *
cŞÚ
 = '\0';

89 *
node
 = 
li¡’”
;

90 *
pÜt
 = 
cŞÚ
 + 1;

92 ià(!
	`¡rcmp
(*
node
, "*")) {

94 *
node
 = "0.0.0.0";

98  
AF_INET
;

99 
	}
}

101 
§_çmy_t


102 
	$·r£_li¡’”_v6
(*
li¡’”
, **
node
, **
pÜt
)

104 *
Ï¡_cŞÚ
 = 
	`¡¼chr
(
li¡’”
, ':');

105 ià(!
Ï¡_cŞÚ
)

106  
AF_UNSPEC
;

108 ià(*(
Ï¡_cŞÚ
 - 1) == ']') {

110 *(
Ï¡_cŞÚ
 - 1) = '\0';

111 *
node
 = 
li¡’”
 + 1;

112 *
pÜt
 = 
Ï¡_cŞÚ
 + 1;

115 
li¡’”
[
	`¡¾’
(listener) - 1] = '\0';

116 *
node
 = 
li¡’”
 + 1;

117 *
pÜt
 = "8080";

120  
AF_INET6
;

121 
	}
}

123 
§_çmy_t


124 
	$·r£_li¡’”
(*
li¡’”
, **
node
, **
pÜt
)

126 ià(*
li¡’”
 == '[')

127  
	`·r£_li¡’”_v6
(
li¡’”
, 
node
, 
pÜt
);

128  
	`·r£_li¡’”_v4
(
li¡’”
, 
node
, 
pÜt
);

129 
	}
}

132 
	$li¡’_addršfo
(
fd
, cÚ¡ 
addršfo
 *
addr
)

134 ià(
	`li¡’
(
fd
, 
	`g‘_backlog_size
()) < 0)

135 
	`lwª_¡©us_ü™iÿl_³¼Ü
("listen");

137 
ho¡_buf
[
NI_MAXHOST
], 
£rv_buf
[
NI_MAXSERV
];

138 
»t
 = 
	`g‘Çmešfo
(
addr
->
ai_addr
,‡ddr->
ai_add¾’
, 
ho¡_buf
, (host_buf),

139 
£rv_buf
, (£rv_buf), 
NI_NUMERICHOST
 | 
NI_NUMERICSERV
);

140 ià(
»t
)

141 
	`lwª_¡©us_ü™iÿl
("g‘Çmešfo: %s", 
	`gai_¡»¼Ü
(
»t
));

143 ià(
addr
->
ai_çmy
 =ğ
AF_INET6
)

144 
	`lwª_¡©us_šfo
("Li¡’šg oÀh‰p://[%s]:%s", 
ho¡_buf
, 
£rv_buf
);

146 
	`lwª_¡©us_šfo
("Li¡’šg oÀh‰p://%s:%s", 
ho¡_buf
, 
£rv_buf
);

148  
fd
;

149 
	}
}

151 
	#SET_SOCKET_OPTION
(
_domaš
,
_İtiÚ
,
_·¿m
,
_size
) \

153 ià(
	`£tsockİt
(
fd
, (
_domaš
), (
_İtiÚ
), (
_·¿m
), (
_size
)) < 0) \

154 
	`lwª_¡©us_ü™iÿl_³¼Ü
("setsockopt"); \

155 } 0)

	)

157 
	#SET_SOCKET_OPTION_MAY_FAIL
(
_domaš
,
_İtiÚ
,
_·¿m
,
_size
) \

159 ià(
	`£tsockİt
(
fd
, (
_domaš
), (
_İtiÚ
), (
_·¿m
), (
_size
)) < 0) \

160 
	`lwª_¡©us_w¬nšg
("%s‚ot supported byhe kernel", \

162 } 0)

	)

164 #iâdeà
SO_REUSEPORT


165 
	#SO_REUSEPORT
 15

	)

169 
	$bšd_ªd_li¡’_addršfos
(
addršfo
 *
addrs
, 
boŞ
 
»u£_pÜt
)

171 cÚ¡ 
addršfo
 *
addr
;

174 
addr
 = 
addrs
;‡ddr;‡dd¸ğaddr->
ai_Ãxt
) {

175 
fd
 = 
	`sock‘
(
addr
->
ai_çmy
,‡ddr->
ai_sockty³
,‡ddr->
ai_´ÙocŞ
);

176 ià(
fd
 < 0)

179 
	`SET_SOCKET_OPTION
(
SOL_SOCKET
, 
SO_REUSEADDR
, ([]){ 1 }, ());

180 
	`SET_SOCKET_OPTION_MAY_FAIL
(
SOL_SOCKET
, 
SO_REUSEPORT
,

181 ([]){ 
»u£_pÜt
 }, ());

183 ià(!
	`bšd
(
fd
, 
addr
->
ai_addr
,‡ddr->
ai_add¾’
))

184  
	`li¡’_addršfo
(
fd
, 
addr
);

186 
	`şo£
(
fd
);

189 
	`lwª_¡©us_ü™iÿl
("Could‚ot bind socket");

190 
	}
}

193 
	$£tup_sock‘_nÜm®ly
(
lwª_t
 *
l
)

195 *
node
, *
pÜt
;

196 *
li¡’”
 = 
	`¡rdu·
(
l
->
cÚfig
.listener);

197 
§_çmy_t
 
çmy
 = 
	`·r£_li¡’”
(
li¡’”
, &
node
, &
pÜt
);

198 ià(
çmy
 =ğ
AF_UNSPEC
)

199 
	`lwª_¡©us_ü™iÿl
("Could‚Ù…¬£†i¡’”: %s", 
l
->
cÚfig
.
li¡’”
);

201 
addršfo
 *
addrs
;

202 
addršfo
 
hšts
 = {

203 .
ai_çmy
 = 
çmy
,

204 .
ai_sockty³
 = 
SOCK_STREAM
,

205 .
ai_æags
 = 
AI_PASSIVE


208 
»t
 = 
	`g‘addršfo
(
node
, 
pÜt
, &
hšts
, &
addrs
);

209 ià(
»t
)

210 
	`lwª_¡©us_ü™iÿl
("g‘addršfo: %s", 
	`gai_¡»¼Ü
(
»t
));

212 
fd
 = 
	`bšd_ªd_li¡’_addršfos
(
addrs
, 
l
->
cÚfig
.
»u£_pÜt
);

213 
	`ä“addršfo
(
addrs
);

214  
fd
;

215 
	}
}

217 #iâdeà
TCP_FASTOPEN


218 
	#TCP_FASTOPEN
 23

	)

222 
	$lwª_sock‘_š™
(
lwª_t
 *
l
)

224 
fd
, 
n
;

226 
	`lwª_¡©us_debug
("Initializing sockets");

228 
n
 = 
	`sd_li¡’_fds
(1);

229 ià(
n
 > 1) {

230 
	`lwª_¡©us_ü™iÿl
("Too many file descriptors„eceived");

231 } ià(
n
 == 1) {

232 
fd
 = 
	`£tup_sock‘_äom_sy¡emd
();

234 
fd
 = 
	`£tup_sock‘_nÜm®ly
(
l
);

237 
	`SET_SOCKET_OPTION
(
SOL_SOCKET
, 
SO_LINGER
,

238 ((
lšg”
[]){{ .
l_Úoff
 = 1, .
l_lšg”
 = 1 }}), (linger));

240 
	`SET_SOCKET_OPTION_MAY_FAIL
(
SOL_TCP
, 
TCP_FASTOPEN
,

242 
	`SET_SOCKET_OPTION_MAY_FAIL
(
SOL_TCP
, 
TCP_QUICKACK
,

245 
l
->
maš_sock‘
 = 
fd
;

246 
	}
}

248 #undeà
SET_SOCKET_OPTION


249 #undeà
SET_SOCKET_OPTION_MAY_FAIL


	@common/lwan-status.c

20 
	#_GNU_SOURCE


	)

21 
	~<”ºo.h
>

22 
	~<±h»ad.h
>

23 
	~<¡d¬g.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

28 #iâdeà
NDEBUG


29 
	~<uni¡d.h
>

30 
	~<sys/sysÿÎ.h
>

33 
	~"lwª.h
"

36 
	mSTATUS_INFO
 = 1<<0,

37 
	mSTATUS_WARNING
 = 1<<1,

38 
	mSTATUS_ERROR
 = 1<<2,

39 
	mSTATUS_PERROR
 = 1<<3,

40 
	mSTATUS_CRITICAL
 = 1<<4,

41 
	mSTATUS_DEBUG
 = 1<<5,

42 } 
	tlwª_¡©us_ty³_t
;

44 vŞ©
boŞ
 
	gqu›t
 = 
çl£
;

45 
±h»ad_mu‹x_t
 
	gmu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

48 
	$lwª_¡©us_š™
(
lwª_t
 *
l
)

50 #ifdeà
NDEBUG


51 
qu›t
 = 
l
->
cÚfig
.quiet;

53 
qu›t
 = 
çl£
;

54 (è
l
;

56 
	}
}

59 
lwª_¡©us_shutdown
(
lwª_t
 *
l
 
__©Œibu‹__
((
unu£d
)))

64 
	$g‘_cŞÜ_¡¬t_fÜ_ty³
(
lwª_¡©us_ty³_t
 
ty³
, 
size_t
 *
Ën_out
)

66 cÚ¡ *
»tv®
;

68 ià(
ty³
 & 
STATUS_INFO
)

69 
»tv®
 = "\033[36m";

70 ià(
ty³
 & 
STATUS_WARNING
)

71 
»tv®
 = "\033[33m";

72 ià(
ty³
 & 
STATUS_CRITICAL
)

73 
»tv®
 = "\033[31;1m";

74 ià(
ty³
 & 
STATUS_DEBUG
)

75 
»tv®
 = "\033[37m";

76 ià(
ty³
 & 
STATUS_PERROR
)

77 
»tv®
 = "\033[35m";

79 
»tv®
 = "\033[32m";

81 *
Ën_out
 = 
	`¡¾’
(
»tv®
);

83  
»tv®
;

84 
	}
}

87 
g‘_cŞÜ_’d_fÜ_ty³
(
lwª_¡©us_ty³_t
 
ty³
 
__©Œibu‹__
((
unu£d
)),

88 
size_t
 *
Ën_out
)

90 cÚ¡ *
	g»tv®
 = "\033[0m";

91 *
	gËn_out
 = 
¡¾’
(
»tv®
);

92  
	g»tv®
;

96 #ifdeà
NDEBUG


97 
	$¡©us_out_msg
(
lwª_¡©us_ty³_t
 
ty³
, cÚ¡ *
msg
, 
size_t
 
msg_Ën
)

99 
	$¡©us_out_msg
(cÚ¡ *
fe
, cÚ¡ 
lše
, cÚ¡ *
func
,

100 
lwª_¡©us_ty³_t
 
ty³
, cÚ¡ *
msg
, 
size_t
 
msg_Ën
)

103 
”rÜ_numb”
 = 
”ºo
;

104 
size_t
 
¡¬t_Ën
, 
’d_Ën
;

105 cÚ¡ *
¡¬t_cŞÜ
 = 
	`g‘_cŞÜ_¡¬t_fÜ_ty³
(
ty³
, &
¡¬t_Ën
);

106 cÚ¡ *
’d_cŞÜ
 = 
	`g‘_cŞÜ_’d_fÜ_ty³
(
ty³
, &
’d_Ën
);

108 ià(
	`UNLIKELY
(
	`±h»ad_mu‹x_lock
(&
mu‹x
) < 0))

109 
	`³¼Ü
("pthread_mutex_lock");

111 #iâdeà
NDEBUG


112 
	`årštf
(
¡dout
, "\033[32;1m%ld\033[0m", 
	`sysÿÎ
(
SYS_g‘tid
));

113 
	`årštf
(
¡dout
, " \033[3m%s:%d\033[0m", 
	`ba£Çme
(
fe
), 
lše
);

114 
	`årštf
(
¡dout
, " \033[33m%s()\033[0m", 
func
);

115 
	`årštf
(
¡dout
, " ");

118 
	`fwr™e
(
¡¬t_cŞÜ
, 
¡¬t_Ën
, 1, 
¡dout
);

119 
	`fwr™e
(
msg
, 
msg_Ën
, 1, 
¡dout
);

121 ià(
ty³
 & 
STATUS_PERROR
) {

122 
bufãr
[512];

123 *
”rÜ_msg
 = 
	`¡»¼Ü_r
(
”rÜ_numb”
, 
bufãr
, (buffer) - 1);

124 
	`åutc
(':', 
¡dout
);

125 
	`åutc
(' ', 
¡dout
);

126 
	`fwr™e
(
”rÜ_msg
, 
	`¡¾’
Ó¼Ü_msg), 1, 
¡dout
);

129 
	`åutc
('.', 
¡dout
);

130 
	`fwr™e
(
’d_cŞÜ
, 
’d_Ën
, 1, 
¡dout
);

131 
	`åutc
('\n', 
¡dout
);

133 ià(
	`UNLIKELY
(
	`±h»ad_mu‹x_uÆock
(&
mu‹x
) < 0))

134 
	`³¼Ü
("pthread_mutex_unlock");

135 
	}
}

138 #ifdeà
NDEBUG


139 
	$¡©us_out
(
lwª_¡©us_ty³_t
 
ty³
, cÚ¡ *
fmt
, 
va_li¡
 
v®ues
)

141 
	$¡©us_out
(cÚ¡ *
fe
, cÚ¡ 
lše
, cÚ¡ *
func
,

142 
lwª_¡©us_ty³_t
 
ty³
, cÚ¡ *
fmt
, 
va_li¡
 
v®ues
)

145 *
ouut
;

146 
Ën
;

148 
Ën
 = 
	`va¥rštf
(&
ouut
, 
fmt
, 
v®ues
);

149 ià(
Ën
 >= 0) {

150 #ifdeà
NDEBUG


151 
	`¡©us_out_msg
(
ty³
, 
ouut
, (
size_t
)
Ën
);

153 
	`¡©us_out_msg
(
fe
, 
lše
, 
func
, 
ty³
, 
ouut
, (
size_t
)
Ën
);

155 
	`ä“
(
ouut
);

157 
	}
}

159 #ifdeà
NDEBUG


160 
	#IMPLEMENT_FUNCTION
(
â_Çme_
, 
ty³_
) \

162 
lwª_¡©us_
##
	`â_Çme_
(cÚ¡ *
fmt
, ...) \

164 ià(!
qu›t
) { \

165 
va_li¡
 
v®ues
; \

166 
	`va_¡¬t
(
v®ues
, 
fmt
); \

167 
	`¡©us_out
(
ty³_
, 
fmt
, 
v®ues
); \

168 
	`va_’d
(
v®ues
); \

170 ià((
ty³_
è& 
STATUS_CRITICAL
è
	`abÜt
(); \

171 }

	)

173 
	#IMPLEMENT_FUNCTION
(
â_Çme_
, 
ty³_
) \

175 
lwª_¡©us_
##
â_Çme_
##
	`_debug
(cÚ¡ *
fe
, \

176 cÚ¡ 
lše
, cÚ¡ *
func
, \

177 cÚ¡ *
fmt
, ...) \

179 ià(!
qu›t
) { \

180 
va_li¡
 
v®ues
; \

181 
	`va_¡¬t
(
v®ues
, 
fmt
); \

182 
	`¡©us_out
(
fe
, 
lše
, 
func
, 
ty³_
, 
fmt
, 
v®ues
); \

183 
	`va_’d
(
v®ues
); \

185 ià((
ty³_
è& 
STATUS_CRITICAL
è
	`abÜt
(); \

186 }

	)

188 
	$IMPLEMENT_FUNCTION
(
debug
, 
STATUS_DEBUG
)

191 
	$IMPLEMENT_FUNCTION
(
šfo
, 
STATUS_INFO
)

192 
	$IMPLEMENT_FUNCTION
(
w¬nšg
, 
STATUS_WARNING
)

193 
	$IMPLEMENT_FUNCTION
(
”rÜ
, 
STATUS_ERROR
)

194 
	$IMPLEMENT_FUNCTION
(
³¼Ü
, 
STATUS_PERROR
)

196 
	$IMPLEMENT_FUNCTION
(
ü™iÿl
, 
STATUS_CRITICAL
)

197 
	`IMPLEMENT_FUNCTION
(
ü™iÿl_³¼Ü
, 
STATUS_CRITICAL
 | 
STATUS_PERROR
)

199 #undeà
IMPLEMENT_FUNCTION


	@common/lwan-status.h

20 #iâdeà
_LWAN_STATUS_H_


21 
	#_LWAN_STATUS_H_


	)

23 #ifdeà
NDEBUG


24 
	#DECLARE_STATUS_PROTO
(
ty³_
, ...) \

25 
lwª_¡©us_
##
	`ty³_
(cÚ¡ *
fmt
, ...) \

26 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 1, 2))) \

27 
__VA_ARGS__
;

	)

29 
	#lwª_¡©us_debug
(
fmt
, ...)

	)

31 
	#DECLARE_STATUS_PROTO
(
ty³_
, ...) \

32 
lwª_¡©us_
##
ty³_
##
	`_debug
(cÚ¡ *
fe
, cÚ¡ 
lše
, \

33 cÚ¡ *
func
, cÚ¡ *
fmt
, ...) \

34 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 4, 5))) \

35 
__VA_ARGS__
;

	)

37 
	#lwª_¡©us_šfo
(
fmt
, ...) \

38 
	`lwª_¡©us_šfo_debug
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, 
fmt
, ##
__VA_ARGS__
)

	)

39 
	#lwª_¡©us_w¬nšg
(
fmt
, ...) \

40 
	`lwª_¡©us_w¬nšg_debug
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, 
fmt
, ##
__VA_ARGS__
)

	)

41 
	#lwª_¡©us_”rÜ
(
fmt
, ...) \

42 
	`lwª_¡©us_”rÜ_debug
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, 
fmt
, ##
__VA_ARGS__
)

	)

43 
	#lwª_¡©us_³¼Ü
(
fmt
, ...) \

44 
	`lwª_¡©us_³¼Ü_debug
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, 
fmt
, ##
__VA_ARGS__
)

	)

45 
	#lwª_¡©us_ü™iÿl
(
fmt
, ...) \

46 
	`lwª_¡©us_ü™iÿl_debug
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, 
fmt
, ##
__VA_ARGS__
)

	)

47 
	#lwª_¡©us_ü™iÿl_³¼Ü
(
fmt
, ...) \

48 
	`lwª_¡©us_ü™iÿl_³¼Ü_debug
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, 
fmt
, ##
__VA_ARGS__
)

	)

49 
	#lwª_¡©us_debug
(
fmt
, ...) \

50 
	`lwª_¡©us_debug_debug
(
__FILE__
, 
__LINE__
, 
__FUNCTION__
, 
fmt
, ##
__VA_ARGS__
)

	)

52 
	$DECLARE_STATUS_PROTO
(
debug
)

55 
	$DECLARE_STATUS_PROTO
(
šfo
)

56 
	$DECLARE_STATUS_PROTO
(
w¬nšg
)

57 
	$DECLARE_STATUS_PROTO
(
”rÜ
)

58 
	$DECLARE_STATUS_PROTO
(
³¼Ü
)

59 
	`DECLARE_STATUS_PROTO
(
ü™iÿl
, 
	`__©Œibu‹__
((
nÜ‘uº
)))

60 
	`DECLARE_STATUS_PROTO
(
ü™iÿl_³¼Ü
, 
	`__©Œibu‹__
((
nÜ‘uº
)))

	@common/lwan-tables.c

20 
	#_GNU_SOURCE


	)

21 
	~<as£¹.h
>

22 
	~<¡ršg.h
>

23 
	~<¡dlib.h
>

24 
	~<zlib.h
>

26 
	~"lwª.h
"

27 
	~"mime-ty³s.h
"

30 
	guncom´es£d_mime_’Œ›s
[
MIME_UNCOMPRESSED_LEN
];

31 
mime_’Œy
 
	gmime_’Œ›s
[
MIME_ENTRIES
];

32 
boŞ
 
	gmime_’Œ›s_š™Ÿlized
 = 
çl£
;

35 
	$lwª_bËs_š™
()

37 ià(
mime_’Œ›s_š™Ÿlized
)

40 
	`lwª_¡©us_debug
("Uncompressing MIMEypeable");

41 
uLÚgf
 
uncom´es£d_Ëngth
 = 
MIME_UNCOMPRESSED_LEN
;

42 
»t
 = 
	`uncom´ess
((
By‹f
*)
uncom´es£d_mime_’Œ›s
,

43 &
uncom´es£d_Ëngth
, (cÚ¡ 
By‹f
*)
mime_’Œ›s_com´es£d
,

44 
MIME_COMPRESSED_LEN
);

45 ià(
»t
 !ğ
Z_OK
)

46 
	`lwª_¡©us_ü™iÿl
(

47 "E¼Ü whuncom´essšgabË: zlibƒ¼Ü %d", 
»t
);

49 ià(
uncom´es£d_Ëngth
 !ğ
MIME_UNCOMPRESSED_LEN
)

50 
	`lwª_¡©us_ü™iÿl
("Expected uncompressed†ength %d, got %ld",

51 
MIME_UNCOMPRESSED_LEN
, 
uncom´es£d_Ëngth
);

53 *
±r
 = 
uncom´es£d_mime_’Œ›s
;

54 
size_t
 
i
 = 0; i < 
MIME_ENTRIES
; i++) {

55 
mime_’Œ›s
[
i
].
ex‹nsiÚ
 = (*)
±r
;

56 
±r
 = (*)
	`¿wmemchr
(ptr + 1, '\0') + 1;

57 
mime_’Œ›s
[
i
].
ty³
 = (*)
±r
;

58 
±r
 = (*)
	`¿wmemchr
(ptr + 1, '\0') + 1;

61 
mime_’Œ›s_š™Ÿlized
 = 
Œue
;

62 
	}
}

65 
	$lwª_bËs_shutdown
()

67 
	}
}

70 
	$com·»_mime_’Œy
(cÚ¡ *
a
, cÚ¡ *
b
)

72 cÚ¡ 
mime_’Œy
 *
me1
 = 
a
;

73 cÚ¡ 
mime_’Œy
 *
me2
 = 
b
;

74  
	`¡rcmp
(
me1
->
ex‹nsiÚ
, 
me2
->extension);

75 
	}
}

78 
	$lwª_d‘”mše_mime_ty³_fÜ_fe_Çme
(cÚ¡ *
fe_Çme
)

80 *
Ï¡_dÙ
 = 
	`¡¼chr
(
fe_Çme
, '.');

81 ià(
	`UNLIKELY
(!
Ï¡_dÙ
))

82 
çÎback
;

85 
EXT_JPG
 = 
	`MULTICHAR_CONSTANT_L
('.','j','p','g'),

86 
EXT_PNG
 = 
	`MULTICHAR_CONSTANT_L
('.','p','n','g'),

87 
EXT_HTM
 = 
	`MULTICHAR_CONSTANT_L
('.','h','t','m'),

88 
EXT_CSS
 = 
	`MULTICHAR_CONSTANT_L
('.','c','s','s'),

89 
EXT_TXT
 = 
	`MULTICHAR_CONSTANT_L
('.','t','x','t'),

90 
EXT_JS
 = 
	`MULTICHAR_CONSTANT_L
('.','j','s',0),

93 
	`STRING_SWITCH_L
(
Ï¡_dÙ
) {

94 
EXT_CSS
:  "text/css";

95 
EXT_HTM
:  "text/html";

96 
EXT_JPG
:  "image/jpeg";

97 
EXT_JS
:  "application/javascript";

98 
EXT_PNG
:  "image/png";

99 
EXT_TXT
:  "text/plain";

102 ià(
	`LIKELY
(*
Ï¡_dÙ
)) {

103 
mime_’Œy
 *
’Œy
, 
key
 = { .
ex‹nsiÚ
 = 
Ï¡_dÙ
 + 1 };

105 
’Œy
 = 
	`b£¬ch
(&
key
, 
mime_’Œ›s
, 
MIME_ENTRIES
,

106 (
mime_’Œy
), 
com·»_mime_’Œy
);

107 ià(
	`LIKELY
(
’Œy
))

108  
’Œy
->
ty³
;

111 
çÎback
:

113 
	}
}

116 
	$lwª_h‰p_¡©us_as_¡ršg_w™h_code
(
lwª_h‰p_¡©us_t
 
¡©us
)

118 
¡©us
) {

119 
HTTP_OK
:  "200 OK";

120 
HTTP_PARTIAL_CONTENT
:  "206 Partial content";

121 
HTTP_MOVED_PERMANENTLY
:  "301 Moved…ermanently";

122 
HTTP_NOT_MODIFIED
:  "304 Not modified";

123 
HTTP_BAD_REQUEST
:  "400 Bad„equest";

124 
HTTP_NOT_AUTHORIZED
:  "401 Not‡uthorized";

125 
HTTP_FORBIDDEN
:  "403 Forbidden";

126 
HTTP_NOT_FOUND
:  "404 Not found";

127 
HTTP_NOT_ALLOWED
:  "405 Not‡llowed";

128 
HTTP_TIMEOUT
:  "408 Requestimeout";

129 
HTTP_TOO_LARGE
:  "413 Requestoo†arge";

130 
HTTP_RANGE_UNSATISFIABLE
:  "416 Requested„ange unsatisfiable";

131 
HTTP_INTERNAL_ERROR
:  "500 Internal serverƒrror";

132 
HTTP_UNAVAILABLE
:  "503 Service unavailable";

135 
	}
}

137 
ALWAYS_INLINE
 const *

138 
	$lwª_h‰p_¡©us_as_¡ršg
(
lwª_h‰p_¡©us_t
 
¡©us
)

140  
	`lwª_h‰p_¡©us_as_¡ršg_w™h_code
(
¡©us
) + 4;

141 
	}
}

144 
	$lwª_h‰p_¡©us_as_desütive_¡ršg
(
lwª_h‰p_¡©us_t
 
¡©us
)

146 
¡©us
) {

147 
HTTP_OK
:  "Success!";

148 
HTTP_PARTIAL_CONTENT
:  "Delivering…art of„equested„esource.";

149 
HTTP_MOVED_PERMANENTLY
:  "This content has movedo‡nother…lace.";

150 
HTTP_NOT_MODIFIED
:  "The content has‚ot changed since…revious„equest.";

151 
HTTP_BAD_REQUEST
:  "The client has issued‡ bad„equest.";

152 
HTTP_NOT_AUTHORIZED
:  "Client has‚o‡uthorizationo‡ccesshis„esource.";

153 
HTTP_FORBIDDEN
:  "Accessohis„esource has been denied.";

154 
HTTP_NOT_FOUND
:  "The„equested„esource could‚ot be found onhis server.";

155 
HTTP_NOT_ALLOWED
:  "The„equested method is‚ot‡llowed byhis server.";

156 
HTTP_TIMEOUT
:  "Client did‚ot…roduce‡„equest withinƒxpectedimeframe.";

157 
HTTP_TOO_LARGE
:  "The„equestƒntity isoo†arge.";

158 
HTTP_RANGE_UNSATISFIABLE
:  "The server can't supplyhe„equested…ortion ofhe„equested„esource.";

159 
HTTP_INTERNAL_ERROR
:  "The serverƒncountered‡n internalƒrrorhat couldn't be„ecovered from.";

160 
HTTP_UNAVAILABLE
:  "The server isƒither overloaded or down for maintenance.";

163 
	}
}

	@common/lwan-template.c

23 
	~<”ºo.h
>

24 
	~<fú.h
>

25 
	~<lim™s.h
>

26 
	~<¡dboŞ.h
>

27 
	~<¡dšt.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<sys/mmª.h
>

31 
	~<sys/¡©.h
>

32 
	~<uni¡d.h
>

34 
	~"hash.h
"

35 
	~"št-to-¡r.h
"

36 
	~"li¡.h
"

37 
	~"lwª-‹m¶©e.h
"

38 
	~"¡rbuf.h
"

40 
lwª_l_chunk_t_
 
	tlwª_l_chunk_t
;

43 
	mTPL_ACTION_APPEND
,

44 
	mTPL_ACTION_APPEND_CHAR
,

45 
	mTPL_ACTION_VARIABLE
,

46 
	mTPL_ACTION_LIST_START_ITER
,

47 
	mTPL_ACTION_LIST_END_ITER
,

48 
	mTPL_ACTION_IF_VARIABLE_NOT_EMPTY
,

49 
	mTPL_ACTION_END_IF_VARIABLE_NOT_EMPTY
,

50 
	mTPL_ACTION_APPLY_TPL
,

51 
	mTPL_ACTION_LAST


52 } 
	tlwª_l_aùiÚ_t
;

55 
	mTPL_FLAG_NEGATE
 = 1<<0

56 } 
	tlwª_l_æag_t
;

59 
	mSTATE_DEFAULT
,

60 
	mSTATE_FIRST_BRACE
,

61 
	mSTATE_SECOND_BRACE
,

62 
	mSTATE_FIRST_CLOSING_BRACE
,

63 
	mSTATE_SECOND_CLOSING_BRACE
,

64 
	mSTATE_PARSE_ERROR


67 
	slwª_l_chunk_t_
 {

68 
li¡_node
 
	mli¡
;

69 
lwª_l_aùiÚ_t
 
	maùiÚ
;

70 
lwª_l_æag_t
 
	mæags
;

71 *
	md©a
;

74 
	slwª_l_t_
 {

75 
li¡_h—d
 
	mchunks
;

76 
size_t
 
	mmšimum_size
;

79 
	ssymb
 {

80 
hash
 *
	mhash
;

81 
symb
 *
	mÃxt
;

84 
	s·r£r_¡©e
 {

85 
lwª_l_t
 *
	ml
;

86 
symb
 *
	msymb
;

89 
	schunk_desütÜ
 {

90 
lwª_l_chunk_t
 *
	mchunk
;

91 
lwª_v¬_desütÜ_t
 *
	mdesütÜ
;

94 
lwª_v¬_desütÜ_t
 *

95 
	$symb_lookup
(
·r£r_¡©e
 *
¡©e
, cÚ¡ *
v¬_Çme
)

97 
symb
 *
b
 = 
¡©e
->symb;ab;ab =ab->
Ãxt
) {

98 
lwª_v¬_desütÜ_t
 *
v¬
 = 
	`hash_fšd
(
b
->
hash
, 
v¬_Çme
);

99 ià(
v¬
)

100  
v¬
;

103  
NULL
;

104 
	}
}

106 
boŞ


107 
	$symb_push
(
·r£r_¡©e
 *
¡©e
, cÚ¡ 
lwª_v¬_desütÜ_t
 *
desütÜ
)

109 
symb
 *
b
 = 
	`m®loc
((*tab));

111 ià(!
b
)

112  
çl£
;

114 
b
->
hash
 = 
	`hash_¡r_Ãw
(
NULL
, NULL);

115 ià(!
b
->
hash
) {

116 
	`ä“
(
b
);

117  
çl£
;

120 
b
->
Ãxt
 = 
¡©e
->
symb
;

121 
¡©e
->
symb
 = 
b
;

123 ; 
desütÜ
->
Çme
; descriptor++)

124 
	`hash_add
(
¡©e
->
symb
->
hash
, 
desütÜ
->
Çme
, descriptor);

126  
Œue
;

127 
	}
}

130 
	$symb_pİ
(
·r£r_¡©e
 *
¡©e
)

132 
symb
 *
b
 = 
¡©e
->symtab;

134 
	`as£¹
(
b
);

136 
	`hash_ä“
(
b
->
hash
);

137 
¡©e
->
symb
 = 
b
->
Ãxt
;

138 
	`ä“
(
b
);

139 
	}
}

142 
	$lwª_­³nd_št_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
)

144 
cÚv”tbuf
[
INT_TO_STR_BUFFER_SIZE
];

145 
size_t
 
Ën
;

146 *
cÚv”‹d
;

148 
cÚv”‹d
 = 
	`št_to_¡ršg
(*(*)
±r
, 
cÚv”tbuf
, &
Ën
);

149 
	`¡rbuf_­³nd_¡r
(
buf
, 
cÚv”‹d
, 
Ën
);

150 
	}
}

152 
boŞ


153 
	$lwª_l_št_is_em±y
(*
±r
)

155  (*(*)
±r
) == 0;

156 
	}
}

159 
	$lwª_­³nd_doubË_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
)

161 
	`¡rbuf_­³nd_´štf
(
buf
, "%f", *(*)
±r
);

162 
	}
}

164 
boŞ


165 
	$lwª_l_doubË_is_em±y
(*
±r
)

167  (*(*)
±r
) == 0.0f;

168 
	}
}

171 
	$lwª_­³nd_¡r_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
)

173 
	sv
 {

174 *
¡r
;

175 } *
v
 = 
±r
;

177 ià(
	`LIKELY
(
v
->
¡r
))

178 
	`¡rbuf_­³nd_¡r
(
buf
, 
v
->
¡r
, 0);

179 
	}
}

182 
	$lwª_­³nd_¡r_esÿ³d_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
)

184 
	sv
 {

185 *
¡r
;

186 } *
v
 = 
±r
;

188 ià(
	`UNLIKELY
(!
v
->
¡r
))

191 *
p
 = 
v
->
¡r
; *p;…++) {

192 ià(*
p
 == '<')

193 
	`¡rbuf_­³nd_¡r
(
buf
, "&lt;", 4);

194 ià(*
p
 == '>')

195 
	`¡rbuf_­³nd_¡r
(
buf
, "&gt;", 4);

196 ià(*
p
 == '&')

197 
	`¡rbuf_­³nd_¡r
(
buf
, "&amp;", 5);

198 ià(*
p
 == '"')

199 
	`¡rbuf_­³nd_¡r
(
buf
, "&quot;", 6);

200 ià(*
p
 == '\'')

201 
	`¡rbuf_­³nd_¡r
(
buf
, "&#x27;", 6);

202 ià(*
p
 == '/')

203 
	`¡rbuf_­³nd_¡r
(
buf
, "&#x2f;", 6);

205 
	`¡rbuf_­³nd_ch¬
(
buf
, *
p
);

207 
	}
}

209 
boŞ


210 
	$lwª_l_¡r_is_em±y
(*
±r
)

212 *
¡r
 = 
±r
;

213 ià(!
¡r
)

214  
Œue
;

215 ià(*
¡r
 == '\0')

216  
Œue
;

217  
çl£
;

218 
	}
}

221 
	$compe_­³nd_‹xt
(
·r£r_¡©e
 *
¡©e
, 
¡rbuf_t
 *
buf
)

223 
size_t
 
Ëngth
 = 
	`¡rbuf_g‘_Ëngth
(
buf
);

224 ià(!
Ëngth
)

227 
lwª_l_chunk_t
 *
chunk
 = 
	`m®loc
((*chunk));

228 ià(!
chunk
)

229  -
ENOMEM
;

231 ià(
Ëngth
 == 1) {

232 
chunk
->
aùiÚ
 = 
TPL_ACTION_APPEND_CHAR
;

233 
chunk
->
d©a
 = (*)((
ušŒ_t
)
	`¡rbuf_g‘_bufãr
(
buf
)[0]);

235 
chunk
->
aùiÚ
 = 
TPL_ACTION_APPEND
;

236 
chunk
->
d©a
 = 
	`¡rbuf_Ãw_w™h_size
(
Ëngth
);

237 
	`¡rbuf_£t
(
chunk
->
d©a
, 
	`¡rbuf_g‘_bufãr
(
buf
), 
Ëngth
);

240 
	`li¡_add_
(&
¡©e
->
l
->
chunks
, &
chunk
->
li¡
);

241 
¡©e
->
l
->
mšimum_size
 +ğ
Ëngth
;

242 
	`¡rbuf_»£t
(
buf
);

245 
	}
}

248 
	$compe_­³nd_v¬
(
·r£r_¡©e
 *
¡©e
, 
¡rbuf_t
 *
buf
,

249 cÚ¡ 
lwª_v¬_desütÜ_t
 *
desütÜ
)

251 
lwª_l_chunk_t
 *
chunk
 = 
	`m®loc
((*chunk));

252 ià(!
chunk
)

253  -
ENOMEM
;

255 *
v¬ŸbË
 = 
	`¡rbuf_g‘_bufãr
(
buf
);

256 
size_t
 
Ëngth
 = 
	`¡rbuf_g‘_Ëngth
(
buf
);

257 ià(!
Ëngth
)

258 
em±y_v¬ŸbË
;

260 
Ëngth
--;

261 
chunk
->
æags
 = 0;

263 
Ãxt_ch¬
:

264 *
v¬ŸbË
) {

266 
em±y_v¬ŸbË
;

269 
chunk
->
æags
 ^ğ
TPL_FLAG_NEGATE
;

270 
v¬ŸbË
++;

271 
Ëngth
--;

272 
Ãxt_ch¬
;

275 
	`ä“
(
chunk
);

276 
	`¡rbuf_»£t
(
buf
);

280 ià(
chunk
->
æags
 & 
TPL_FLAG_NEGATE
)

281 
šv®id_Ãg©e
;

283 
‹m¶©e_fe
[
PATH_MAX
];

284 
	`¢´štf
(
‹m¶©e_fe
, Ñem¶©e_fe), "%s.l", 
v¬ŸbË
 + 1);

286 
lwª_l_t
 *
šşuded
 = 
	`lwª_l_compe_fe
(
‹m¶©e_fe
, 
desütÜ
);

287 ià(!
šşuded
) {

288 
	`ä“
(
chunk
);

289  -
ENOENT
;

291 
chunk
->
aùiÚ
 = 
TPL_ACTION_APPLY_TPL
;

292 
chunk
->
d©a
 = 
šşuded
;

296 
chunk
->
d©a
 = 
	`symb_lookup
(
¡©e
, 
v¬ŸbË
 + 1);

297 ià(!
chunk
->
d©a
)

298 
no_such_key
;

300 
chunk
->
aùiÚ
 = 
TPL_ACTION_LIST_START_ITER
;

301 
lwª_v¬_desütÜ_t
 *
chd
 = 
chunk
->
d©a
;

302 
	`symb_push
(
¡©e
, 
chd
->
li¡_desc
);

305 ià(
chunk
->
æags
 & 
TPL_FLAG_NEGATE
)

306 
šv®id_Ãg©e
;

308 
lwª_l_chunk_t
 *
¡¬t_chunk
;

309 
lwª_v¬_desütÜ_t
 *
desü
;

310 
boŞ
 
was_if
 = 
çl£
;

312 ià(
v¬ŸbË
[
Ëngth
] == '?') {

313 
v¬ŸbË
[
Ëngth
] = '\0';

314 
was_if
 = 
Œue
;

317 
desü
 = 
	`symb_lookup
(
¡©e
, 
v¬ŸbË
 + 1);

318 ià(!
desü
)

319 
no_such_key
;

321 ià(
was_if
) {

322 
chunk
->
aùiÚ
 = 
TPL_ACTION_END_IF_VARIABLE_NOT_EMPTY
;

323 
	`li¡_fÜ_—ch_»v
(&
¡©e
->
l
->
chunks
, 
¡¬t_chunk
, 
li¡
) {

324 ià(
¡¬t_chunk
->
aùiÚ
 !ğ
TPL_ACTION_IF_VARIABLE_NOT_EMPTY
)

326 ià(
¡¬t_chunk
->
d©a
 !ğ
desü
)

329 
chunk
->
d©a
 = 
desü
;

330 
add_chunk
;

333 
chunk
->
aùiÚ
 = 
TPL_ACTION_LIST_END_ITER
;

334 
	`li¡_fÜ_—ch_»v
(&
¡©e
->
l
->
chunks
, 
¡¬t_chunk
, 
li¡
) {

335 ià(
¡¬t_chunk
->
d©a
 =ğ
desü
) {

336 
chunk
->
d©a
 = 
¡¬t_chunk
;

337 
	`symb_pİ
(
¡©e
);

338 
add_chunk
;

343 
no_such_key
;

346 ià(
chunk
->
æags
 & 
TPL_FLAG_NEGATE
)

347 
šv®id_Ãg©e
;

349 ià(
v¬ŸbË
[
Ëngth
] == '?') {

350 
chunk
->
aùiÚ
 = 
TPL_ACTION_IF_VARIABLE_NOT_EMPTY
;

351 
v¬ŸbË
[
Ëngth
] = '\0';

353 
chunk
->
aùiÚ
 = 
TPL_ACTION_VARIABLE
;

355 
chunk
->
d©a
 = 
	`symb_lookup
(
¡©e
, 
v¬ŸbË
);

356 ià(!
chunk
->
d©a
)

357 
no_such_key
;

360 
add_chunk
:

361 
	`li¡_add_
(&
¡©e
->
l
->
chunks
, &
chunk
->
li¡
);

362 
¡©e
->
l
->
mšimum_size
 +ğ
Ëngth
 + 1;

363 
	`¡rbuf_»£t
(
buf
);

367 
no_such_key
:

368 
	`ä“
(
chunk
);

369  -
ENOKEY
;

371 
šv®id_Ãg©e
:

372 
	`ä“
(
chunk
);

373  -
EILSEQ
;

375 
em±y_v¬ŸbË
:

376 
	`ä“
(
chunk
);

377  -
ENOTNAM
;

378 
	}
}

381 
	$ä“_chunk
(
lwª_l_chunk_t
 *
chunk
)

383 ià(!
chunk
)

386 
chunk
->
aùiÚ
) {

387 
TPL_ACTION_LAST
:

388 
TPL_ACTION_APPEND_CHAR
:

389 
TPL_ACTION_VARIABLE
:

390 
TPL_ACTION_END_IF_VARIABLE_NOT_EMPTY
:

391 
TPL_ACTION_LIST_END_ITER
:

394 
TPL_ACTION_IF_VARIABLE_NOT_EMPTY
:

395 
TPL_ACTION_LIST_START_ITER
:

396 
	`ä“
(
chunk
->
d©a
);

398 
TPL_ACTION_APPEND
:

399 
	`¡rbuf_ä“
(
chunk
->
d©a
);

401 
TPL_ACTION_APPLY_TPL
:

402 
	`lwª_l_ä“
(
chunk
->
d©a
);

406 
	`ä“
(
chunk
);

407 
	}
}

410 
	$lwª_l_ä“
(
lwª_l_t
 *
l
)

412 ià(!
l
)

415 
lwª_l_chunk_t
 *
chunk
;

416 
lwª_l_chunk_t
 *
Ãxt
;

417 
	`li¡_fÜ_—ch_§ã
(&
l
->
chunks
, 
chunk
, 
Ãxt
, 
li¡
) {

418 
	`li¡_d–
(&
chunk
->
li¡
);

419 
	`ä“_chunk
(
chunk
);

422 
	`ä“
(
l
);

423 
	}
}

425 
	#PARSE_ERROR
(
msg
,...) \

427 
	`¢´štf
(
”rÜ_msg
, 512, 
msg
, ##
__VA_ARGS__
); \

428  
STATE_PARSE_ERROR
; \

429 } 0)

	)

432 
	$ãed_što_comp”
(
·r£r_¡©e
 *parser_state,

433 cÚ¡ 
lwª_v¬_desütÜ_t
 *
desütÜ
,

434 
¡©e
,

435 
¡rbuf_t
 *
buf
,

436 
ch
,

437 *
”rÜ_msg
)

439 
boŞ
 
Ï¡_·ss
 = 
ch
 =ğ
EOF
;

441 
¡©e
) {

442 
STATE_DEFAULT
:

443 ià(
ch
 == '{')

444  
STATE_FIRST_BRACE
;

445 ià(
Ï¡_·ss
)

446 
­³nd_‹xt
;

448 
	`¡rbuf_­³nd_ch¬
(
buf
, ()
ch
);

451 
STATE_FIRST_BRACE
:

452 ià(
ch
 == '{') {

453 
¡©e
 = 
STATE_SECOND_BRACE
;

454 
­³nd_‹xt
;

457 
	`¡rbuf_­³nd_ch¬
(
buf
, '{');

459 ià(
Ï¡_·ss
)

460 
­³nd_‹xt
;

462 
	`¡rbuf_­³nd_ch¬
(
buf
, ()
ch
);

464  
STATE_DEFAULT
;

466 
STATE_SECOND_BRACE
:

467 ià(
ch
 == '{')

468 
	`PARSE_ERROR
("Unexpected open brace");

469 ià(
ch
 == '}')

470  
STATE_FIRST_CLOSING_BRACE
;

471 ià(
Ï¡_·ss
)

472 
	`PARSE_ERROR
("Missing close brace");

474 
	`¡rbuf_­³nd_ch¬
(
buf
, ()
ch
);

477 
STATE_FIRST_CLOSING_BRACE
:

478 ià(
ch
 == '}')

479  
STATE_SECOND_CLOSING_BRACE
;

481 
	`PARSE_ERROR
("Closing braceƒxpected");

483 
STATE_SECOND_CLOSING_BRACE
:

484 
	`compe_­³nd_v¬
(
·r£r_¡©e
, 
buf
, 
desütÜ
)) {

485 -
EILSEQ
:

486 
	`PARSE_ERROR
("Neg©iÚ‚Ù suµÜ‹d fÜ ``%s''", 
	`¡rbuf_g‘_bufãr
(
buf
));

487 -
ENOTNAM
:

488 
	`PARSE_ERROR
("Expecting variable‚ame");

489 -
ENOKEY
:

490 
	`PARSE_ERROR
("UnknowÀv¬ŸbË: ``%s''", 
	`¡rbuf_g‘_bufãr
(
buf
));

491 -
ENOMEM
:

492 
	`PARSE_ERROR
("Out of memory while‡ppending variable");

493 -
ENOENT
:

494 
	`PARSE_ERROR
("Cannot findemplateo include: ``%s''",

495 
	`¡rbuf_g‘_bufãr
(
buf
) + 1);

498 ià(
Ï¡_·ss
)

499  
STATE_DEFAULT
;

500 ià(
ch
 == '{')

501  
STATE_FIRST_BRACE
;

503 
	`¡rbuf_­³nd_ch¬
(
buf
, ()
ch
);

504  
STATE_DEFAULT
;

507  
¡©e
;

509 
­³nd_‹xt
:

510 
	`compe_­³nd_‹xt
(
·r£r_¡©e
, 
buf
)) {

511 -
ENOMEM
:

512 
	`PARSE_ERROR
("Out of memory while‡ppendingext");

515  
¡©e
;

516 
	}
}

519 
	$po¡_´oûss_‹m¶©e
(
lwª_l_t
 *
l
)

521 
lwª_l_chunk_t
 *
chunk
;

522 
lwª_l_chunk_t
 *
´ev_chunk
;

524 
	`li¡_fÜ_—ch
(&
l
->
chunks
, 
chunk
, 
li¡
) {

525 ià(
chunk
->
aùiÚ
 =ğ
TPL_ACTION_IF_VARIABLE_NOT_EMPTY
) {

526 
´ev_chunk
 = 
chunk
;

528 (
chunk
 = (
lwª_l_chunk_t
 *èchunk->
li¡
.
Ãxt
)) {

529 ià(
chunk
->
aùiÚ
 =ğ
TPL_ACTION_LAST
)

531 ià(
chunk
->
aùiÚ
 =ğ
TPL_ACTION_END_IF_VARIABLE_NOT_EMPTY


532 && 
chunk
->
d©a
 =ğ
´ev_chunk
->data)

536 
chunk_desütÜ
 *
cd
 = 
	`m®loc
((*cd));

537 ià(!
cd
)

538 
	`lwª_¡©us_ü™iÿl_³¼Ü
("malloc");

540 
cd
->
desütÜ
 = 
´ev_chunk
->
d©a
;

541 
cd
->
chunk
 = chunk;

542 
´ev_chunk
->
d©a
 = 
cd
;

543 } ià(
chunk
->
aùiÚ
 =ğ
TPL_ACTION_LIST_START_ITER
) {

544 
lwª_l_æag_t
 
æags
 = 
chunk
->flags;

546 
´ev_chunk
 = 
chunk
;

548 (
chunk
 = (
lwª_l_chunk_t
 *èchunk->
li¡
.
Ãxt
)) {

549 ià(
chunk
->
aùiÚ
 =ğ
TPL_ACTION_LAST
)

551 ià(
chunk
->
aùiÚ
 =ğ
TPL_ACTION_LIST_END_ITER


552 && 
chunk
->
d©a
 =ğ
´ev_chunk
) {

553 
chunk
->
æags
 |= flags;

558 
chunk_desütÜ
 *
cd
 = 
	`m®loc
((*cd));

559 ià(!
cd
)

560 
	`lwª_¡©us_ü™iÿl_³¼Ü
("malloc");

562 
cd
->
desütÜ
 = 
´ev_chunk
->
d©a
;

563 
´ev_chunk
->
d©a
 = 
cd
;

565 ià(!
chunk
 || chunk->
aùiÚ
 =ğ
TPL_ACTION_LAST
)

566 
cd
->
chunk
 = chunk;

568 
cd
->
chunk
 = (
lwª_l_chunk_t
 *)chunk->
li¡
.
Ãxt
;

569 } ià(
chunk
->
aùiÚ
 =ğ
TPL_ACTION_LAST
) {

573 
	}
}

575 
lwª_l_t
 *

576 
	$lwª_l_compe_¡ršg
(cÚ¡ *
¡ršg
, cÚ¡ 
lwª_v¬_desütÜ_t
 *
desütÜ
)

578 
lwª_l_t
 *
l
;

579 
¡rbuf_t
 *
buf
;

580 
¡©e
 = 
STATE_DEFAULT
;

581 
”rÜ_msg
[512];

582 
·r£r_¡©e
…arser_state;

584 
l
 = 
	`ÿÎoc
(1, (*tpl));

585 ià(!
l
)

586 
”rÜ_®loÿ‹_l
;

588 
	`li¡_h—d_š™
(&
l
->
chunks
);

590 
·r£r_¡©e
.
l
 =pl;

591 
·r£r_¡©e
.
symb
 = 
NULL
;

592 ià(!
	`symb_push
(&
·r£r_¡©e
, 
desütÜ
))

593 
”rÜ_symb_push
;

595 
buf
 = 
	`¡rbuf_Ãw
();

596 ià(!
buf
)

597 
”rÜ_®loÿ‹_¡rbuf
;

599 
lše
 = 1;

600 
cŞumn
 = 1;

601 ; *
¡ršg
; string++) {

602 ià(*
¡ršg
 == '\n') {

603 ià(
¡©e
 =ğ
STATE_DEFAULT
)

604 
	`¡rbuf_­³nd_ch¬
(
buf
, '\n');

606 ++
lše
;

607 
cŞumn
 = 1;

610 ++
cŞumn
;

612 
¡©e
 = 
	`ãed_što_comp”
(&
·r£r_¡©e
, 
desütÜ
, state,

613 
buf
, *
¡ršg
, 
”rÜ_msg
);

614 ià(
¡©e
 =ğ
STATE_PARSE_ERROR
)

615 
·r£_”rÜ
;

618 
¡©e
 = 
	`ãed_što_comp”
(&
·r£r_¡©e
, 
desütÜ
, state,

619 
buf
, 
EOF
, 
”rÜ_msg
);

620 ià(
¡©e
 =ğ
STATE_PARSE_ERROR
)

621 
·r£_”rÜ
;

623 
lwª_l_chunk_t
 *
Ï¡
 = 
	`m®loc
((*last));

624 ià(!
Ï¡
)

625 
ä“_¡rbuf
;

627 
Ï¡
->
aùiÚ
 = 
TPL_ACTION_LAST
;

628 
Ï¡
->
d©a
 = 
NULL
;

630 
	`li¡_add_
(&
·r£r_¡©e
.
l
->
chunks
, &
Ï¡
->
li¡
);

632 
	`¡rbuf_ä“
(
buf
);

633 
	`symb_pİ
(&
·r£r_¡©e
);

635 
	`po¡_´oûss_‹m¶©e
(
l
);

637  
l
;

639 
·r£_”rÜ
:

640 
	`lwª_¡©us_”rÜ
("Lš%d, cŞumÀ%d: %s", 
lše
, 
cŞumn
, 
”rÜ_msg
);

642 
ä“_¡rbuf
:

643 
	`¡rbuf_ä“
(
buf
);

645 
”rÜ_®loÿ‹_¡rbuf
:

646 
	`symb_pİ
(&
·r£r_¡©e
);

648 
”rÜ_symb_push
:

649 
	`lwª_l_ä“
(
l
);

651 
”rÜ_®loÿ‹_l
:

652  
NULL
;

653 
	}
}

655 #undeà
PARSE_ERROR


657 
lwª_l_t
 *

658 
	$lwª_l_compe_fe
(cÚ¡ *
f’ame
, cÚ¡ 
lwª_v¬_desütÜ_t
 *
desütÜ
)

660 
fd
;

661 
¡©
 
¡
;

662 *
m­³d
;

663 
lwª_l_t
 *
l
 = 
NULL
;

665 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

666 ià(
fd
 < 0)

667 
’d
;

669 ià(
	`f¡©
(
fd
, &
¡
) < 0)

670 
şo£_fe
;

672 
m­³d
 = 
	`mm­
(
NULL
, (
size_t
)
¡
.
¡_size
, 
PROT_READ
, 
MAP_SHARED
, 
fd
, 0);

673 ià(
m­³d
 =ğ
MAP_FAILED
)

674 
şo£_fe
;

676 
l
 = 
	`lwª_l_compe_¡ršg
(
m­³d
, 
desütÜ
);

678 ià(
	`munm­
(
m­³d
, (
size_t
)
¡
.
¡_size
) < 0)

679 
	`lwª_¡©us_³¼Ü
("munmap");

681 
şo£_fe
:

682 
	`şo£
(
fd
);

683 
’d
:

684  
l
;

685 
	}
}

687 
boŞ


688 
uÁ_’d
(
lwª_l_chunk_t
 *
chunk
, *
d©a
 
__©Œibu‹__
((
unu£d
)))

690  
	gchunk
->
	gaùiÚ
 =ğ
TPL_ACTION_LAST
;

693 
boŞ


694 
	$uÁ_found_’d_if
(
lwª_l_chunk_t
 *
chunk
, *
d©a
)

696  
chunk
 =ğ
d©a
;

697 
	}
}

699 
boŞ


700 
	$uÁ_™”_’d
(
lwª_l_chunk_t
 *
chunk
, *
d©a
)

702 ià(
chunk
->
aùiÚ
 !ğ
TPL_ACTION_LIST_END_ITER
)

703  
çl£
;

704 ià(
d©a
 !ğ
chunk
->data)

705  
çl£
;

706  
Œue
;

707 
	}
}

710 
	$­³nd_v¬_to_¡rbuf
(
lwª_l_chunk_t
 *
chunk
, *
v¬ŸbËs
,

711 
¡rbuf_t
 *
buf
)

713 
lwª_v¬_desütÜ_t
 *
desütÜ
 = 
chunk
->
d©a
;

714 ià(
	`LIKELY
(
desütÜ
))

715 
desütÜ
->
	`­³nd_to_¡rbuf
(
buf
, (*)
v¬ŸbËs
 + desütÜ->
off£t
);

716 
	}
}

718 
boŞ


719 
	$v¬_g‘_is_em±y
(
lwª_v¬_desütÜ_t
 *
desütÜ
,

720 *
v¬ŸbËs
)

722 ià(
	`UNLIKELY
(!
desütÜ
))

723  
Œue
;

725  
desütÜ
->
	`g‘_is_em±y
((*)((*)
v¬ŸbËs
 + desütÜ->
off£t
));

726 
	}
}

728 
lwª_l_chunk_t
 *

729 
lwª_l_­¶y_uÁ
(
lwª_l_t
 *
l
,

730 
lwª_l_chunk_t
 *
chunks
, 
¡rbuf_t
 *
buf
,

731 *
v¬ŸbËs
,

732 
	$boŞ
 (*
uÁ
)(
lwª_l_chunk_t
 *
chunk
, *
d©a
), *
uÁ_d©a
)

734 
cÜo_sw™ch”_t
 
sw™ch”
;

735 
cÜo_t
 *
cÜo
 = 
NULL
;

736 
lwª_l_chunk_t
 *
chunk
 = 
chunks
;

738 ià(
	`UNLIKELY
(!
chunk
))

739 
out
;

742 ià(
	`uÁ
(
chunk
, 
uÁ_d©a
))

745 
chunk
->
aùiÚ
) {

746 
TPL_ACTION_APPEND
:

747 
	`¡rbuf_­³nd_¡r
(
buf
, 
	`¡rbuf_g‘_bufãr
(
chunk
->
d©a
),

748 
	`¡rbuf_g‘_Ëngth
(
chunk
->
d©a
));

750 
TPL_ACTION_APPEND_CHAR
:

751 
	`¡rbuf_­³nd_ch¬
(
buf
, ()(
ušŒ_t
)
chunk
->
d©a
);

753 
TPL_ACTION_VARIABLE
:

754 
	`­³nd_v¬_to_¡rbuf
(
chunk
, 
v¬ŸbËs
, 
buf
);

756 
TPL_ACTION_IF_VARIABLE_NOT_EMPTY
: {

757 
chunk_desütÜ
 *
cd
 = 
chunk
->
d©a
;

758 
boŞ
 
em±y
 = 
	`v¬_g‘_is_em±y
(
cd
->
desütÜ
, 
v¬ŸbËs
);

759 ià(
chunk
->
æags
 & 
TPL_FLAG_NEGATE
)

760 
em±y
 = !empty;

761 ià(
em±y
) {

762 
chunk
 = 
cd
->chunk;

764 
chunk
 = 
	`lwª_l_­¶y_uÁ
(
l
,

765 (
lwª_l_chunk_t
 *è
chunk
->
li¡
.
Ãxt
, 
buf
, 
v¬ŸbËs
,

766 
uÁ_found_’d_if
, 
cd
->
chunk
);

770 
TPL_ACTION_APPLY_TPL
: {

771 
¡rbuf_t
 *
tmp
;

773 
tmp
 = 
	`lwª_l_­¶y
(
chunk
->
d©a
, 
v¬ŸbËs
);

774 
	`¡rbuf_­³nd_¡r
(
buf
, 
	`¡rbuf_g‘_bufãr
(
tmp
), 
	`¡rbuf_g‘_Ëngth
(tmp));

775 
	`¡rbuf_ä“
(
tmp
);

778 
TPL_ACTION_LIST_START_ITER
: {

779 ià(
	`UNLIKELY
(
cÜo
 !ğ
NULL
)) {

780 
	`lwª_¡©us_w¬nšg
("Coroutine is‚ot NULL when starting iteration");

784 
chunk_desütÜ
 *
cd
 = 
chunk
->
d©a
;

785 
cÜo
 = 
	`cÜo_Ãw
(&
sw™ch”
, 
cd
->
desütÜ
->
g’”©Ü
, 
v¬ŸbËs
);

787 
boŞ
 
»sumed
 = 
	`cÜo_»sume_v®ue
(
cÜo
, 0);

788 
lwª_l_æag_t
 
æags
 = 
chunk
->flags;

789 ià(
æags
 & 
TPL_FLAG_NEGATE
)

790 
»sumed
 = !resumed;

791 ià(!
»sumed
) {

792 
chunk
 = 
cd
->chunk;

793 ià(
æags
 & 
TPL_FLAG_NEGATE
) {

794 
	`cÜo_»sume_v®ue
(
cÜo
, 1);

795 
	`cÜo_ä“
(
cÜo
);

796 
cÜo
 = 
NULL
;

800 
	`cÜo_ä“
(
cÜo
);

801 
cÜo
 = 
NULL
;

806 
chunk
 = 
	`lwª_l_­¶y_uÁ
(
l
, (
lwª_l_chunk_t
 *èchunk->
li¡
.
Ãxt
,

807 
buf
, 
v¬ŸbËs
, 
uÁ_™”_’d
, 
chunk
);

810 
TPL_ACTION_LIST_END_ITER
: {

811 ià(
	`UNLIKELY
(!
cÜo
)) {

812 ià(!
chunk
->
æags
)

813 
	`lwª_¡©us_w¬nšg
("Coroutine is NULL when finishing iteration");

817 ià(!
	`cÜo_»sume_v®ue
(
cÜo
, 0)) {

818 
	`cÜo_ä“
(
cÜo
);

819 
cÜo
 = 
NULL
;

823 
lwª_l_chunk_t
 *
Ãxt
 = 
chunk
->
d©a
;

824 
Ãxt
 = (
lwª_l_chunk_t
 *êext->
li¡
.next;

826 
chunk
 = 
	`lwª_l_­¶y_uÁ
(
l
, 
Ãxt
, 
buf
, 
v¬ŸbËs
, 
uÁ_™”_’d
,

827 
chunk
->
d©a
);

830 
TPL_ACTION_END_IF_VARIABLE_NOT_EMPTY
:

831 
TPL_ACTION_LAST
:

836 ià(!
chunk
)

838 
chunk
 = (
lwª_l_chunk_t
 *)chunk->
li¡
.
Ãxt
;

839 } 
chunk
);

841 
out
:

842  
chunk
;

843 
	}
}

845 
¡rbuf_t
 *

846 
	$lwª_l_­¶y_w™h_bufãr
(
lwª_l_t
 *
l
, 
¡rbuf_t
 *
buf
, *
v¬ŸbËs
)

848 ià(
	`UNLIKELY
(!
	`¡rbuf_»£t_Ëngth
(
buf
)))

849  
NULL
;

851 ià(
	`UNLIKELY
(!
	`¡rbuf_grow_to
(
buf
, 
l
->
mšimum_size
)))

852  
NULL
;

854 
	`lwª_l_­¶y_uÁ
(
l
, (
lwª_l_chunk_t
 *)&l->
chunks
.
n
, 
buf
, 
v¬ŸbËs
, 
uÁ_’d
, 
NULL
);

855  
buf
;

856 
	}
}

858 
¡rbuf_t
 *

859 
	$lwª_l_­¶y
(
lwª_l_t
 *
l
, *
v¬ŸbËs
)

861 
¡rbuf_t
 *
buf
 = 
	`¡rbuf_Ãw_w™h_size
(
l
->
mšimum_size
);

862  
	`lwª_l_­¶y_w™h_bufãr
(
l
, 
buf
, 
v¬ŸbËs
);

863 
	}
}

865 #ifdeà
TEMPLATE_TEST


867 
	s‹¡_¡ruù
 {

868 
	msome_št
;

869 *
	ma_¡ršg
;

872 
	$maš
(
¬gc
, *
¬gv
[])

874 ià(
¬gc
 < 2) {

875 
	`´štf
("U§ge: % fe.l\n", 
¬gv
[0]);

879 
	`´štf
("*** Compilingemplate...\n");

880 
lwª_v¬_desütÜ_t
 
desc
[] = {

881 
	`TPL_VAR_INT
(
‹¡_¡ruù
, 
some_št
),

882 
	`TPL_VAR_STR
(
‹¡_¡ruù
, 
a_¡ršg
),

883 
TPL_VAR_SENTINEL


885 
lwª_l_t
 *
l
 = 
	`lwª_l_compe_fe
(
¬gv
[1], 
desc
);

886 ià(!
l
)

889 
	`´štf
("*** Applyingemplate 100000imes...\n");

890 
size_t
 
i
 = 0; i < 100000; i++) {

891 
¡rbuf_t
 *
­¶›d
 = 
	`lwª_l_­¶y
(
l
, (
‹¡_¡ruù
[]) {{

892 .
some_št
 = 42,

893 .
a_¡ršg
 = "some string"

895 
	`¡rbuf_ä“
(
­¶›d
);

898 
	`lwª_l_ä“
(
l
);

900 
	}
}

	@common/lwan-template.h

19 #iâdeà
__TEMPLATE_H__


20 
	#__TEMPLATE_H__


	)

22 
	~<¡ddef.h
>

23 
	~"¡rbuf.h
"

24 
	~"lwª-cÜo.h
"

26 
lwª_l_t_
 
	tlwª_l_t
;

27 
lwª_v¬_desütÜ_t_
 
	tlwª_v¬_desütÜ_t
;

29 (*
	tlwª_l_li¡_g’”©Ü_t
)(
	tcÜo_t
 *
	tcÜo
);

31 
	slwª_v¬_desütÜ_t_
 {

32 cÚ¡ *
Çme
;

33 cÚ¡ 
off_t
 
off£t
;

35 (*
­³nd_to_¡rbuf
)(
¡rbuf_t
 *
buf
, *
±r
);

36 
	`boŞ
 (*
g‘_is_em±y
)(*
±r
);

38 
lwª_l_li¡_g’”©Ü_t
 
g’”©Ü
;

39 cÚ¡ 
lwª_v¬_desütÜ_t
 *
li¡_desc
;

42 
	#TPL_VAR_SIMPLE
(
¡ruù_
, 
v¬_
, 
­³nd_to_¡rbuf_
, 
g‘_is_em±y_
) \

44 .
Çme
 = #var_, \

45 .
off£t
 = 
	`off£tof
(
¡ruù_
, 
v¬_
), \

46 .
­³nd_to_¡rbuf
 = 
­³nd_to_¡rbuf_
, \

47 .
g‘_is_em±y
 = 
g‘_is_em±y_
 \

48 
	}

	)
}

50 
	#TPL_VAR_SEQUENCE
(
¡ruù_
, 
v¬_
, 
g’”©Ü_
, 
£q™em_desc_
) \

52 .
Çme
 = #var_, \

53 .
off£t
 = 
	`off£tof
(
¡ruù_
, 
v¬_
.
g’”©Ü
), \

54 .
g’”©Ü
 = 
g’”©Ü_
, \

55 .
li¡_desc
 = 
£q™em_desc_
 \

56 }

	)

58 
	#TPL_VAR_INT
(
¡ruù_
, 
v¬_
) \

59 
	`TPL_VAR_SIMPLE
(
¡ruù_
, 
v¬_
, 
lwª_­³nd_št_to_¡rbuf
, 
lwª_l_št_is_em±y
)

	)

61 
	#TPL_VAR_DOUBLE
(
¡ruù_
, 
v¬_
) \

62 
	`TPL_VAR_SIMPLE
(
¡ruù_
, 
v¬_
, 
lwª_­³nd_doubË_to_¡rbuf
, 
lwª_l_doubË_is_em±y
)

	)

64 
	#TPL_VAR_STR
(
¡ruù_
, 
v¬_
) \

65 
	`TPL_VAR_SIMPLE
(
¡ruù_
, 
v¬_
, 
lwª_­³nd_¡r_to_¡rbuf
, 
lwª_l_¡r_is_em±y
)

	)

67 
	#TPL_VAR_STR_ESCAPE
(
¡ruù_
, 
v¬_
) \

68 
	`TPL_VAR_SIMPLE
(
¡ruù_
, 
v¬_
, 
lwª_­³nd_¡r_esÿ³d_to_¡rbuf
, 
lwª_l_¡r_is_em±y
)

	)

70 
	#TPL_VAR_SENTINEL
 \

71 { 
NULL
, 0, NULL, NULL, NULL, NULL }

	)

78 
lwª_­³nd_št_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
);

79 
boŞ
 
lwª_l_št_is_em±y
(*
±r
);

80 
lwª_­³nd_¡r_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
);

81 
lwª_­³nd_¡r_esÿ³d_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
);

82 
boŞ
 
lwª_l_¡r_is_em±y
(*
±r
);

83 
lwª_­³nd_doubË_to_¡rbuf
(
¡rbuf_t
 *
buf
, *
±r
);

84 
boŞ
 
lwª_l_doubË_is_em±y
(*
±r
);

86 
lwª_l_t
 *
lwª_l_compe_¡ršg
(cÚ¡ *
¡ršg
, cÚ¡ 
lwª_v¬_desütÜ_t
 *
desütÜ
);

87 
lwª_l_t
 *
lwª_l_compe_fe
(cÚ¡ *
f’ame
, cÚ¡ 
lwª_v¬_desütÜ_t
 *
desütÜ
);

88 
¡rbuf_t
 *
lwª_l_­¶y
(
lwª_l_t
 *
l
, *
v¬ŸbËs
);

89 
¡rbuf_t
 *
lwª_l_­¶y_w™h_bufãr
(
lwª_l_t
 *
l
, sŒbuf_ˆ*
buf
, *
v¬ŸbËs
);

90 
lwª_l_ä“
(
lwª_l_t
 *
l
);

	@common/lwan-thread.c

20 
	#_GNU_SOURCE


	)

21 
	~<as£¹.h
>

22 
	~<”ºo.h
>

23 
	~<fú.h
>

24 
	~<±h»ad.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<sys/•Şl.h
>

28 
	~<uni¡d.h
>

30 
	~"lwª.h
"

32 
	sd—th_queue_t
 {

33 
lwª_cÚÃùiÚ_t
 *
	mcÚns
;

34 
lwª_cÚÃùiÚ_t
 
	mh—d
;

35 
	mtime
;

36 
	mk“p_®ive_timeout
;

39 cÚ¡ 
	gev’ts_by_wr™e_æag
[] = {

40 
EPOLLOUT
 | 
EPOLLRDHUP
 | 
EPOLLERR
,

41 
EPOLLIN
 | 
EPOLLRDHUP
 | 
EPOLLERR
 | 
EPOLLET


44 
šlše
 
	$d—th_queue_node_to_idx
(
d—th_queue_t
 *
dq
,

45 
lwª_cÚÃùiÚ_t
 *
cÚn
)

47  (
cÚn
 =ğ&
dq
->
h—d
è? -1 : ()(
±rdiff_t
)(cÚÀ- dq->
cÚns
);

48 
	}
}

50 
šlše
 
lwª_cÚÃùiÚ_t
 *
	$d—th_queue_idx_to_node
(
d—th_queue_t
 *
dq
,

51 
idx
)

53  (
idx
 < 0è? &
dq
->
h—d
 : &dq->
cÚns
[idx];

54 
	}
}

56 
	$d—th_queue_š£¹
(
d—th_queue_t
 *
dq
,

57 
lwª_cÚÃùiÚ_t
 *
Ãw_node
)

59 
Ãw_node
->
Ãxt
 = -1;

60 
Ãw_node
->
´ev
 = 
dq
->
h—d
.prev;

61 
lwª_cÚÃùiÚ_t
 *
´ev
 = 
	`d—th_queue_idx_to_node
(
dq
, dq->
h—d
.prev);

62 
dq
->
h—d
.
´ev
 =…»v->
Ãxt
 = 
	`d—th_queue_node_to_idx
(dq, 
Ãw_node
);

63 
	}
}

65 
	$d—th_queue_»move
(
d—th_queue_t
 *
dq
,

66 
lwª_cÚÃùiÚ_t
 *
node
)

68 
lwª_cÚÃùiÚ_t
 *
´ev
 = 
	`d—th_queue_idx_to_node
(
dq
, 
node
->prev);

69 
lwª_cÚÃùiÚ_t
 *
Ãxt
 = 
	`d—th_queue_idx_to_node
(
dq
, 
node
->next);

70 
Ãxt
->
´ev
 = 
node
->prev;

71 
´ev
->
Ãxt
 = 
node
->next;

72 
	}
}

74 
boŞ
 
	$d—th_queue_em±y
(
d—th_queue_t
 *
dq
)

76  
dq
->
h—d
.
Ãxt
 < 0;

77 
	}
}

79 
	$d—th_queue_move_to_Ï¡
(
d—th_queue_t
 *
dq
,

80 
lwª_cÚÃùiÚ_t
 *
cÚn
)

90 
cÚn
->
time_to_d›
 = 
dq
->
time
 + dq->
k“p_®ive_timeout
 *

91 ()!!(
cÚn
->
æags
 & (
CONN_KEEP_ALIVE
 | 
CONN_SHOULD_RESUME_CORO
));

93 
	`d—th_queue_»move
(
dq
, 
cÚn
);

94 
	`d—th_queue_š£¹
(
dq
, 
cÚn
);

95 
	}
}

98 
	$d—th_queue_š™
(
d—th_queue_t
 *
dq
, 
lwª_cÚÃùiÚ_t
 *
cÚns
,

99 
k“p_®ive_timeout
)

101 
dq
->
cÚns
 = conns;

102 
dq
->
time
 = 0;

103 
dq
->
k“p_®ive_timeout
 = keep_alive_timeout;

104 
dq
->
h—d
.
Ãxt
 = dq->h—d.
´ev
 = -1;

105 
	}
}

107 
ALWAYS_INLINE
 

108 
	$d—th_queue_•Şl_timeout
(
d—th_queue_t
 *
dq
)

110  
	`d—th_queue_em±y
(
dq
) ? -1 : 1000;

111 
	}
}

113 
ALWAYS_INLINE
 

114 
	$de¡roy_cÜo
(
d—th_queue_t
 *
dq
, 
lwª_cÚÃùiÚ_t
 *
cÚn
)

116 
	`d—th_queue_»move
(
dq
, 
cÚn
);

117 ià(
	`LIKELY
(
cÚn
->
cÜo
)) {

118 
	`cÜo_ä“
(
cÚn
->
cÜo
);

119 
cÚn
->
cÜo
 = 
NULL
;

121 ià(
cÚn
->
æags
 & 
CONN_IS_ALIVE
) {

122 
cÚn
->
æags
 &ğ~
CONN_IS_ALIVE
;

123 
	`şo£
(
	`lwª_cÚÃùiÚ_g‘_fd
(
cÚn
));

125 
	}
}

127 
ALWAYS_INLINE
 

128 
	$mš
(cÚ¡ 
a
, cÚ¡ 
b
)

130  
a
 < 
b
 ?‡ : b;

131 
	}
}

134 
	$´oûss_»que¡_cÜo
(
cÜo_t
 *
cÜo
)

136 
¡rbuf_t
 *
¡rbuf
 = 
	`cÜo_m®loc_fuÎ
(
cÜo
, (*¡rbuf), 
¡rbuf_ä“
);

137 ià(
	`UNLIKELY
(!
¡rbuf
))

138  
CONN_CORO_ABORT
;

140 
lwª_cÚÃùiÚ_t
 *
cÚn
 = 
	`cÜo_g‘_d©a
(
cÜo
);

141 
lwª_»que¡_t
 
»que¡
 = {

142 .
cÚn
 = conn,

143 .
fd
 = 
	`lwª_cÚÃùiÚ_g‘_fd
(
cÚn
),

144 .
»¥Ú£
 = {

145 .
bufãr
 = 
¡rbuf


149 
	`as£¹
(
cÚn
->
æags
 & 
CONN_IS_ALIVE
);

151 
	`¡rbuf_š™
(
¡rbuf
);

152 
	`lwª_´oûss_»que¡
(
cÚn
->
th»ad
->
lwª
, &
»que¡
);

154  
CONN_CORO_FINISHED
;

155 
	}
}

157 
ALWAYS_INLINE
 

158 
	$»sume_cÜo_if_Ãeded
(
d—th_queue_t
 *
dq
, 
lwª_cÚÃùiÚ_t
 *
cÚn
,

159 
•Şl_fd
)

161 
	`as£¹
(
cÚn
->
cÜo
);

163 ià(!(
cÚn
->
æags
 & 
CONN_SHOULD_RESUME_CORO
))

166 
lwª_cÚÃùiÚ_cÜo_y›ld_t
 
y›ld_»suÉ
 = 
	`cÜo_»sume
(
cÚn
->
cÜo
);

168 ià(
y›ld_»suÉ
 < 
CONN_CORO_MAY_RESUME
) {

169 
	`de¡roy_cÜo
(
dq
, 
cÚn
);

173 
boŞ
 
should_»sume_cÜo
 = 
y›ld_»suÉ
 =ğ
CONN_CORO_MAY_RESUME
;

174 
boŞ
 
wr™e_ev’ts
 = 
cÚn
->
æags
 & 
CONN_WRITE_EVENTS
;

175 ià(
should_»sume_cÜo
)

176 
cÚn
->
æags
 |ğ
CONN_SHOULD_RESUME_CORO
;

178 
cÚn
->
æags
 &ğ~
CONN_SHOULD_RESUME_CORO
;

179 ià(
should_»sume_cÜo
 =ğ
wr™e_ev’ts
)

182 
fd
 = 
	`lwª_cÚÃùiÚ_g‘_fd
(
cÚn
);

183 
•Şl_ev’t
 
ev’t
 = {

184 .
ev’ts
 = 
ev’ts_by_wr™e_æag
[
wr™e_ev’ts
],

185 .
d©a
.
±r
 = 
cÚn


188 ià(
	`UNLIKELY
(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_MOD
, 
fd
, &
ev’t
) < 0))

189 
	`lwª_¡©us_³¼Ü
("epoll_ctl");

191 
cÚn
->
æags
 ^ğ
CONN_WRITE_EVENTS
;

192 
	}
}

195 
	$d—th_queue_kl_wa™šg
(
d—th_queue_t
 *
dq
)

197 
dq
->
time
++;

199 !
	`d—th_queue_em±y
(
dq
)) {

200 
lwª_cÚÃùiÚ_t
 *
cÚn
 = 
	`d—th_queue_idx_to_node
(
dq
, dq->
h—d
.
Ãxt
);

202 ià(
cÚn
->
time_to_d›
 > 
dq
->
time
)

205 
	`de¡roy_cÜo
(
dq
, 
cÚn
);

209 
dq
->
time
 = 0;

210 
	}
}

213 
	$lwª_fÜm©_rfc_time
(
time_t
 
t
, 
bufãr
[30])

215 
tm
m;

217 ià(
	`UNLIKELY
(!
	`gmtime_r
(&
t
, &
tm
))) {

218 
	`lwª_¡©us_³¼Ü
("gmtime_r");

222 ià(
	`UNLIKELY
(!
	`¡ráime
(
bufãr
, 30, "%a, %d %b %Y %H:%M:%S GMT", &
tm
)))

223 
	`lwª_¡©us_³¼Ü
("strftime");

224 
	}
}

227 
	$upd©e_d©e_ÿche
(
lwª_th»ad_t
 *
th»ad
)

229 
time_t
 
now
 = 
	`time
(
NULL
);

230 ià(
now
 !ğ
th»ad
->
d©e
.
Ï¡
) {

231 
th»ad
->
d©e
.
Ï¡
 = 
now
;

232 
	`lwª_fÜm©_rfc_time
(
now
, 
th»ad
->
d©e
.date);

233 
	`lwª_fÜm©_rfc_time
(
now
 + (
time_t
)
th»ad
->
lwª
->
cÚfig
.
expœes
,

234 
th»ad
->
d©e
.
expœes
);

236 
	}
}

238 
ALWAYS_INLINE
 

239 
	$¥awn_Ü_»£t_cÜo_if_Ãeded
(
lwª_cÚÃùiÚ_t
 *
cÚn
,

240 
cÜo_sw™ch”_t
 *
sw™ch”
, 
d—th_queue_t
 *
dq
)

242 ià(
cÚn
->
cÜo
) {

243 ià(
cÚn
->
æags
 & 
CONN_SHOULD_RESUME_CORO
)

246 
	`cÜo_»£t
(
cÚn
->
cÜo
, 
´oûss_»que¡_cÜo
, conn);

248 
cÚn
->
cÜo
 = 
	`cÜo_Ãw
(
sw™ch”
, 
´oûss_»que¡_cÜo
, conn);

250 
	`d—th_queue_š£¹
(
dq
, 
cÚn
);

251 
cÚn
->
æags
 |ğ
CONN_IS_ALIVE
;

253 
cÚn
->
æags
 |ğ
CONN_SHOULD_RESUME_CORO
;

254 
cÚn
->
æags
 &ğ~
CONN_WRITE_EVENTS
;

255 
	}
}

257 
lwª_cÚÃùiÚ_t
 *

258 
	$g¿b_ªd_w©ch_ş›Á
(
lwª_th»ad_t
 *
t
, 
lwª_cÚÃùiÚ_t
 *
cÚns
)

260 
fd
;

261 ià(
	`UNLIKELY
(
	`»ad
(
t
->
pe_fd
[0], &
fd
, ()) != ())) {

262 
	`lwª_¡©us_³¼Ü
("read");

263  
NULL
;

266 
•Şl_ev’t
 
ev’t
 = {

267 .
ev’ts
 = 
ev’ts_by_wr™e_æag
[1],

268 .
d©a
.
±r
 = &
cÚns
[
fd
]

270 ià(
	`UNLIKELY
(
	`•Şl_ùl
(
t
->
•Şl_fd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev’t
) < 0))

271 
	`lwª_¡©us_ü™iÿl_³¼Ü
("epoll_ctl");

273  &
cÚns
[
fd
];

274 
	}
}

277 
	$th»ad_io_loİ
(*
d©a
)

279 
lwª_th»ad_t
 *
t
 = 
d©a
;

280 
•Şl_ev’t
 *
ev’ts
;

281 
lwª_cÚÃùiÚ_t
 *
cÚns
 = 
t
->
lwª
->conns;

282 
cÜo_sw™ch”_t
 
sw™ch”
;

283 
d—th_queue_t
 
dq
;

284 
•Şl_fd
 = 
t
->epoll_fd;

285 
n_fds
;

286 cÚ¡ 
max_ev’ts
 = 
	`mš
(()
t
->
lwª
->
th»ad
.
max_fd
, 1024);

288 
	`lwª_¡©us_debug
("S¹šg IO†oİ oÀth»ad #%d", 
t
->
id
 + 1);

290 
ev’ts
 = 
	`ÿÎoc
((
size_t
)
max_ev’ts
, (*events));

291 ià(
	`UNLIKELY
(!
ev’ts
))

292 
	`lwª_¡©us_ü™iÿl
("Could‚ot‡llocate memory forƒvents");

294 
	`d—th_queue_š™
(&
dq
, 
cÚns
, 
t
->
lwª
->
cÚfig
.
k“p_®ive_timeout
);

297 
n_fds
 = 
	`•Şl_wa™
(
•Şl_fd
, 
ev’ts
, 
max_ev’ts
,

298 
	`d—th_queue_•Şl_timeout
(&
dq
))) {

300 
”ºo
) {

301 
EBADF
:

302 
EINVAL
:

303 
•Şl_fd_şo£d
;

307 
	`d—th_queue_kl_wa™šg
(&
dq
);

310 
	`upd©e_d©e_ÿche
(
t
);

312 
•Şl_ev’t
 *
•_ev’t
 = 
ev’ts
; 
n_fds
--;ƒp_event++) {

313 
lwª_cÚÃùiÚ_t
 *
cÚn
;

315 ià(!
•_ev’t
->
d©a
.
±r
) {

316 
cÚn
 = 
	`g¿b_ªd_w©ch_ş›Á
(
t
, 
cÚns
);

317 ià(
	`UNLIKELY
(!
cÚn
))

319 
	`¥awn_Ü_»£t_cÜo_if_Ãeded
(
cÚn
, &
sw™ch”
, &
dq
);

321 
cÚn
 = 
•_ev’t
->
d©a
.
±r
;

322 ià(
	`UNLIKELY
(
•_ev’t
->
ev’ts
 & (
EPOLLRDHUP
 | 
EPOLLHUP
))) {

323 
	`de¡roy_cÜo
(&
dq
, 
cÚn
);

327 
	`¥awn_Ü_»£t_cÜo_if_Ãeded
(
cÚn
, &
sw™ch”
, &
dq
);

328 
	`»sume_cÜo_if_Ãeded
(&
dq
, 
cÚn
, 
•Şl_fd
);

331 
	`d—th_queue_move_to_Ï¡
(&
dq
, 
cÚn
);

336 
•Şl_fd_şo£d
:

337 
	`ä“
(
ev’ts
);

339  
NULL
;

340 
	}
}

343 
	$ü—‹_th»ad
(
lwª_t
 *
l
, 
th»ad_n
)

345 
±h»ad_©Œ_t
 
©Œ
;

346 
lwª_th»ad_t
 *
th»ad
 = &
l
->th»ad.
th»ads
[
th»ad_n
];

348 
	`mem£t
(
th»ad
, 0, (*thread));

349 
th»ad
->
lwª
 = 
l
;

350 
th»ad
->
id
 = 
th»ad_n
;

352 ià((
th»ad
->
•Şl_fd
 = 
	`•Şl_ü—‹1
(0)) < 0)

353 
	`lwª_¡©us_ü™iÿl_³¼Ü
("epoll_create");

355 ià(
	`±h»ad_©Œ_š™
(&
©Œ
))

356 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pthread_attr_init");

358 ià(
	`±h»ad_©Œ_£tscİe
(&
©Œ
, 
PTHREAD_SCOPE_SYSTEM
))

359 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pthread_attr_setscope");

361 ià(
	`±h»ad_©Œ_£td‘ach¡©e
(&
©Œ
, 
PTHREAD_CREATE_JOINABLE
))

362 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pthread_attr_setdetachstate");

364 ià(
	`±h»ad_ü—‹
(&
th»ad
->
£lf
, &
©Œ
, 
th»ad_io_loİ
,hread))

365 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pthread_create");

367 ià(
	`±h»ad_©Œ_de¡roy
(&
©Œ
))

368 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pthread_attr_destroy");

370 ià(
	`pe2
(
th»ad
->
pe_fd
, 
O_NONBLOCK
) < 0)

371 
	`lwª_¡©us_ü™iÿl_³¼Ü
("pipe");

373 
•Şl_ev’t
 
ev’t
 = { .
ev’ts
 = 
EPOLLIN
, .
d©a
.
±r
 = 
NULL
 };

374 ià(
	`•Şl_ùl
(
th»ad
->
•Şl_fd
, 
EPOLL_CTL_ADD
,h»ad->
pe_fd
[0], &
ev’t
) < 0)

375 
	`lwª_¡©us_ü™iÿl_³¼Ü
("epoll_ctl");

376 
	}
}

379 
	$lwª_th»ad_add_ş›Á
(
lwª_th»ad_t
 *
t
, 
fd
)

381 
t
->
lwª
->
cÚns
[
fd
].
æags
 = 0;

382 
t
->
lwª
->
cÚns
[
fd
].
th»ad
 =;

384 ià(
	`UNLIKELY
(
	`wr™e
(
t
->
pe_fd
[1], &
fd
, ()) < 0))

385 
	`lwª_¡©us_³¼Ü
("write");

386 
	}
}

389 
	$lwª_th»ad_š™
(
lwª_t
 *
l
)

391 
	`lwª_¡©us_debug
("Initializinghreads");

393 
l
->
th»ad
.
th»ads
 = 
	`ÿÎoc
((
size_t
î->th»ad.
couÁ
, (
lwª_th»ad_t
));

394 ià(!
l
->
th»ad
.
th»ads
)

395 
	`lwª_¡©us_ü™iÿl
("Could‚ot‡llocate memory forhreads");

397 
i
 = 0; i < 
l
->
th»ad
.
couÁ
; i++)

398 
	`ü—‹_th»ad
(
l
, 
i
);

399 
	}
}

402 
	$lwª_th»ad_shutdown
(
lwª_t
 *
l
)

404 
	`lwª_¡©us_debug
("Shutting downhreads");

406 
i
 = 
l
->
th»ad
.
couÁ
 - 1; i >= 0; i--) {

407 
lwª_th»ad_t
 *
t
 = &
l
->
th»ad
.
th»ads
[
i
];

410 
	`şo£
(
t
->
•Şl_fd
);

412 
	`şo£
(
t
->
pe_fd
[0]);

413 
	`şo£
(
t
->
pe_fd
[1]);

415 
	`±h»ad_Œyjoš_Å
(
l
->
th»ad
.
th»ads
[
i
].
£lf
, 
NULL
);

418 
	`ä“
(
l
->
th»ad
.
th»ads
);

419 
	}
}

	@common/lwan-trie.c

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

23 
	~"lwª.h
"

25 
lwª_Œ›_node_t_
 
	tlwª_Œ›_node_t
;

26 
lwª_Œ›_Ëaf_t_
 
	tlwª_Œ›_Ëaf_t
;

28 
	slwª_Œ›_node_t_
 {

29 
lwª_Œ›_node_t
 *
	mÃxt
[8];

30 
lwª_Œ›_Ëaf_t
 *
	mËaf
;

31 
	m»f_couÁ
;

34 
	slwª_Œ›_Ëaf_t_
 {

35 *
	mkey
;

36 *
	md©a
;

37 
lwª_Œ›_Ëaf_t
 *
	mÃxt
;

40 
	slwª_Œ›_t_
 {

41 
lwª_Œ›_node_t
 *
	mroÙ
;

42 (*
	mä“_node
)(*
	md©a
);

45 
lwª_Œ›_t
 *

46 
lwª_Œ›_Ãw
((*
ä“_node
)(*
d©a
))

48 
lwª_Œ›_t
 *
Œ›
;

49 
Œ›
 = 
	`ÿÎoc
(1, (
lwª_Œ›_t
));

50 ià(!
Œ›
)

51  
NULL
;

52 
Œ›
->
ä“_node
 = free_node;

53  
Œ›
;

54 
	}
}

56 
ALWAYS_INLINE
 
lwª_Œ›_Ëaf_t
 *

57 
	$fšd_Ëaf_w™h_key
(
lwª_Œ›_node_t
 *
node
, cÚ¡ *
key
, 
size_t
 
Ën
)

59 
lwª_Œ›_Ëaf_t
 *
Ëaf
 = 
node
->leaf;

61 ià(!
Ëaf
)

62  
NULL
;

64 ià(!
Ëaf
->
Ãxt
)

65  
Ëaf
;

67 ; 
Ëaf
;†—àğËaf->
Ãxt
) {

68 ià(!
	`¡ºcmp
(
Ëaf
->
key
, key, 
Ën
 - 1))

69  
Ëaf
;

72  
NULL
;

73 
	}
}

75 
	#GET_NODE
() \

77 ià(!(
node
 = *
knode
)) { \

78 *
knode
 = 
node
 = 
	`ÿÎoc
(1, (*node)); \

79 ià(!
node
) \

80 
oom
; \

82 ++
node
->
»f_couÁ
; \

83 } 0)

	)

86 
	$lwª_Œ›_add
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
, *
d©a
)

88 ià(
	`UNLIKELY
(!
Œ›
 || !
key
 || !
d©a
))

91 
lwª_Œ›_node_t
 **
knode
, *
node
;

92 cÚ¡ *
Üig_key
 = 
key
;

95 
knode
 = &
Œ›
->
roÙ
; *
key
; knodğ&
node
->
Ãxt
[()(*key++ & 7)])

96 
	`GET_NODE
();

99 
	`GET_NODE
();

101 
lwª_Œ›_Ëaf_t
 *
Ëaf
 = 
	`fšd_Ëaf_w™h_key
(
node
, 
Üig_key
, (
size_t
)(
key
 - orig_key));

102 
boŞ
 
had_key
 = 
Ëaf
;

103 ià(!
Ëaf
) {

104 
Ëaf
 = 
	`m®loc
((*leaf));

105 ià(!
Ëaf
)

106 
	`lwª_¡©us_ü™iÿl_³¼Ü
("malloc");

109 
Ëaf
->
d©a
 = data;

110 ià(!
had_key
) {

111 
Ëaf
->
key
 = 
	`¡rdup
(
Üig_key
);

112 
Ëaf
->
Ãxt
 = 
node
->leaf;

113 
node
->
Ëaf
 =†eaf;

117 
oom
:

118 
	`lwª_¡©us_ü™iÿl_³¼Ü
("calloc");

119 
	}
}

121 #undeà
GET_NODE


123 
ALWAYS_INLINE
 
lwª_Œ›_node_t
 *

124 
	$lookup_node
(
lwª_Œ›_node_t
 *
roÙ
, cÚ¡ *
key
, 
boŞ
 
´efix
, 
size_t
 *
´efix_Ën
)

126 
lwª_Œ›_node_t
 *
node
, *
´evious_node
 = 
NULL
;

127 cÚ¡ *
Üig_key
 = 
key
;

129 
node
 = 
roÙ
;‚od&& *
key
;‚odğnode->
Ãxt
[()(*key++ & 7)]) {

130 ià(
node
->
Ëaf
)

131 
´evious_node
 = 
node
;

134 *
´efix_Ën
 = (
size_t
)(
key
 - 
Üig_key
);

135 ià(
node
 &&‚ode->
Ëaf
)

136  
node
;

137 ià(
´efix
 && 
´evious_node
)

138  
´evious_node
;

139  
NULL
;

140 
	}
}

143 
ALWAYS_INLINE
 *

144 
	$lwª_Œ›_lookup_fuÎ
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
, 
boŞ
 
´efix
)

146 ià(
	`UNLIKELY
(!
Œ›
))

147  
NULL
;

149 
size_t
 
´efix_Ën
;

150 
lwª_Œ›_node_t
 *
node
 = 
	`lookup_node
(
Œ›
->
roÙ
, 
key
, 
´efix
, &
´efix_Ën
);

151 ià(!
node
)

152  
NULL
;

153 
lwª_Œ›_Ëaf_t
 *
Ëaf
 = 
	`fšd_Ëaf_w™h_key
(
node
, 
key
, 
´efix_Ën
);

154  
Ëaf
 ?†—f->
d©a
 : 
NULL
;

155 
	}
}

157 
ALWAYS_INLINE
 *

158 
	$lwª_Œ›_lookup_´efix
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
)

160  
	`lwª_Œ›_lookup_fuÎ
(
Œ›
, 
key
, 
Œue
);

161 
	}
}

163 
ALWAYS_INLINE
 *

164 
	$lwª_Œ›_lookup_exaù
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
)

166  
	`lwª_Œ›_lookup_fuÎ
(
Œ›
, 
key
, 
çl£
);

167 
	}
}

169 
ALWAYS_INLINE
 
št32_t


170 
	$lwª_Œ›_’Œy_couÁ
(
lwª_Œ›_t
 *
Œ›
)

172  (
Œ›
 &&r›->
roÙ
è?r›->roÙ->
»f_couÁ
 : 0;

173 
	}
}

176 
	$lwª_Œ›_node_de¡roy
(
lwª_Œ›_t
 *
Œ›
, 
lwª_Œ›_node_t
 *
node
)

178 ià(!
node
)

181 
št32_t
 
nodes_de¡royed
 = 
node
->
»f_couÁ
;

183 
lwª_Œ›_Ëaf_t
 *
Ëaf
 = 
node
->leaf;†eaf;) {

184 
lwª_Œ›_Ëaf_t
 *
tmp
 = 
Ëaf
->
Ãxt
;

186 ià(
Œ›
->
ä“_node
)

187 
Œ›
->
	`ä“_node
(
Ëaf
->
d©a
);

189 
	`ä“
(
Ëaf
->
key
);

190 
	`ä“
(
Ëaf
);

191 
Ëaf
 = 
tmp
;

194 
št32_t
 
i
 = 0; 
nodes_de¡royed
 > 0 && i < 8; i++) {

195 ià(
node
->
Ãxt
[
i
]) {

196 
	`lwª_Œ›_node_de¡roy
(
Œ›
, 
node
->
Ãxt
[
i
]);

197 --
nodes_de¡royed
;

201 
	`ä“
(
node
);

202 
	}
}

205 
	$lwª_Œ›_de¡roy
(
lwª_Œ›_t
 *
Œ›
)

207 ià(!
Œ›
 || !Œ›->
roÙ
)

209 
	`lwª_Œ›_node_de¡roy
(
Œ›
,r›->
roÙ
);

210 
	`ä“
(
Œ›
);

211 
	}
}

	@common/lwan-trie.h

20 #iâdeà
__LWAN_TRIE_H__


21 
	#__LWAN_TRIE_H__


	)

23 
	~<¡dboŞ.h
>

24 
	~<¡dšt.h
>

26 
lwª_Œ›_t_
 
	tlwª_Œ›_t
;

28 
lwª_Œ›_t
 *
lwª_Œ›_Ãw
((*
ä“_node
)(*
d©a
));

29 
	`lwª_Œ›_de¡roy
(
lwª_Œ›_t
 *
Œ›
);

30 
	`lwª_Œ›_add
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
, *
d©a
);

31 *
	`lwª_Œ›_lookup_fuÎ
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
, 
boŞ
 
´efix
);

32 *
	`lwª_Œ›_lookup_´efix
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
);

33 *
	`lwª_Œ›_lookup_exaù
(
lwª_Œ›_t
 *
Œ›
, cÚ¡ *
key
);

34 
št32_t
 
	`lwª_Œ›_’Œy_couÁ
(
lwª_Œ›_t
 *
Œ›
);

	@common/lwan.c

20 
	#_GNU_SOURCE


	)

21 
	~<as£¹.h
>

22 
	~<dlfú.h
>

23 
	~<lim™s.h
>

24 
	~<sigÇl.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<sys/•Şl.h
>

28 
	~<sys/»sourû.h
>

29 
	~<uni¡d.h
>

30 
	~<”ºo.h
>

32 
	~"lwª.h
"

33 
	~"lwª-´iv©e.h
"

35 
	~"lwª-cÚfig.h
"

36 
	~"lwª-h‰p-authÜize.h
"

37 
	~"lwª-lua.h
"

38 
	~"lwª-»dœeù.h
"

39 
	~"lwª-£rve-fes.h
"

41 cÚ¡ 
lwª_cÚfig_t
 
	gdeçuÉ_cÚfig
 = {

42 .
li¡’”
 = "localhost:8080",

43 .
	gk“p_®ive_timeout
 = 15,

44 .
	gqu›t
 = 
çl£
,

45 .
	g»u£_pÜt
 = 
çl£
,

46 .
	gexpœes
 = 1 * 
ONE_WEEK


49 
	$lwª_moduË_š™
(
lwª_t
 *
l
)

51 ià(!
l
->
moduË_»gi¡ry
) {

52 
	`lwª_¡©us_debug
("Initializing module„egistry");

53 
l
->
moduË_»gi¡ry
 = 
	`hash_¡r_Ãw
(
NULL
, NULL);

55 
	}
}

57 
	$lwª_moduË_shutdown
(
lwª_t
 *
l
)

59 
	`hash_ä“
(
l
->
moduË_»gi¡ry
);

60 
	}
}

62 
	$lwª_moduË_»gi¡”
(
lwª_t
 *
l
, cÚ¡ 
lwª_moduË_t
 *
moduË
)

64 ià(!
moduË
->
Çme
)

65 
	`lwª_¡©us_ü™iÿl
("ModuË‡ˆ%°ha nØÇme", 
moduË
);

67 
	`lwª_¡©us_debug
("Regi¡”šg moduË \"%s\"", 
moduË
->
Çme
);

68 
	`hash_add
(
l
->
moduË_»gi¡ry
, 
moduË
->
Çme
, module);

69 
	}
}

71 cÚ¡ 
lwª_moduË_t
 *
	$lwª_moduË_fšd
(
lwª_t
 *
l
, cÚ¡ *
Çme
)

73  
	`hash_fšd
(
l
->
moduË_»gi¡ry
, 
Çme
);

74 
	}
}

76 *
	$fšd_hªdËr_symbŞ
(cÚ¡ *
Çme
)

78 *
symbŞ
 = 
	`dlsym
(
RTLD_NEXT
, 
Çme
);

79 ià(!
symbŞ
)

80 
symbŞ
 = 
	`dlsym
(
RTLD_DEFAULT
, 
Çme
);

81  
symbŞ
;

82 
	}
}

84 
	$de¡roy_u¾m­
(*
d©a
)

86 
lwª_u¾_m­_t
 *
u¾_m­
 = 
d©a
;

88 ià(
u¾_m­
->
moduË
) {

89 cÚ¡ 
lwª_moduË_t
 *
moduË
 = 
u¾_m­
->module;

90 ià(
moduË
->
shutdown
)

91 
moduË
->
	`shutdown
(
u¾_m­
->
d©a
);

92 } ià(
u¾_m­
->
d©a
) {

93 
	`hash_ä“
(
u¾_m­
->
d©a
);

96 
	`ä“
(
u¾_m­
->
authÜiz©iÚ
.
»®m
);

97 
	`ä“
(
u¾_m­
->
authÜiz©iÚ
.
·sswÜd_fe
);

98 
	`ä“
(
u¾_m­
->
´efix
);

99 
	`ä“
(
u¾_m­
);

100 
	}
}

102 
lwª_u¾_m­_t
 *
	$add_u¾_m­
(
lwª_Œ›_t
 *
t
, cÚ¡ *
´efix
, cÚ¡ 
lwª_u¾_m­_t
 *
m­
)

104 
lwª_u¾_m­_t
 *
cİy
 = 
	`m®loc
((*copy));

106 ià(!
cİy
)

107 
	`lwª_¡©us_ü™iÿl_³¼Ü
("Could‚ot copy URL map");

109 
	`memıy
(
cİy
, 
m­
, (*copy));

111 
cİy
->
´efix
 = 
	`¡rdup
(prefix ?…refix : copy->prefix);

112 
cİy
->
´efix_Ën
 = 
	`¡¾’
(cİy->
´efix
);

113 
	`lwª_Œ›_add
(
t
, 
cİy
->
´efix
, copy);

115  
cİy
;

116 
	}
}

118 
	$·r£_li¡’”_´efix_authÜiz©iÚ
(
cÚfig_t
 *
c
,

119 
cÚfig_lše_t
 *
l
, 
lwª_u¾_m­_t
 *
u¾_m­
)

121 ià(
	`¡rcmp
(
l
->
£ùiÚ
.
·¿m
, "basic")) {

122 
	`cÚfig_”rÜ
(
c
, "Only basic‡uthorization supported");

126 
	`mem£t
(&
u¾_m­
->
authÜiz©iÚ
, 0, (url_map->authorization));

128 
	`cÚfig_»ad_lše
(
c
, 
l
)) {

129 
l
->
ty³
) {

130 
CONFIG_LINE_TYPE_LINE
:

131 ià(!
	`¡rcmp
(
l
->
lše
.
key
, "realm")) {

132 
	`ä“
(
u¾_m­
->
authÜiz©iÚ
.
»®m
);

133 
u¾_m­
->
authÜiz©iÚ
.
»®m
 = 
	`¡rdup
(
l
->
lše
.
v®ue
);

134 } ià(!
	`¡rcmp
(
l
->
lše
.
key
, "password file")) {

135 
	`ä“
(
u¾_m­
->
authÜiz©iÚ
.
·sswÜd_fe
);

136 
u¾_m­
->
authÜiz©iÚ
.
·sswÜd_fe
 = 
	`¡rdup
(
l
->
lše
.
v®ue
);

140 
CONFIG_LINE_TYPE_SECTION
:

141 
	`cÚfig_”rÜ
(
c
, "UÃx³ùed seùiÚ: %s", 
l
->
£ùiÚ
.
Çme
);

142 
”rÜ
;

144 
CONFIG_LINE_TYPE_SECTION_END
:

145 ià(!
u¾_m­
->
authÜiz©iÚ
.
»®m
)

146 
u¾_m­
->
authÜiz©iÚ
.
»®m
 = 
	`¡rdup
("Lwan");

147 ià(!
u¾_m­
->
authÜiz©iÚ
.
·sswÜd_fe
)

148 
u¾_m­
->
authÜiz©iÚ
.
·sswÜd_fe
 = 
	`¡rdup
("htpasswd");

150 
u¾_m­
->
æags
 |ğ
HANDLER_MUST_AUTHORIZE
;

151 
out
;

155 
out
:

158 
”rÜ
:

159 
	`ä“
(
u¾_m­
->
authÜiz©iÚ
.
»®m
);

160 
	`ä“
(
u¾_m­
->
authÜiz©iÚ
.
·sswÜd_fe
);

161 
	}
}

163 
	$·r£_li¡’”_´efix
(
cÚfig_t
 *
c
, 
cÚfig_lše_t
 *
l
, 
lwª_t
 *
lwª
,

164 cÚ¡ 
lwª_moduË_t
 *
moduË
)

166 
lwª_u¾_m­_t
 
u¾_m­
 = {0};

167 
hash
 *hash = 
	`hash_¡r_Ãw
(
ä“
, free);

168 *
hªdËr
 = 
NULL
;

169 *
´efix
 = 
	`¡rdu·
(
l
->
lše
.
v®ue
);

171 
	`cÚfig_»ad_lše
(
c
, 
l
)) {

172 
l
->
ty³
) {

173 
CONFIG_LINE_TYPE_LINE
:

174 ià(!
	`¡rcmp
(
l
->
lše
.
key
, "module")) {

175 ià(
moduË
) {

176 
	`cÚfig_”rÜ
(
c
, "Module‡lready specified");

177 
out
;

179 
moduË
 = 
	`lwª_moduË_fšd
(
lwª
, 
l
->
lše
.
v®ue
);

180 ià(!
moduË
) {

181 
	`cÚfig_”rÜ
(
c
, "Could‚Ù fšd moduË \"%s\"", 
l
->
lše
.
v®ue
);

182 
out
;

184 } ià(!
	`¡rcmp
(
l
->
lše
.
key
, "handler")) {

185 
hªdËr
 = 
	`fšd_hªdËr_symbŞ
(
l
->
lše
.
v®ue
);

186 ià(!
hªdËr
) {

187 
	`cÚfig_”rÜ
(
c
, "Could‚Ù fšd hªdË¸\"%s\"", 
l
->
lše
.
v®ue
);

188 
out
;

191 
	`hash_add
(
hash
, 
	`¡rdup
(
l
->
lše
.
key
), sŒdupÖ->lše.
v®ue
));

195 
CONFIG_LINE_TYPE_SECTION
:

196 ià(!
	`¡rcmp
(
l
->
£ùiÚ
.
Çme
, "authorization")) {

197 
	`·r£_li¡’”_´efix_authÜiz©iÚ
(
c
, 
l
, &
u¾_m­
);

199 
	`cÚfig_”rÜ
(
c
, "UnknowÀ£ùiÚy³: \"%s\"", 
l
->
£ùiÚ
.
Çme
);

200 
out
;

204 
CONFIG_LINE_TYPE_SECTION_END
:

205 
add_m­
;

209 
	`cÚfig_”rÜ
(
c
, "Expecting sectionƒnd while…arsing…refix");

210 
out
;

212 
add_m­
:

213 ià(
moduË
 =ğ
hªdËr
 && !handler) {

214 
	`cÚfig_”rÜ
(
c
, "Missing module or handler");

215 
out
;

217 ià(
moduË
 && 
hªdËr
) {

218 
	`cÚfig_”rÜ
(
c
, "Handler‡nd module‡re mutuallyƒxclusive");

219 
out
;

222 ià(
hªdËr
) {

223 
u¾_m­
.
hªdËr
 = handler;

224 
u¾_m­
.
æags
 |ğ
HANDLER_PARSE_MASK
;

225 
u¾_m­
.
d©a
 = 
hash
;

226 
u¾_m­
.
moduË
 = 
NULL
;

228 
hash
 = 
NULL
;

229 } ià(
moduË
 && moduË->
š™_äom_hash
 && moduË->
hªdË
) {

230 
u¾_m­
.
d©a
 = 
moduË
->
	`š™_äom_hash
(
hash
);

231 
u¾_m­
.
hªdËr
 = 
moduË
->
hªdË
;

232 
u¾_m­
.
æags
 |ğ
moduË
->flags;

233 
u¾_m­
.
moduË
 = module;

235 
	`cÚfig_”rÜ
(
c
, "Invalid handler");

236 
out
;

239 
	`add_u¾_m­
(
lwª
->
u¾_m­_Œ›
, 
´efix
, &
u¾_m­
);

241 
out
:

242 
	`hash_ä“
(
hash
);

243 
	}
}

245 
	$lwª_£t_u¾_m­
(
lwª_t
 *
l
, cÚ¡ 
lwª_u¾_m­_t
 *
m­
)

247 
	`lwª_Œ›_de¡roy
(
l
->
u¾_m­_Œ›
);

248 
l
->
u¾_m­_Œ›
 = 
	`lwª_Œ›_Ãw
(
de¡roy_u¾m­
);

250 ; 
m­
->
´efix
; map++) {

251 
lwª_u¾_m­_t
 *
cİy
 = 
	`add_u¾_m­
(
l
->
u¾_m­_Œ›
, 
NULL
, 
m­
);

253 ià(
	`UNLIKELY
(!
cİy
))

256 ià(
cİy
->
moduË
 && cİy->moduË->
š™
) {

257 
cİy
->
d©a
 = cİy->
moduË
->
	`š™
(cİy->
¬gs
);

258 
cİy
->
æags
 = cİy->
moduË
->flags;

259 
cİy
->
hªdËr
 = cİy->
moduË
->
hªdË
;

261 
cİy
->
æags
 = 
HANDLER_PARSE_MASK
;

264 
	}
}

266 
	$·r£_li¡’”
(
cÚfig_t
 *
c
, 
cÚfig_lše_t
 *
l
, 
lwª_t
 *
lwª
)

268 
lwª
->
cÚfig
.
li¡’”
 = 
	`¡rdup
(
l
->
£ùiÚ
.
·¿m
);

270 
	`cÚfig_»ad_lše
(
c
, 
l
)) {

271 
l
->
ty³
) {

272 
CONFIG_LINE_TYPE_LINE
:

273 
	`cÚfig_”rÜ
(
c
, "Expecting…refix section");

275 
CONFIG_LINE_TYPE_SECTION
:

276 ià(!
	`¡rcmp
(
l
->
£ùiÚ
.
Çme
, "prefix")) {

277 
	`·r£_li¡’”_´efix
(
c
, 
l
, 
lwª
, 
NULL
);

279 cÚ¡ 
lwª_moduË_t
 *
moduË
 = 
	`lwª_moduË_fšd
(
lwª
, 
l
->
£ùiÚ
.
Çme
);

280 ià(!
moduË
) {

281 
	`cÚfig_”rÜ
(
c
, "Invalid section‚ame or module‚ot found: %s",

282 
l
->
£ùiÚ
.
Çme
);

284 
	`·r£_li¡’”_´efix
(
c
, 
l
, 
lwª
, 
moduË
);

288 
CONFIG_LINE_TYPE_SECTION_END
:

293 
	`cÚfig_”rÜ
(
c
, "Expecting sectionƒnd while…arsing†istener");

294 
	}
}

296 cÚ¡ *
	$g‘_cÚfig_·th
(*
·th_buf
)

298 *
·th
 = 
NULL
;

299 
ssize_t
 
·th_Ën
;

303 
·th_Ën
 = 
	`»adlšk
("/´oc/£lf/exe", 
·th_buf
, 
PATH_MAX
);

304 ià(
·th_Ën
 < 0)

305 
out
;

306 
·th_buf
[
·th_Ën
] = '\0';

307 
·th
 = 
	`¡¼chr
(
·th_buf
, '/');

308 ià(!
·th
)

309 
out
;

310 ià(
	`¢´štf
(
·th_buf
, 
PATH_MAX
, "%s.cÚf", 
·th
 + 1) < 0)

311 
out
;

313  
·th_buf
;

315 
out
:

317 
	}
}

319 
boŞ
 
	$£tup_äom_cÚfig
(
lwª_t
 *
lwª
)

321 
cÚfig_t
 
cÚf
;

322 
cÚfig_lše_t
 
lše
;

323 
boŞ
 
has_li¡’”
 = 
çl£
;

324 
·th_buf
[
PATH_MAX
];

325 cÚ¡ *
·th
;

327 
·th
 = 
	`g‘_cÚfig_·th
(
·th_buf
);

328 
	`lwª_¡©us_šfo
("Lßdšg cÚfigu¿tiÚ fe: %s", 
·th
);

330 
lwª
->
u¾_m­_Œ›
 = 
	`lwª_Œ›_Ãw
(
de¡roy_u¾m­
);

332 ià(!
	`cÚfig_İ’
(&
cÚf
, 
·th
))

333  
çl£
;

335 
	`cÚfig_»ad_lše
(&
cÚf
, &
lše
)) {

336 
lše
.
ty³
) {

337 
CONFIG_LINE_TYPE_LINE
:

338 ià(!
	`¡rcmp
(
lše
.lše.
key
, "keep_alive_timeout"))

339 
lwª
->
cÚfig
.
k“p_®ive_timeout
 = ()
	`·r£_lÚg
(
lše
.lše.
v®ue
,

340 
deçuÉ_cÚfig
.
k“p_®ive_timeout
);

341 ià(!
	`¡rcmp
(
lše
.lše.
key
, "quiet"))

342 
lwª
->
cÚfig
.
qu›t
 = 
	`·r£_boŞ
(
lše
.lše.
v®ue
,

343 
deçuÉ_cÚfig
.
qu›t
);

344 ià(!
	`¡rcmp
(
lše
.lše.
key
, "reuse_port"))

345 
lwª
->
cÚfig
.
»u£_pÜt
 = 
	`·r£_boŞ
(
lše
.lše.
v®ue
,

346 
deçuÉ_cÚfig
.
»u£_pÜt
);

347 ià(!
	`¡rcmp
(
lše
.lše.
key
, "expires"))

348 
lwª
->
cÚfig
.
expœes
 = 
	`·r£_time_³riod
(
lše
.lše.
v®ue
,

349 
deçuÉ_cÚfig
.
expœes
);

351 
	`cÚfig_”rÜ
(&
cÚf
, "UnknowÀcÚfig key: %s", 
lše
.lše.
key
);

353 
CONFIG_LINE_TYPE_SECTION
:

354 ià(!
has_li¡’”
) {

355 
has_li¡’”
 = 
Œue
;

356 ià(!
	`¡rcmp
(
lše
.
£ùiÚ
.
Çme
, "listener"))

357 
	`·r£_li¡’”
(&
cÚf
, &
lše
, 
lwª
);

359 
	`cÚfig_”rÜ
(&
cÚf
, "UnknowÀ£ùiÚy³: %s", 
lše
.
£ùiÚ
.
Çme
);

361 
	`cÚfig_”rÜ
(&
cÚf
, "Only one†istener supported");

364 
CONFIG_LINE_TYPE_SECTION_END
:

365 
	`cÚfig_”rÜ
(&
cÚf
, "Unexpected sectionƒnd");

369 ià(
cÚf
.
”rÜ_mes§ge
) {

370 
	`lwª_¡©us_ü™iÿl
("Error on config file \"%s\",†ine %d: %s",

371 
·th
, 
cÚf
.
lše
, cÚf.
”rÜ_mes§ge
);

374 
	`cÚfig_şo£
(&
cÚf
);

376  
Œue
;

377 
	}
}

379 
¾im_t


380 
	$£tup_İ’_fe_couÁ_lim™s
()

382 
¾im™
 
r
;

384 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
, &
r
) < 0)

385 
	`lwª_¡©us_ü™iÿl_³¼Ü
("getrlimit");

387 ià(
r
.
¾im_max
 =ğ
RLIM_INFINITY
)

388 
r
.
¾im_cur
 *= 8;

389 ià(
r
.
¾im_cur
 <„.
¾im_max
)

390 
r
.
¾im_cur
 =„.
¾im_max
;

392 ià(
	`£Œlim™
(
RLIMIT_NOFILE
, &
r
) < 0)

393 
	`lwª_¡©us_ü™iÿl_³¼Ü
("setrlimit");

395  
r
.
¾im_cur
;

396 
	}
}

399 
	$®loÿ‹_cÚÃùiÚs
(
lwª_t
 *
l
, 
size_t
 
max_İ’_fes
)

401 
l
->
cÚns
 = 
	`ÿÎoc
(
max_İ’_fes
, (
lwª_cÚÃùiÚ_t
));

402 ià(!
l
->
cÚns
)

403 
	`lwª_¡©us_ü™iÿl_³¼Ü
("calloc");

404 
	}
}

407 
	$g‘_numb”_of_ıus
()

409 
n_Úlše_ıus
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

410 ià(
	`UNLIKELY
(
n_Úlše_ıus
 < 0)) {

411 
	`lwª_¡©us_w¬nšg
("Could‚ot get‚umber of online CPUs,‡ssuming 1 CPU.");

414  ()
n_Úlše_ıus
;

415 
	}
}

418 
	$lwª_š™
(
lwª_t
 *
l
)

421 
	`mem£t
(
l
, 0, (*l));

422 
	`memıy
(&
l
->
cÚfig
, &
deçuÉ_cÚfig
, (default_config));

426 
	`lwª_¡©us_š™
(
l
);

431 
	`lwª_job_th»ad_š™
();

432 
	`lwª_»¥Ú£_š™
();

433 
	`lwª_bËs_š™
();

435 
	`lwª_moduË_š™
(
l
);

436 
	`lwª_moduË_»gi¡”
(
l
, 
	`lwª_moduË_£rve_fes
());

437 
	`lwª_moduË_»gi¡”
(
l
, 
	`lwª_moduË_»dœeù
());

438 
	`lwª_moduË_»gi¡”
(
l
, 
	`lwª_moduË_lua
());

441 ià(!
	`£tup_äom_cÚfig
(
l
))

442 
	`lwª_¡©us_w¬nšg
("Could‚ot„ead config file, using defaults");

445 
	`lwª_¡©us_debug
("Initializing†wan web server");

447 
l
->
th»ad
.
couÁ
 = 
	`g‘_numb”_of_ıus
();

448 ià(
l
->
th»ad
.
couÁ
 == 1)

449 
l
->
th»ad
.
couÁ
 = 2;

451 
¾im_t
 
max_İ’_fes
 = 
	`£tup_İ’_fe_couÁ_lim™s
();

452 
	`®loÿ‹_cÚÃùiÚs
(
l
, (
size_t
)
max_İ’_fes
);

454 
l
->
th»ad
.
max_fd
 = ()
max_İ’_fes
 / (î->th»ad.
couÁ
;

455 
	`lwª_¡©us_šfo
("Using %dhreads, maximum %d sockets…erhread",

456 
l
->
th»ad
.
couÁ
,†->th»ad.
max_fd
);

458 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

459 
	`şo£
(
STDIN_FILENO
);

461 
	`lwª_th»ad_š™
(
l
);

462 
	`lwª_sock‘_š™
(
l
);

463 
	`lwª_h‰p_authÜize_š™
();

464 
	}
}

467 
	$lwª_shutdown
(
lwª_t
 *
l
)

469 
	`lwª_¡©us_šfo
("Shutting down");

471 ià(
l
->
cÚfig
.
li¡’”
 !ğ
deçuÉ_cÚfig
.listener)

472 
	`ä“
(
l
->
cÚfig
.
li¡’”
);

474 
	`lwª_job_th»ad_shutdown
();

475 
	`lwª_th»ad_shutdown
(
l
);

477 
	`lwª_¡©us_debug
("Shutting down URL handlers");

478 
	`lwª_Œ›_de¡roy
(
l
->
u¾_m­_Œ›
);

480 
	`ä“
(
l
->
cÚns
);

482 
	`lwª_»¥Ú£_shutdown
();

483 
	`lwª_bËs_shutdown
();

484 
	`lwª_¡©us_shutdown
(
l
);

485 
	`lwª_h‰p_authÜize_shutdown
();

486 
	`lwª_moduË_shutdown
(
l
);

487 
	}
}

489 
ALWAYS_INLINE
 

490 
	$scheduË_ş›Á
(
lwª_t
 *
l
, 
fd
)

492 
th»ad
;

493 #ifdeà
__x86_64__


494 
	`¡©ic_as£¹
((
lwª_cÚÃùiÚ_t
) == 32,

502 
th»ad
 = ((
fd
 - 1è/ 2è% 
l
->th»ad.
couÁ
;

504 
couÁ”
 = 0;

505 
th»ad
 = 
couÁ”
++ % 
l
->th»ad.
couÁ
;

507 
lwª_th»ad_t
 *
t
 = &
l
->
th»ad
.
th»ads
[thread];

508 
	`lwª_th»ad_add_ş›Á
(
t
, 
fd
);

509 
	}
}

511 vŞ©
sig_©omic_t
 
	gmaš_sock‘
 = -1;

514 
sigšt_hªdËr
(
sigÇl_numb”
 
__©Œibu‹__
((
unu£d
)))

516 ià(
	gmaš_sock‘
 < 0)

518 
şo£
(
maš_sock‘
);

519 
	gmaš_sock‘
 = -1;

523 
	$lwª_maš_loİ
(
lwª_t
 *
l
)

525 
	`as£¹
(
maš_sock‘
 == -1);

526 
maš_sock‘
 = 
l
->main_socket;

527 ià(
	`sigÇl
(
SIGINT
, 
sigšt_hªdËr
è=ğ
SIG_ERR
)

528 
	`lwª_¡©us_ü™iÿl
("Could‚ot set signal handler");

530 
	`lwª_¡©us_šfo
("Readyo serve");

533 
ş›Á_fd
 = 
	`acû±4
(
l
->
maš_sock‘
, 
NULL
, NULL, 
SOCK_NONBLOCK
);

534 ià(
	`UNLIKELY
(
ş›Á_fd
 < 0)) {

535 ià(
”ºo
 !ğ
EBADF
) {

536 
	`lwª_¡©us_³¼Ü
("accept");

540 ià(
maš_sock‘
 < 0) {

541 
	`lwª_¡©us_šfo
("Signal 2 (Interrupt)„eceived");

543 
	`lwª_¡©us_šfo
("Main socket closed for unknown„easons");

549 
	`scheduË_ş›Á
(
l
, 
ş›Á_fd
);

551 
	}
}

	@common/lwan.h

20 #iâdeà
__LWAN_H__


21 
	#__LWAN_H__


	)

23 
	~<±h»ad.h
>

24 
	~<¡dboŞ.h
>

25 
	~<¡dšt.h
>

26 
	~<Ãtš‘/š.h
>

28 
	~"lwª-cÜo.h
"

29 
	~"lwª-Œ›.h
"

30 
	~"lwª-¡©us.h
"

31 
	~"¡rbuf.h
"

32 
	~"hash.h
"

34 
	#DEFAULT_BUFFER_SIZE
 4096

	)

35 
	#DEFAULT_HEADERS_SIZE
 512

	)

37 #undeà
¡©ic_as£¹


38 #ià
HAVE_STATIC_ASSERT


39 
	#¡©ic_as£¹
(
ex´
, 
msg
è
	`_Stic_as£¹
Óx´, msg)

	)

41 
	#¡©ic_as£¹
(
ex´
, 
msg
)

	)

44 
	#N_ELEMENTS
(
¬¿y
è(×¼ayè/ ×¼ay[0]))

	)

46 #ià
__BYTE_ORDER__
 =ğ
__ORDER_LITTLE_ENDIAN__


47 
	#MULTICHAR_CONSTANT
(
a
,
b
,
c
,
d
è((
št32_t
)(×è| (bè<< 8 | (cè<< 16 | (dè<< 24))

	)

48 #–ià
__BYTE_ORDER__
 =ğ
__ORDER_BIG_ENDIAN__


49 
	#MULTICHAR_CONSTANT
(
d
,
c
,
b
,
a
è((
št32_t
)(×è| (bè<< 8 | (cè<< 16 | (dè<< 24))

	)

50 #–ià
__BYTE_ORDER__
 =ğ
__ORDER_PDP_ENDIAN__


51 #”rÜ 
A
 
PDP
? 
S”iou¦y
?

54 
	#MULTICHAR_CONSTANT_L
(
a
,
b
,
c
,
d
è(
	`MULTICHAR_CONSTANT
×,b,c,dè| 0x20202020)

	)

56 
	#STRING_SWITCH
(
s
è*((
št32_t
 *)(s)))

	)

57 
	#STRING_SWITCH_L
(
s
è*((
št32_t
 *)(s)è| 0x20202020)

	)

59 #ifdeà
DISABLE_INLINE_FUNCTIONS


60 
	#ALWAYS_INLINE


	)

62 
	#ALWAYS_INLINE
 
šlše
 
	`__©Œibu‹__
((
®ways_šlše
))

	)

65 #ifdeà
DISABLE_BRANCH_PREDICTION


66 
	#LIKELY_IS
(
x
,
y
è(x)

	)

68 
	#LIKELY_IS
(
x
,
y
è
	`__butš_ex³ù
((x), (y))

	)

71 
	#LIKELY
(
x
è
	`LIKELY_IS
(!!(x), 1)

	)

72 
	#UNLIKELY
(
x
è
	`LIKELY_IS
((x), 0)

	)

74 
	#ATOMIC_READ
(
V
è(*(vŞ©
	`ty³of
(Vè*)&(V))

	)

75 
	#ATOMIC_AAF
(
P
, 
V
è(
	`__sync_add_ªd_ãtch
((P), (V)))

	)

76 
	#ATOMIC_INC
(
V
è
	`ATOMIC_AAF
(&(V), 1)

	)

77 
	#ATOMIC_DEC
(
V
è
	`ATOMIC_AAF
(&(V), -1)

	)

78 
	#ATOMIC_BITWISE
(
P
, 
O
, 
V
è(
__sync_
##O##
	`_ªd_ãtch
((P), (V)))

	)

80 
lwª_t_
 
	tlwª_t
;

81 
lwª_moduË_t_
 
	tlwª_moduË_t
;

82 
lwª_key_v®ue_t_
 
	tlwª_key_v®ue_t
;

83 
lwª_»que¡_t_
 
	tlwª_»que¡_t
;

84 
lwª_»¥Ú£_t_
 
	tlwª_»¥Ú£_t
;

85 
lwª_th»ad_t_
 
	tlwª_th»ad_t
;

86 
lwª_u¾_m­_t_
 
	tlwª_u¾_m­_t
;

87 
lwª_v®ue_t_
 
	tlwª_v®ue_t
;

88 
lwª_cÚfig_t_
 
	tlwª_cÚfig_t
;

89 
lwª_cÚÃùiÚ_t_
 
	tlwª_cÚÃùiÚ_t
;

92 
	mHTTP_OK
 = 200,

93 
	mHTTP_PARTIAL_CONTENT
 = 206,

94 
	mHTTP_MOVED_PERMANENTLY
 = 301,

95 
	mHTTP_NOT_MODIFIED
 = 304,

96 
	mHTTP_BAD_REQUEST
 = 400,

97 
	mHTTP_NOT_AUTHORIZED
 = 401,

98 
	mHTTP_FORBIDDEN
 = 403,

99 
	mHTTP_NOT_FOUND
 = 404,

100 
	mHTTP_NOT_ALLOWED
 = 405,

101 
	mHTTP_TIMEOUT
 = 408,

102 
	mHTTP_TOO_LARGE
 = 413,

103 
	mHTTP_RANGE_UNSATISFIABLE
 = 416,

104 
	mHTTP_INTERNAL_ERROR
 = 500,

105 
	mHTTP_UNAVAILABLE
 = 503,

106 } 
	tlwª_h‰p_¡©us_t
;

109 
	mHANDLER_PARSE_QUERY_STRING
 = 1<<0,

110 
	mHANDLER_PARSE_IF_MODIFIED_SINCE
 = 1<<1,

111 
	mHANDLER_PARSE_RANGE
 = 1<<2,

112 
	mHANDLER_PARSE_ACCEPT_ENCODING
 = 1<<3,

113 
	mHANDLER_PARSE_POST_DATA
 = 1<<4,

114 
	mHANDLER_MUST_AUTHORIZE
 = 1<<5,

115 
	mHANDLER_REMOVE_LEADING_SLASH
 = 1<<6,

117 
	mHANDLER_PARSE_MASK
 = 1<<0 | 1<<1 | 1<<2 | 1<<3 | 1<<4

118 } 
	tlwª_hªdËr_æags_t
;

121 
	mREQUEST_ACCEPT_DEFLATE
 = 1<<0,

122 
	mREQUEST_IS_HTTP_1_0
 = 1<<1,

123 
	mREQUEST_METHOD_GET
 = 1<<2,

124 
	mREQUEST_METHOD_HEAD
 = 1<<3,

125 
	mREQUEST_METHOD_POST
 = 1<<4,

126 
	mRESPONSE_SENT_HEADERS
 = 1<<5,

127 
	mRESPONSE_CHUNKED_ENCODING
 = 1<<6,

128 
	mRESPONSE_NO_CONTENT_LENGTH
 = 1<<7

129 } 
	tlwª_»que¡_æags_t
;

132 
	mCONN_MASK
 = -1,

133 
	mCONN_KEEP_ALIVE
 = 1<<0,

134 
	mCONN_IS_ALIVE
 = 1<<1,

135 
	mCONN_SHOULD_RESUME_CORO
 = 1<<2,

136 
	mCONN_WRITE_EVENTS
 = 1<<3

137 } 
	tlwª_cÚÃùiÚ_æags_t
;

140 
	mCONN_CORO_ABORT
 = -1,

141 
	mCONN_CORO_MAY_RESUME
 = 0,

142 
	mCONN_CORO_FINISHED
 = 1

143 } 
	tlwª_cÚÃùiÚ_cÜo_y›ld_t
;

145 
	slwª_key_v®ue_t_
 {

146 *
	mkey
;

147 *
	mv®ue
;

150 
	slwª_»¥Ú£_t_
 {

151 
¡rbuf_t
 *
	mbufãr
;

152 cÚ¡ *
	mmime_ty³
;

153 
size_t
 
	mcÚ‹Á_Ëngth
;

154 
lwª_key_v®ue_t
 *
	mh—d”s
;

157 
lwª_h‰p_¡©us_t
 (*
ÿÎback
)(
lwª_»que¡_t
 *
	m»que¡
, *
	md©a
);

158 *
	md©a
;

159 *
	m´iv
;

160 } 
	m¡»am
;

163 
	slwª_v®ue_t_
 {

164 *
	mv®ue
;

165 
size_t
 
	mËn
;

168 
	slwª_cÚÃùiÚ_t_
 {

171 
lwª_cÚÃùiÚ_æags_t
 
	mæags
;

172 
	mtime_to_d›
;

173 
cÜo_t
 *
	mcÜo
;

174 
lwª_th»ad_t
 *
	mth»ad
;

175 
	m´ev
, 
	mÃxt
;

178 
	slwª_»que¡_t_
 {

179 
lwª_»que¡_æags_t
 
	mæags
;

180 
	mfd
;

181 
lwª_v®ue_t
 
	mu¾
;

182 
lwª_v®ue_t
 
	mÜigš®_u¾
;

183 
lwª_cÚÃùiÚ_t
 *
	mcÚn
;

186 
lwª_key_v®ue_t
 *
	mba£
;

187 
size_t
 
	mËn
;

188 } 
	mqu”y_·¿ms
, 
	mpo¡_d©a
;

190 
time_t
 
	mif_modif›d_sšû
;

192 
off_t
 
	mäom
;

193 
off_t
 
	mto
;

194 } 
	m¿nge
;

195 } 
	mh—d”
;

196 
lwª_»¥Ú£_t
 
	m»¥Ú£
;

199 
	slwª_moduË_t_
 {

200 cÚ¡ *
	mÇme
;

201 *(*
	mš™
)(*
	m¬gs
);

202 *(*
	mš™_äom_hash
)(cÚ¡ 
hash
 *
	mhash
);

203 (*
	mshutdown
)(*
	md©a
);

204 
lwª_h‰p_¡©us_t
 (*
hªdË
)(
lwª_»que¡_t
 *
	m»que¡
, 
lwª_»¥Ú£_t
 *
	m»¥Ú£
, *
	md©a
);

205 
lwª_hªdËr_æags_t
 
	mæags
;

208 
	slwª_u¾_m­_t_
 {

209 
lwª_h‰p_¡©us_t
 (*
hªdËr
)(
lwª_»que¡_t
 *
	m»que¡
, 
lwª_»¥Ú£_t
 *
	m»¥Ú£
, *
	md©a
);

210 *
	md©a
;

212 *
	m´efix
;

213 
size_t
 
	m´efix_Ën
;

214 
lwª_hªdËr_æags_t
 
	mæags
;

216 cÚ¡ 
lwª_moduË_t
 *
	mmoduË
;

217 *
	m¬gs
;

220 *
	m»®m
;

221 *
	m·sswÜd_fe
;

222 } 
	mauthÜiz©iÚ
;

225 
	slwª_th»ad_t_
 {

226 
lwª_t
 *
	mlwª
;

228 
	md©e
[30];

229 
	mexpœes
[30];

230 
time_t
 
	mÏ¡
;

231 } 
	md©e
;

232 
	mid
;

234 
±h»ad_t
 
	m£lf
;

235 
	m•Şl_fd
;

236 
	mpe_fd
[2];

239 
	slwª_cÚfig_t_
 {

240 *
	mli¡’”
;

241 
	mk“p_®ive_timeout
;

242 
boŞ
 
	mqu›t
;

243 
boŞ
 
	m»u£_pÜt
;

244 
	mexpœes
;

247 
	slwª_t_
 {

248 
lwª_Œ›_t
 *
	mu¾_m­_Œ›
;

249 
lwª_cÚÃùiÚ_t
 *
	mcÚns
;

250 
	mmaš_sock‘
;

252 
lwª_cÚfig_t
 
	mcÚfig
;

255 
	mcouÁ
;

256 
	mmax_fd
;

257 
lwª_th»ad_t
 *
	mth»ads
;

258 } 
	mth»ad
;

260 
hash
 *
	mmoduË_»gi¡ry
;

263 
lwª_£t_u¾_m­
(
lwª_t
 *
l
, cÚ¡ 
lwª_u¾_m­_t
 *
m­
);

264 
lwª_maš_loİ
(
lwª_t
 *
l
);

266 
lwª_»¥Ú£
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
);

267 
lwª_deçuÉ_»¥Ú£
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
);

268 
size_t
 
	$lwª_´•¬e_»¥Ú£_h—d”
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
, 
h—d”_bufãr
[], 
size_t
 
h—d”_bufãr_size
)

269 
	`__©Œibu‹__
((
w¬n_unu£d_»suÉ
));

271 cÚ¡ *
	$lwª_»que¡_g‘_po¡_·¿m
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
key
)

272 
	`__©Œibu‹__
((
w¬n_unu£d_»suÉ
));

273 cÚ¡ *
	$lwª_»que¡_g‘_qu”y_·¿m
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
key
)

274 
	`__©Œibu‹__
((
w¬n_unu£d_»suÉ
));

275 cÚ¡ *
	$lwª_»que¡_g‘_»mÙe_add»ss
(
lwª_»que¡_t
 *
»que¡
, 
bufãr
[
INET6_ADDRSTRLEN
])

276 
	`__©Œibu‹__
((
w¬n_unu£d_»suÉ
));

277 
	`lwª_´oûss_»que¡
(
lwª_t
 *
l
, 
lwª_»que¡_t
 *
»que¡
);

279 
boŞ
 
	`lwª_»¥Ú£_£t_chunked
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
);

280 
	`lwª_»¥Ú£_£nd_chunk
(
lwª_»que¡_t
 *
»que¡
);

282 
boŞ
 
	`lwª_»¥Ú£_£t_ev’t_¡»am
(
lwª_»que¡_t
 *
»que¡
, 
lwª_h‰p_¡©us_t
 
¡©us
);

283 
	`lwª_»¥Ú£_£nd_ev’t
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
ev’t
);

285 
	`lwª_fÜm©_rfc_time
(
time_t
 
t
, 
bufãr
[30]);

287 cÚ¡ *
	$lwª_h‰p_¡©us_as_¡ršg
(
lwª_h‰p_¡©us_t
 
¡©us
)

288 
	`__©Œibu‹__
((
pu»
)è__©Œibu‹__((
w¬n_unu£d_»suÉ
));

289 cÚ¡ *
	$lwª_h‰p_¡©us_as_¡ršg_w™h_code
(
lwª_h‰p_¡©us_t
 
¡©us
)

290 
	`__©Œibu‹__
((
pu»
)è__©Œibu‹__((
w¬n_unu£d_»suÉ
));

291 cÚ¡ *
	$lwª_h‰p_¡©us_as_desütive_¡ršg
(
lwª_h‰p_¡©us_t
 
¡©us
)

292 
	`__©Œibu‹__
((
pu»
)è__©Œibu‹__((
w¬n_unu£d_»suÉ
));

293 cÚ¡ *
	$lwª_d‘”mše_mime_ty³_fÜ_fe_Çme
(cÚ¡ *
fe_Çme
)

294 
	`__©Œibu‹__
((
pu»
)è__©Œibu‹__((
w¬n_unu£d_»suÉ
));

296 
	`lwª_š™
(
lwª_t
 *
l
);

297 
	`lwª_shutdown
(
lwª_t
 *
l
);

299 
	$lwª_cÚÃùiÚ_g‘_fd
(
lwª_cÚÃùiÚ_t
 *
cÚn
)

300 
	`__©Œibu‹__
((
pu»
)è__©Œibu‹__((
w¬n_unu£d_»suÉ
));

	@common/murmur3.c

10 
	~"murmur3.h
"

11 
	~<¡dšt.h
>

12 
	~<¡ršg.h
>

17 #ifdeà
__GNUC__


18 
	#FORCE_INLINE
 
	`__©Œibu‹__
((
®ways_šlše
)è
šlše


	)

20 
	#FORCE_INLINE


	)

23 #iâdeà
__x86_64__


24 
FORCE_INLINE
 
ušt32_t
 
	$rÙl32
(
ušt32_t
 
x
, 
št8_t
 
r
)

26  (
x
 << 
r
) | (x >> (32 -„));

27 
	}
}

30 
FORCE_INLINE
 
ušt64_t
 
	$rÙl64
(
ušt64_t
 
x
, 
št8_t
 
r
)

32  (
x
 << 
r
) | (x >> (64 -„));

33 
	}
}

35 
	#ROTL32
(
x
,
y
è
	`rÙl32
(x,y)

	)

36 
	#ROTL64
(
x
,
y
è
	`rÙl64
(x,y)

	)

38 
	#BIG_CONSTANT
(
x
è(x##
LLU
)

	)

44 
	#g‘block
(
p
, 
i
èÕ[i])

	)

48 #iâdeà
__x86_64__


49 
FORCE_INLINE
 
ušt32_t
 
	$fmix32
(
ušt32_t
 
h
)

51 
h
 ^= h >> 16;

52 
h
 *= 0x85ebca6b;

53 
h
 ^= h >> 13;

54 
h
 *= 0xc2b2ae35;

55 
h
 ^= h >> 16;

56  
h
;

57 
	}
}

61 
FORCE_INLINE
 
ušt64_t
 
	$fmix64
(
ušt64_t
 
k
)

63 
k
 ^= k >> 33;

64 
k
 *ğ
	`BIG_CONSTANT
(0xff51afd7ed558ccd);

65 
k
 ^= k >> 33;

66 
k
 *ğ
	`BIG_CONSTANT
(0xc4ceb9fe1a85ec53);

67 
k
 ^= k >> 33;

68  
k
;

69 
	}
}

73 #iâdeà
__x86_64__


74 
FORCE_INLINE
 

75 
	$MurmurHash3_x86_32
(cÚ¡ *
key
, 
size_t
 
Ën
, 
ušt32_t
 
£ed
, *
out
)

77 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

78 cÚ¡ 
size_t
 
nblocks
 = 
Ën
 / 4;

79 
size_t
 
i
;

80 
ušt32_t
 
h1
 = 
£ed
;

81 
ušt32_t
 
c1
 = 0xcc9e2d51;

82 
ušt32_t
 
c2
 = 0x1b873593;

86 cÚ¡ 
ušt32_t
 *
blocks
 = (cÚ¡ ušt32_ˆ*)(
d©a
 + 
nblocks
 * 4);

87 
i
 = -
nblocks
; i; i++) {

88 
ušt32_t
 
k1
 = 
	`g‘block
(
blocks
, 
i
);

89 
k1
 *ğ
c1
;

90 
k1
 = 
	`ROTL32
(k1, 15);

91 
k1
 *ğ
c2
;

92 
h1
 ^ğ
k1
;

93 
h1
 = 
	`ROTL32
(h1, 13);

94 
h1
 = h1 * 5 + 0xe6546b64;

99 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_ˆ*)(
d©a
 + 
nblocks
 * 4);

100 
ušt32_t
 
k1
 = 0;

101 
Ën
 & 3) {

103 
k1
 ^ğ(
ušt32_t
)

[2] << 16;

105 
k1
 ^ğ(
ušt32_t
)

[1] << 8;

107 
k1
 ^ğ(
ušt32_t
)

[0];

108 
k1
 *ğ
c1
;

109 
k1
 = 
	`ROTL32
(k1, 15);

110 
k1
 *ğ
c2
;

111 
h1
 ^ğ
k1
;

116 
h1
 ^ğ(
ušt32_t
)
Ën
;

117 
h1
 = 
	`fmix32
(h1);

118 *(
ušt32_t
 *è
out
 = 
h1
;

119 
	}
}

123 
FORCE_INLINE
 
	$MurmurHash3_x86_128
 (cÚ¡ *
key
, cÚ¡ 
size_t
 
Ën
,

124 
ušt32_t
 
£ed
, *
out
)

126 
size_t
 
i
;

127 cÚ¡ 
ušt8_t
 * 
d©a
 = (cÚ¡ ušt8_t*)
key
;

128 cÚ¡ 
size_t
 
nblocks
 = 
Ën
 / 16;

130 
ušt32_t
 
h1
 = 
£ed
;

131 
ušt32_t
 
h2
 = 
£ed
;

132 
ušt32_t
 
h3
 = 
£ed
;

133 
ušt32_t
 
h4
 = 
£ed
;

135 cÚ¡ 
ušt32_t
 
c1
 = 0x239b961b;

136 cÚ¡ 
ušt32_t
 
c2
 = 0xab0e9789;

137 cÚ¡ 
ušt32_t
 
c3
 = 0x38b34ae5;

138 cÚ¡ 
ušt32_t
 
c4
 = 0xa1e38b93;

143 cÚ¡ 
ušt32_t
 * 
blocks
 = (cÚ¡ ušt32_ˆ*)(
d©a
 + 
nblocks
*16);

145 
i
 = -
nblocks
; i; i++) {

146 
ušt32_t
 
k1
 = 
	`g‘block
(
blocks
,
i
*4+0);

147 
ušt32_t
 
k2
 = 
	`g‘block
(
blocks
,
i
*4+1);

148 
ušt32_t
 
k3
 = 
	`g‘block
(
blocks
,
i
*4+2);

149 
ušt32_t
 
k4
 = 
	`g‘block
(
blocks
,
i
*4+3);

151 
k1
 *ğ
c1
; k1 = 
	`ROTL32
(k1,15); k1 *ğ
c2
; 
h1
 ^= k1;

152 
h1
 = 
	`ROTL32
(h1,19); h1 +ğ
h2
; h1 = h1*5+0x561ccd1b;

153 
k2
 *ğ
c2
; k2 = 
	`ROTL32
(k2,16); k2 *ğ
c3
; 
h2
 ^= k2;

154 
h2
 = 
	`ROTL32
(h2,17); h2 +ğ
h3
; h2 = h2*5+0x0bcaa747;

155 
k3
 *ğ
c3
; k3 = 
	`ROTL32
(k3,17); k3 *ğ
c4
; 
h3
 ^= k3;

156 
h3
 = 
	`ROTL32
(h3,15); h3 +ğ
h4
; h3 = h3*5+0x96cd1c35;

157 
k4
 *ğ
c4
; k4 = 
	`ROTL32
(k4,18); k4 *ğ
c1
; 
h4
 ^= k4;

158 
h4
 = 
	`ROTL32
(h4,13); h4 +ğ
h1
; h4 = h4*5+0x32ac3b17;

164 cÚ¡ 
ušt8_t
 * 

 = (cÚ¡ ušt8_t*)(
d©a
 + 
nblocks
*16);

166 
ušt32_t
 
k1
 = 0;

167 
ušt32_t
 
k2
 = 0;

168 
ušt32_t
 
k3
 = 0;

169 
ušt32_t
 
k4
 = 0;

171 
Ën
 & 15) {

172 15: 
k4
 ^ğ(
ušt32_t
)

[14] << 16;

173 14: 
k4
 ^ğ(
ušt32_t
)

[13] << 8;

174 13: 
k4
 ^ğ(
ušt32_t
)

[12] << 0;

175 
k4
 *ğ
c4
; k4 = 
	`ROTL32
(k4,18); k4 *ğ
c1
; 
h4
 ^= k4;

177 12: 
k3
 ^ğ(
ušt32_t
)

[11] << 24;

178 11: 
k3
 ^ğ(
ušt32_t
)

[10] << 16;

179 10: 
k3
 ^ğ(
ušt32_t
)

[ 9] << 8;

180 9: 
k3
 ^ğ(
ušt32_t
)

[ 8] << 0;

181 
k3
 *ğ
c3
; k3 = 
	`ROTL32
(k3,17); k3 *ğ
c4
; 
h3
 ^= k3;

183 8: 
k2
 ^ğ(
ušt32_t
)

[ 7] << 24;

184 7: 
k2
 ^ğ(
ušt32_t
)

[ 6] << 16;

185 6: 
k2
 ^ğ(
ušt32_t
)

[ 5] << 8;

186 5: 
k2
 ^ğ(
ušt32_t
)

[ 4] << 0;

187 
k2
 *ğ
c2
; k2 = 
	`ROTL32
(k2,16); k2 *ğ
c3
; 
h2
 ^= k2;

189 4: 
k1
 ^ğ(
ušt32_t
)

[ 3] << 24;

190 3: 
k1
 ^ğ(
ušt32_t
)

[ 2] << 16;

191 2: 
k1
 ^ğ(
ušt32_t
)

[ 1] << 8;

192 1: 
k1
 ^ğ(
ušt32_t
)

[ 0] << 0;

193 
k1
 *ğ
c1
; k1 = 
	`ROTL32
(k1,15); k1 *ğ
c2
; 
h1
 ^= k1;

199 
h1
 ^ğ(
ušt32_t
)
Ën
; 
h2
 ^= (uint32_t)len;

200 
h3
 ^ğ(
ušt32_t
)
Ën
; 
h4
 ^= (uint32_t)len;

202 
h1
 +ğ
h2
; h1 +ğ
h3
; h1 +ğ
h4
;

203 
h2
 +ğ
h1
; 
h3
 +ğh1; 
h4
 += h1;

205 
h1
 = 
	`fmix32
(h1);

206 
h2
 = 
	`fmix32
(h2);

207 
h3
 = 
	`fmix32
(h3);

208 
h4
 = 
	`fmix32
(h4);

210 
h1
 +ğ
h2
; h1 +ğ
h3
; h1 +ğ
h4
;

211 
h2
 +ğ
h1
; 
h3
 +ğh1; 
h4
 += h1;

213 ((
ušt32_t
*)
out
)[0] = 
h1
;

214 ((
ušt32_t
*)
out
)[1] = 
h2
;

215 ((
ušt32_t
*)
out
)[2] = 
h3
;

216 ((
ušt32_t
*)
out
)[3] = 
h4
;

217 
	}
}

221 
FORCE_INLINE
 

222 
	$MurmurHash3_x64_128
(cÚ¡ *
key
, cÚ¡ 
size_t
 
Ën
, cÚ¡ 
ušt32_t
 
£ed
,

223 *
out
)

225 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

226 cÚ¡ 
size_t
 
nblocks
 = 
Ën
 / 16;

227 
size_t
 
i
;

228 
ušt64_t
 
h1
 = 
£ed
;

229 
ušt64_t
 
h2
 = 
£ed
;

230 
ušt64_t
 
c1
 = 
	`BIG_CONSTANT
(0x87c37b91114253d5);

231 
ušt64_t
 
c2
 = 
	`BIG_CONSTANT
(0x4cf5ad432745937f);

235 cÚ¡ 
ušt64_t
 *
blocks
 = (cÚ¡ ušt64_ˆ*)(
d©a
);

236 
i
 = 0; i < 
nblocks
; i++) {

237 
ušt64_t
 
k1
 = 
	`g‘block
(
blocks
, 
i
 * 2 + 0);

238 
ušt64_t
 
k2
 = 
	`g‘block
(
blocks
, 
i
 * 2 + 1);

239 
k1
 *ğ
c1
;

240 
k1
 = 
	`ROTL64
(k1, 31);

241 
k1
 *ğ
c2
;

242 
h1
 ^ğ
k1
;

243 
h1
 = 
	`ROTL64
(h1, 27);

244 
h1
 +ğ
h2
;

245 
h1
 = h1 * 5 + 0x52dce729;

246 
k2
 *ğ
c2
;

247 
k2
 = 
	`ROTL64
(k2, 33);

248 
k2
 *ğ
c1
;

249 
h2
 ^ğ
k2
;

250 
h2
 = 
	`ROTL64
(h2, 31);

251 
h2
 +ğ
h1
;

252 
h2
 = h2 * 5 + 0x38495ab5;

257 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_ˆ*)(
d©a
 + 
nblocks
 * 16);

258 
ušt64_t
 
k1
 = 0;

259 
ušt64_t
 
k2
 = 0;

260 
Ën
 & 15) {

262 
k2
 ^ğ(
ušt64_t
è(

[14]) << 48;

264 
k2
 ^ğ(
ušt64_t
è(

[13]) << 40;

266 
k2
 ^ğ(
ušt64_t
è(

[12]) << 32;

268 
k2
 ^ğ(
ušt64_t
è(

[11]) << 24;

270 
k2
 ^ğ(
ušt64_t
è(

[10]) << 16;

272 
k2
 ^ğ(
ušt64_t
è(

[9]) << 8;

274 
k2
 ^ğ(
ušt64_t
è(

[8]) << 0;

275 
k2
 *ğ
c2
;

276 
k2
 = 
	`ROTL64
(k2, 33);

277 
k2
 *ğ
c1
;

278 
h2
 ^ğ
k2
;

280 
k1
 ^ğ(
ušt64_t
è(

[7]) << 56;

282 
k1
 ^ğ(
ušt64_t
è(

[6]) << 48;

284 
k1
 ^ğ(
ušt64_t
è(

[5]) << 40;

286 
k1
 ^ğ(
ušt64_t
è(

[4]) << 32;

288 
k1
 ^ğ(
ušt64_t
è(

[3]) << 24;

290 
k1
 ^ğ(
ušt64_t
è(

[2]) << 16;

292 
k1
 ^ğ(
ušt64_t
è(

[1]) << 8;

294 
k1
 ^ğ(
ušt64_t
è(

[0]) << 0;

295 
k1
 *ğ
c1
;

296 
k1
 = 
	`ROTL64
(k1, 31);

297 
k1
 *ğ
c2
;

298 
h1
 ^ğ
k1
;

303 
h1
 ^ğ(
ušt64_t
)
Ën
;

304 
h2
 ^ğ(
ušt64_t
)
Ën
;

305 
h1
 +ğ
h2
;

306 
h2
 +ğ
h1
;

307 
h1
 = 
	`fmix64
(h1);

308 
h2
 = 
	`fmix64
(h2);

309 
h1
 +ğ
h2
;

310 
h2
 +ğ
h1
;

311 ((
ušt64_t
 *è
out
)[0] = 
h1
;

312 ((
ušt64_t
 *è
out
)[1] = 
h2
;

313 
	}
}

318 
	$murmur3_sim¶e
(cÚ¡ *
key±r
)

320 
size_t
 
Ën
 = 
	`¡¾’
((*)
key±r
);

321 #ifdeà
__x86_64__


322 
ušt64_t
 
hash
[2];

323 
	`MurmurHash3_x64_128
(
key±r
, 
Ën
, 0xd—db“f, 
hash
);

324  ()
hash
[1];

326 ià(
Ën
 <= 16) {

327 
hash
;

328 
	`MurmurHash3_x86_32
(
key±r
, 
Ën
, 0xd—db“f, &
hash
);

329  
hash
;

332 
hash
[4];

333 
	`MurmurHash3_x86_128
(
key±r
, 
Ën
, 0xd—db“f, 
hash
);

334  
hash
[3];

336 
	}
}

	@common/murmur3.h

6 #iâdeà
_MURMURHASH3_H_


7 
	#_MURMURHASH3_H_


	)

11 
murmur3_sim¶e
(cÚ¡ *
key
);

	@common/realpathat.c

22 
	#_GNU_SOURCE


	)

23 
	~<as£¹.h
>

24 
	~<”ºo.h
>

25 
	~<fú.h
>

26 
	~<lim™s.h
>

27 
	~<¡ddef.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<¡ršg.h
>

31 
	~<sys/·¿m.h
>

32 
	~<sys/¡©.h
>

33 
	~<uni¡d.h
>

35 
	~"lwª.h
"

38 
	$»®·th©2
(
dœfd
, *
dœfd·th
, cÚ¡ *
Çme
, *
»sŞved
,

39 
¡©
 *
¡
)

41 *
½©h
, *
de¡
, 
exŒa_buf
[
PATH_MAX
];

42 cÚ¡ *
¡¬t
, *
’d
, *
½©h_lim™
;

43 
num_lšks
 = 0;

44 
±rdiff_t
 
dœfdËn
;

45 *
·th©
;

50 ià(
	`UNLIKELY
(
dœfd
 < 0 || 
dœfd·th
 =ğ
NULL
 || 
Çme
[0] == '/'))

51  
	`»®·th
(
Çme
, 
»sŞved
);

53 ià(
	`UNLIKELY
(
Çme
 =ğ
NULL
)) {

58 
”ºo
 = 
EINVAL
;

59  
NULL
;

62 ià(
Çme
[0] == '\0') {

63 ià(
	`UNLIKELY
(
	`f¡©
(
dœfd
, 
¡
) < 0))

64  
NULL
;

65 ià(
	`LIKELY
(!
»sŞved
))

66  
	`¡rdup
(
dœfd·th
);

67  
	`¡rıy
(
»sŞved
, 
dœfd·th
);

70 ià(
	`LIKELY
(!
»sŞved
)) {

71 
½©h
 = 
	`m®loc
(
PATH_MAX
);

72 ià(
	`UNLIKELY
(!
½©h
))

73  
NULL
;

75 
½©h
 = 
»sŞved
;

76 
½©h_lim™
 = 
½©h
 + 
PATH_MAX
;

78 
	`¡rıy
(
½©h
, 
dœfd·th
);

79 
de¡
 = 
	`¿wmemchr
(
½©h
, '\0');

80 
dœfdËn
 = 
de¡
 - 
½©h
;

82 
¡¬t
 = 
’d
 = 
Çme
; *start; start =ƒnd) {

83 
n
;

86 *
¡¬t
 == '/')

87 ++
¡¬t
;

90 
’d
 = 
¡¬t
; *end && *end != '/'; ++end)

93 ià(
’d
 - 
¡¬t
 == 0)

95 ià(
’d
 - 
¡¬t
 == 1 && start[0] == '.')

97 ià(
’d
 - 
¡¬t
 == 2 && start[0] == '.' && start[1] == '.') {

99 ià(
de¡
 > 
½©h
 + 1)

100 (--
de¡
)[-1] != '/');

102 
size_t
 
Ãw_size
;

104 ià(
de¡
[-1] != '/')

105 *
de¡
++ = '/';

107 ià(
de¡
 + (
’d
 - 
¡¬t
è>ğ
½©h_lim™
) {

108 
±rdiff_t
 
de¡_off£t
 = 
de¡
 - 
½©h
;

109 *
Ãw_½©h
;

111 ià(
	`UNLIKELY
(
»sŞved
 !ğ
NULL
)) {

112 
”ºo
 = 
ENAMETOOLONG
;

113 ià(
de¡
 > 
½©h
 + 1)

114 
de¡
--;

115 *
de¡
 = '\0';

116 
”rÜ
;

119 
Ãw_size
 = (
size_t
)(
½©h_lim™
 - 
½©h
);

120 ià(
’d
 - 
¡¬t
 + 1 > 
PATH_MAX
)

121 
Ãw_size
 +ğ(
size_t
)(
’d
 - 
¡¬t
 + 1);

123 
Ãw_size
 +ğ
PATH_MAX
;

124 
Ãw_½©h
 = (*è
	`»®loc
(
½©h
, 
Ãw_size
);

125 ià(
	`UNLIKELY
(
Ãw_½©h
 =ğ
NULL
))

126 
”rÜ
;

127 
½©h
 = 
Ãw_½©h
;

128 
½©h_lim™
 = 
½©h
 + 
Ãw_size
;

130 
de¡
 = 
½©h
 + 
de¡_off£t
;

133 
de¡
 = 
	`mempıy
(de¡, 
¡¬t
, (
size_t
)(
’d
 - start));

134 *
de¡
 = '\0';

136 ià(
	`LIKELY
(!
	`¡ºcmp
(
½©h
, 
dœfd·th
, (
size_t
)
dœfdËn
))) {

137 
·th©
 = 
½©h
 + 
dœfdËn
 + 1;

138 ià(*
·th©
 == '\0')

139 
·th©
 = 
½©h
;

141 
·th©
 = 
½©h
;

144 ià(
	`UNLIKELY
(
	`f¡©©
(
dœfd
, 
·th©
, 
¡
, 
AT_SYMLINK_NOFOLLOW
) < 0))

145 
”rÜ
;

147 ià(
	`UNLIKELY
(
	`S_ISLNK
(
¡
->
¡_mode
))) {

148 
buf
[
PATH_MAX
];

149 
size_t
 
Ën
;

151 ià(
	`UNLIKELY
(++
num_lšks
 > 
MAXSYMLINKS
)) {

152 
”ºo
 = 
ELOOP
;

153 
”rÜ
;

156 
n
 = ()
	`»adlšk©
(
dœfd
, 
·th©
, 
buf
, 
PATH_MAX
 - 1);

157 ià(
	`UNLIKELY
(
n
 < 0))

158 
”rÜ
;

159 
buf
[
n
] = '\0';

161 
Ën
 = 
	`¡¾’
(
’d
);

162 ià(
	`UNLIKELY
((è(
n
 + ()
Ën
è>ğ
PATH_MAX
)) {

163 
”ºo
 = 
ENAMETOOLONG
;

164 
”rÜ
;

168 
	`memmove
(&
exŒa_buf
[
n
], 
’d
, 
Ën
 + 1);

169 
’d
 = 
	`memıy
(
exŒa_buf
, 
buf
, (
size_t
)
n
);

171 ià(
buf
[0] == '/')

172 
de¡
 = 
½©h
 + 1;

175 ià(
de¡
 > 
½©h
 + 1)

176 (--
de¡
)[-1] != '/');

177 } ià(
	`UNLIKELY
(!
	`S_ISDIR
(
¡
->
¡_mode
è&& *
’d
 != '\0')) {

178 
”ºo
 = 
ENOTDIR
;

179 
”rÜ
;

184 ià(
de¡
 > 
½©h
 + 1 && dest[-1] == '/')

185 --
de¡
;

186 *
de¡
 = '\0';

188 
	`as£¹
(
»sŞved
 =ğ
NULL
 ||„esŞved =ğ
½©h
);

189  
½©h
;

191 
”rÜ
:

192 
	`as£¹
(
»sŞved
 =ğ
NULL
 ||„esŞved =ğ
½©h
);

193 ià(
»sŞved
 =ğ
NULL
)

194 
	`ä“
(
½©h
);

195  
NULL
;

196 
	}
}

199 
	$»®·th©
(
dœfd
, *
dœfd·th
, cÚ¡ *
Çme
, *
»sŞved
)

201 
¡©
 
¡
;

202  
	`»®·th©2
(
dœfd
, 
dœfd·th
, 
Çme
, 
»sŞved
, &
¡
);

203 
	}
}

	@common/realpathat.h

22 #iâdeà
__REALPATHAT_H__


24 
	~<sys/¡©.h
>

26 *
»®·th©
(
dœfd
, *
dœfd·th
, cÚ¡ *
Çme
, *
»sŞved
);

27 *
»®·th©2
(
dœfd
, *
dœfd·th
, cÚ¡ *
Çme
, *
»sŞved
,

28 
¡©
 *
¡
);

	@common/sd-daemon.c

22 
	#_GNU_SOURCE


	)

23 
	~<sys/ty³s.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/sock‘.h
>

26 
	~<sys/un.h
>

27 
	~<fú.h
>

28 
	~<Ãtš‘/š.h
>

29 
	~<¡dlib.h
>

30 
	~<”ºo.h
>

31 
	~<uni¡d.h
>

32 
	~<¡ršg.h
>

33 
	~<¡d¬g.h
>

34 
	~<¡dio.h
>

35 
	~<¡ddef.h
>

36 
	~<lim™s.h
>

38 
	~"sd-d«mÚ.h
"

40 
	$sd_li¡’_fds
(
un£t_’vœÚm’t
) {

41 
r
, 
fd
;

42 cÚ¡ *
e
;

43 *
p
 = 
NULL
;

44 
l
;

46 
e
 = 
	`g‘’v
("LISTEN_PID");

47 ià(!
e
) {

48 
r
 = 0;

49 
fšish
;

52 
”ºo
 = 0;

53 
l
 = 
	`¡¹oul
(
e
, &
p
, 10);

55 ià(
”ºo
 > 0) {

56 
r
 = -
”ºo
;

57 
fšish
;

60 ià(!
p
 ||… =ğ
e
 || *°|| 
l
 <= 0) {

61 
r
 = -
EINVAL
;

62 
fšish
;

66 ià(
	`g‘pid
(è!ğ(
pid_t
è
l
) {

67 
r
 = 0;

68 
fšish
;

71 
e
 = 
	`g‘’v
("LISTEN_FDS");

72 ià(!
e
) {

73 
r
 = 0;

74 
fšish
;

77 
”ºo
 = 0;

78 
l
 = 
	`¡¹oul
(
e
, &
p
, 10);

80 ià(
”ºo
 > 0) {

81 
r
 = -
”ºo
;

82 
fšish
;

85 ià(!
p
 ||… =ğ
e
 || *p) {

86 
r
 = -
EINVAL
;

87 
fšish
;

90 
fd
 = 
SD_LISTEN_FDS_START
; fd < SD_LISTEN_FDS_START + (è
l
; fd ++) {

91 
æags
;

93 
æags
 = 
	`fú
(
fd
, 
F_GETFD
);

94 ià(
æags
 < 0) {

95 
r
 = -
”ºo
;

96 
fšish
;

99 ià(
æags
 & 
FD_CLOEXEC
)

102 ià(
	`fú
(
fd
, 
F_SETFD
, 
æags
 | 
FD_CLOEXEC
) < 0) {

103 
r
 = -
”ºo
;

104 
fšish
;

108 
r
 = (è
l
;

110 
fšish
:

111 ià(
un£t_’vœÚm’t
) {

112 
	`un£‹nv
("LISTEN_PID");

113 
	`un£‹nv
("LISTEN_FDS");

116  
r
;

117 
	}
}

119 
	$sd_is_fifo
(
fd
, cÚ¡ *
·th
) {

120 
¡©
 
¡_fd
;

122 ià(
fd
 < 0)

123  -
EINVAL
;

125 ià(
	`f¡©
(
fd
, &
¡_fd
) < 0)

126  -
”ºo
;

128 ià(!
	`S_ISFIFO
(
¡_fd
.
¡_mode
))

131 ià(
·th
) {

132 
¡©
 
¡_·th
;

134 ià(
	`¡©
(
·th
, &
¡_·th
) < 0) {

136 ià(
”ºo
 =ğ
ENOENT
 ||ƒ¼nØ=ğ
ENOTDIR
)

139  -
”ºo
;

143 
¡_·th
.
¡_dev
 =ğ
¡_fd
.st_dev &&

144 
¡_·th
.
¡_šo
 =ğ
¡_fd
.st_ino;

148 
	}
}

150 
	$sd_is_¥ecŸl
(
fd
, cÚ¡ *
·th
) {

151 
¡©
 
¡_fd
;

153 ià(
fd
 < 0)

154  -
EINVAL
;

156 ià(
	`f¡©
(
fd
, &
¡_fd
) < 0)

157  -
”ºo
;

159 ià(!
	`S_ISREG
(
¡_fd
.
¡_mode
è&& !
	`S_ISCHR
(st_fd.st_mode))

162 ià(
·th
) {

163 
¡©
 
¡_·th
;

165 ià(
	`¡©
(
·th
, &
¡_·th
) < 0) {

167 ià(
”ºo
 =ğ
ENOENT
 ||ƒ¼nØ=ğ
ENOTDIR
)

170  -
”ºo
;

173 ià(
	`S_ISREG
(
¡_fd
.
¡_mode
è&& S_ISREG(
¡_·th
.st_mode))

175 
¡_·th
.
¡_dev
 =ğ
¡_fd
.st_dev &&

176 
¡_·th
.
¡_šo
 =ğ
¡_fd
.st_ino;

177 ià(
	`S_ISCHR
(
¡_fd
.
¡_mode
è&& S_ISCHR(
¡_·th
.st_mode))

178  
¡_·th
.
¡_rdev
 =ğ
¡_fd
.st_rdev;

184 
	}
}

186 
	$sd_is_sock‘_š‹º®
(
fd
, 
ty³
, 
li¡’šg
) {

187 
¡©
 
¡_fd
;

189 ià(
fd
 < 0 || 
ty³
 < 0)

190  -
EINVAL
;

192 ià(
	`f¡©
(
fd
, &
¡_fd
) < 0)

193  -
”ºo
;

195 ià(!
	`S_ISSOCK
(
¡_fd
.
¡_mode
))

198 ià(
ty³
 != 0) {

199 
Ùh”_ty³
 = 0;

200 
sockËn_t
 
l
 = (
Ùh”_ty³
);

202 ià(
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_TYPE
, &
Ùh”_ty³
, &
l
) < 0)

203  -
”ºo
;

205 ià(
l
 !ğ(
Ùh”_ty³
))

206  -
EINVAL
;

208 ià(
Ùh”_ty³
 !ğ
ty³
)

212 ià(
li¡’šg
 >= 0) {

213 
acû±šg
 = 0;

214 
sockËn_t
 
l
 = (
acû±šg
);

216 ià(
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_ACCEPTCONN
, &
acû±šg
, &
l
) < 0)

217  -
”ºo
;

219 ià(
l
 !ğ(
acû±šg
))

220  -
EINVAL
;

222 ià(!
acû±šg
 !ğ!
li¡’šg
)

227 
	}
}

229 
	usockaddr_uniÚ
 {

230 
sockaddr
 
	m§
;

231 
sockaddr_š
 
	mš4
;

232 
sockaddr_š6
 
	mš6
;

233 
sockaddr_un
 
	mun
;

234 
sockaddr_¡Üage
 
	m¡Üage
;

237 
	$sd_is_sock‘
(
fd
, 
çmy
, 
ty³
, 
li¡’šg
) {

238 
r
;

240 ià(
çmy
 < 0)

241  -
EINVAL
;

243 
r
 = 
	`sd_is_sock‘_š‹º®
(
fd
, 
ty³
, 
li¡’šg
);

244 ià(
r
 <= 0)

245  
r
;

247 ià(
çmy
 > 0) {

248 
sockaddr_uniÚ
 
sockaddr
 = {};

249 
sockËn_t
 
l
 = (
sockaddr
);

251 ià(
	`g‘sockÇme
(
fd
, &
sockaddr
.
§
, &
l
) < 0)

252  -
”ºo
;

254 ià(
l
 < (
§_çmy_t
))

255  -
EINVAL
;

257  
sockaddr
.
§
.
§_çmy
 =ğ
çmy
;

261 
	}
}

263 
	$sd_is_sock‘_š‘
(
fd
, 
çmy
, 
ty³
, 
li¡’šg
, 
ušt16_t
 
pÜt
) {

264 
sockaddr_uniÚ
 
sockaddr
 = {};

265 
sockËn_t
 
l
 = (
sockaddr
);

266 
r
;

268 ià(
çmy
 !ğ0 && famy !ğ
AF_INET
 && famy !ğ
AF_INET6
)

269  -
EINVAL
;

271 
r
 = 
	`sd_is_sock‘_š‹º®
(
fd
, 
ty³
, 
li¡’šg
);

272 ià(
r
 <= 0)

273  
r
;

275 ià(
	`g‘sockÇme
(
fd
, &
sockaddr
.
§
, &
l
) < 0)

276  -
”ºo
;

278 ià(
l
 < (
§_çmy_t
))

279  -
EINVAL
;

281 ià(
sockaddr
.
§
.
§_çmy
 !ğ
AF_INET
 &&

282 
sockaddr
.
§
.
§_çmy
 !ğ
AF_INET6
)

285 ià(
çmy
 > 0)

286 ià(
sockaddr
.
§
.
§_çmy
 !ğ
çmy
)

289 ià(
pÜt
 > 0) {

290 ià(
sockaddr
.
§
.
§_çmy
 =ğ
AF_INET
) {

291 ià(
l
 < (
sockaddr_š
))

292  -
EINVAL
;

294  
	`htÚs
(
pÜt
è=ğ
sockaddr
.
š4
.
sš_pÜt
;

296 ià(
l
 < (
sockaddr_š6
))

297  -
EINVAL
;

299  
	`htÚs
(
pÜt
è=ğ
sockaddr
.
š6
.
sš6_pÜt
;

304 
	}
}

306 
	$sd_is_sock‘_unix
(
fd
, 
ty³
, 
li¡’šg
, cÚ¡ *
·th
, 
size_t
 
Ëngth
) {

307 
sockaddr_uniÚ
 
sockaddr
 = {};

308 
sockËn_t
 
l
 = (
sockaddr
);

309 
r
;

311 
r
 = 
	`sd_is_sock‘_š‹º®
(
fd
, 
ty³
, 
li¡’šg
);

312 ià(
r
 <= 0)

313  
r
;

315 ià(
	`g‘sockÇme
(
fd
, &
sockaddr
.
§
, &
l
) < 0)

316  -
”ºo
;

318 ià(
l
 < (
§_çmy_t
))

319  -
EINVAL
;

321 ià(
sockaddr
.
§
.
§_çmy
 !ğ
AF_UNIX
)

324 ià(
·th
) {

325 ià(
Ëngth
 == 0)

326 
Ëngth
 = 
	`¡¾’
(
·th
);

328 ià(
Ëngth
 == 0)

330  
l
 =ğ
	`off£tof
(
sockaddr_un
, 
sun_·th
);

332 ià(
·th
[0])

335 (
l
 >ğ
	`off£tof
(
sockaddr_un
, 
sun_·th
è+ 
Ëngth
 + 1) &&

336 
	`memcmp
(
·th
, 
sockaddr
.
un
.
sun_·th
, 
Ëngth
+1) == 0;

340 (
l
 =ğ
	`off£tof
(
sockaddr_un
, 
sun_·th
è+ 
Ëngth
) &&

341 
	`memcmp
(
·th
, 
sockaddr
.
un
.
sun_·th
, 
Ëngth
) == 0;

345 
	}
}

347 
	$sd_nÙify
(
un£t_’vœÚm’t
, cÚ¡ *
¡©e
) {

348 
fd
 = -1, 
r
;

349 
msghdr
 msghdr;

350 
iovec
 iovec;

351 
sockaddr_uniÚ
 
sockaddr
;

352 cÚ¡ *
e
;

354 ià(!
¡©e
) {

355 
r
 = -
EINVAL
;

356 
fšish
;

359 
e
 = 
	`g‘’v
("NOTIFY_SOCKET");

360 ià(!
e
)

364 ià((
e
[0] != '@' &&ƒ[0] != '/') ||ƒ[1] == 0) {

365 
r
 = -
EINVAL
;

366 
fšish
;

369 
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_DGRAM
|
SOCK_CLOEXEC
, 0);

370 ià(
fd
 < 0) {

371 
r
 = -
”ºo
;

372 
fšish
;

375 
	`mem£t
(&
sockaddr
, 0, (sockaddr));

376 
sockaddr
.
§
.
§_çmy
 = 
AF_UNIX
;

377 
	`¡ºıy
(
sockaddr
.
un
.
sun_·th
, 
e
, (sockaddr.un.sun_path));

379 ià(
sockaddr
.
un
.
sun_·th
[0] == '@')

380 
sockaddr
.
un
.
sun_·th
[0] = 0;

382 
	`mem£t
(&
iovec
, 0, (iovec));

383 
iovec
.
iov_ba£
 = (*è
¡©e
;

384 
iovec
.
iov_Ën
 = 
	`¡¾’
(
¡©e
);

386 
	`mem£t
(&
msghdr
, 0, (msghdr));

387 
msghdr
.
msg_Çme
 = &
sockaddr
;

388 
msghdr
.
msg_Çm–’
 = (
sockËn_t
)(
	`off£tof
(
sockaddr_un
, 
sun_·th
è+ 
	`¡¾’
(
e
));

390 ià(
msghdr
.
msg_Çm–’
 > (
sockaddr_un
))

391 
msghdr
.
msg_Çm–’
 = (
sockaddr_un
);

393 
msghdr
.
msg_iov
 = &
iovec
;

394 
msghdr
.
msg_iovËn
 = 1;

396 ià(
	`£ndmsg
(
fd
, &
msghdr
, 
MSG_NOSIGNAL
) < 0) {

397 
r
 = -
”ºo
;

398 
fšish
;

401 
r
 = 1;

403 
fšish
:

404 ià(
un£t_’vœÚm’t
)

405 
	`un£‹nv
("NOTIFY_SOCKET");

407 ià(
fd
 >= 0)

408 
	`şo£
(
fd
);

410  
r
;

411 
	}
}

413 
	$sd_nÙifyf
(
un£t_’vœÚm’t
, cÚ¡ *
fÜm©
, ...) {

414 
va_li¡
 
­
;

415 *
p
 = 
NULL
;

416 
r
;

418 
	`va_¡¬t
(
­
, 
fÜm©
);

419 
r
 = 
	`va¥rštf
(&
p
, 
fÜm©
, 
­
);

420 
	`va_’d
(
­
);

422 ià(
r
 < 0 || !
p
)

423  -
ENOMEM
;

425 
r
 = 
	`sd_nÙify
(
un£t_’vœÚm’t
, 
p
);

426 
	`ä“
(
p
);

428  
r
;

429 
	}
}

431 
	$sd_boÙed
() {

432 
¡©
 
¡
;

438 ià(
	`l¡©
("/run/sy¡emd/sy¡em/", &
¡
) < 0)

441  !!
	`S_ISDIR
(
¡
.
¡_mode
);

442 
	}
}

444 
	$sd_w©chdog_’abËd
(
un£t_’vœÚm’t
, 
ušt64_t
 *
u£c
) {

445 
Î
;

446 
l
;

447 cÚ¡ *
e
;

448 *
p
 = 
NULL
;

449 
r
;

451 
e
 = 
	`g‘’v
("WATCHDOG_PID");

452 ià(!
e
) {

453 
r
 = 0;

454 
fšish
;

457 
”ºo
 = 0;

458 
l
 = 
	`¡¹oul
(
e
, &
p
, 10);

459 ià(
”ºo
 > 0) {

460 
r
 = -
”ºo
;

461 
fšish
;

463 ià(!
p
 ||… =ğ
e
 || *°|| 
l
 <= 0) {

464 
r
 = -
EINVAL
;

465 
fšish
;

469 ià(
	`g‘pid
(è!ğ(
pid_t
è
l
) {

470 
r
 = 0;

471 
fšish
;

474 
e
 = 
	`g‘’v
("WATCHDOG_USEC");

475 ià(!
e
) {

476 
r
 = -
EINVAL
;

477 
fšish
;

480 
”ºo
 = 0;

481 
Î
 = 
	`¡¹ouÎ
(
e
, &
p
, 10);

482 ià(
”ºo
 > 0) {

483 
r
 = -
”ºo
;

484 
fšish
;

486 ià(!
p
 ||… =ğ
e
 || *°|| 
l
 <= 0) {

487 
r
 = -
EINVAL
;

488 
fšish
;

491 ià(
u£c
)

492 *
u£c
 = 
Î
;

494 
r
 = 1;

496 
fšish
:

497 ià(
un£t_’vœÚm’t
) {

498 
	`un£‹nv
("WATCHDOG_PID");

499 
	`un£‹nv
("WATCHDOG_USEC");

502  
r
;

503 
	}
}

	@common/sd-daemon.h

3 #iâdeà
foosdd«mÚhfoo


4 
	#foosdd«mÚhfoo


	)

25 
	~<sys/ty³s.h
>

26 
	~<š‰y³s.h
>

46 
	#SD_EMERG
 "<0>"

	)

47 
	#SD_ALERT
 "<1>"

	)

48 
	#SD_CRIT
 "<2>"

	)

49 
	#SD_ERR
 "<3>"

	)

50 
	#SD_WARNING
 "<4>"

	)

51 
	#SD_NOTICE
 "<5>"

	)

52 
	#SD_INFO
 "<6>"

	)

53 
	#SD_DEBUG
 "<7>"

	)

56 
	#SD_LISTEN_FDS_START
 3

	)

73 
sd_li¡’_fds
(
un£t_’vœÚm’t
);

85 
sd_is_fifo
(
fd
, cÚ¡ *
·th
);

97 
sd_is_¥ecŸl
(
fd
, cÚ¡ *
·th
);

113 
sd_is_sock‘
(
fd
, 
çmy
, 
ty³
, 
li¡’šg
);

127 
sd_is_sock‘_š‘
(
fd
, 
çmy
, 
ty³
, 
li¡’šg
, 
ušt16_t
 
pÜt
);

143 
sd_is_sock‘_unix
(
fd
, 
ty³
, 
li¡’šg
, cÚ¡ *
·th
, 
size_t
 
Ëngth
);

153 
sd_is_mq
(
fd
, cÚ¡ *
·th
);

205 
sd_nÙify
(
un£t_’vœÚm’t
, cÚ¡ *
¡©e
);

227 
	$sd_nÙifyf
(
un£t_’vœÚm’t
, cÚ¡ *
fÜm©
, ...)

228 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

241 
	`sd_boÙed
();

257 
	`sd_w©chdog_’abËd
(
un£t_’vœÚm’t
, 
ušt64_t
 *
u£c
);

	@common/strbuf.c

20 
	#_GNU_SOURCE


	)

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<¡d¬g.h
>

25 
	~"lwª.h
"

26 
	~"¡rbuf.h
"

28 cÚ¡ 
	gSTATIC
 = 1<<0;

29 cÚ¡ 
	gDYNAMICALLY_ALLOCATED
 = 1<<1;

30 cÚ¡ 
size_t
 
	gDEFAULT_BUF_SIZE
 = 64;

32 
size_t


33 
	$fšd_Ãxt_pow”_of_two
(
size_t
 
numb”
)

35 
numb”
--;

36 
numb”
 |=‚umber >> 1;

37 
numb”
 |=‚umber >> 2;

38 
numb”
 |=‚umber >> 4;

39 
numb”
 |=‚umber >> 8;

40 
numb”
 |=‚umber >> 16;

41  
numb”
 + 1;

42 
	}
}

44 
ALWAYS_INLINE
 
size_t


45 
	$max
(
size_t
 
Úe
, size_ˆ
ªÙh”
)

47  (
Úe
 > 
ªÙh”
) ? one :‡nother;

48 
	}
}

50 
boŞ


51 
	$grow_bufãr_if_Ãeded
(
¡rbuf_t
 *
s
, 
size_t
 
size
)

53 ià(
s
->
æags
 & 
STATIC
) {

54 cÚ¡ 
size_t
 
Ãxt_pow”
 = 
	`fšd_Ãxt_pow”_of_two
(
	`max
(
size
 + 1,

55 
s
->
Ën
.
bufãr
));

56 *
bufãr
 = 
	`m®loc
(
Ãxt_pow”
);

57 ià(!
bufãr
)

58  
çl£
;

60 
	`memıy
(
bufãr
, 
s
->
v®ue
.
¡©ic_bufãr
, s->
Ën
.buffer);

61 
bufãr
[
s
->
Ën
.buffer + 1] = '\0';

63 
s
->
æags
 &ğ~
STATIC
;

64 
s
->
Ën
.
®loÿ‹d
 = 
Ãxt_pow”
;

65 
s
->
v®ue
.
bufãr
 = buffer;

67  
Œue
;

70 ià(
	`UNLIKELY
(
s
->
Ën
.
®loÿ‹d
 < 
size
)) {

71 cÚ¡ 
size_t
 
Ãxt_pow”
 = 
	`fšd_Ãxt_pow”_of_two
(
size
);

72 *
bufãr
 = 
	`»®loc
(
s
->
v®ue
.bufãr, 
Ãxt_pow”
 + 1);

73 ià(
	`UNLIKELY
(!
bufãr
))

74  
çl£
;

75 
s
->
Ën
.
®loÿ‹d
 = 
Ãxt_pow”
;

76 
s
->
v®ue
.
bufãr
 = buffer;

79  
Œue
;

80 
	}
}

82 
boŞ


83 
	$¡rbuf_š™_w™h_size
(
¡rbuf_t
 *
s
, 
size_t
 
size
)

85 ià(
	`UNLIKELY
(!
s
))

86  
çl£
;

88 
	`mem£t
(
s
, 0, (*s));

90 ià(
	`UNLIKELY
(!
	`grow_bufãr_if_Ãeded
(
s
, 
size
)))

91  
çl£
;

93 
s
->
Ën
.
bufãr
 = 0;

94 
s
->
v®ue
.
bufãr
[0] = '\0';

96  
Œue
;

97 
	}
}

99 
ALWAYS_INLINE
 
boŞ


100 
	$¡rbuf_š™
(
¡rbuf_t
 *
s
)

102  
	`¡rbuf_š™_w™h_size
(
s
, 
DEFAULT_BUF_SIZE
);

103 
	}
}

105 
¡rbuf_t
 *

106 
	$¡rbuf_Ãw_w™h_size
(
size_t
 
size
)

108 
¡rbuf_t
 *
s
 = 
	`m®loc
((*s));

109 ià(
	`UNLIKELY
(!
	`¡rbuf_š™_w™h_size
(
s
, 
size
))) {

110 
	`ä“
(
s
);

111 
s
 = 
NULL
;

113 
s
->
æags
 |ğ
DYNAMICALLY_ALLOCATED
;

115  
s
;

116 
	}
}

118 
ALWAYS_INLINE
 
¡rbuf_t
 *

119 
	$¡rbuf_Ãw
()

121  
	`¡rbuf_Ãw_w™h_size
(
DEFAULT_BUF_SIZE
);

122 
	}
}

125 
	$¡rbuf_ä“
(
¡rbuf_t
 *
s
)

127 ià(
	`UNLIKELY
(!
s
))

129 ià(!(
s
->
æags
 & 
STATIC
))

130 
	`ä“
(
s
->
v®ue
.
bufãr
);

131 ià(
s
->
æags
 & 
DYNAMICALLY_ALLOCATED
)

132 
	`ä“
(
s
);

133 
	}
}

135 
boŞ


136 
	$¡rbuf_­³nd_ch¬
(
¡rbuf_t
 *
s
, cÚ¡ 
c
)

138 ià(
	`UNLIKELY
(!
	`grow_bufãr_if_Ãeded
(
s
, s->
Ën
.
bufãr
 + 2)))

139  
çl£
;

141 *(
s
->
v®ue
.
bufãr
 + s->
Ën
.bufãr++èğ
c
;

142 *(
s
->
v®ue
.
bufãr
 + s->
Ën
.buffer) = '\0';

144  
Œue
;

145 
	}
}

147 
boŞ


148 
	$¡rbuf_­³nd_¡r
(
¡rbuf_t
 *
s1
, cÚ¡ *
s2
, 
size_t
 
sz
)

150 ià(!
sz
)

151 
sz
 = 
	`¡¾’
(
s2
);

153 ià(
	`UNLIKELY
(!
	`grow_bufãr_if_Ãeded
(
s1
, s1->
Ën
.
bufãr
 + 
sz
 + 2)))

154  
çl£
;

156 
	`memıy
(
s1
->
v®ue
.
bufãr
 + s1->
Ën
.bufãr, 
s2
, 
sz
);

157 
s1
->
Ën
.
bufãr
 +ğ
sz
;

158 
s1
->
v®ue
.
bufãr
[s1->
Ën
.buffer + 1] = '\0';

160  
Œue
;

161 
	}
}

163 
boŞ


164 
	$¡rbuf_£t_¡©ic
(
¡rbuf_t
 *
s1
, cÚ¡ *
s2
, 
size_t
 
sz
)

166 ià(!
sz
)

167 
sz
 = 
	`¡¾’
(
s2
);

169 ià(!(
s1
->
æags
 & 
STATIC
))

170 
	`ä“
(
s1
->
v®ue
.
bufãr
);

171 
s1
->
v®ue
.
¡©ic_bufãr
 = 
s2
;

172 
s1
->
Ën
.
®loÿ‹d
 = s1->Ën.
bufãr
 = 
sz
;

173 
s1
->
æags
 |ğ
STATIC
;

175  
Œue
;

176 
	}
}

178 
boŞ


179 
	$¡rbuf_£t
(
¡rbuf_t
 *
s1
, cÚ¡ *
s2
, 
size_t
 
sz
)

181 ià(!
sz
)

182 
sz
 = 
	`¡¾’
(
s2
);

184 ià(
	`UNLIKELY
(!
	`grow_bufãr_if_Ãeded
(
s1
, 
sz
 + 1)))

185  
çl£
;

187 
	`memıy
(
s1
->
v®ue
.
bufãr
, 
s2
, 
sz
);

188 
s1
->
Ën
.
bufãr
 = 
sz
;

189 
s1
->
v®ue
.
bufãr
[
sz
 + 1] = '\0';

191  
Œue
;

192 
	}
}

194 
ALWAYS_INLINE
 

195 
	$¡rbuf_cmp
(
¡rbuf_t
 *
s1
, sŒbuf_ˆ*
s2
)

197 ià(
s1
 =ğ
s2
)

199 
»suÉ
 = 
	`memcmp
(
s1
->
v®ue
.
bufãr
, 
s2
->v®ue.bufãr, s1->
Ën
.buffer < s2->len.buffer ? s1->len.buffer : s2->len.buffer);

200 ià(!
»suÉ
)

201  ()(
s1
->
Ën
.
bufãr
 - 
s2
->len.buffer);

202  
»suÉ
;

203 
	}
}

205 
ALWAYS_INLINE
 
boŞ


206 
š‹º®_´štf
(
¡rbuf_t
 *
s1
, 
	$boŞ
 (*
§ve_¡r
)(
¡rbuf_t
 *, cÚ¡ *, 
size_t
), cÚ¡ *
fmt
, 
va_li¡
 
v®ues
)

208 *
s2
;

209 
Ën
;

211 ià(
	`UNLIKELY
((
Ën
 = 
	`va¥rštf
(&
s2
, 
fmt
, 
v®ues
)) < 0))

212  
çl£
;

214 
boŞ
 
sucûss
 = 
	`§ve_¡r
(
s1
, 
s2
, (
size_t
)
Ën
);

215 
	`ä“
(
s2
);

217  
sucûss
;

218 
	}
}

220 
boŞ


221 
	$¡rbuf_´štf
(
¡rbuf_t
 *
s
, cÚ¡ *
fmt
, ...)

223 
boŞ
 
could_´štf
;

224 
va_li¡
 
v®ues
;

226 
	`va_¡¬t
(
v®ues
, 
fmt
);

227 
could_´štf
 = 
	`š‹º®_´štf
(
s
, 
¡rbuf_£t
, 
fmt
, 
v®ues
);

228 
	`va_’d
(
v®ues
);

230  
could_´štf
;

231 
	}
}

233 
boŞ


234 
	$¡rbuf_­³nd_´štf
(
¡rbuf_t
 *
s
, cÚ¡ *
fmt
, ...)

236 
boŞ
 
could_´štf
;

237 
va_li¡
 
v®ues
;

239 
	`va_¡¬t
(
v®ues
, 
fmt
);

240 
could_´štf
 = 
	`š‹º®_´štf
(
s
, 
¡rbuf_­³nd_¡r
, 
fmt
, 
v®ues
);

241 
	`va_’d
(
v®ues
);

243  
could_´štf
;

244 
	}
}

246 
ALWAYS_INLINE
 
size_t


247 
	$¡rbuf_g‘_Ëngth
(
¡rbuf_t
 *
s
)

249  
s
->
Ën
.
bufãr
;

250 
	}
}

252 
ALWAYS_INLINE
 *

253 
	$¡rbuf_g‘_bufãr
(
¡rbuf_t
 *
s
)

255  
s
->
v®ue
.
bufãr
;

256 
	}
}

258 
boŞ


259 
	$¡rbuf_shršk_to
(
¡rbuf_t
 *
s
, 
size_t
 
Ãw_size
)

261 ià(
s
->
Ën
.
®loÿ‹d
 <ğ
Ãw_size
)

262  
Œue
;

264 ià(
s
->
æags
 & 
STATIC
)

265  
Œue
;

267 
size_t
 
Ãxt_pow”_of_two
 = 
	`fšd_Ãxt_pow”_of_two
(
Ãw_size
);

268 *
bufãr
 = 
	`»®loc
(
s
->
v®ue
.bufãr, 
Ãxt_pow”_of_two
 + 1);

269 ià(
	`UNLIKELY
(!
bufãr
))

270  
çl£
;

272 
s
->
v®ue
.
bufãr
 = buffer;

273 
s
->
Ën
.
®loÿ‹d
 = 
Ãxt_pow”_of_two
;

274 ià(
s
->
Ën
.
bufãr
 > 
Ãxt_pow”_of_two
) {

275 
s
->
Ën
.
bufãr
 = 
Ãxt_pow”_of_two
 - 1;

276 
s
->
v®ue
.
bufãr
[s->
Ën
.buffer + 1] = '\0';

279  
Œue
;

280 
	}
}

282 
ALWAYS_INLINE
 
boŞ


283 
	$¡rbuf_shršk_to_deçuÉ
(
¡rbuf_t
 *
s
)

285  
	`¡rbuf_shršk_to
(
s
, 
DEFAULT_BUF_SIZE
);

286 
	}
}

288 
ALWAYS_INLINE
 
boŞ


289 
	$¡rbuf_»£t
(
¡rbuf_t
 *
s
)

291 
	`¡rbuf_shršk_to_deçuÉ
(
s
);

292 
s
->
Ën
.
bufãr
 = 0;

293  
çl£
;

294 
	}
}

296 
boŞ


297 
	$¡rbuf_grow_to
(
¡rbuf_t
 *
s
, 
size_t
 
Ãw_size
)

299  
	`grow_bufãr_if_Ãeded
(
s
, 
Ãw_size
 + 1);

300 
	}
}

302 
boŞ


303 
	$¡rbuf_»£t_Ëngth
(
¡rbuf_t
 *
s
)

305 ià(
s
->
æags
 & 
STATIC
) {

306 
s
->
æags
 &ğ~
STATIC
;

307 
s
->
v®ue
.
bufãr
 = 
	`m®loc
(s->
Ën
.
®loÿ‹d
);

308 ià(
	`UNLIKELY
(!
s
->
v®ue
.
bufãr
))

309  
çl£
;

312 
s
->
Ën
.
bufãr
 = 0;

313 
s
->
v®ue
.
bufãr
[0] = '\0';

315  
Œue
;

316 
	}
}

	@common/strbuf.h

20 #iâdeà
__STRBUF_H__


21 
	#__STRBUF_H__


	)

23 
	~<¡dboŞ.h
>

24 
	~<¡dio.h
>

26 
¡rbuf_t_
 
	t¡rbuf_t
;

28 
	s¡rbuf_t_
 {

30 *
	mbufãr
;

31 cÚ¡ *
	m¡©ic_bufãr
;

32 } 
	mv®ue
;

34 
size_t
 
	m®loÿ‹d
, 
	mbufãr
;

35 } 
	mËn
;

36 
	mæags
;

39 
boŞ
 
¡rbuf_š™_w™h_size
(
¡rbuf_t
 *
buf
, 
size_t
 
size
);

40 
boŞ
 
¡rbuf_š™
(
¡rbuf_t
 *
buf
);

41 
¡rbuf_t
 *
¡rbuf_Ãw_w™h_size
(
size_t
 
size
);

42 
¡rbuf_t
 *
¡rbuf_Ãw
();

43 
¡rbuf_ä“
(
¡rbuf_t
 *
s
);

44 
boŞ
 
¡rbuf_­³nd_ch¬
(
¡rbuf_t
 *
s
, cÚ¡ 
c
);

45 
boŞ
 
¡rbuf_­³nd_¡r
(
¡rbuf_t
 *
s1
, cÚ¡ *
s2
, 
size_t
 
sz
);

46 
boŞ
 
¡rbuf_£t_¡©ic
(
¡rbuf_t
 *
s1
, cÚ¡ *
s2
, 
size_t
 
sz
);

47 
boŞ
 
¡rbuf_£t
(
¡rbuf_t
 *
s1
, cÚ¡ *
s2
, 
size_t
 
sz
);

48 
¡rbuf_cmp
(
¡rbuf_t
 *
s1
, sŒbuf_ˆ*
s2
);

49 
boŞ
 
¡rbuf_­³nd_´štf
(
¡rbuf_t
 *
s
, cÚ¡ *
fmt
, ...);

50 
boŞ
 
¡rbuf_´štf
(
¡rbuf_t
 *
s1
, cÚ¡ *
fmt
, ...);

51 
size_t
 
¡rbuf_g‘_Ëngth
(
¡rbuf_t
 *
s
);

52 *
¡rbuf_g‘_bufãr
(
¡rbuf_t
 *
s
);

53 
boŞ
 
¡rbuf_shršk_to
(
¡rbuf_t
 *
s
, 
size_t
 
Ãw_size
);

54 
boŞ
 
¡rbuf_shršk_to_deçuÉ
(
¡rbuf_t
 *
s
);

55 
boŞ
 
¡rbuf_grow_to
(
¡rbuf_t
 *
s
, 
size_t
 
Ãw_size
);

56 
boŞ
 
¡rbuf_»£t
(
¡rbuf_t
 *
s
);

57 
boŞ
 
¡rbuf_»£t_Ëngth
(
¡rbuf_t
 *
s
);

	@freegeoip/freegeoip.c

23 
	#_DEFAULT_SOURCE


	)

24 
	~<¬·/š‘.h
>

25 
	~<¡ršg.h
>

26 
	~<¡dlib.h
>

27 
	~<sql™e3.h
>

29 
	~"lwª.h
"

30 
	~"lwª-ÿche.h
"

31 
	~"lwª-£rve-fes.h
"

32 
	~"lwª-‹m¶©e.h
"

35 
	#QUERIES_PER_HOUR
 10000

	)

37 
	s_šfo_t
 {

38 
ÿche_’Œy_t
 
	mba£
;

40 *
	mcode
;

41 *
	mÇme
;

42 } 
	mcouÁry
, 
	m»giÚ
;

44 *
	mÇme
;

45 *
	mz_code
;

46 } 
	mc™y
;

47 
	mÏt™ude
, 
	mlÚg™ude
;

49 *
	mcode
, *
	m¬—
;

50 } 
	mm‘ro
;

51 *
	m
;

52 cÚ¡ *
	mÿÎback
;

55 cÚ¡ 
lwª_v¬_desütÜ_t
 
	g‹m¶©e_desütÜ
[] = {

56 
TPL_VAR_STR
(
_šfo_t
, 
couÁry
.
code
),

57 
TPL_VAR_STR
(
_šfo_t
, 
couÁry
.
Çme
),

58 
TPL_VAR_STR
(
_šfo_t
, 
»giÚ
.
code
),

59 
TPL_VAR_STR
(
_šfo_t
, 
»giÚ
.
Çme
),

60 
TPL_VAR_STR
(
_šfo_t
, 
c™y
.
Çme
),

61 
TPL_VAR_STR
(
_šfo_t
, 
c™y
.
z_code
),

62 
TPL_VAR_DOUBLE
(
_šfo_t
, 
Ït™ude
),

63 
TPL_VAR_DOUBLE
(
_šfo_t
, 
lÚg™ude
),

64 
TPL_VAR_STR
(
_šfo_t
, 
m‘ro
.
code
),

65 
TPL_VAR_STR
(
_šfo_t
, 
m‘ro
.
¬—
),

66 
TPL_VAR_STR
(
_šfo_t
, 

),

67 
TPL_VAR_STR
(
_šfo_t
, 
ÿÎback
),

68 
TPL_VAR_SENTINEL


71 cÚ¡ cÚ¡ 
	gjsÚ_‹m¶©e_¡r
[] = \

88 cÚ¡ cÚ¡ 
	gxml_‹m¶©e_¡r
[] = \

104 cÚ¡ cÚ¡ 
	gcsv_‹m¶©e_¡r
[] = \

118 cÚ¡ cÚ¡ 
	g_to_c™y_qu”y
[] = \

137 
	u_to_où‘
 {

138 
	moù‘
[(
š_addr_t
)];

139 
š_addr_t
 
	m
;

142 
	s_Ãt_t
 {

143 
_to_où‘
 
	m
;

144 
_to_où‘
 
	mmask
;

148 
	#ADDRESS
(
o1
, 
o2
, 
o3
, 
o4
) \

149 { .
où‘
[0] = 
o1
, .où‘[1] = 
o2
, .où‘[2] = 
o3
, .où‘[3] = 
o4
 }

	)

151 cÚ¡ 
_Ãt_t
 
	g»£rved_s
[] = {

152 {
ADDRESS
(0, 0, 0, 0), ADDRESS(255, 0, 0, 0)},

153 {
ADDRESS
(10, 0, 0, 0), ADDRESS(255, 0, 0, 0)},

154 {
ADDRESS
(100, 64, 0, 0), ADDRESS(255, 192, 0, 0)},

155 {
ADDRESS
(127, 0, 0, 0), ADDRESS(255, 0, 0, 0)},

156 {
ADDRESS
(169, 254, 0, 0), ADDRESS(255, 255, 0, 0)},

157 {
ADDRESS
(172, 16, 0, 0), ADDRESS(255, 240, 0, 0)},

158 {
ADDRESS
(192, 0, 0, 0), ADDRESS(255, 255, 255, 248)},

159 {
ADDRESS
(192, 0, 2, 0), ADDRESS(255, 255, 255, 0)},

160 {
ADDRESS
(192, 88, 99, 0), ADDRESS(255, 255, 255, 0)},

161 {
ADDRESS
(192, 168, 0, 0), ADDRESS(255, 255, 0, 0)},

162 {
ADDRESS
(198, 18, 0, 0), ADDRESS(255, 254, 0, 0)},

163 {
ADDRESS
(198, 51, 100, 0), ADDRESS(255, 255, 255, 0)},

164 {
ADDRESS
(203, 0, 113, 0), ADDRESS(255, 255, 255, 0)},

165 {
ADDRESS
(224, 0, 0, 0), ADDRESS(240, 0, 0, 0)},

166 {
ADDRESS
(240, 0, 0, 0), ADDRESS(240, 0, 0, 0)},

167 {
ADDRESS
(255, 255, 255, 255), ADDRESS(255, 255, 255, 255)},

170 #undeà
ADDRESS


173 #ià
QUERIES_PER_HOUR
 != 0

174 
	squ”y_lim™_t
 {

175 
ÿche_’Œy_t
 
	mba£
;

176 
	mqu”›s
;

179 
ÿche_t
 *
	gqu”y_lim™
;

183 
lwª_l_t
 *
	gjsÚ_‹m¶©e
 = 
NULL
;

184 
lwª_l_t
 *
	gxml_‹m¶©e
 = 
NULL
;

185 
lwª_l_t
 *
	gcsv_‹m¶©e
 = 
NULL
;

186 
ÿche_t
 *
	gÿche
 = 
NULL
;

187 
sql™e3
 *
	gdb
 = 
NULL
;

189 
boŞ


190 
	$Ãt_cÚšs_
(cÚ¡ 
_Ãt_t
 *
Ãt
, 
š_addr_t
 

)

192 
_to_où‘
 
_
 = { .

 = ip };

193  (
Ãt
->

.
où‘
[0] &‚‘->
mask
.où‘[0]è=ğ(
_
.octet[0] &‚et->mask.octet[0]) && \

194 (
Ãt
->

.
où‘
[1] &‚‘->
mask
.où‘[1]è=ğ(
_
.octet[1] &‚et->mask.octet[1]) && \

195 (
Ãt
->

.
où‘
[2] &‚‘->
mask
.où‘[2]è=ğ(
_
.octet[2] &‚et->mask.octet[2]) && \

196 (
Ãt
->

.
où‘
[3] &‚‘->
mask
.où‘[3]è=ğ(
_
.octet[3] &‚et->mask.octet[3]);

197 
	}
}

199 
boŞ


200 
	$is_»£rved_
(
š_addr_t
 

)

202 
size_t
 
i
;

203 
i
 = 0; i < 
	`N_ELEMENTS
(
»£rved_s
); i++) {

204 ià(
	`Ãt_cÚšs_
(&
»£rved_s
[
i
], 

))

205  
Œue
;

207  
çl£
;

208 
	}
}

211 
de¡roy_šfo
(
ÿche_’Œy_t
 *
’Œy
,

212 *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

214 
_šfo_t
 *
	g_šfo
 = (_šfo_ˆ*)
’Œy
;

216 ià(!
	g_šfo
)

219 
ä“
(
_šfo
->
couÁry
.
code
);

220 
ä“
(
_šfo
->
couÁry
.
Çme
);

221 
ä“
(
_šfo
->
»giÚ
.
code
);

222 
ä“
(
_šfo
->
»giÚ
.
Çme
);

223 
ä“
(
_šfo
->
c™y
.
Çme
);

224 
ä“
(
_šfo
->
c™y
.
z_code
);

225 
ä“
(
_šfo
->
m‘ro
.
code
);

226 
ä“
(
_šfo
->
m‘ro
.
¬—
);

227 
ä“
(
_šfo
->

);

228 
ä“
(
_šfo
);

231 
ALWAYS_INLINE
 *

232 
	$‹xt_cŞumn_h–³r
(
sql™e3_¡mt
 *
¡mt
, 
šd
)

234 cÚ¡ *
v®ue
;

236 
v®ue
 = 
	`sql™e3_cŞumn_‹xt
(
¡mt
, 
šd
);

237  
v®ue
 ? 
	`¡rdup
((*)v®ueè: 
NULL
;

238 
	}
}

240 
ÿche_’Œy_t
 *

241 
ü—‹_šfo
(cÚ¡ *
key
, *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

243 
sql™e3_¡mt
 *
	g¡mt
;

244 
_šfo_t
 *
	g_šfo
 = 
NULL
;

245 
š_addr
 
	gaddr
;

247 ià(
UNLIKELY
(!
š‘_©Ú
(
key
, &
addr
)))

248 
	g’d_no_fš®ize
;

250 ià(
is_»£rved_
(
addr
.
s_addr
)) {

251 
	g_šfo
 = 
ÿÎoc
(1, (*
_šfo
));

252 ià(
LIKELY
(
_šfo
)) {

253 
	g_šfo
->
	gcouÁry
.
	gcode
 = 
¡rdup
("RD");

254 
	g_šfo
->
	gcouÁry
.
	gÇme
 = 
¡rdup
("Reserved");

255 
	g_šfo
->
	g
 = 
¡rdup
(
key
);

257 
	g’d_no_fš®ize
;

260 ià(
sql™e3_´•¬e
(
db
, 
_to_c™y_qu”y
,

261 (
_to_c™y_qu”y
) - 1,

262 &
¡mt
, 
NULL
è!ğ
SQLITE_OK
)

263 
’d_no_fš®ize
;

265 ià(
sql™e3_bšd_št64
(
¡mt
, 1, 
Áohl
(
addr
.
s_addr
)è!ğ
SQLITE_OK
)

266 
’d
;

268 ià(
sql™e3_¡•
(
¡mt
è!ğ
SQLITE_ROW
)

269 
’d
;

271 
	g_šfo
 = 
m®loc
((*
_šfo
));

272 ià(!
	g_šfo
)

273 
	g’d
;

275 
	#TEXT_COLUMN
(
šdex
è
	`‹xt_cŞumn_h–³r
(
¡mt
, index)

	)

277 
	g_šfo
->
	gcouÁry
.
	gcode
 = 
TEXT_COLUMN
(0);

278 
	g_šfo
->
	gcouÁry
.
	gÇme
 = 
TEXT_COLUMN
(1);

279 
	g_šfo
->
	g»giÚ
.
	gcode
 = 
TEXT_COLUMN
(2);

280 
	g_šfo
->
	g»giÚ
.
	gÇme
 = 
TEXT_COLUMN
(3);

281 
	g_šfo
->
	gc™y
.
	gÇme
 = 
TEXT_COLUMN
(4);

282 
	g_šfo
->
	gc™y
.
	gz_code
 = 
TEXT_COLUMN
(5);

283 
	g_šfo
->
	gÏt™ude
 = 
sql™e3_cŞumn_doubË
(
¡mt
, 6);

284 
	g_šfo
->
	glÚg™ude
 = 
sql™e3_cŞumn_doubË
(
¡mt
, 7);

285 
	g_šfo
->
	gm‘ro
.
	gcode
 = 
TEXT_COLUMN
(8);

286 
	g_šfo
->
	gm‘ro
.
	g¬—
 = 
TEXT_COLUMN
(9);

288 #undeà
TEXT_COLUMN


290 
	g_šfo
->
	g
 = 
¡rdup
(
key
);

292 
	g’d
:

293 
sql™e3_fš®ize
(
¡mt
);

294 
	g’d_no_fš®ize
:

295  (
ÿche_’Œy_t
 *)
_šfo
;

298 #ià
QUERIES_PER_HOUR
 != 0

299 
ÿche_’Œy_t
 *

300 
ü—‹_qu”y_lim™
(cÚ¡ *
key
 
__©Œibu‹__
((
unu£d
)),

301 *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

303 
qu”y_lim™_t
 *
	g’Œy
 = 
m®loc
((*
’Œy
));

304 ià(
LIKELY
(
’Œy
))

305 
	g’Œy
->
	gqu”›s
 = 0;

306  (
	gÿche_’Œy_t
 *)
	g’Œy
;

310 
de¡roy_qu”y_lim™
(
ÿche_’Œy_t
 *
’Œy
,

311 *
cÚ‹xt
 
__©Œibu‹__
((
unu£d
)))

313 
ä“
(
’Œy
);

317 
_šfo_t
 *

318 
	$š‹º®_qu”y
(
lwª_»que¡_t
 *
»que¡
, cÚ¡ *
_add»ss
)

320 cÚ¡ *
qu”y
;

322 ià(
»que¡
->
u¾
.
Ën
 == 0)

323 
qu”y
 = 
_add»ss
;

324 ià(
»que¡
->
u¾
.
Ën
 < 7)

325 
qu”y
 = 
NULL
;

327 
qu”y
 = 
»que¡
->
u¾
.
v®ue
;

328 ià(
	`UNLIKELY
(!
qu”y
))

329  
NULL
;

331  (
_šfo_t
 *)
	`ÿche_cÜo_g‘_ªd_»f_’Œy
(
ÿche
,

332 
»que¡
->
cÚn
->
cÜo
, 
qu”y
);

333 
	}
}

335 #ià
QUERIES_PER_HOUR
 != 0

336 
boŞ
 
	$is_¿‹_lim™ed
(cÚ¡ *
_add»ss
)

338 
boŞ
 
lim™ed
;

339 
”rÜ
;

340 
qu”y_lim™_t
 *
lim™
;

342 
lim™
 = (
qu”y_lim™_t
 *)

343 
	`ÿche_g‘_ªd_»f_’Œy
(
qu”y_lim™
, 
_add»ss
, &
”rÜ
);

344 ià(!
lim™
)

345  
Œue
;

347 
lim™ed
 = 
	`ATOMIC_AAF
(&
lim™
->
qu”›s
, 1è> 
QUERIES_PER_HOUR
;

348 
	`ÿche_’Œy_uÄef
(
qu”y_lim™
, &
lim™
->
ba£
);

350  
lim™ed
;

351 
	}
}

354 
lwª_h‰p_¡©us_t


355 
	$‹m¶©ed_ouut
(
lwª_»que¡_t
 *
»que¡
,

356 
lwª_»¥Ú£_t
 *
»¥Ú£
,

357 *
d©a
)

359 cÚ¡ *
_add»ss
;

360 
lwª_l_t
 *
l
 = 
d©a
;

361 
_šfo_t
 *
šfo
;

362 
_add»ss_buf
[
INET6_ADDRSTRLEN
];

364 
_add»ss
 = 
	`lwª_»que¡_g‘_»mÙe_add»ss
(
»que¡
, 
_add»ss_buf
);

365 ià(
	`UNLIKELY
(!
_add»ss
))

366  
HTTP_INTERNAL_ERROR
;

368 #ià
QUERIES_PER_HOUR
 != 0

369 ià(
	`UNLIKELY
(
	`is_¿‹_lim™ed
(
_add»ss
)))

370  
HTTP_FORBIDDEN
;

373 
šfo
 = 
	`š‹º®_qu”y
(
»que¡
, 
_add»ss
);

374 ià(
	`UNLIKELY
(!
šfo
))

375  
HTTP_NOT_FOUND
;

377 ià(
l
 =ğ
jsÚ_‹m¶©e
)

378 
»¥Ú£
->
mime_ty³
 = "application/json; charset=UTF-8";

379 ià(
l
 =ğ
xml_‹m¶©e
)

380 
»¥Ú£
->
mime_ty³
 = "application/xml; charset=UTF-8";

382 
»¥Ú£
->
mime_ty³
 = "text/plain; charset=UTF-8";

384 cÚ¡ *
ÿÎback
 = 
	`lwª_»que¡_g‘_qu”y_·¿m
(
»que¡
, "callback");

385 
_šfo_t
 
šfo_w™h_ÿÎback
 = *
šfo
;

386 
šfo_w™h_ÿÎback
.
ÿÎback
 = callback;

388 
	`lwª_l_­¶y_w™h_bufãr
(
l
, 
»¥Ú£
->
bufãr
,

389 &
šfo_w™h_ÿÎback
);

391  
HTTP_OK
;

392 
	}
}

395 
	$maš
()

397 
lwª_t
 
l
;

399 
	`lwª_š™
(&
l
);

401 
jsÚ_‹m¶©e
 = 
	`lwª_l_compe_¡ršg
(
jsÚ_‹m¶©e_¡r
, 
‹m¶©e_desütÜ
);

402 ià(!
jsÚ_‹m¶©e
)

403 
	`lwª_¡©us_ü™iÿl
("Could‚ot compile JSONemplate");

404 
xml_‹m¶©e
 = 
	`lwª_l_compe_¡ršg
(
xml_‹m¶©e_¡r
, 
‹m¶©e_desütÜ
);

405 ià(!
xml_‹m¶©e
)

406 
	`lwª_¡©us_ü™iÿl
("Could‚ot compile XMLemplate");

407 
csv_‹m¶©e
 = 
	`lwª_l_compe_¡ršg
(
csv_‹m¶©e_¡r
, 
‹m¶©e_desütÜ
);

408 ià(!
csv_‹m¶©e
)

409 
	`lwª_¡©us_ü™iÿl
("Could‚ot compile CSVemplate");

411 
»suÉ
 = 
	`sql™e3_İ’_v2
("./db/db.sql™e", &
db
,

412 
SQLITE_OPEN_READONLY
, 
NULL
);

413 ià(
»suÉ
 !ğ
SQLITE_OK
)

414 
	`lwª_¡©us_ü™iÿl
("Could‚ot open database: %s",

415 
	`sql™e3_”rmsg
(
db
));

416 
ÿche
 = 
	`ÿche_ü—‹
(
ü—‹_šfo
, 
de¡roy_šfo
, 
NULL
, 10);

418 #ià
QUERIES_PER_HOUR
 != 0

419 
	`lwª_¡©us_šfo
("Limitingo %d queries…er hour…er client",

420 
QUERIES_PER_HOUR
);

421 
qu”y_lim™
 = 
	`ÿche_ü—‹
(
ü—‹_qu”y_lim™
,

422 
de¡roy_qu”y_lim™
, 
NULL
, 3600);

424 
	`lwª_¡©us_šfo
("Rate-limiting disabled");

427 cÚ¡ 
lwª_u¾_m­_t
 
deçuÉ_m­
[] = {

428 { .
´efix
 = "/jsÚ/", .
hªdËr
 = 
‹m¶©ed_ouut
, .
d©a
 = 
jsÚ_‹m¶©e
 },

429 { .
´efix
 = "/xml/", .
hªdËr
 = 
‹m¶©ed_ouut
, .
d©a
 = 
xml_‹m¶©e
 },

430 { .
´efix
 = "/csv/", .
hªdËr
 = 
‹m¶©ed_ouut
, .
d©a
 = 
csv_‹m¶©e
 },

431 { .
´efix
 = "/", 
	`SERVE_FILES
("./static") },

432 { .
´efix
 = 
NULL
 }

435 
	`lwª_£t_u¾_m­
(&
l
, 
deçuÉ_m­
);

436 
	`lwª_maš_loİ
(&
l
);

437 
	`lwª_shutdown
(&
l
);

439 
	`lwª_l_ä“
(
csv_‹m¶©e
);

440 
	`lwª_l_ä“
(
xml_‹m¶©e
);

441 
	`lwª_l_ä“
(
jsÚ_‹m¶©e
);

442 #ià
QUERIES_PER_HOUR
 != 0

443 
	`ÿche_de¡roy
(
qu”y_lim™
);

445 
	`ÿche_de¡roy
(
ÿche
);

446 
	`sql™e3_şo£
(
db
);

449 
	}
}

	@lwan/main.c

20 
	~"lwª.h
"

21 
	~"lwª-£rve-fes.h
"

23 
lwª_h‰p_¡©us_t


24 
gif_b—cÚ
(
lwª_»que¡_t
 *
»que¡
 
__©Œibu‹__
((
unu£d
)),

25 
lwª_»¥Ú£_t
 *
»¥Ú£
,

26 *
d©a
 
__©Œibu‹__
((
unu£d
)))

32 cÚ¡ 
	ggif_b—cÚ_d©a
[] = {

39 
	g»¥Ú£
->
	gmime_ty³
 = "image/gif";

40 
¡rbuf_£t_¡©ic
(
»¥Ú£
->
bufãr
, (*)
gif_b—cÚ_d©a
, (gif_beacon_data));

42  
	gHTTP_OK
;

45 
lwª_h‰p_¡©us_t


46 
‹¡_chunked_’codšg
(
lwª_»que¡_t
 *
»que¡
,

47 
lwª_»¥Ú£_t
 *
»¥Ú£
,

48 *
d©a
 
__©Œibu‹__
((
unu£d
)))

50 
	gi
;

52 
	g»¥Ú£
->
	gmime_ty³
 = "text/plain";

54 
¡rbuf_´štf
(
»¥Ú£
->
bufãr
, "Testing chunkedƒncoding! First chunk\n");

55 
lwª_»¥Ú£_£nd_chunk
(
»que¡
);

57 
	gi
 = 0; i <= 10; i++) {

58 
¡rbuf_´štf
(
»¥Ú£
->
bufãr
, "*Thi i chunk %d*\n", 
i
);

59 
lwª_»¥Ú£_£nd_chunk
(
»que¡
);

62 
¡rbuf_´štf
(
»¥Ú£
->
bufãr
, "Last chunk\n");

63 
lwª_»¥Ú£_£nd_chunk
(
»que¡
);

65  
	gHTTP_OK
;

68 
lwª_h‰p_¡©us_t


69 
‹¡_£rv”_£Á_ev’t
(
lwª_»que¡_t
 *
»que¡
,

70 
lwª_»¥Ú£_t
 *
»¥Ú£
,

71 *
d©a
 
__©Œibu‹__
((
unu£d
)))

73 
	gi
;

75 
	gi
 = 0; i <= 10; i++) {

76 
¡rbuf_´štf
(
»¥Ú£
->
bufãr
, "Cu¼’ˆv®ui %d", 
i
);

77 
lwª_»¥Ú£_£nd_ev’t
(
»que¡
, "currval");

80  
	gHTTP_OK
;

83 
lwª_h‰p_¡©us_t


84 
h–lo_wÜld
(
lwª_»que¡_t
 *
»que¡
,

85 
lwª_»¥Ú£_t
 *
»¥Ú£
,

86 *
d©a
 
__©Œibu‹__
((
unu£d
)))

88 
lwª_key_v®ue_t
 
	gh—d”s
[] = {

89 { .
key
 = "X-The-Answ”-To-The-Univ”§l-Que¡iÚ", .
	gv®ue
 = "42" },

90 { 
	gNULL
, NULL }

92 
	g»¥Ú£
->
	gh—d”s
 = 
h—d”s
;

93 
	g»¥Ú£
->
	gmime_ty³
 = "text/plain";

95 cÚ¡ *
	gÇme
 = 
lwª_»que¡_g‘_qu”y_·¿m
(
»que¡
, "name");

96 ià(
	gÇme
)

97 
¡rbuf_´štf
(
»¥Ú£
->
bufãr
, "H–lo, %s!", 
Çme
);

99 
¡rbuf_£t_¡©ic
(
»¥Ú£
->
bufãr
, "Hello, world!", ("Hello, world!") -1);

101 cÚ¡ *
	gdump_v¬s
 = 
lwª_»que¡_g‘_qu”y_·¿m
(
»que¡
, "dump_vars");

102 ià(!
	gdump_v¬s
)

103 
	g’d
;

105 
¡rbuf_­³nd_¡r
(
»¥Ú£
->
bufãr
, "\n\nQuery String Variables\n", 0);

106 
¡rbuf_­³nd_¡r
(
»¥Ú£
->
bufãr
, "----------------------\n\n", 0);

108 
lwª_key_v®ue_t
 *
	gqs
 = 
»que¡
->
qu”y_·¿ms
.
ba£
;

109 ; 
	gqs
->
	gkey
; qs++)

110 
¡rbuf_­³nd_´štf
(
»¥Ú£
->
bufãr
,

111 "Key = \"%s\"; V®uğ\"%s\"\n", 
qs
->
key
, qs->
v®ue
);

113 ià(!(
	g»que¡
->
	gæags
 & 
	gREQUEST_METHOD_POST
))

114 
	g’d
;

116 
¡rbuf_­³nd_¡r
(
»¥Ú£
->
bufãr
, "\n\nPOST data\n", 0);

117 
¡rbuf_­³nd_¡r
(
»¥Ú£
->
bufãr
, "---------\n\n", 0);

119 
	gqs
 = 
»que¡
->
po¡_d©a
.
ba£
; qs->
	gkey
; qs++)

120 
¡rbuf_­³nd_´štf
(
»¥Ú£
->
bufãr
,

121 "Key = \"%s\"; V®uğ\"%s\"\n", 
qs
->
key
, qs->
v®ue
);

123 
	g’d
:

124  
HTTP_OK
;

128 
	$maš
()

130 
lwª_t
 
l
;

132 
	`lwª_š™
(&
l
);

133 
	`lwª_maš_loİ
(&
l
);

134 
	`lwª_shutdown
(&
l
);

137 
	}
}

	@techempower/array.c

21 
	~"¬¿y.h
"

23 
	~<as£¹.h
>

24 
	~<”ºo.h
>

25 
	~<¡ddef.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

32 
	$¬¿y_»®loc
(
¬¿y
 *¬¿y, 
size_t
 
Ãw_tÙ®
)

34 *
tmp
 = 
	`»®loc
(
¬¿y
->¬¿y, (*è* 
Ãw_tÙ®
);

35 ià(
tmp
 =ğ
NULL
)

36  -
ENOMEM
;

37 
¬¿y
->¬¿y = 
tmp
;

38 
¬¿y
->
tÙ®
 = 
Ãw_tÙ®
;

40 
	}
}

42 
	$¬¿y_š™
(
¬¿y
 *¬¿y, 
size_t
 
¡•
)

44 
	`as£¹
(
¡•
 > 0);

45 
¬¿y
->¬¿y = 
NULL
;

46 
¬¿y
->
couÁ
 = 0;

47 
¬¿y
->
tÙ®
 = 0;

48 
¬¿y
->
¡•
 = step;

49 
	}
}

51 
	$¬¿y_­³nd
(
¬¿y
 *¬¿y, cÚ¡ *
–em’t
)

53 
size_t
 
idx
;

55 ià(
¬¿y
->
couÁ
 + 1 >ğ¬¿y->
tÙ®
) {

56 
r
 = 
	`¬¿y_»®loc
(
¬¿y
,‡¼ay->
tÙ®
 +‡¼ay->
¡•
);

57 ià(
r
 < 0)

58  
r
;

60 
idx
 = 
¬¿y
->
couÁ
;

61 
¬¿y
->¬¿y[
idx
] = (*)
–em’t
;

62 
¬¿y
->
couÁ
++;

63  ()
idx
;

64 
	}
}

66 
	$¬¿y_­³nd_unique
(
¬¿y
 *¬¿y, cÚ¡ *
–em’t
)

68 **
™r
 = 
¬¿y
->array;

69 **
™r_’d
 = 
™r
 + 
¬¿y
->
couÁ
;

70 ; 
™r
 < 
™r_’d
; itr++)

71 ià(*
™r
 =ğ
–em’t
)

72  -
EEXIST
;

73  
	`¬¿y_­³nd
(
¬¿y
, 
–em’t
);

74 
	}
}

76 
	$¬¿y_pİ
(
¬¿y
 *array) {

77 
¬¿y
->
couÁ
--;

78 ià(
¬¿y
->
couÁ
 +‡¼ay->
¡•
 <‡¼ay->
tÙ®
) {

79 
r
 = 
	`¬¿y_»®loc
(
¬¿y
,‡¼ay->
tÙ®
 -‡¼ay->
¡•
);

80 ià(
r
 < 0)

83 
	}
}

85 
	$¬¿y_ä“_¬¿y
(
¬¿y
 *array) {

86 
	`ä“
(
¬¿y
->array);

87 
¬¿y
->
couÁ
 = 0;

88 
¬¿y
->
tÙ®
 = 0;

89 
	}
}

92 
¬¿y_sÜt
(
¬¿y
 *¬¿y, (*
cmp
)(cÚ¡ *
a
, cÚ¡ *
b
))

94 
	`qsÜt
(
¬¿y
->¬¿y,‡¼ay->
couÁ
, (*), 
cmp
);

95 
	}
}

97 
	$¬¿y_»move_©
(
¬¿y
 *¬¿y, 
pos
)

99 ià(
¬¿y
->
couÁ
 <ğ
pos
)

100  -
ENOENT
;

102 
¬¿y
->
couÁ
--;

103 ià(
pos
 < 
¬¿y
->
couÁ
)

104 
	`memmove
(
¬¿y
->¬¿y + 
pos
,‡rray->array +…os + 1,

105 (*è* (
¬¿y
->
couÁ
 - 
pos
));

107 ià(
¬¿y
->
couÁ
 +‡¼ay->
¡•
 <‡¼ay->
tÙ®
) {

108 
r
 = 
	`¬¿y_»®loc
(
¬¿y
,‡¼ay->
tÙ®
 -‡¼ay->
¡•
);

110 ià(
r
 < 0)

115 
	}
}

	@techempower/array.h

1 #´agm¨
Úû


3 
	~<¡ddef.h
>

9 
	s¬¿y
 {

10 **
	m¬¿y
;

11 
size_t
 
	mcouÁ
;

12 
size_t
 
	mtÙ®
;

13 
size_t
 
	m¡•
;

16 
¬¿y_š™
(
¬¿y
 *¬¿y, 
size_t
 
¡•
);

17 
¬¿y_­³nd
(
¬¿y
 *¬¿y, cÚ¡ *
–em’t
);

18 
¬¿y_­³nd_unique
(
¬¿y
 *¬¿y, cÚ¡ *
–em’t
);

19 
¬¿y_pİ
(
¬¿y
 *array);

20 
¬¿y_ä“_¬¿y
(
¬¿y
 *array);

21 
¬¿y_sÜt
(
¬¿y
 *¬¿y, (*
cmp
)(cÚ¡ *
a
, cÚ¡ *
b
));

22 
	`¬¿y_»move_©
(
¬¿y
 *¬¿y, 
pos
);

	@techempower/database.c

20 
	~<mysql.h
>

21 
	~<sql™e3.h
>

22 
	~<¡ddef.h
>

23 
	~<¡dlib.h
>

25 
	~"d©aba£.h
"

27 
	sdb_¡mt
 {

28 
boŞ
 (*
bšd
)(cÚ¡ 
db_¡mt
 *
	m¡mt
, 
db_row
 *
	mrows
, 
size_t
 
	mn_rows
);

29 
boŞ
 (*
¡•
)(cÚ¡ 
db_¡mt
 *
	m¡mt
, 
db_row
 *
	mrow
);

30 (*
	mfš®ize
)(
db_¡mt
 *
	m¡mt
);

33 
	sdb
 {

34 (*
	mdiscÚÃù
)(
db
 *
	mdb
);

35 
	mdb_¡mt
 *(*
	m´•¬e
)(cÚ¡ 
db
 *
	mdb
, cÚ¡ *
	msql
, cÚ¡ 
size_t
 
	msql_Ën
);

40 
	sdb_mysql
 {

41 
db
 
	mba£
;

42 
MYSQL
 *
	mcÚ
;

45 
	sdb_¡mt_mysql
 {

46 
db_¡mt
 
	mba£
;

47 
MYSQL_STMT
 *
	m¡mt
;

48 
MYSQL_BIND
 *
	m·¿m_bšd
;

49 
MYSQL_BIND
 *
	m»suÉ_bšd
;

50 
boŞ
 
	mmu¡_execu‹_agaš
;

53 
boŞ
 
	$db_¡mt_bšd_mysql
(cÚ¡ 
db_¡mt
 *
¡mt
,

54 
db_row
 *
rows
, 
size_t
 
n_rows
)

56 
db_¡mt_mysql
 *
¡mt_mysql
 = (db_¡mt_mysqÈ*)
¡mt
;

58 
¡mt_mysql
->
mu¡_execu‹_agaš
 = 
Œue
;

60 ià(!
¡mt_mysql
->
·¿m_bšd
) {

61 
¡mt_mysql
->
·¿m_bšd
 = 
	`ÿÎoc
(
n_rows
, (*stmt_mysql->param_bind));

62 ià(!
¡mt_mysql
->
·¿m_bšd
)

63  
çl£
;

65 
	`mysql_¡mt_»£t
(
¡mt_mysql
->
¡mt
);

68 
size_t
 
row
 = 0;„ow < 
n_rows
;„ow++) {

69 ià(
rows
[
row
].
kšd
 == '\0') ;

71 
MYSQL_BIND
 *
·¿m
 = &
¡mt_mysql
->
·¿m_bšd
[
row
];

72 ià(
rows
[
row
].
kšd
 == 's') {

73 
·¿m
->
bufãr_ty³
 = 
MYSQL_TYPE_STRING
;

74 
·¿m
->
bufãr
 = 
rows
[
row
].
u
.
s
;

75 } ià(
rows
[
row
].
kšd
 == 'i') {

76 
·¿m
->
bufãr_ty³
 = 
MYSQL_TYPE_LONG
;

77 
·¿m
->
bufãr
 = &
rows
[
row
].
u
.
i
;

79 
·¿m
->
is_nuÎ
 = 
çl£
;

80 
·¿m
->
Ëngth
 = 0;

83  !
	`mysql_¡mt_bšd_·¿m
(
¡mt_mysql
->
¡mt
, stmt_mysql->
·¿m_bšd
);

84 
	}
}

86 
boŞ
 
	$db_¡mt_¡•_mysql
(cÚ¡ 
db_¡mt
 *
¡mt
, 
db_row
 *
row
)

88 
db_¡mt_mysql
 *
¡mt_mysql
 = (db_¡mt_mysqÈ*)
¡mt
;

90 ià(
¡mt_mysql
->
mu¡_execu‹_agaš
) {

91 
¡mt_mysql
->
mu¡_execu‹_agaš
 = 
çl£
;

92 ià(
	`mysql_¡mt_execu‹
(
¡mt_mysql
->
¡mt
))

93  
çl£
;

96 ià(!
¡mt_mysql
->
»suÉ_bšd
) {

97 
size_t
 
n_rows
 = 0;

98 
db_row
 *
r
 = 
row
;„->
kšd
 != '\0';„++)

99 
n_rows
++;

101 ià(!
n_rows
)

102  
çl£
;

104 
¡mt_mysql
->
»suÉ_bšd
 = 
	`ÿÎoc
(
n_rows
, (*stmt_mysql->result_bind));

105 ià(!
¡mt_mysql
->
»suÉ_bšd
)

106  
çl£
;

108 
¡mt_mysql
->
·¿m_bšd
 = 
	`ÿÎoc
(
n_rows
, (*stmt_mysql->param_bind));

109 ià(!
¡mt_mysql
->
·¿m_bšd
) {

110 
	`ä“
(
¡mt_mysql
->
·¿m_bšd
);

111  
çl£
;

114 
MYSQL_BIND
 *
»suÉ
 = 
¡mt_mysql
->
»suÉ_bšd
;

115 
size_t
 
r
 = 0;„ < 
n_rows
;„++) {

116 ià(
row
[
r
].
kšd
 == 's') {

117 
»suÉ
[
r
].
bufãr_ty³
 = 
MYSQL_TYPE_STRING
;

118 
»suÉ
[
r
].
bufãr
 = 
row
[r].
u
.
s
;

119 } ià(
row
[
r
].
kšd
 == 'i') {

120 
»suÉ
[
r
].
bufãr_ty³
 = 
MYSQL_TYPE_LONG
;

121 
»suÉ
[
r
].
bufãr
 = &
row
[r].
u
.
i
;

123  
çl£
;

126 
»suÉ
[
r
].
is_nuÎ
 = 
çl£
;

127 
»suÉ
[
r
].
bufãr_Ëngth
 = 
row
[r].buffer_length;

130 ià(
	`mysql_¡mt_bšd_»suÉ
(
¡mt_mysql
->
¡mt
, 
»suÉ
))

131  
çl£
;

134  
	`mysql_¡mt_ãtch
(
¡mt_mysql
->
¡mt
) == 0;

135 
	}
}

137 
	$db_¡mt_fš®ize_mysql
(
db_¡mt
 *
¡mt
)

139 
db_¡mt_mysql
 *
¡mt_mysql
 = (db_¡mt_mysqÈ*)
¡mt
;

141 
	`mysql_¡mt_şo£
(
¡mt_mysql
->
¡mt
);

142 
	`ä“
(
¡mt_mysql
->
»suÉ_bšd
);

143 
	`ä“
(
¡mt_mysql
->
·¿m_bšd
);

144 
	`ä“
(
¡mt_mysql
);

145 
	}
}

147 
db_¡mt
 *
	$db_´•¬e_mysql
(cÚ¡ 
db
 *db, cÚ¡ *
sql
,

148 cÚ¡ 
size_t
 
sql_Ën
)

150 cÚ¡ 
db_mysql
 *db_mysqÈğ(cÚ¡ db_mysqÈ*)
db
;

151 
db_¡mt_mysql
 *
¡mt_mysql
 = 
	`m®loc
((*stmt_mysql));

153 ià(!
¡mt_mysql
)

154  
NULL
;

156 
¡mt_mysql
->
¡mt
 = 
	`mysql_¡mt_š™
(
db_mysql
->
cÚ
);

157 ià(!
¡mt_mysql
->
¡mt
) {

158 
	`ä“
(
¡mt_mysql
);

159  
NULL
;

162 ià(
	`mysql_¡mt_´•¬e
(
¡mt_mysql
->
¡mt
, 
sql
, 
sql_Ën
)) {

163 
	`mysql_¡mt_şo£
(
¡mt_mysql
->
¡mt
);

164 
	`ä“
(
¡mt_mysql
);

165  
NULL
;

168 
¡mt_mysql
->
ba£
.
bšd
 = 
db_¡mt_bšd_mysql
;

169 
¡mt_mysql
->
ba£
.
¡•
 = 
db_¡mt_¡•_mysql
;

170 
¡mt_mysql
->
ba£
.
fš®ize
 = 
db_¡mt_fš®ize_mysql
;

171 
¡mt_mysql
->
»suÉ_bšd
 = 
NULL
;

172 
¡mt_mysql
->
·¿m_bšd
 = 
NULL
;

173 
¡mt_mysql
->
mu¡_execu‹_agaš
 = 
Œue
;

175  (
db_¡mt
*)
¡mt_mysql
;

176 
	}
}

178 
	$db_discÚÃù_mysql
(
db
 *db)

180 
db_mysql
 *db_mysqÈğ(db_mysqÈ*)
db
;

182 
	`mysql_şo£
(
db_mysql
->
cÚ
);

183 
	`ä“
(
db
);

184 
	}
}

186 
db
 *
	$db_cÚÃù_mysql
(cÚ¡ *
ho¡
, cÚ¡ *
u£r
, cÚ¡ *
·ss
,

187 cÚ¡ *
d©aba£
)

189 
db_mysql
 *db_mysqÈğ
	`m®loc
((*db_mysql));

191 ià(!
db_mysql
)

192  
NULL
;

194 
db_mysql
->
cÚ
 = 
	`mysql_š™
(
NULL
);

195 ià(!
db_mysql
->
cÚ
) {

196 
	`ä“
(
db_mysql
);

197  
NULL
;

200 ià(!
	`mysql_»®_cÚÃù
(
db_mysql
->
cÚ
, 
ho¡
, 
u£r
, 
·ss
, 
d©aba£
, 0, 
NULL
, 0))

201 
”rÜ
;

203 ià(
	`mysql_£t_ch¬aù”_£t
(
db_mysql
->
cÚ
, "utf8"))

204 
”rÜ
;

206 
db_mysql
->
ba£
.
discÚÃù
 = 
db_discÚÃù_mysql
;

207 
db_mysql
->
ba£
.
´•¬e
 = 
db_´•¬e_mysql
;

209  (
db
 *)
db_mysql
;

211 
”rÜ
:

212 
	`mysql_şo£
(
db_mysql
->
cÚ
);

213 
	`ä“
(
db_mysql
);

214  
NULL
;

215 
	}
}

219 
	sdb_sql™e
 {

220 
db
 
	mba£
;

221 
sql™e3
 *
	msql™e
;

224 
	sdb_¡mt_sql™e
 {

225 
db_¡mt
 
	mba£
;

226 
sql™e3_¡mt
 *
	msql™e
;

229 
boŞ
 
	$db_¡mt_bšd_sql™e
(cÚ¡ 
db_¡mt
 *
¡mt
, 
db_row
 *
rows
, 
size_t
 
n_rows
)

231 cÚ¡ 
db_¡mt_sql™e
 *
¡mt_sql™e
 = (cÚ¡ db_¡mt_sql™*)
¡mt
;

232 cÚ¡ 
db_row
 *
rows_1_ba£d
 = 
rows
 - 1;

233 
»t
;

235 
	`sql™e3_»£t
(
¡mt_sql™e
->
sql™e
);

236 
	`sql™e3_ş—r_bšdšgs
(
¡mt_sql™e
->
sql™e
);

238 
size_t
 
row
 = 1;„ow <ğ
n_rows
;„ow++) {

239 cÚ¡ 
db_row
 *
r
 = &
rows_1_ba£d
[
row
];

240 ià(
r
->
kšd
 == '\0') ;

242 ià(
r
->
kšd
 == 's') {

243 
»t
 = 
	`sql™e3_bšd_‹xt
(
¡mt_sql™e
->
sql™e
, ()
row
, 
r
->
u
.
s
, -1, 
NULL
);

244 ià(
»t
 !ğ
SQLITE_OK
)

245  
çl£
;

246 } ià(
r
->
kšd
 == 'i') {

247 
»t
 = 
	`sql™e3_bšd_št
(
¡mt_sql™e
->
sql™e
, ()
row
, 
r
->
u
.
i
);

248 ià(
»t
 !ğ
SQLITE_OK
)

249  
çl£
;

251  
çl£
;

255  
Œue
;

256 
	}
}

258 
boŞ
 
	$db_¡mt_¡•_sql™e
(cÚ¡ 
db_¡mt
 *
¡mt
, 
db_row
 *
row
)

260 cÚ¡ 
db_¡mt_sql™e
 *
¡mt_sql™e
 = (cÚ¡ db_¡mt_sql™*)
¡mt
;

262 ià(
	`sql™e3_¡•
(
¡mt_sql™e
->
sql™e
è!ğ
SQLITE_ROW
)

263  
çl£
;

265 
cŞumn_id
 = 0;

266 
db_row
 *
r
 = 
row
;„->
kšd
 !ğ'\0';„++, 
cŞumn_id
++) {

267 ià(
r
->
kšd
 == 'i') {

268 
r
->
u
.
i
 = 
	`sql™e3_cŞumn_št
(
¡mt_sql™e
->
sql™e
, 
cŞumn_id
);

269 } ià(
r
->
kšd
 == 's') {

270 
r
->
u
.
s
 = (*)
	`sql™e3_cŞumn_‹xt
(
¡mt_sql™e
->
sql™e
, 
cŞumn_id
);

272  
çl£
;

276  
Œue
;

277 
	}
}

279 
	$db_¡mt_fš®ize_sql™e
(
db_¡mt
 *
¡mt
)

281 
db_¡mt_sql™e
 *
¡mt_sql™e
 = (db_¡mt_sql™*)
¡mt
;

283 
	`sql™e3_fš®ize
(
¡mt_sql™e
->
sql™e
);

284 
	`ä“
(
¡mt_sql™e
);

285 
	}
}

287 
db_¡mt
 *
	$db_´•¬e_sql™e
(cÚ¡ 
db
 *db, cÚ¡ *
sql
,

288 cÚ¡ 
size_t
 
sql_Ën
)

290 cÚ¡ 
db_sql™e
 *db_sql™ğ(cÚ¡ db_sql™*)
db
;

291 
db_¡mt_sql™e
 *
¡mt_sql™e
 = 
	`m®loc
((*stmt_sqlite));

293 ià(!
¡mt_sql™e
)

294  
NULL
;

296 
»t
 = 
	`sql™e3_´•¬e
(
db_sql™e
->
sql™e
, 
sql
, ()
sql_Ën
, &
¡mt_sql™e
->sql™e, 
NULL
);

297 ià(
»t
 !ğ
SQLITE_OK
) {

298 
	`ä“
(
¡mt_sql™e
);

299  
NULL
;

302 
¡mt_sql™e
->
ba£
.
bšd
 = 
db_¡mt_bšd_sql™e
;

303 
¡mt_sql™e
->
ba£
.
¡•
 = 
db_¡mt_¡•_sql™e
;

304 
¡mt_sql™e
->
ba£
.
fš®ize
 = 
db_¡mt_fš®ize_sql™e
;

306  (
db_¡mt
 *)
¡mt_sql™e
;

307 
	}
}

309 
	$db_discÚÃù_sql™e
(
db
 *db)

311 
db_sql™e
 *db_sql™ğ(db_sql™*)
db
;

313 
	`sql™e3_şo£
(
db_sql™e
->
sql™e
);

314 
	`ä“
(
db
);

315 
	}
}

317 
db
 *
	$db_cÚÃù_sql™e
(cÚ¡ *
·th
, 
boŞ
 
»ad_Úly
, cÚ¡ *
´agmas
[])

319 
db_sql™e
 *db_sql™ğ
	`m®loc
((*db_sqlite));

321 ià(!
db_sql™e
)

322  
NULL
;

324 
æags
 = 
»ad_Úly
 ? 
SQLITE_OPEN_READONLY
 : 0;

325 
»t
 = 
	`sql™e3_İ’_v2
(
·th
, &
db_sql™e
->
sql™e
, 
æags
, 
NULL
);

326 ià(
»t
 !ğ
SQLITE_OK
) {

327 
	`ä“
(
db_sql™e
);

328  
NULL
;

331 ià(
´agmas
) {

332 
size_t
 
p
 = 0; 
´agmas
[p];…++)

333 
	`sql™e3_exec
(
db_sql™e
->
sql™e
, 
´agmas
[
p
], 
NULL
, NULL, NULL);

336 
db_sql™e
->
ba£
.
discÚÃù
 = 
db_discÚÃù_sql™e
;

337 
db_sql™e
->
ba£
.
´•¬e
 = 
db_´•¬e_sql™e
;

339  (
db
 *)
db_sql™e
;

340 
	}
}

344 
šlše
 
boŞ
 
	$db_¡mt_bšd
(cÚ¡ 
db_¡mt
 *
¡mt
, 
db_row
 *
rows
, 
size_t
 
n_rows
)

346  
¡mt
->
	`bšd
(¡mt, 
rows
, 
n_rows
);

347 
	}
}

349 
šlše
 
boŞ
 
	$db_¡mt_¡•
(cÚ¡ 
db_¡mt
 *
¡mt
, 
db_row
 *
row
)

351  
¡mt
->
	`¡•
(¡mt, 
row
);

352 
	}
}

354 
šlše
 
	$db_¡mt_fš®ize
(
db_¡mt
 *
¡mt
)

356 
¡mt
->
	`fš®ize
(stmt);

357 
	}
}

359 
šlše
 
	$db_discÚÃù
(
db
 *db)

361 
db
->
	`discÚÃù
(db);

362 
	}
}

364 
šlše
 
db_¡mt
 *
	$db_´•¬e_¡mt
(cÚ¡ 
db
 *db, cÚ¡ *
sql
,

365 cÚ¡ 
size_t
 
sql_Ën
)

367  
db
->
	`´•¬e
(db, 
sql
, 
sql_Ën
);

368 
	}
}

	@techempower/database.h

20 #iâdeà
__DATABASE_H__


21 
	#__DATABASE_H__


	)

23 
	~<¡dboŞ.h
>

25 
	gdb
;

26 
	gdb_¡mt
;

28 
	sdb_row
 {

30 *
	ms
;

31 
	mi
;

32 } 
	mu
;

33 
	mkšd
;

34 
size_t
 
	mbufãr_Ëngth
;

37 
boŞ
 
db_¡mt_bšd
(cÚ¡ 
db_¡mt
 *
¡mt
, 
db_row
 *
rows
, 
size_t
 
n_rows
);

38 
boŞ
 
db_¡mt_¡•
(cÚ¡ 
db_¡mt
 *
¡mt
, 
db_row
 *
row
);

39 
db_¡mt_fš®ize
(
db_¡mt
 *
¡mt
);

40 
db_discÚÃù
(
db
 *db);

41 
db_¡mt
 *
db_´•¬e_¡mt
(cÚ¡ 
db
 *db, cÚ¡ *
sql
,

42 cÚ¡ 
size_t
 
sql_Ën
);

44 
db
 *
db_cÚÃù_sql™e
(cÚ¡ *
·th
, 
boŞ
 
»ad_Úly
, cÚ¡ *
´agmas
[]);

45 
db
 *
db_cÚÃù_mysql
(cÚ¡ *
ho¡
, cÚ¡ *
u£r
, cÚ¡ *
·ss
, cÚ¡ *
d©aba£
);

	@techempower/json.c

24 
	~"jsÚ.h
"

26 
	~<as£¹.h
>

27 
	~<¡dšt.h
>

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<¡ršg.h
>

32 
	#out_of_memÜy
() do { \

33 
	`årštf
(
¡d”r
, "Out of memory.\n"); \

34 
	`ex™
(
EXIT_FAILURE
); \

35 } 0)

	)

41 *
	mcur
;

42 *
	m’d
;

43 *
	m¡¬t
;

44 } 
	tSB
;

46 
	$sb_š™
(
SB
 *
sb
)

48 
sb
->
¡¬t
 = (*è
	`m®loc
(17);

49 ià(
sb
->
¡¬t
 =ğ
NULL
)

50 
	`out_of_memÜy
();

51 
sb
->
cur
 = sb->
¡¬t
;

52 
sb
->
’d
 = sb->
¡¬t
 + 16;

53 
	}
}

56 
	#sb_Ãed
(
sb
, 
Ãed
) do { \

57 ià((
size_t
)((
sb
)->
’d
 - (sb)->
cur
è< (
Ãed
)) \

58 
	`sb_grow
(
sb
, 
Ãed
); \

59 } 0)

	)

61 
	$sb_grow
(
SB
 *
sb
, 
size_t
 
Ãed
)

63 
size_t
 
Ëngth
 = (size_t)(
sb
->
cur
 - sb->
¡¬t
);

64 
size_t
 
®loc
 = (size_t)(
sb
->
’d
 - sb->
¡¬t
);

67 
®loc
 *= 2;

68 } 
®loc
 < 
Ëngth
 + 
Ãed
);

70 
sb
->
¡¬t
 = (*è
	`»®loc
(sb->¡¬t, 
®loc
 + 1);

71 ià(
sb
->
¡¬t
 =ğ
NULL
)

72 
	`out_of_memÜy
();

73 
sb
->
cur
 = sb->
¡¬t
 + 
Ëngth
;

74 
sb
->
’d
 = sb->
¡¬t
 + 
®loc
;

75 
	}
}

77 
	$sb_put
(
SB
 *
sb
, cÚ¡ *
by‹s
, 
size_t
 
couÁ
)

79 
	`sb_Ãed
(
sb
, 
couÁ
);

80 
	`memıy
(
sb
->
cur
, 
by‹s
, 
couÁ
);

81 
sb
->
cur
 +ğ
couÁ
;

82 
	}
}

84 
	#sb_putc
(
sb
, 
c
) do { \

85 ià((
sb
)->
cur
 >ğ(sb)->
’d
) \

86 
	`sb_grow
(
sb
, 1); \

87 *(
sb
)->
cur
++ = (
c
); \

88 } 0)

	)

90 
	$sb_puts
(
SB
 *
sb
, cÚ¡ *
¡r
)

92 
	`sb_put
(
sb
, 
¡r
, 
	`¡¾’
(str));

93 
	}
}

95 *
	$sb_fšish
(
SB
 *
sb
)

97 *
sb
->
cur
 = 0;

98 
	`as£¹
(
sb
->
¡¬t
 <ğsb->
cur
 && 
	`¡¾’
(sb->¡¬tè=ğ(
size_t
)(sb->cur - sb->start));

99  
sb
->
¡¬t
;

100 
	}
}

102 *
	$sb_fšish_Ëngth
(
SB
 *
sb
, 
size_t
 *
Ëngth
)

104 *
sb
->
cur
 = 0;

105 
	`as£¹
(
sb
->
¡¬t
 <ğsb->
cur
 && 
	`¡¾’
(sb->¡¬tè=ğ(
size_t
)(sb->cur - sb->start));

106 *
Ëngth
 = (
size_t
)(
sb
->
cur
 - sb->
¡¬t
);

107  
sb
->
¡¬t
;

108 
	}
}

110 
	$sb_ä“
(
SB
 *
sb
)

112 
	`ä“
(
sb
->
¡¬t
);

113 
	}
}

127 
ušt32_t
 
	tuch¬_t
;

149 
size_t
 
	$utf8_v®id©e_cz
(cÚ¡ *
s
)

151 
c
 = ()*
s
++;

153 ià(
c
 <= 0x7F) {

155 } ià(
c
 <= 0xC1) {

158 } ià(
c
 <= 0xDF) {

160 ià((()*
s
++ & 0xC0) != 0x80)

164 } ià(
c
 <= 0xEF) {

166 ià(
c
 =ğ0xE0 && ()*
s
 < 0xA0)

170 ià(
c
 =ğ0xED && ()*
s
 > 0x9F)

174 ià((()*
s
++ & 0xC0) != 0x80)

176 ià((()*
s
++ & 0xC0) != 0x80)

180 } ià(
c
 <= 0xF4) {

182 ià(
c
 =ğ0xF0 && ()*
s
 < 0x90)

186 ià(
c
 =ğ0xF4 && ()*
s
 > 0x8F)

190 ià((()*
s
++ & 0xC0) != 0x80)

192 ià((()*
s
++ & 0xC0) != 0x80)

194 ià((()*
s
++ & 0xC0) != 0x80)

201 
	}
}

204 
boŞ
 
	$utf8_v®id©e
(cÚ¡ *
s
)

206 
size_t
 
Ën
;

208 ; *
s
 !ğ0; s +ğ
Ën
) {

209 
Ën
 = 
	`utf8_v®id©e_cz
(
s
);

210 ià(
Ën
 == 0)

211  
çl£
;

214  
Œue
;

215 
	}
}

224 
	$utf8_»ad_ch¬
(cÚ¡ *
s
, 
uch¬_t
 *
out
)

226 cÚ¡ *
c
 = (cÚ¡ *è
s
;

228 
	`as£¹
(
	`utf8_v®id©e_cz
(
s
));

230 ià(
c
[0] <= 0x7F) {

232 *
out
 = 
c
[0];

234 } ià(
c
[0] <= 0xDF) {

236 *
out
 = ((
uch¬_t
)
c
[0] & 0x1F) << 6 |

237 ((
uch¬_t
)
c
[1] & 0x3F);

239 } ià(
c
[0] <= 0xEF) {

241 *
out
 = ((
uch¬_t
)
c
[0] & 0xF) << 12 |

242 ((
uch¬_t
)
c
[1] & 0x3F) << 6 |

243 ((
uch¬_t
)
c
[2] & 0x3F);

247 *
out
 = ((
uch¬_t
)
c
[0] & 0x7) << 18 |

248 ((
uch¬_t
)
c
[1] & 0x3F) << 12 |

249 ((
uch¬_t
)
c
[2] & 0x3F) << 6 |

250 ((
uch¬_t
)
c
[3] & 0x3F);

253 
	}
}

263 
	$utf8_wr™e_ch¬
(
uch¬_t
 
unicode
, *
out
)

265 *
o
 = (*è
out
;

267 
	`as£¹
(
unicode
 <= 0x10FFFF && !(unicode >= 0xD800 && unicode <= 0xDFFF));

269 ià(
unicode
 <= 0x7F) {

271 *
o
++ = ()
unicode
;

273 } ià(
unicode
 <= 0x7FF) {

275 *
o
++ = ()(0xC0 | 
unicode
 >> 6);

276 *
o
++ = ()(0x80 | (
unicode
 & 0x3F));

278 } ià(
unicode
 <= 0xFFFF) {

280 *
o
++ = ()(0xE0 | 
unicode
 >> 12);

281 *
o
++ = ()(0x80 | (
unicode
 >> 6 & 0x3F));

282 *
o
++ = ()(0x80 | (
unicode
 & 0x3F));

286 *
o
++ = ()(0xF0 | 
unicode
 >> 18);

287 *
o
++ = ()(0x80 | (
unicode
 >> 12 & 0x3F));

288 *
o
++ = ()(0x80 | (
unicode
 >> 6 & 0x3F));

289 *
o
++ = ()(0x80 | (
unicode
 & 0x3F));

292 
	}
}

300 
boŞ
 
	$äom_su¼og©e_·œ
(
ušt16_t
 
uc
, ušt16_ˆ
lc
, 
uch¬_t
 *
unicode
)

302 ià(
uc
 >ğ0xD800 && uø<ğ0xDBFF && 
lc
 >= 0xDC00 &&†c <= 0xDFFF) {

303 *
unicode
 = 0x10000 + ((((
uch¬_t
)
uc
 & 0x3FFè<< 10è| (
lc
 & 0x3FF));

304  
Œue
;

306  
çl£
;

308 
	}
}

315 
	$to_su¼og©e_·œ
(
uch¬_t
 
unicode
, 
ušt16_t
 *
uc
, ušt16_ˆ*
lc
)

317 
uch¬_t
 
n
;

319 
	`as£¹
(
unicode
 >= 0x10000 && unicode <= 0x10FFFF);

321 
n
 = 
unicode
 - 0x10000;

322 *
uc
 = (
ušt16_t
)(((
n
 >> 10) & 0x3FF) | 0xD800);

323 *
lc
 = (
ušt16_t
)((
n
 & 0x3FF) | 0xDC00);

324 
	}
}

326 
	#is_¥aû
(
c
è((cè=ğ'\t' || (cè=ğ'\n' || (cè=ğ'\r' || (cè=ğ' ')

	)

327 
	#is_dig™
(
c
è((cè>ğ'0' && (cè<ğ'9')

	)

329 
boŞ
 
·r£_v®ue
 (cÚ¡ **
¥
, 
JsÚNode
 **
out
);

330 
boŞ
 
·r£_¡ršg
 (cÚ¡ **
¥
, **
out
);

331 
boŞ
 
·r£_numb”
 (cÚ¡ **
¥
, *
out
);

332 
boŞ
 
·r£_¬¿y
 (cÚ¡ **
¥
, 
JsÚNode
 **
out
);

333 
boŞ
 
·r£_objeù
 (cÚ¡ **
¥
, 
JsÚNode
 **
out
);

334 
boŞ
 
·r£_hex16
 (cÚ¡ **
¥
, 
ušt16_t
 *
out
);

336 
boŞ
 
ex³ù_l™”®
 (cÚ¡ **
¥
, cÚ¡ *
¡r
);

337 
sk_¥aû
 (cÚ¡ **
¥
);

339 
em™_v®ue
 (
SB
 *
out
, cÚ¡ 
JsÚNode
 *
node
);

340 
em™_v®ue_šd’‹d
 (
SB
 *
out
, cÚ¡ 
JsÚNode
 *
node
, cÚ¡ *
¥aû
, 
šd’t_Ëv–
);

341 
em™_¡ršg
 (
SB
 *
out
, cÚ¡ *
¡r
);

342 
em™_numb”
 (
SB
 *
out
, 
num
);

343 
em™_¬¿y
 (
SB
 *
out
, cÚ¡ 
JsÚNode
 *
¬¿y
);

344 
em™_¬¿y_šd’‹d
 (
SB
 *
out
, cÚ¡ 
JsÚNode
 *
¬¿y
, cÚ¡ *
¥aû
, 
šd’t_Ëv–
);

345 
em™_objeù
 (
SB
 *
out
, cÚ¡ 
JsÚNode
 *
objeù
);

346 
em™_objeù_šd’‹d
 (
SB
 *
out
, cÚ¡ 
JsÚNode
 *
objeù
, cÚ¡ *
¥aû
, 
šd’t_Ëv–
);

348 
wr™e_hex16
(*
out
, 
ušt16_t
 
v®
);

350 
JsÚNode
 *
mknode
(
JsÚTag
 
g
);

351 
­³nd_node
(
JsÚNode
 *
·»Á
, JsÚNod*
chd
);

352 
´•’d_node
(
JsÚNode
 *
·»Á
, JsÚNod*
chd
);

353 
­³nd_memb”
(
JsÚNode
 *
objeù
, *
key
, JsÚNod*
v®ue
);

356 
boŞ
 
g_is_v®id
(
g
);

357 
boŞ
 
numb”_is_v®id
(cÚ¡ *
num
);

359 
JsÚNode
 *
	$jsÚ_decode
(cÚ¡ *
jsÚ
)

361 cÚ¡ *
s
 = 
jsÚ
;

362 
JsÚNode
 *
»t
;

364 
	`sk_¥aû
(&
s
);

365 ià(!
	`·r£_v®ue
(&
s
, &
»t
))

366  
NULL
;

368 
	`sk_¥aû
(&
s
);

369 ià(*
s
 != 0) {

370 
	`jsÚ_d–‘e
(
»t
);

371  
NULL
;

374  
»t
;

375 
	}
}

377 *
	$jsÚ_’code
(cÚ¡ 
JsÚNode
 *
node
)

379  
	`jsÚ_¡ršgify
(
node
, 
NULL
);

380 
	}
}

382 *
	$jsÚ_’code_¡ršg
(cÚ¡ *
¡r
)

384 
SB
 
sb
;

385 
	`sb_š™
(&
sb
);

387 
	`em™_¡ršg
(&
sb
, 
¡r
);

389  
	`sb_fšish
(&
sb
);

390 
	}
}

392 *
	$jsÚ_¡ršgify
(cÚ¡ 
JsÚNode
 *
node
, cÚ¡ *
¥aû
)

394 
SB
 
sb
;

395 
	`sb_š™
(&
sb
);

397 ià(
¥aû
 !ğ
NULL
)

398 
	`em™_v®ue_šd’‹d
(&
sb
, 
node
, 
¥aû
, 0);

400 
	`em™_v®ue
(&
sb
, 
node
);

402  
	`sb_fšish
(&
sb
);

403 
	}
}

405 *
	$jsÚ_¡ršgify_Ëngth
(cÚ¡ 
JsÚNode
 *
node
, cÚ¡ *
¥aû
, 
size_t
 *
Ëngth
)

407 
SB
 
sb
;

408 
	`sb_š™
(&
sb
);

410 ià(
¥aû
 !ğ
NULL
)

411 
	`em™_v®ue_šd’‹d
(&
sb
, 
node
, 
¥aû
, 0);

413 
	`em™_v®ue
(&
sb
, 
node
);

415  
	`sb_fšish_Ëngth
(&
sb
, 
Ëngth
);

416 
	}
}

418 
	$jsÚ_d–‘e
(
JsÚNode
 *
node
)

420 ià(
node
 !ğ
NULL
) {

421 
	`jsÚ_»move_äom_·»Á
(
node
);

423 
node
->
g
) {

424 
JSON_STRING
:

425 
	`ä“
(
node
->
¡ršg_
);

427 
JSON_ARRAY
:

428 
JSON_OBJECT
:

430 
JsÚNode
 *
chd
, *
Ãxt
;

431 
chd
 = 
node
->
chd»n
.
h—d
; chd !ğ
NULL
; chd = 
Ãxt
) {

432 
Ãxt
 = 
chd
->next;

433 
	`jsÚ_d–‘e
(
chd
);

440 
	`ä“
(
node
);

442 
	}
}

444 
boŞ
 
	$jsÚ_v®id©e
(cÚ¡ *
jsÚ
)

446 cÚ¡ *
s
 = 
jsÚ
;

448 
	`sk_¥aû
(&
s
);

449 ià(!
	`·r£_v®ue
(&
s
, 
NULL
))

450  
çl£
;

452 
	`sk_¥aû
(&
s
);

453 ià(*
s
 != 0)

454  
çl£
;

456  
Œue
;

457 
	}
}

459 
JsÚNode
 *
	$jsÚ_fšd_–em’t
(
JsÚNode
 *
¬¿y
, 
šdex
)

461 
JsÚNode
 *
–em’t
;

462 
i
 = 0;

464 ià(
¬¿y
 =ğ
NULL
 ||‡¼ay->
g
 !ğ
JSON_ARRAY
)

465  
NULL
;

467 
	`jsÚ_fÜ—ch
(
–em’t
, 
¬¿y
) {

468 ià(
i
 =ğ
šdex
)

469  
–em’t
;

470 
i
++;

473  
NULL
;

474 
	}
}

476 
JsÚNode
 *
	$jsÚ_fšd_memb”
(
JsÚNode
 *
objeù
, cÚ¡ *
Çme
)

478 
JsÚNode
 *
memb”
;

480 ià(
objeù
 =ğ
NULL
 || objeù->
g
 !ğ
JSON_OBJECT
)

481  
NULL
;

483 
	`jsÚ_fÜ—ch
(
memb”
, 
objeù
)

484 ià(
	`¡rcmp
(
memb”
->
key
, 
Çme
) == 0)

485  
memb”
;

487  
NULL
;

488 
	}
}

490 
JsÚNode
 *
	$jsÚ_fœ¡_chd
(cÚ¡ 
JsÚNode
 *
node
)

492 ià(
node
 !ğ
NULL
 && (node->
g
 =ğ
JSON_ARRAY
 ||‚ode->g =ğ
JSON_OBJECT
))

493  
node
->
chd»n
.
h—d
;

494  
NULL
;

495 
	}
}

497 
JsÚNode
 *
	$mknode
(
JsÚTag
 
g
)

499 
JsÚNode
 *
»t
 = (JsÚNode*è
	`ÿÎoc
(1, (JsonNode));

500 ià(
»t
 =ğ
NULL
)

501 
	`out_of_memÜy
();

502 
»t
->
g
 =ag;

503  
»t
;

504 
	}
}

506 
JsÚNode
 *
	$jsÚ_mknuÎ
()

508  
	`mknode
(
JSON_NULL
);

509 
	}
}

511 
JsÚNode
 *
	$jsÚ_mkboŞ
(
boŞ
 
b
)

513 
JsÚNode
 *
»t
 = 
	`mknode
(
JSON_BOOL
);

514 
»t
->
boŞ_
 = 
b
;

515  
»t
;

516 
	}
}

518 
JsÚNode
 *
	$mk¡ršg
(*
s
)

520 
JsÚNode
 *
»t
 = 
	`mknode
(
JSON_STRING
);

521 
»t
->
¡ršg_
 = 
s
;

522  
»t
;

523 
	}
}

525 
JsÚNode
 *
	$jsÚ_mk¡ršg
(cÚ¡ *
s
)

527  
	`mk¡ršg
(
	`¡rdup
(
s
));

528 
	}
}

530 
JsÚNode
 *
	$jsÚ_mknumb”
(
n
)

532 
JsÚNode
 *
node
 = 
	`mknode
(
JSON_NUMBER
);

533 
node
->
numb”_
 = 
n
;

534  
node
;

535 
	}
}

537 
JsÚNode
 *
	$jsÚ_mk¬¿y
()

539  
	`mknode
(
JSON_ARRAY
);

540 
	}
}

542 
JsÚNode
 *
	$jsÚ_mkobjeù
()

544  
	`mknode
(
JSON_OBJECT
);

545 
	}
}

547 
	$­³nd_node
(
JsÚNode
 *
·»Á
, JsÚNod*
chd
)

549 
chd
->
·»Á
 =…arent;

550 
chd
->
´ev
 = 
·»Á
->
chd»n
.

;

551 
chd
->
Ãxt
 = 
NULL
;

553 ià(
·»Á
->
chd»n
.

 !ğ
NULL
)

554 
·»Á
->
chd»n
.

->
Ãxt
 = 
chd
;

556 
·»Á
->
chd»n
.
h—d
 = 
chd
;

557 
·»Á
->
chd»n
.

 = 
chd
;

558 
	}
}

560 
	$´•’d_node
(
JsÚNode
 *
·»Á
, JsÚNod*
chd
)

562 
chd
->
·»Á
 =…arent;

563 
chd
->
´ev
 = 
NULL
;

564 
chd
->
Ãxt
 = 
·»Á
->
chd»n
.
h—d
;

566 ià(
·»Á
->
chd»n
.
h—d
 !ğ
NULL
)

567 
·»Á
->
chd»n
.
h—d
->
´ev
 = 
chd
;

569 
·»Á
->
chd»n
.

 = 
chd
;

570 
·»Á
->
chd»n
.
h—d
 = 
chd
;

571 
	}
}

573 
	$­³nd_memb”
(
JsÚNode
 *
objeù
, *
key
, JsÚNod*
v®ue
)

575 
v®ue
->
key
 = key;

576 
	`­³nd_node
(
objeù
, 
v®ue
);

577 
	}
}

579 
	$jsÚ_­³nd_–em’t
(
JsÚNode
 *
¬¿y
, JsÚNod*
–em’t
)

581 
	`as£¹
(
¬¿y
->
g
 =ğ
JSON_ARRAY
);

582 
	`as£¹
(
–em’t
->
·»Á
 =ğ
NULL
);

584 
	`­³nd_node
(
¬¿y
, 
–em’t
);

585 
	}
}

587 
	$jsÚ_´•’d_–em’t
(
JsÚNode
 *
¬¿y
, JsÚNod*
–em’t
)

589 
	`as£¹
(
¬¿y
->
g
 =ğ
JSON_ARRAY
);

590 
	`as£¹
(
–em’t
->
·»Á
 =ğ
NULL
);

592 
	`´•’d_node
(
¬¿y
, 
–em’t
);

593 
	}
}

595 
	$jsÚ_­³nd_memb”
(
JsÚNode
 *
objeù
, cÚ¡ *
key
, JsÚNod*
v®ue
)

597 
	`as£¹
(
objeù
->
g
 =ğ
JSON_OBJECT
);

598 
	`as£¹
(
v®ue
->
·»Á
 =ğ
NULL
);

600 
	`­³nd_memb”
(
objeù
, 
	`¡rdup
(
key
), 
v®ue
);

601 
	}
}

603 
	$jsÚ_´•’d_memb”
(
JsÚNode
 *
objeù
, cÚ¡ *
key
, JsÚNod*
v®ue
)

605 
	`as£¹
(
objeù
->
g
 =ğ
JSON_OBJECT
);

606 
	`as£¹
(
v®ue
->
·»Á
 =ğ
NULL
);

608 
v®ue
->
key
 = 
	`¡rdup
(key);

609 
	`´•’d_node
(
objeù
, 
v®ue
);

610 
	}
}

612 
	$jsÚ_»move_äom_·»Á
(
JsÚNode
 *
node
)

614 
JsÚNode
 *
·»Á
 = 
node
->parent;

616 ià(
·»Á
 !ğ
NULL
) {

617 ià(
node
->
´ev
 !ğ
NULL
)

618 
node
->
´ev
->
Ãxt
 =‚ode->next;

620 
·»Á
->
chd»n
.
h—d
 = 
node
->
Ãxt
;

621 ià(
node
->
Ãxt
 !ğ
NULL
)

622 
node
->
Ãxt
->
´ev
 =‚ode->prev;

624 
·»Á
->
chd»n
.

 = 
node
->
´ev
;

626 
	`ä“
(
node
->
key
);

628 
node
->
·»Á
 = 
NULL
;

629 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

630 
node
->
key
 = 
NULL
;

632 
	}
}

634 
boŞ
 
	$·r£_v®ue
(cÚ¡ **
¥
, 
JsÚNode
 **
out
)

636 cÚ¡ *
s
 = *
¥
;

638 *
s
) {

640 ià(
	`ex³ù_l™”®
(&
s
, "null")) {

641 ià(
out
)

642 *
out
 = 
	`jsÚ_mknuÎ
();

643 *
¥
 = 
s
;

644  
Œue
;

646  
çl£
;

649 ià(
	`ex³ù_l™”®
(&
s
, "false")) {

650 ià(
out
)

651 *
out
 = 
	`jsÚ_mkboŞ
(
çl£
);

652 *
¥
 = 
s
;

653  
Œue
;

655  
çl£
;

658 ià(
	`ex³ù_l™”®
(&
s
, "true")) {

659 ià(
out
)

660 *
out
 = 
	`jsÚ_mkboŞ
(
Œue
);

661 *
¥
 = 
s
;

662  
Œue
;

664  
çl£
;

667 *
¡r
;

668 ià(
	`·r£_¡ršg
(&
s
, 
out
 ? &
¡r
 : 
NULL
)) {

669 ià(
out
)

670 *
out
 = 
	`mk¡ršg
(
¡r
);

671 *
¥
 = 
s
;

672  
Œue
;

674  
çl£
;

678 ià(
	`·r£_¬¿y
(&
s
, 
out
)) {

679 *
¥
 = 
s
;

680  
Œue
;

682  
çl£
;

685 ià(
	`·r£_objeù
(&
s
, 
out
)) {

686 *
¥
 = 
s
;

687  
Œue
;

689  
çl£
;

692 
num
;

693 ià(
	`·r£_numb”
(&
s
, 
out
 ? &
num
 : 
NULL
)) {

694 ià(
out
)

695 *
out
 = 
	`jsÚ_mknumb”
(
num
);

696 *
¥
 = 
s
;

697  
Œue
;

699  
çl£
;

702 
	}
}

704 
boŞ
 
	$·r£_¬¿y
(cÚ¡ **
¥
, 
JsÚNode
 **
out
)

706 cÚ¡ *
s
 = *
¥
;

707 
JsÚNode
 *
»t
 = 
out
 ? 
	`jsÚ_mk¬¿y
(è: 
NULL
;

708 
JsÚNode
 *
–em’t
;

710 ià(*
s
++ != '[')

711 
çu»
;

712 
	`sk_¥aû
(&
s
);

714 ià(*
s
 == ']') {

715 
s
++;

716 
sucûss
;

720 ià(!
	`·r£_v®ue
(&
s
, 
out
 ? &
–em’t
 : 
NULL
))

721 
çu»
;

722 
	`sk_¥aû
(&
s
);

724 ià(
out
)

725 
	`jsÚ_­³nd_–em’t
(
»t
, 
–em’t
);

727 ià(*
s
 == ']') {

728 
s
++;

729 
sucûss
;

732 ià(*
s
++ != ',')

733 
çu»
;

734 
	`sk_¥aû
(&
s
);

737 
sucûss
:

738 *
¥
 = 
s
;

739 ià(
out
)

740 *
out
 = 
»t
;

741  
Œue
;

743 
çu»
:

744 
	`jsÚ_d–‘e
(
»t
);

745  
çl£
;

746 
	}
}

748 
boŞ
 
	$·r£_objeù
(cÚ¡ **
¥
, 
JsÚNode
 **
out
)

750 cÚ¡ *
s
 = *
¥
;

751 
JsÚNode
 *
»t
 = 
out
 ? 
	`jsÚ_mkobjeù
(è: 
NULL
;

752 *
key
;

753 
JsÚNode
 *
v®ue
;

755 ià(*
s
++ != '{')

756 
çu»
;

757 
	`sk_¥aû
(&
s
);

759 ià(*
s
 == '}') {

760 
s
++;

761 
sucûss
;

765 ià(!
	`·r£_¡ršg
(&
s
, 
out
 ? &
key
 : 
NULL
))

766 
çu»
;

767 
	`sk_¥aû
(&
s
);

769 ià(*
s
++ != ':')

770 
çu»_ä“_key
;

771 
	`sk_¥aû
(&
s
);

773 ià(!
	`·r£_v®ue
(&
s
, 
out
 ? &
v®ue
 : 
NULL
))

774 
çu»_ä“_key
;

775 
	`sk_¥aû
(&
s
);

777 ià(
out
)

778 
	`­³nd_memb”
(
»t
, 
key
, 
v®ue
);

780 ià(*
s
 == '}') {

781 
s
++;

782 
sucûss
;

785 ià(*
s
++ != ',')

786 
çu»
;

787 
	`sk_¥aû
(&
s
);

790 
sucûss
:

791 *
¥
 = 
s
;

792 ià(
out
)

793 *
out
 = 
»t
;

794  
Œue
;

796 
çu»_ä“_key
:

797 ià(
out
)

798 
	`ä“
(
key
);

799 
çu»
:

800 
	`jsÚ_d–‘e
(
»t
);

801  
çl£
;

802 
	}
}

804 
boŞ
 
	$·r£_¡ršg
(cÚ¡ **
¥
, **
out
)

806 cÚ¡ *
s
 = (*)*
¥
;

807 
SB
 
sb
 = {0};

808 
throwaway_bufãr
[4];

810 *
b
;

812 ià(*
s
++ != '"')

813  
çl£
;

815 ià(
out
) {

816 
	`sb_š™
(&
sb
);

817 
	`sb_Ãed
(&
sb
, 4);

818 
b
 = 
sb
.
cur
;

820 
b
 = 
throwaway_bufãr
;

823 *
s
 != '"') {

824 
c
 = *
s
++;

827 ià(
c
 == '\\') {

828 
c
 = *
s
++;

829 
c
) {

833 *
b
++ = ()
c
;

836 *
b
++ = '\b';

839 *
b
++ = '\f';

842 *
b
++ = '\n';

845 *
b
++ = '\r';

848 *
b
++ = '\t';

852 
ušt16_t
 
uc
, 
lc
;

853 
uch¬_t
 
unicode
;

855 ià(!
	`·r£_hex16
(&
s
, &
uc
))

856 
çed
;

858 ià(
uc
 >= 0xD800 && uc <= 0xDFFF) {

860 ià(*
s
++ !ğ'\\' || *s++ !ğ'u' || !
	`·r£_hex16
(&s, &
lc
))

861 
çed
;

862 ià(!
	`äom_su¼og©e_·œ
(
uc
, 
lc
, &
unicode
))

863 
çed
;

864 } ià(
uc
 == 0) {

866 
çed
;

868 
unicode
 = 
uc
;

871 
b
 +ğ
	`utf8_wr™e_ch¬
(
unicode
, b);

876 
çed
;

878 } ià(
c
 <= 0x1F) {

880 
çed
;

883 
size_t
 
Ën
;

885 
s
--;

886 
Ën
 = 
	`utf8_v®id©e_cz
(
s
);

887 ià(
Ën
 == 0)

888 
çed
;

890 
Ën
--)

891 *
b
++ = *
s
++;

898 ià(
out
) {

899 
sb
.
cur
 = 
b
;

900 
	`sb_Ãed
(&
sb
, 4);

901 
b
 = 
sb
.
cur
;

903 
b
 = 
throwaway_bufãr
;

906 
s
++;

908 ià(
out
)

909 *
out
 = 
	`sb_fšish
(&
sb
);

910 *
¥
 = 
s
;

911  
Œue
;

913 
çed
:

914 ià(
out
)

915 
	`sb_ä“
(&
sb
);

916  
çl£
;

917 
	}
}

929 
boŞ
 
	$·r£_numb”
(cÚ¡ **
¥
, *
out
)

931 cÚ¡ *
s
 = *
¥
;

934 ià(*
s
 == '-')

935 
s
++;

938 ià(*
s
 == '0') {

939 
s
++;

941 ià(!
	`is_dig™
(*
s
))

942  
çl£
;

944 
s
++;

945 } 
	`is_dig™
(*
s
));

949 ià(*
s
 == '.') {

950 
s
++;

951 ià(!
	`is_dig™
(*
s
))

952  
çl£
;

954 
s
++;

955 } 
	`is_dig™
(*
s
));

959 ià(*
s
 == 'E' || *s == 'e') {

960 
s
++;

961 ià(*
s
 == '+' || *s == '-')

962 
s
++;

963 ià(!
	`is_dig™
(*
s
))

964  
çl£
;

966 
s
++;

967 } 
	`is_dig™
(*
s
));

970 ià(
out
)

971 *
out
 = 
	`¡¹od
(*
¥
, 
NULL
);

973 *
¥
 = 
s
;

974  
Œue
;

975 
	}
}

977 
	$sk_¥aû
(cÚ¡ **
¥
)

979 cÚ¡ *
s
 = *
¥
;

980 
	`is_¥aû
(*
s
))

981 
s
++;

982 *
¥
 = 
s
;

983 
	}
}

985 
	$em™_v®ue
(
SB
 *
out
, cÚ¡ 
JsÚNode
 *
node
)

987 
	`as£¹
(
	`g_is_v®id
(
node
->
g
));

988 
node
->
g
) {

989 
JSON_NULL
:

990 
	`sb_puts
(
out
, "null");

992 
JSON_BOOL
:

993 
	`sb_puts
(
out
, 
node
->
boŞ_
 ? "true" : "false");

995 
JSON_STRING
:

996 
	`em™_¡ršg
(
out
, 
node
->
¡ršg_
);

998 
JSON_NUMBER
:

999 
	`em™_numb”
(
out
, 
node
->
numb”_
);

1001 
JSON_ARRAY
:

1002 
	`em™_¬¿y
(
out
, 
node
);

1004 
JSON_OBJECT
:

1005 
	`em™_objeù
(
out
, 
node
);

1008 
	`as£¹
(
çl£
);

1010 
	}
}

1012 
	$em™_v®ue_šd’‹d
(
SB
 *
out
, cÚ¡ 
JsÚNode
 *
node
, cÚ¡ *
¥aû
, 
šd’t_Ëv–
)

1014 
	`as£¹
(
	`g_is_v®id
(
node
->
g
));

1015 
node
->
g
) {

1016 
JSON_NULL
:

1017 
	`sb_puts
(
out
, "null");

1019 
JSON_BOOL
:

1020 
	`sb_puts
(
out
, 
node
->
boŞ_
 ? "true" : "false");

1022 
JSON_STRING
:

1023 
	`em™_¡ršg
(
out
, 
node
->
¡ršg_
);

1025 
JSON_NUMBER
:

1026 
	`em™_numb”
(
out
, 
node
->
numb”_
);

1028 
JSON_ARRAY
:

1029 
	`em™_¬¿y_šd’‹d
(
out
, 
node
, 
¥aû
, 
šd’t_Ëv–
);

1031 
JSON_OBJECT
:

1032 
	`em™_objeù_šd’‹d
(
out
, 
node
, 
¥aû
, 
šd’t_Ëv–
);

1035 
	`as£¹
(
çl£
);

1037 
	}
}

1039 
	$em™_¬¿y
(
SB
 *
out
, cÚ¡ 
JsÚNode
 *
¬¿y
)

1041 cÚ¡ 
JsÚNode
 *
–em’t
;

1043 
	`sb_putc
(
out
, '[');

1044 
	`jsÚ_fÜ—ch
(
–em’t
, 
¬¿y
) {

1045 
	`em™_v®ue
(
out
, 
–em’t
);

1046 ià(
–em’t
->
Ãxt
 !ğ
NULL
)

1047 
	`sb_putc
(
out
, ',');

1049 
	`sb_putc
(
out
, ']');

1050 
	}
}

1052 
	$em™_¬¿y_šd’‹d
(
SB
 *
out
, cÚ¡ 
JsÚNode
 *
¬¿y
, cÚ¡ *
¥aû
, 
šd’t_Ëv–
)

1054 cÚ¡ 
JsÚNode
 *
–em’t
 = 
¬¿y
->
chd»n
.
h—d
;

1055 
i
;

1057 ià(
–em’t
 =ğ
NULL
) {

1058 
	`sb_puts
(
out
, "[]");

1062 
	`sb_puts
(
out
, "[\n");

1063 
–em’t
 !ğ
NULL
) {

1064 
i
 = 0; i < 
šd’t_Ëv–
 + 1; i++)

1065 
	`sb_puts
(
out
, 
¥aû
);

1066 
	`em™_v®ue_šd’‹d
(
out
, 
–em’t
, 
¥aû
, 
šd’t_Ëv–
 + 1);

1068 
–em’t
 =ƒËm’t->
Ãxt
;

1069 
	`sb_puts
(
out
, 
–em’t
 !ğ
NULL
 ? ",\n" : "\n");

1071 
i
 = 0; i < 
šd’t_Ëv–
; i++)

1072 
	`sb_puts
(
out
, 
¥aû
);

1073 
	`sb_putc
(
out
, ']');

1074 
	}
}

1076 
	$em™_objeù
(
SB
 *
out
, cÚ¡ 
JsÚNode
 *
objeù
)

1078 cÚ¡ 
JsÚNode
 *
memb”
;

1080 
	`sb_putc
(
out
, '{');

1081 
	`jsÚ_fÜ—ch
(
memb”
, 
objeù
) {

1082 
	`em™_¡ršg
(
out
, 
memb”
->
key
);

1083 
	`sb_putc
(
out
, ':');

1084 
	`em™_v®ue
(
out
, 
memb”
);

1085 ià(
memb”
->
Ãxt
 !ğ
NULL
)

1086 
	`sb_putc
(
out
, ',');

1088 
	`sb_putc
(
out
, '}');

1089 
	}
}

1091 
	$em™_objeù_šd’‹d
(
SB
 *
out
, cÚ¡ 
JsÚNode
 *
objeù
, cÚ¡ *
¥aû
, 
šd’t_Ëv–
)

1093 cÚ¡ 
JsÚNode
 *
memb”
 = 
objeù
->
chd»n
.
h—d
;

1094 
i
;

1096 ià(
memb”
 =ğ
NULL
) {

1097 
	`sb_puts
(
out
, "{}");

1101 
	`sb_puts
(
out
, "{\n");

1102 
memb”
 !ğ
NULL
) {

1103 
i
 = 0; i < 
šd’t_Ëv–
 + 1; i++)

1104 
	`sb_puts
(
out
, 
¥aû
);

1105 
	`em™_¡ršg
(
out
, 
memb”
->
key
);

1106 
	`sb_puts
(
out
, ": ");

1107 
	`em™_v®ue_šd’‹d
(
out
, 
memb”
, 
¥aû
, 
šd’t_Ëv–
 + 1);

1109 
memb”
 = memb”->
Ãxt
;

1110 
	`sb_puts
(
out
, 
memb”
 !ğ
NULL
 ? ",\n" : "\n");

1112 
i
 = 0; i < 
šd’t_Ëv–
; i++)

1113 
	`sb_puts
(
out
, 
¥aû
);

1114 
	`sb_putc
(
out
, '}');

1115 
	}
}

1117 
	$em™_¡ršg
(
SB
 *
out
, cÚ¡ *
¡r
)

1119 cÚ¡ *
s
 = 
¡r
;

1120 *
b
;

1122 
	`as£¹
(
	`utf8_v®id©e
(
¡r
));

1128 
	`sb_Ãed
(
out
, 14);

1129 
b
 = 
out
->
cur
;

1131 *
b
++ = '"';

1132 *
s
 != 0) {

1133 
c
 = *
s
++;

1136 
c
) {

1138 *
b
++ = '\\';

1139 *
b
++ = '"';

1142 *
b
++ = '\\';

1143 *
b
++ = '\\';

1146 *
b
++ = '\\';

1147 *
b
++ = 'b';

1150 *
b
++ = '\\';

1151 *
b
++ = 'f';

1154 *
b
++ = '\\';

1155 *
b
++ = 'n';

1158 *
b
++ = '\\';

1159 *
b
++ = 'r';

1162 *
b
++ = '\\';

1163 *
b
++ = 't';

1166 
size_t
 
Ën
;

1168 
s
--;

1169 
Ën
 = 
	`utf8_v®id©e_cz
(
s
);

1171 ià(
Ën
 == 0) {

1180 
	`as£¹
(
çl£
);

1181 *
b
++ = ()0xEF;

1182 *
b
++ = ()0xBF;

1183 *
b
++ = ()0xBD;

1184 
s
++;

1185 } ià(
c
 < 0x1F) {

1187 
ušt32_t
 
unicode
;

1189 
s
 +ğ
	`utf8_»ad_ch¬
(s, &
unicode
);

1191 ià(
unicode
 <= 0xFFFF) {

1192 *
b
++ = '\\';

1193 *
b
++ = 'u';

1194 
b
 +ğ
	`wr™e_hex16
(b, (
ušt16_t
)
unicode
);

1197 
ušt16_t
 
uc
, 
lc
;

1198 
	`as£¹
(
unicode
 <= 0x10FFFF);

1199 
	`to_su¼og©e_·œ
(
unicode
, &
uc
, &
lc
);

1200 *
b
++ = '\\';

1201 *
b
++ = 'u';

1202 
b
 +ğ
	`wr™e_hex16
(b, 
uc
);

1203 *
b
++ = '\\';

1204 *
b
++ = 'u';

1205 
b
 +ğ
	`wr™e_hex16
(b, 
lc
);

1209 
Ën
--)

1210 *
b
++ = *
s
++;

1221 
out
->
cur
 = 
b
;

1222 
	`sb_Ãed
(
out
, 14);

1223 
b
 = 
out
->
cur
;

1225 *
b
++ = '"';

1227 
out
->
cur
 = 
b
;

1228 
	}
}

1230 
	$em™_numb”
(
SB
 *
out
, 
num
)

1238 
buf
[64];

1239 
	`¥rštf
(
buf
, "%.16g", 
num
);

1241 ià(
	`numb”_is_v®id
(
buf
))

1242 
	`sb_puts
(
out
, 
buf
);

1244 
	`sb_puts
(
out
, "null");

1245 
	}
}

1247 
boŞ
 
	$g_is_v®id
(
g
)

1249  ( 
g
 <ğ
JSON_OBJECT
);

1250 
	}
}

1252 
boŞ
 
	$numb”_is_v®id
(cÚ¡ *
num
)

1254  (
	`·r£_numb”
(&
num
, 
NULL
) && *num == '\0');

1255 
	}
}

1257 
boŞ
 
	$ex³ù_l™”®
(cÚ¡ **
¥
, cÚ¡ *
¡r
)

1259 cÚ¡ *
s
 = *
¥
;

1261 *
¡r
 != '\0')

1262 ià(*
s
++ !ğ*
¡r
++)

1263  
çl£
;

1265 *
¥
 = 
s
;

1266  
Œue
;

1267 
	}
}

1273 
boŞ
 
	$·r£_hex16
(cÚ¡ **
¥
, 
ušt16_t
 *
out
)

1275 cÚ¡ *
s
 = *
¥
;

1276 
ušt16_t
 
»t
 = 0;

1277 
ušt16_t
 
i
;

1278 
ušt16_t
 
tmp
;

1280 
i
 = 0; i < 4; i++) {

1281 
c
 = *
s
++;

1282 ià(
c
 >= '0' && c <= '9')

1283 
tmp
 = (
ušt16_t
)(
c
 - '0');

1284 ià(
c
 >= 'A' && c <= 'F')

1285 
tmp
 = (
ušt16_t
)(
c
 - 'A' + 10);

1286 ià(
c
 >= 'a' && c <= 'f')

1287 
tmp
 = (
ušt16_t
)(
c
 - 'a' + 10);

1289  
çl£
;

1291 
»t
 = (
ušt16_t
)(Ô‘ << 4è+ 
tmp
);

1294 ià(
out
)

1295 *
out
 = 
»t
;

1296 *
¥
 = 
s
;

1297  
Œue
;

1298 
	}
}

1304 
	$wr™e_hex16
(*
out
, 
ušt16_t
 
v®
)

1306 cÚ¡ *
hex
 = "0123456789ABCDEF";

1308 *
out
++ = 
hex
[(
v®
 >> 12) & 0xF];

1309 *
out
++ = 
hex
[(
v®
 >> 8) & 0xF];

1310 *
out
++ = 
hex
[(
v®
 >> 4) & 0xF];

1311 *
out
++ = 
hex
[ 
v®
 & 0xF];

1314 
	}
}

1316 
boŞ
 
	$jsÚ_check
(cÚ¡ 
JsÚNode
 *
node
, 
”rmsg
[256])

1318 
	#´obËm
(...) do { \

1319 ià(
”rmsg
 !ğ
NULL
) \

1320 
	`¢´štf
(
”rmsg
, 256, 
__VA_ARGS__
); \

1321  
çl£
; \

1322 } 0)

	)

1324 ià(
node
->
key
 !ğ
NULL
 && !
	`utf8_v®id©e
(node->key))

1325 
	`´obËm
("key contains invalid UTF-8");

1327 ià(!
	`g_is_v®id
(
node
->
g
))

1328 
	`´obËm
("g i šv®id (%u)", 
node
->
g
);

1330 ià(
node
->
g
 =ğ
JSON_BOOL
) {

1331 ià(
node
->
boŞ_
 !ğ
çl£
 &&‚ode->boŞ_ !ğ
Œue
)

1332 
	`´obËm
("boŞ_ i Ã™h” f®£ (%dènÜru(%d)", ()
çl£
, ()
Œue
);

1333 } ià(
node
->
g
 =ğ
JSON_STRING
) {

1334 ià(
node
->
¡ršg_
 =ğ
NULL
)

1335 
	`´obËm
("string_ is NULL");

1336 ià(!
	`utf8_v®id©e
(
node
->
¡ršg_
))

1337 
	`´obËm
("string_ contains invalid UTF-8");

1338 } ià(
node
->
g
 =ğ
JSON_ARRAY
 ||‚ode->g =ğ
JSON_OBJECT
) {

1339 
JsÚNode
 *
h—d
 = 
node
->
chd»n
.head;

1340 
JsÚNode
 *

 = 
node
->
chd»n
.tail;

1342 ià(
h—d
 =ğ
NULL
 || 

 == NULL) {

1343 ià(
h—d
 !ğ
NULL
)

1344 
	`´obËm
("tail is NULL, but head is‚ot");

1345 ià(

 !ğ
NULL
)

1346 
	`´obËm
("head is NULL, butail is‚ot");

1348 
JsÚNode
 *
chd
;

1349 
JsÚNode
 *
Ï¡
 = 
NULL
;

1351 ià(
h—d
->
´ev
 !ğ
NULL
)

1352 
	`´obËm
("First child's…rev…ointer is‚ot NULL");

1354 
chd
 = 
h—d
; chd !ğ
NULL
; 
Ï¡
 = chd, chd = chd->
Ãxt
) {

1355 ià(
chd
 =ğ
node
)

1356 
	`´obËm
("node is its own child");

1357 ià(
chd
->
Ãxt
 == child)

1358 
	`´obËm
("child->next == child (cycle)");

1359 ià(
chd
->
Ãxt
 =ğ
h—d
)

1360 
	`´obËm
("child->next == head (cycle)");

1362 ià(
chd
->
·»Á
 !ğ
node
)

1363 
	`´obËm
("child does‚ot…oint backo…arent");

1364 ià(
chd
->
Ãxt
 !ğ
NULL
 && chd->Ãxt->
´ev
 != child)

1365 
	`´obËm
("child->next does‚ot…oint backo child");

1367 ià(
node
->
g
 =ğ
JSON_ARRAY
 && 
chd
->
key
 !ğ
NULL
)

1368 
	`´obËm
("Arrayƒlement's key is‚ot NULL");

1369 ià(
node
->
g
 =ğ
JSON_OBJECT
 && 
chd
->
key
 =ğ
NULL
)

1370 
	`´obËm
("Object member's key is NULL");

1372 ià(!
	`jsÚ_check
(
chd
, 
”rmsg
))

1373  
çl£
;

1376 ià(
Ï¡
 !ğ

)

1377 
	`´obËm
("tail does‚ot match…ointer found by starting‡t head‡nd following‚ext†inks");

1381  
Œue
;

1383 #undeà
´obËm


1384 
	}
}

	@techempower/json.h

24 #iâdeà
CCAN_JSON_H


25 
	#CCAN_JSON_H


	)

27 
	~<¡dboŞ.h
>

28 
	~<¡ddef.h
>

31 
	mJSON_NULL
,

32 
	mJSON_BOOL
,

33 
	mJSON_STRING
,

34 
	mJSON_NUMBER
,

35 
	mJSON_ARRAY
,

36 
	mJSON_OBJECT
,

37 } 
	tJsÚTag
;

39 
JsÚNode
 
	tJsÚNode
;

41 
	sJsÚNode


44 
JsÚNode
 *
	m·»Á
;

45 
JsÚNode
 *
	m´ev
, *
	mÃxt
;

48 *
	mkey
;

50 
JsÚTag
 
	mg
;

53 
boŞ
 
	mboŞ_
;

56 *
	m¡ršg_
;

59 
	mnumb”_
;

64 
JsÚNode
 *
	mh—d
, *
	m
;

65 } 
	mchd»n
;

71 
JsÚNode
 *
jsÚ_decode
 (cÚ¡ *
jsÚ
);

72 *
jsÚ_’code
 (cÚ¡ 
JsÚNode
 *
node
);

73 *
jsÚ_’code_¡ršg
 (cÚ¡ *
¡r
);

74 *
jsÚ_¡ršgify
 (cÚ¡ 
JsÚNode
 *
node
, cÚ¡ *
¥aû
);

75 *
jsÚ_¡ršgify_Ëngth
(cÚ¡ 
JsÚNode
 *
node
, cÚ¡ *
¥aû
, 
size_t
 *
Ëngth
);

76 
jsÚ_d–‘e
 (
JsÚNode
 *
node
);

78 
boŞ
 
jsÚ_v®id©e
 (cÚ¡ *
jsÚ
);

82 
JsÚNode
 *
jsÚ_fšd_–em’t
 (JsÚNod*
¬¿y
, 
šdex
);

83 
JsÚNode
 *
jsÚ_fšd_memb”
 (JsÚNod*
objeù
, cÚ¡ *
key
);

85 
JsÚNode
 *
jsÚ_fœ¡_chd
 (cÚ¡ JsÚNod*
node
);

87 
	#jsÚ_fÜ—ch
(
i
, 
objeù_Ü_¬¿y
) \

88 (
i
èğ
	`jsÚ_fœ¡_chd
(
objeù_Ü_¬¿y
); \

89 (
i
è!ğ
NULL
; \

90 (
i
èğ(i)->
Ãxt
)

	)

94 
JsÚNode
 *
jsÚ_mknuÎ
();

95 
JsÚNode
 *
jsÚ_mkboŞ
(
boŞ
 
b
);

96 
JsÚNode
 *
jsÚ_mk¡ršg
(cÚ¡ *
s
);

97 
JsÚNode
 *
jsÚ_mknumb”
(
n
);

98 
JsÚNode
 *
jsÚ_mk¬¿y
();

99 
JsÚNode
 *
jsÚ_mkobjeù
();

101 
jsÚ_­³nd_–em’t
(
JsÚNode
 *
¬¿y
, JsÚNod*
–em’t
);

102 
jsÚ_´•’d_–em’t
(
JsÚNode
 *
¬¿y
, JsÚNod*
–em’t
);

103 
jsÚ_­³nd_memb”
(
JsÚNode
 *
objeù
, cÚ¡ *
key
, JsÚNod*
v®ue
);

104 
jsÚ_´•’d_memb”
(
JsÚNode
 *
objeù
, cÚ¡ *
key
, JsÚNod*
v®ue
);

106 
jsÚ_»move_äom_·»Á
(
JsÚNode
 *
node
);

116 
boŞ
 
jsÚ_check
(cÚ¡ 
JsÚNode
 *
node
, 
”rmsg
[256]);

	@techempower/techempower.c

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

23 
	~"lwª.h
"

24 
	~"lwª-cÚfig.h
"

25 
	~"lwª-‹m¶©e.h
"

27 
	~"¬¿y.h
"

28 
	~"d©aba£.h
"

29 
	~"jsÚ.h
"

31 cÚ¡ 
	gh–lo_wÜld
[] = "Hello, World!";

32 cÚ¡ 
	g¿ndom_numb”_qu”y
[] = "SELECT„andomNumber FROM World WHERE id=?";

34 
	sFÜtuÃ
 {

36 
lwª_l_li¡_g’”©Ü_t
 
	mg’”©Ü
;

38 
	mid
;

39 *
	mmes§ge
;

40 } 
	m™em
;

43 cÚ¡ 
	gfÜtuÃs_‹m¶©e_¡r
[] = "<!DOCTYPE html>" \

56 
fÜtuÃ_li¡_g’”©Ü
(
cÜo_t
 *
cÜo
);

58 cÚ¡ 
lwª_v¬_desütÜ_t
 
	gfÜtuÃ_™em_desc
[] = {

59 
TPL_VAR_INT
(
FÜtuÃ
, 
™em
.
id
),

60 
TPL_VAR_STR_ESCAPE
(
FÜtuÃ
, 
™em
.
mes§ge
),

61 
TPL_VAR_SENTINEL


64 cÚ¡ 
lwª_v¬_desütÜ_t
 
	gfÜtuÃ_desc
[] = {

65 
TPL_VAR_SEQUENCE
(
FÜtuÃ
, 
™em
,

66 
fÜtuÃ_li¡_g’”©Ü
, 
fÜtuÃ_™em_desc
),

67 
TPL_VAR_SENTINEL


70 
db
 *
	gd©aba£
;

71 
lwª_l_t
 *
	gfÜtuÃ_l
;

73 
lwª_h‰p_¡©us_t


74 
	$jsÚ_»¥Ú£
(
lwª_»¥Ú£_t
 *
»¥Ú£
, 
JsÚNode
 *
node
)

76 
size_t
 
Ëngth
;

77 *
£rŸlized
;

79 
£rŸlized
 = 
	`jsÚ_¡ršgify_Ëngth
(
node
, 
NULL
, &
Ëngth
);

80 
	`jsÚ_d–‘e
(
node
);

81 ià(
	`UNLIKELY
(!
£rŸlized
))

82  
HTTP_INTERNAL_ERROR
;

84 
	`¡rbuf_£t
(
»¥Ú£
->
bufãr
, 
£rŸlized
, 
Ëngth
);

85 
	`ä“
(
£rŸlized
);

87 
»¥Ú£
->
mime_ty³
 = "application/json";

88  
HTTP_OK
;

89 
	}
}

91 
lwª_h‰p_¡©us_t


92 
jsÚ
(
lwª_»que¡_t
 *
»que¡
 
__©Œibu‹__
((
unu£d
)),

93 
lwª_»¥Ú£_t
 *
»¥Ú£
,

94 *
d©a
 
__©Œibu‹__
((
unu£d
)))

96 
JsÚNode
 *
	gh–lo
 = 
jsÚ_mkobjeù
();

97 ià(
UNLIKELY
(!
h–lo
))

98  
	gHTTP_INTERNAL_ERROR
;

100 
jsÚ_­³nd_memb”
(
h–lo
, "mes§ge", 
jsÚ_mk¡ršg
(
h–lo_wÜld
));

102  
jsÚ_»¥Ú£
(
»¥Ú£
, 
h–lo
);

105 
JsÚNode
 *

106 
	$db_qu”y
(
db_¡mt
 *
¡mt
, 
db_row
 
rows
[], db_row 
»suÉs
[])

108 
JsÚNode
 *
objeù
 = 
NULL
;

109 
id
 = 
	`¿nd
() % 10000;

111 
rows
[0].
u
.
i
 = 
id
;

113 ià(
	`UNLIKELY
(!
	`db_¡mt_bšd
(
¡mt
, 
rows
, 1)))

114 
out
;

116 ià(
	`UNLIKELY
(!
	`db_¡mt_¡•
(
¡mt
, 
»suÉs
)))

117 
out
;

119 
objeù
 = 
	`jsÚ_mkobjeù
();

120 ià(
	`UNLIKELY
(!
objeù
))

121 
out
;

123 
	`jsÚ_­³nd_memb”
(
objeù
, "id", 
	`jsÚ_mknumb”
(
id
));

124 
	`jsÚ_­³nd_memb”
(
objeù
, "¿ndomNumb”", 
	`jsÚ_mknumb”
(
»suÉs
[0].
u
.
i
));

126 
out
:

127  
objeù
;

128 
	}
}

130 
lwª_h‰p_¡©us_t


131 
db
(
lwª_»que¡_t
 *
»que¡
 
__©Œibu‹__
((
unu£d
)),

132 
lwª_»¥Ú£_t
 *
»¥Ú£
,

133 *
d©a
 
__©Œibu‹__
((
unu£d
)))

135 
db_row
 
	grows
[1] = {{ .
kšd
 = 'i' }};

136 
db_row
 
	g»suÉs
[] = {{ .
kšd
 = 'i' }, { .
	gkšd
 = '\0' }};

137 
db_¡mt
 *
	g¡mt
 = 
db_´•¬e_¡mt
(
d©aba£
, 
¿ndom_numb”_qu”y
,

138 (
¿ndom_numb”_qu”y
) - 1);

139 ià(
UNLIKELY
(!
¡mt
))

140  
	gHTTP_INTERNAL_ERROR
;

142 
JsÚNode
 *
	gobjeù
 = 
db_qu”y
(
¡mt
, 
rows
, 
»suÉs
);

143 
db_¡mt_fš®ize
(
¡mt
);

145 ià(
UNLIKELY
(!
objeù
))

146  
	gHTTP_INTERNAL_ERROR
;

148  
jsÚ_»¥Ú£
(
»¥Ú£
, 
objeù
);

151 
lwª_h‰p_¡©us_t


152 
qu”›s
(
lwª_»que¡_t
 *
»que¡
,

153 
lwª_»¥Ú£_t
 *
»¥Ú£
,

154 *
d©a
 
__©Œibu‹__
((
unu£d
)))

156 cÚ¡ *
	gqu”›s_¡r
 = 
lwª_»que¡_g‘_qu”y_·¿m
(
»que¡
, "queries");

158 ià(
UNLIKELY
(!
qu”›s_¡r
))

159  
	gHTTP_BAD_REQUEST
;

161 
	gqu”›s
 = 
·r£_lÚg
(
qu”›s_¡r
, -1);

162 ià(
UNLIKELY
(
qu”›s
 <= 0))

163 
qu”›s
 = 1;

164 ià(
UNLIKELY
(
qu”›s
 > 500))

165 
	gqu”›s
 = 500;

167 
db_¡mt
 *
	g¡mt
 = 
db_´•¬e_¡mt
(
d©aba£
, 
¿ndom_numb”_qu”y
,

168 (
¿ndom_numb”_qu”y
) - 1);

169 ià(
UNLIKELY
(!
¡mt
))

170  
	gHTTP_INTERNAL_ERROR
;

172 
JsÚNode
 *
	g¬¿y
 = 
jsÚ_mk¬¿y
();

173 ià(
UNLIKELY
(!
¬¿y
))

174 
	gout_no_¬¿y
;

176 
db_row
 
	grows
[1] = {{ .
kšd
 = 'i' }};

177 
db_row
 
	g»suÉs
[] = {{ .
kšd
 = 'i' }, { .
	gkšd
 = '\0' }};

178 
	gqu”›s
--) {

179 
JsÚNode
 *
	gobjeù
 = 
db_qu”y
(
¡mt
, 
rows
, 
»suÉs
);

181 ià(
UNLIKELY
(!
objeù
))

182 
	gout_¬¿y
;

184 
jsÚ_­³nd_–em’t
(
¬¿y
, 
objeù
);

187 
db_¡mt_fš®ize
(
¡mt
);

188  
jsÚ_»¥Ú£
(
»¥Ú£
, 
¬¿y
);

190 
	gout_¬¿y
:

191 
jsÚ_d–‘e
(
¬¿y
);

192 
	gout_no_¬¿y
:

193 
db_¡mt_fš®ize
(
¡mt
);

194  
	gHTTP_INTERNAL_ERROR
;

197 
lwª_h‰p_¡©us_t


198 
¶aš‹xt
(
lwª_»que¡_t
 *
»que¡
 
__©Œibu‹__
((
unu£d
)),

199 
lwª_»¥Ú£_t
 *
»¥Ú£
,

200 *
d©a
 
__©Œibu‹__
((
unu£d
)))

202 
¡rbuf_£t_¡©ic
(
»¥Ú£
->
bufãr
, 
h–lo_wÜld
, (hello_world) - 1);

204 
	g»¥Ú£
->
	gmime_ty³
 = "text/plain";

205  
	gHTTP_OK
;

208 
	$fÜtuÃ_com·»
(cÚ¡ *
a
, cÚ¡ *
b
)

210 cÚ¡ 
FÜtuÃ
 *
fÜtuÃ_a
 = *(cÚ¡ FÜtuÃ **)
a
;

211 cÚ¡ 
FÜtuÃ
 *
fÜtuÃ_b
 = *(cÚ¡ FÜtuÃ **)
b
;

212 
size_t
 
a_Ën
 = 
	`¡¾’
(
fÜtuÃ_a
->
™em
.
mes§ge
);

213 
size_t
 
b_Ën
 = 
	`¡¾’
(
fÜtuÃ_b
->
™em
.
mes§ge
);

215 ià(!
a_Ën
 || !
b_Ën
)

216  
a_Ën
 > 
b_Ën
;

218 
size_t
 
mš_Ën
 = 
a_Ën
 < 
b_Ën
 ?‡_len : b_len;

219 
cmp
 = 
	`memcmp
(
fÜtuÃ_a
->
™em
.
mes§ge
, 
fÜtuÃ_b
->™em.mes§ge, 
mš_Ën
);

220 ià(
cmp
 == 0)

221  
a_Ën
 > 
b_Ën
;

223  
cmp
 > 0;

224 
	}
}

226 
boŞ
 
	$­³nd_fÜtuÃ
(
cÜo_t
 *
cÜo
, 
¬¿y
 *
fÜtuÃs
,

227 
id
, cÚ¡ *
mes§ge
)

229 
FÜtuÃ
 *
fÜtuÃ
;

231 
fÜtuÃ
 = 
	`cÜo_m®loc
(
cÜo
, (*fortune));

232 ià(
	`UNLIKELY
(!
fÜtuÃ
))

233  
çl£
;

235 
fÜtuÃ
->
™em
.
id
 = id;

236 
fÜtuÃ
->
™em
.
mes§ge
 = 
	`cÜo_¡rdup
(
cÜo
, message);

237 ià(
	`UNLIKELY
(!
fÜtuÃ
->
™em
.
mes§ge
))

238  
çl£
;

240  
	`¬¿y_­³nd
(
fÜtuÃs
, 
fÜtuÃ
) >= 0;

241 
	}
}

243 
	$fÜtuÃ_li¡_g’”©Ü
(
cÜo_t
 *
cÜo
)

245 cÚ¡ 
fÜtuÃ_qu”y
[] = "SELECT * FROM Fortune";

246 
fÜtuÃ_bufãr
[256];

247 
FÜtuÃ
 *
fÜtuÃ
;

248 
¬¿y
 
fÜtuÃs
;

249 
db_¡mt
 *
¡mt
;

250 
size_t
 
i
;

252 
¡mt
 = 
	`db_´•¬e_¡mt
(
d©aba£
, 
fÜtuÃ_qu”y
, (fortune_query) - 1);

253 ià(
	`UNLIKELY
(!
¡mt
))

256 
	`¬¿y_š™
(&
fÜtuÃs
, 16);

258 
db_row
 
»suÉs
[] = {

259 { .
kšd
 = 'i' },

260 { .
kšd
 = 's', .
u
.
s
 = 
fÜtuÃ_bufãr
, .
bufãr_Ëngth
 = (fortune_buffer) },

261 { .
kšd
 = '\0' }

263 
	`db_¡mt_¡•
(
¡mt
, 
»suÉs
)) {

264 ià(!
	`­³nd_fÜtuÃ
(
cÜo
, &
fÜtuÃs
, 
»suÉs
[0].
u
.
i
,„esuÉs[1].u.
s
))

265 
out
;

268 ià(!
	`­³nd_fÜtuÃ
(
cÜo
, &
fÜtuÃs
, 0,

270 
out
;

272 
	`¬¿y_sÜt
(&
fÜtuÃs
, 
fÜtuÃ_com·»
);

274 
fÜtuÃ
 = 
	`cÜo_g‘_d©a
(
cÜo
);

275 
i
 = 0; i < 
fÜtuÃs
.
couÁ
; i++) {

276 
FÜtuÃ
 *
f
 = 
fÜtuÃs
.
¬¿y
[
i
];

277 
fÜtuÃ
->
™em
.
id
 = 
f
->item.id;

278 
fÜtuÃ
->
™em
.
mes§ge
 = 
f
->item.message;

279 
	`cÜo_y›ld
(
cÜo
, 1);

282 
out
:

283 
	`¬¿y_ä“_¬¿y
(&
fÜtuÃs
);

284 
	`db_¡mt_fš®ize
(
¡mt
);

286 
	}
}

288 
lwª_h‰p_¡©us_t


289 
fÜtuÃs
(
lwª_»que¡_t
 *
»que¡
 
__©Œibu‹__
((
unu£d
)),

290 
lwª_»¥Ú£_t
 *
»¥Ú£
,

291 *
d©a
 
__©Œibu‹__
((
unu£d
)))

293 
FÜtuÃ
 
	gfÜtuÃ
;

295 ià(
UNLIKELY
(!
lwª_l_­¶y_w™h_bufãr
(
fÜtuÃ_l
,

296 
»¥Ú£
->
bufãr
, &
fÜtuÃ
)))

297  
	gHTTP_INTERNAL_ERROR
;

299 
	g»¥Ú£
->
	gmime_ty³
 = "text/html; charset=UTF-8";

300  
	gHTTP_OK
;

304 
	$maš
()

306 cÚ¡ 
lwª_u¾_m­_t
 
u¾_m­
[] = {

307 { .
´efix
 = "/jsÚ", .
hªdËr
 = 
jsÚ
 },

308 { .
´efix
 = "/db", .
hªdËr
 = 
db
 },

309 { .
´efix
 = "/qu”›s", .
hªdËr
 = 
qu”›s
 },

310 { .
´efix
 = "/¶aš‹xt", .
hªdËr
 = 
¶aš‹xt
 },

311 { .
´efix
 = "/fÜtuÃs", .
hªdËr
 = 
fÜtuÃs
 },

312 { .
´efix
 = 
NULL
 }

314 
lwª_t
 
l
;

316 
	`lwª_š™
(&
l
);

318 
	`¤ªd
(()
	`time
(
NULL
));

320 ià(
	`g‘’v
("USE_MYSQL")) {

321 cÚ¡ *
u£r
 = 
	`g‘’v
("MYSQL_USER");

322 cÚ¡ *
·sswÜd
 = 
	`g‘’v
("MYSQL_PASS");

323 cÚ¡ *
ho¡Çme
 = 
	`g‘’v
("MYSQL_HOST");

324 cÚ¡ *
db
 = 
	`g‘’v
("MYSQL_DB");

326 ià(!
u£r
)

327 
	`lwª_¡©us_ü™iÿl
("No MySQL user…rovided");

328 ià(!
·sswÜd
)

329 
	`lwª_¡©us_ü™iÿl
("No MySQL…assword…rovided");

330 ià(!
ho¡Çme
)

331 
	`lwª_¡©us_ü™iÿl
("No MySQL hostname…rovided");

332 ià(!
db
)

333 
	`lwª_¡©us_ü™iÿl
("No MySQL database…rovided");

335 
d©aba£
 = 
	`db_cÚÃù_mysql
(
ho¡Çme
, 
u£r
, 
·sswÜd
, 
db
);

337 cÚ¡ *
´agmas
[] = {

341 
NULL


343 
d©aba£
 = 
	`db_cÚÃù_sql™e
("‹chempow”.db", 
Œue
, 
´agmas
);

346 ià(!
d©aba£
)

347 
	`lwª_¡©us_ü™iÿl
("Could‚ot connectohe database");

349 
fÜtuÃ_l
 = 
	`lwª_l_compe_¡ršg
(
fÜtuÃs_‹m¶©e_¡r
, 
fÜtuÃ_desc
);

350 ià(!
fÜtuÃ_l
)

351 
	`lwª_¡©us_ü™iÿl
("Could‚ot compile fortuneemplates");

353 
	`lwª_£t_u¾_m­
(&
l
, 
u¾_m­
);

354 
	`lwª_maš_loİ
(&
l
);

356 
	`lwª_l_ä“
(
fÜtuÃ_l
);

357 
	`db_discÚÃù
(
d©aba£
);

358 
	`lwª_shutdown
(&
l
);

361 
	}
}

	@
1
.
0
56
1122
common/base64.c
common/base64.h
common/hash.c
common/hash.h
common/int-to-str.c
common/int-to-str.h
common/list.c
common/list.h
common/lwan-cache.c
common/lwan-cache.h
common/lwan-config.c
common/lwan-config.h
common/lwan-coro.c
common/lwan-coro.h
common/lwan-http-authorize.c
common/lwan-http-authorize.h
common/lwan-io-wrappers.c
common/lwan-io-wrappers.h
common/lwan-job.c
common/lwan-lua.c
common/lwan-lua.h
common/lwan-private.h
common/lwan-redirect.c
common/lwan-redirect.h
common/lwan-request.c
common/lwan-response.c
common/lwan-serve-files.c
common/lwan-serve-files.h
common/lwan-socket.c
common/lwan-status.c
common/lwan-status.h
common/lwan-tables.c
common/lwan-template.c
common/lwan-template.h
common/lwan-thread.c
common/lwan-trie.c
common/lwan-trie.h
common/lwan.c
common/lwan.h
common/murmur3.c
common/murmur3.h
common/realpathat.c
common/realpathat.h
common/sd-daemon.c
common/sd-daemon.h
common/strbuf.c
common/strbuf.h
freegeoip/freegeoip.c
lwan/main.c
techempower/array.c
techempower/array.h
techempower/database.c
techempower/database.h
techempower/json.c
techempower/json.h
techempower/techempower.c
